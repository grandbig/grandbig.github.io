<div class="highlight"><pre><span class="c1">// BeaconServiceクラス</span>
<span class="c1">// Serviceを拡張し、BootstrapNotifierをインターフェースとしたBeaconServiceクラス</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeaconService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="kd">implements</span> <span class="n">BootstrapNotifier</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">altbeacon</span><span class="o">.</span><span class="na">beacon</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">BeaconService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
	
	<span class="c1">// iBeaconのデータを認識するためのParserフォーマット</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">IBEACON_FORMAT</span> <span class="o">=</span> <span class="s">&quot;m:2-3=0215,i:4-19,i:20-21,i:22-23,p:24-24&quot;</span><span class="o">;</span>
	<span class="c1">// BGで監視するiBeacon領域</span>
	<span class="kd">private</span> <span class="n">RegionBootstrap</span> <span class="n">regionBootstrap</span><span class="o">;</span>
	<span class="c1">// iBeacon検知用のマネージャー</span>
	<span class="kd">private</span> <span class="n">BeaconManager</span> <span class="n">beaconManager</span><span class="o">;</span>
	<span class="c1">// UUID設定用</span>
	<span class="kd">private</span> <span class="n">Identifier</span> <span class="n">identifier</span><span class="o">;</span>
	<span class="c1">// iBeacon領域</span>
	<span class="kd">private</span> <span class="n">Region</span> <span class="n">region</span><span class="o">;</span>
	<span class="c1">// 監視するiBeacon領域の名前</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">beaconName</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>

		<span class="c1">// iBeaconのデータを受信できるようにParserを設定</span>
		<span class="n">beaconManager</span> <span class="o">=</span> <span class="n">BeaconManager</span><span class="o">.</span><span class="na">getInstanceForApplication</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		<span class="n">beaconManager</span><span class="o">.</span><span class="na">getBeaconParsers</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">BeaconParser</span><span class="o">().</span><span class="na">setBeaconLayout</span><span class="o">(</span><span class="n">IBEACON_FORMAT</span><span class="o">));</span>
		<span class="c1">// BGでiBeacon領域を監視(モニタリング)するスキャン間隔を設定</span>
		<span class="n">beaconManager</span><span class="o">.</span><span class="na">setBackgroundBetweenScanPeriod</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

		<span class="c1">// UUIDの作成</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;A56BA1E1-C06E-4C08-8467-DB6F5BD04486&quot;</span><span class="o">);</span>
		<span class="c1">// Beacon名の作成</span>
		<span class="n">beaconName</span> <span class="o">=</span> <span class="s">&quot;MyBeacon-000206C6&quot;</span><span class="o">;</span>
		<span class="c1">// major, minorの指定はしない</span>
		<span class="n">region</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Region</span><span class="o">(</span><span class="n">beaconName</span><span class="o">,</span> <span class="n">identifier</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="n">regionBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegionBootstrap</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">region</span><span class="o">);</span>

		<span class="n">beaconManager</span><span class="o">.</span><span class="na">setRangeNotifier</span><span class="o">(</span><span class="k">new</span> <span class="n">RangeNotifier</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">didRangeBeaconsInRegion</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Beacon</span><span class="o">&gt;</span> <span class="n">beacons</span><span class="o">,</span> <span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 検出したビーコンの情報を全部Logに書き出す</span>
				<span class="k">for</span><span class="o">(</span><span class="n">Beacon</span> <span class="n">beacon</span> <span class="o">:</span> <span class="n">beacons</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;UUID:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId1</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, major:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId2</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, minor:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId3</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, Distance:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getDistance</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;,RSSI&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getRssi</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, TxPower&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getTxPower</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">onStartCommand</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onStartCommand</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">startId</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">didEnterRegion</span><span class="o">(</span><span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 領域侵入</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Enter Region&quot;</span><span class="o">);</span>
		<span class="c1">// アプリをFG起動させる</span>
		<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">intent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
		<span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// レンジング開始</span>
			<span class="n">beaconManager</span><span class="o">.</span><span class="na">startRangingBeaconsInRegion</span><span class="o">(</span><span class="n">region</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 例外が発生した場合</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">didExitRegion</span><span class="o">(</span><span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 領域退出</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Exit Region&quot;</span><span class="o">);</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// レンジング停止</span>
			<span class="n">beaconManager</span><span class="o">.</span><span class="na">stopRangingBeaconsInRegion</span><span class="o">(</span><span class="n">region</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span><span class="o">()</span> <span class="o">{</span>
			<span class="c1">// 例外が発生した場合</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">didDetermineStateForRegion</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 領域に対する状態が変化</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Determine State: &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>