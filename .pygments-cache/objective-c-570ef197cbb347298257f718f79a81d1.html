<div class="highlight"><pre><span class="c1">// ViewController.m</span>
<span class="cp">#import &quot;ViewController.h&quot;</span>
<span class="cp">#import &quot;GTMOAuth2Authentication.h&quot;</span>
<span class="cp">#import &quot;GTMOAuth2ViewControllerTouch.h&quot;</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">@&quot;********&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientSecret</span> <span class="o">=</span> <span class="s">@&quot;*********&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">redirectURI</span> <span class="o">=</span> <span class="s">@&quot;urn:ietf:wg:oauth:2.0:oob&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">scope</span> <span class="o">=</span> <span class="s">@&quot;https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">kKeychainItemName</span> <span class="o">=</span> <span class="s">@&quot;Google&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">hasLoggedIn</span> <span class="o">=</span> <span class="s">@&quot;hasLoggedIn&quot;</span><span class="p">;</span>

<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">retain</span><span class="p">)</span> <span class="n">GTMOAuth2Authentication</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">startLogin</span><span class="p">;</span>

<span class="k">@end</span>

<span class="o">&lt;</span> <span class="err">省略</span> <span class="o">&gt;</span>

<span class="c1">// OAuth認証の開始</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startLogin</span>
<span class="p">{</span>
	<span class="c1">// 既に認証をしたかどうか確認</span>
	<span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
	<span class="kt">BOOL</span> <span class="n">hasLoggedin</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">boolForKey:</span><span class="n">hasLoggedIn</span><span class="p">];</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hasLoggedin</span> <span class="o">==</span> <span class="n">YES</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// 認証済みの場合</span>
		<span class="n">self</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">[</span><span class="n">GTMOAuth2ViewControllerTouch</span> <span class="nl">authForGoogleFromKeychainForName:</span><span class="n">kKeychainItemName</span>
		                                                                  <span class="nl">clientID:</span><span class="n">clientId</span>
																	  <span class="nl">clientSecret:</span><span class="n">clientSecret</span><span class="p">];</span>

		<span class="c1">// アクセストークンの取得</span>
		<span class="p">[</span><span class="n">self</span> <span class="n">authorizeRequest</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// 未認証の場合</span>
		<span class="n">GTMOAuth2ViewControllerTouch</span> <span class="o">*</span><span class="n">gvc</span> <span class="o">=</span> <span class="p">[[</span><span class="n">GTMOAuth2ViewControllerTouch</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithScope:</span><span class="n">scope</span>
																					   <span class="nl">clientID:</span><span class="n">clientId</span>
																				   <span class="nl">clientSecret:</span><span class="n">clientSecret</span>
																			   <span class="nl">keychainItemName:</span><span class="n">kKeychainItemName</span>
																			           <span class="nl">delegate:</span><span class="n">self</span>
																			   <span class="nl">finishedSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">viewController:finishedWithAuth:error:</span><span class="p">)];</span>
		<span class="c1">// 認証画面の表示</span>
		<span class="p">[</span><span class="n">self</span> <span class="nl">presentViewController:</span><span class="n">gvc</span> <span class="nl">animated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 認証後に実行する処理</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">viewController:</span><span class="p">(</span><span class="n">GTMOAuth2ViewControllerTouch</span> <span class="o">*</span><span class="p">)</span><span class="n">viewController</span>
      <span class="nl">finishedWithAuth:</span><span class="p">(</span><span class="n">GTMOAuth2Authentication</span> <span class="o">*</span><span class="p">)</span><span class="n">auth</span>
	             <span class="nl">error:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// 認証失敗</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// 認証成功</span>
		<span class="n">self</span><span class="p">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="p">;</span>
		<span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
		<span class="p">[</span><span class="n">defaults</span> <span class="nl">setBool:</span><span class="n">YES</span> <span class="nl">forKey:</span><span class="n">hasLoggedIn</span><span class="p">];</span>
		<span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>

		<span class="c1">// アクセストークンの取得</span>
		<span class="p">[</span><span class="n">self</span> <span class="n">authorizeRequest</span><span class="p">];</span>
	<span class="p">}</span>
	
	<span class="c1">// 認証画面を閉じる</span>
	<span class="p">[</span><span class="n">viewController</span> <span class="nl">dismissViewControllerAnimated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// アクセストークンの取得処理</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">authorizeRequest</span>
<span class="p">{</span>
	<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">auth</span><span class="p">);</span>
	<span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL:</span><span class="n">self</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">tokenURL</span><span class="p">];</span>
	<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">auth</span> <span class="nl">authorizeRequest:</span><span class="n">req</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">auth</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">self</span><span class="p">.</span><span class="n">accessToken</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">accessToken</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}];</span>
<span class="p">}</span>
</pre></div>