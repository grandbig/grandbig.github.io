<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Takahiro Octopress Blog]]></title>
  <link href="http://grandbig.github.io/atom.xml" rel="self"/>
  <link href="http://grandbig.github.io/"/>
  <updated>2014-04-16T23:53:38+09:00</updated>
  <id>http://grandbig.github.io/</id>
  <author>
    <name><![CDATA[Takahiro]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Objective-cでUNIX時間を取得する方法]]></title>
    <link href="http://grandbig.github.io/blog/2014/04/16/unixtime/"/>
    <updated>2014-04-16T23:34:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/04/16/unixtime</id>
    <content type="html"><![CDATA[<h3>Objective-CでUNIX時間を扱うための方法</h3>

<p>今日はUNIX時間を扱う方法について紹介します。UNIX時間とは<strong>UTCでの1970/01/01 00:00:00</strong>からの経過秒数を表したものです。<br/>
世界規模でアプリを開発するなら、UTCで時間を扱う必要があります。また、2つの時刻の差を求めるときは引き算をすれば良いので、時間の演算が非常に簡単にできることもメリットです。<br/>
すなわち、知っておいて損はないってことです。</p>

<p>では、Objective-cでのUNIX時間の扱い方について早速説明しましょう。</p>

<!--more-->


<p>まずは、NSDate型をUNIX時間に変換する処理です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="nf">convertUnixTimeFromDate:</span><span class="p">(</span><span class="n">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="nv">date</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">unixtime</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span> <span class="n">timeIntervalSince1970</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">unixtime</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>次に、UNIX時間をNSDate型に変換する処理です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="nf">convertDateFromUnixTime:</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="nv">unixtime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSDate</span> <span class="o">*</span><span class="n">date</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nl">dateWithTimeIntervalSince1970:</span><span class="n">unixtime</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">date</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これらの２つのメソッドを用いて、試しに現在時間のログを出してみましょう。<br/>
下記はボタンをTouch Downしたときの処理です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">timeBtnAction:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSDate</span> <span class="o">*</span><span class="n">now</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;now: %@&quot;</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">unixtime</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">convertUnixTimeFromDate:</span><span class="n">now</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;unixtime: %f&quot;</span><span class="p">,</span> <span class="n">unixtime</span><span class="p">);</span>
</span><span class='line'>  <span class="n">NSDate</span> <span class="o">*</span><span class="n">now2</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">convertDateFromUnixTime:</span><span class="n">unixtime</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;now2: %@&quot;</span><span class="p">,</span> <span class="n">now2</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>このログは下記のようになります。<br/>
2014-04-16 23:33:27.827 timestamp[22795:907] now: 2014-04-16 14:33:27 +0000<br/>
2014-04-16 23:33:27.828 timestamp[22795:907] unixtime: 1397658807.824172<br/>
2014-04-16 23:33:27.830 timestamp[22795:907] now2: 2014-04-16 14:33:27 +0000</p>

<p>きちんと変換処理が実行されていることがわかります。<br/>
また、unixtimeは<strong>1397658807.824172</strong>のように小数点を伴って出力されます。単位は[秒]なのでマイクロ秒まで表示されていることになります。<br/>
もし、ミリ秒やマイクロ秒単位で時間を管理したいということであれば、くれぐれも小数点以下は切り捨て, 繰り上げ, 四捨五入などしないように！！</p>

<p>ということで本日はここまで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[噂のiOS7.1でiBeaconを試してみよう！！]]></title>
    <link href="http://grandbig.github.io/blog/2014/04/12/io7-dot-1-de-ibeacon/"/>
    <updated>2014-04-12T23:41:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/04/12/io7-dot-1-de-ibeacon</id>
    <content type="html"><![CDATA[<h3>iOS7.1ならアプリのBackground起動も必要なし！？</h3>

<p>さて、本日は最近いろいろなところで取り上げられているiOS7.1でのiBeaconについて実際に試してみました。<br/>
iOS7から導入されたiBeaconですが、これまではアプリをBackgroundで起動していなければBeaconを検知することができませんでした。しかし、iOS7.1からアプリをBackgroundで起動していなくてもBeaconを検知できるようになったとビッグニュースになりました。でも、本当にそうなんでしょうか？と疑問に思った筆者はSampleアプリで試してみました。</p>

<!--more-->


<p>下記がソースです。<br/>
まずはBeacon機器としてiPadを用いるためにPeripheralソースから書きます。<br/>
とりあえずProject作成の手順は<br/>
1: BeaconPeripheralという名称で新規Project作成<br/>
2: UIViewControllerを追加(ViewControllerという名称で作成しました)<br/>
3: CoreBluetoothとCoreLocationライブラリを追加<br/>
として下さい。</p>

<p>ViewController.hのソース</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreBluetooth/CoreBluetooth.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreLocation/CoreLocation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span><span class="o">&lt;</span><span class="n">CBPeripheralManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ViewController.mのソース</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">CBPeripheralManager</span> <span class="o">*</span><span class="n">peripheralManager</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">NSUUID</span> <span class="o">*</span><span class="n">proximityUUID</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 省略</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>          
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">@&quot;Peipheral&quot;</span><span class="p">;</span>
</span><span class='line'>                  
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUUIDString:</span><span class="s">@&quot;8D4DB809-032F-4771-96F3-99BD5C25F924&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">peripheralManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CBPeripheralManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDelegate:</span><span class="n">self</span> <span class="nl">queue:</span><span class="nb">nil</span> <span class="nl">options:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peripheralManager</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CBPeripheralManagerStatePoweredOn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span> <span class="n">startAdvertising</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">startAdvertising</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="n">beaconRegion</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLBeaconRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithProximityUUID:</span> <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID</span>
</span><span class='line'>                                                                         <span class="nl">major:</span><span class="mi">1</span>
</span><span class='line'>                                                                         <span class="nl">minor:</span><span class="mi">2</span>
</span><span class='line'>                                                                    <span class="nl">identifier:</span><span class="s">@&quot;com.test.ibeaconSample&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">beaconPeripheralData</span> <span class="o">=</span> <span class="p">[</span><span class="n">beaconRegion</span> <span class="nl">peripheralDataWithMeasuredPower:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">peripheralManager</span> <span class="nl">startAdvertising:</span><span class="n">beaconPeripheralData</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>次に、Beaconを検知するCentralのソースを書きます。<br/>
Projectの作成手順はPeripheralとほぼ同じで、<br/>
1: BeaconCentralという名称で新規Project作成<br/>
2: UIViewControllerを追加(ViewControllerという名称で作成しました)<br/>
3: CoreLocationライブラリを追加<br/>
として下さい。</p>

<p>ViewController.hのソース</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreLocation/CoreLocation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span><span class="o">&lt;</span><span class="n">CLLocationManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ViewController.mのソース</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">CLLocationManager</span> <span class="o">*</span><span class="n">locationManager</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">NSUUID</span> <span class="o">*</span><span class="n">proximityUUID</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="n">beaconRegion</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">CLBeacon</span> <span class="o">*</span><span class="n">nearestBeacon</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// initWithNibNameは省略</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">CLLocationManager</span> <span class="nl">isMonitoringAvailableForClass:</span><span class="p">[</span><span class="n">CLCircularRegion</span> <span class="n">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];]</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">locationManager</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUUIDString:</span><span class="s">@&quot;8D4DB809-032F-4771-96F3-99BD5C25F924&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">beaconRegion</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLBeaconRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithProximityUUID:</span> <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID</span> <span class="nl">identifier:</span><span class="s">@&quot;com.test.ibeaconSample&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startMonitoringForRegion:</span> <span class="n">self</span><span class="p">.</span><span class="n">beaconRegion</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;お使いの端末ではiBeaconを利用できません。&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 領域計測が開始した場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didStartMonitoringForRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Start Monitoring Region&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 指定した領域に入った場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didEnterRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Enter Region&quot;</span><span class="p">];</span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">region</span> <span class="nl">isMemberOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">isRangingAvailable</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startRangingBeaconsInRegion:</span><span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="n">region</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 指定した領域から出た場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didExitRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Exit Region&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">region</span> <span class="nl">isMemberOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">isRangingAvailable</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">stopRangingBeaconsInRegion:</span><span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="n">region</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Beacon信号を検出した場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didRangeBeacons:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">beacons</span> <span class="nf">inRegion:</span><span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">beacons</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span> <span class="o">=</span> <span class="n">beacons</span><span class="p">.</span><span class="n">firstObject</span><span class="p">;</span>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">rangeMessage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span><span class="p">.</span><span class="n">proximity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityImmediate:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Immediate&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityNear:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Near&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityFar:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Far&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Unknown&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;%f [m]&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span><span class="p">.</span><span class="n">accuracy</span><span class="p">];</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="n">msg</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 領域観測に失敗した場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">monitoringDidFailForRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span> <span class="nf">withError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Exit Region&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ローカルプッシュの処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendLocalNotificationForMessage:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">localNotification</span> <span class="o">=</span> <span class="p">[</span><span class="n">UILocalNotification</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">alertBody</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">fireDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">];</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">soundName</span> <span class="o">=</span> <span class="n">UILocalNotificationDefaultSoundName</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">scheduleLocalNotification:</span><span class="n">localNotification</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでソースは完了です。<br/>
ソースを下記にアップしましたのでダウンロードしたい方はぜひ&hellip;。<br/>
<a href="https://github.com/grandbig/ibeaconCentralSample">Centralソース</a><br/>
<a href="https://github.com/grandbig/ibeaconPeripheralSample">Peripheralソース</a><br/>
まずはアプリをBackgroundで起動させているときの動作を見てみてください。<br/>
動作確認時には必ずCentralを先に起動する必要があります。約5秒後にPeripheralを起動して下さい。Centralの方にローカルプッシュが届くはずです。</p>

<p>続いて、アプリがBackground起動していない場合を見てみましょう。PeripheralアプリとCentralのアプリの両方を停止状態にします。(先ほどの状態から続けて実験する場合は、必ずCentralアプリ側に<strong>Exit Region</strong>というメッセージでローカルプッシュが届いてからにしてください。)<br/>
さて、Peripheralアプリを起動しましょう。しばらくするとCentralアプリを起動していないにも関わらず、ローカルプッシュが届くはずです。そして、Beacon間の距離がどんどんローカルプッシュされてくることでしょう。<br/>
<img src="http://grandbig.github.io/images/ibeacon_ios71_1.png" alt="Centralアプリを起動していない状態でローカルプッシュが届く" /><br/>
その後、Peripheralアプリを停止してみましょう。しばらくするとCentralアプリに<strong>Exit Region</strong>というローカルプッシュが届くはずです。それを最後にローカルプッシュは来なくなります。<br/>
<img src="http://grandbig.github.io/images/ibeacon_ios71_2.png" alt="Beaconの検知終了" /></p>

<p>このように、確かにアプリをBackgroundで起動していなくてもBeaconを検知するようです。因みに、このときアプリがBackground起動しているのか確認したのですが、起動はしてないんですね〜。というかホームボタン2回タップでBackground起動しているアプリが見れるはずなのに、そこに出てないんですね〜。う〜ん。どういうことなんでしょうか？？</p>

<p>まぁ、何はともあれ、iOS7.1からiBeaconの扱いが劇的に変わるってことは間違いないようです。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FMDBを使ったDB接続を関数化しよう！！]]></title>
    <link href="http://grandbig.github.io/blog/2014/04/11/fmdatabase2/"/>
    <updated>2014-04-11T22:17:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/04/11/fmdatabase2</id>
    <content type="html"><![CDATA[<h3>FMDBを使ったDB接続を自作関数化</h3>

<p>さて、ブログを更新します。以前、<a href="http://grandbig.github.io/blog/2013/11/30/fmdatabase/">FMDBを使って簡単にiPhoneのローカルストーレジを活用しよう！</a>でObjective-CでSQLiteを扱うためのFMDBライブラリについて説明させて頂きました。<br/>
そのときは全てをベタ書きしていましたが、毎回書くのは面倒ですよね&hellip;ってことで自作しちゃいましょう！！</p>

<!--more-->


<p>まずはおさらいです。DB接続は下記です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span> <span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="n">YES</span> <span class="p">);</span>
</span><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">FMDatabase</span> <span class="nl">databaseWithPath:</span><span class="p">[</span><span class="n">dir</span> <span class="nl">stringByAppendingPathComponent:</span><span class="s">@&quot;test.db&quot;</span><span class="p">]];</span>
</span></code></pre></td></tr></table></div></figure>


<p>これをtableの作成, select, insert, update, delete, countのたびに書くのは面倒なので&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">dbConnect:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">dbName</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span> <span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="n">YES</span> <span class="p">);</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">FMDatabase</span> <span class="nl">databaseWithPath:</span><span class="p">[</span><span class="n">dir</span> <span class="nl">stringByAppendingPathComponent:</span><span class="n">dbName</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">db</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>としちゃいましょう。<br/>
そうすれば、同じmファイル内であればtableの作成, select, insert, update, delete, countは以下のように書けます。</p>

<h4>tableの作成</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">createTable:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// tableの作成</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;create table if not exists %@ (id INTEGER PRIMARY KEY, uid TEXT, createtime TEXT)&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>select文の実行</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">selectData:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// select文</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;select * from %@&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">FMResultSet</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span> <span class="nl">executeQuery:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="k">while</span><span class="p">([</span><span class="n">rs</span> <span class="n">next</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSInteger</span> <span class="n">idNum</span> <span class="o">=</span> <span class="p">[[</span><span class="n">rs</span> <span class="nl">stringForColumnIndex:</span><span class="mi">0</span><span class="p">]</span> <span class="n">intValue</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">uid</span> <span class="o">=</span> <span class="p">[</span><span class="n">rs</span> <span class="nl">stringForColumnIndex:</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">createtime</span> <span class="o">=</span> <span class="p">[</span><span class="n">rs</span> <span class="nl">stringForColumnIndex:</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;id: %ld, uid: %@, createtime: %@&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">idNum</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">createtime</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>insert文の実行</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">insertData:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'>          <span class="nf">userID:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">uid</span>
</span><span class='line'>      <span class="nf">createtime:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">createtime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// insert文</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;insert into %@ (uid, createtime) values(&#39;%@&#39;, &#39;%@&#39;)&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">createtime</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>update文の実行</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateData:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'>          <span class="nf">userID:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">uid</span>
</span><span class='line'>      <span class="nf">createtime:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">createtime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// update文</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;update %@ set uid=&#39;%@&#39;, createtime=&#39;%@&#39; where id=1&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">createtime</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>delete文の実行</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">deleteData:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// delete文</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;delete from %@&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>count文の実行</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">countData:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableName</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">dbConnect:</span><span class="s">@&quot;test.db&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// count文</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;select count(*) as count from %@&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">open</span><span class="p">];</span>
</span><span class='line'>  <span class="n">FMResultSet</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span> <span class="nl">executeQuery:</span><span class="n">sql</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSInteger</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span><span class="p">([</span><span class="n">rs</span> <span class="n">next</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">rs</span> <span class="nl">intForColumn:</span><span class="s">@&quot;count&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="n">db</span> <span class="n">close</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一度、関数を作ってしまえば、使いやすさがぐんぐん増します！！<br/>
自身のiOSアプリに最適なSQLiteを扱うメソッドを作ってみてはどうでしょうか？</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[didUpdateLocationsを軽く調べてみる]]></title>
    <link href="http://grandbig.github.io/blog/2014/04/08/didupdatetolocation2/"/>
    <updated>2014-04-08T23:03:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/04/08/didupdatetolocation2</id>
    <content type="html"><![CDATA[<h3>didUpdateLocationsのNSArray型の引数が気になる！！</h3>

<p>さて、今日はざっくり調べたことを書きます。ほんの数行です！</p>

<!--more-->


<p><a href="http://grandbig.github.io/blog/2014/04/05/didupdatetolocation/">前回</a>、書きましたdidUpdateLocationsを使ってみました。<br/>
最も気になったのが、NSArray型の引数であるlocationsの中身には何が入っているのか？ということです。<br/>
下記のようにソースを書きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span>
</span><span class='line'>  <span class="nf">adidUpdateLocations:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CLLocation</span> <span class="o">*</span><span class="n">currentLocation</span> <span class="o">=</span> <span class="n">locations</span><span class="p">.</span><span class="n">lastObject</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NSInteger</span> <span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">locations</span> <span class="n">count</span><span class="p">];</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lng</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;cnt: %ld,lat: %f, lng: %f&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">cnt</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>実際にログを出力してみた結果はというと&hellip;<br/>
2014-04-08 23:02:35.371 LocationPractice[11243:60b] cnt: 1,lat: 35.933374, lng: 139.619913<br/>
2014-04-08 23:02:36.837 LocationPractice[11243:60b] cnt: 1,lat: 35.933351, lng: 139.619884<br/>
2014-04-08 23:02:37.428 LocationPractice[11243:60b] cnt: 1,lat: 35.933327, lng: 139.619856<br/>
&hellip;&hellip;</p>

<p>の繰り返しでした。<br/>
NSArray型のlocationsには最新の位置情報しか入らないようです。<br/>
う〜む。なんでNSArray型なんでしょうか&hellip;。ただ、よくよく考えるとNSMutableArray型でないから要素増えないんでしょうか&hellip;。何て思ったりしました。<br/>
はい。短いけど、今日はここまで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CLLocationManagerDelegateのdidUpdateToLocationがDeprecated!?]]></title>
    <link href="http://grandbig.github.io/blog/2014/04/05/didupdatetolocation/"/>
    <updated>2014-04-05T11:25:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/04/05/didupdatetolocation</id>
    <content type="html"><![CDATA[<h3>didUpdateToLocationではなくdidUpdateLocationsを使うべき!?</h3>

<p>久々に更新します。今日は位置情報サービスで変更があった点に注目してみます。筆者は昨日まで、この変更を気にせずに普通にこれまで通りの方法で位置情報の取得をしていました。<br/>
しかし、よくよく<a href="https://developer.apple.com/library/ios/documentation/CoreLocation/Reference/CLLocationManagerDelegate_Protocol/CLLocationManagerDelegate/CLLocationManagerDelegate.html">AppleのCLLocationManagerDelegate Protocol Reference</a>を見てみると、『locationManager:didUpdateToLocation:fromLocation:』に<strong>Deprecated in iOS 6.0</strong>の文字が&hellip;。<br/>
そして代わりに『locationManager:didUpdateLocations:』というものがありました。<br/>
う〜む&hellip;どうやら今はこちらを使った方が良いようですね。</p>

<!--more-->


<p>しかし、最新のXcode5.1でDeployment Targetを6.0に設定して下記をソースに書いたとしてもDeprecatedとWarningが出ることはありません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span><span class="o">*</span><span class="p">)</span><span class="nv">manager</span>
</span><span class='line'>  <span class="nf">didUpdateToLocation:</span><span class="p">(</span><span class="n">CLLocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">newLocation</span>
</span><span class='line'>         <span class="nf">fromLocation:</span><span class="p">(</span><span class="n">CLLocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">oldLocation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lat</span> <span class="o">=</span> <span class="p">[</span><span class="n">newLocation</span> <span class="n">coordinate</span><span class="p">].</span><span class="n">latitude</span><span class="p">;</span> <span class="c1">// 緯度</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lng</span> <span class="o">=</span> <span class="p">[</span><span class="n">newLocation</span> <span class="n">coordinate</span><span class="p">].</span><span class="n">longitude</span><span class="p">;</span> <span class="c1">// 経度</span>
</span><span class='line'>  <span class="n">CLLocationDistance</span> <span class="n">altitude</span> <span class="o">=</span> <span class="n">newLocation</span><span class="p">.</span><span class="n">altitude</span><span class="p">;</span> <span class="c1">// 高度</span>
</span><span class='line'>  <span class="n">CLLocationDirection</span> <span class="n">course</span> <span class="o">=</span> <span class="n">newLocation</span><span class="p">.</span><span class="n">course</span><span class="p">;</span> <span class="c1">// 方角</span>
</span><span class='line'>  <span class="n">CLLocationSpeed</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">newLocation</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span> <span class="c1">// 速度</span>
</span><span class='line'>  <span class="n">CLLocationAccuracy</span> <span class="n">horizontalAccuracy</span> <span class="o">=</span> <span class="n">newLocation</span><span class="p">.</span><span class="n">horizontalAccuracy</span><span class="p">;</span> <span class="c1">//水平方向の精度</span>
</span><span class='line'>  <span class="n">CLLocationAccuracy</span> <span class="n">verticalAccuracy</span> <span class="o">=</span> <span class="n">newLocation</span><span class="p">.</span><span class="n">verticalAccuracy</span><span class="p">;</span> <span class="c1">//垂直方向の精度</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これではDeprecatedになっていることに気づかないですよね&hellip;。ま、新iOSがリリースされるごとにリファレンスをきちんと読むべきってことですね。<br/>
はい！では今度からこう書きましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span>
</span><span class='line'>   <span class="nf">didUpdateLocations:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CLLocation</span> <span class="o">*</span><span class="n">currentLocation</span> <span class="o">=</span> <span class="n">locations</span><span class="p">.</span><span class="n">lastObject</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">;</span> <span class="c1">// 緯度</span>
</span><span class='line'>  <span class="n">CLLocationDegrees</span> <span class="n">lng</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">;</span> <span class="c1">// 経度</span>
</span><span class='line'>  <span class="n">CLLocationDistance</span> <span class="n">altitude</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">altitude</span><span class="p">;</span> <span class="c1">// 高度</span>
</span><span class='line'>  <span class="n">CLLocationDirection</span> <span class="n">course</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">course</span><span class="p">;</span> <span class="c1">// 方角</span>
</span><span class='line'>  <span class="n">CLLocationSpeed</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span> <span class="c1">// 速度</span>
</span><span class='line'>  <span class="n">CLLocationAccuracy</span> <span class="n">horizontalAccuracy</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">horizontalAccuracy</span><span class="p">;</span> <span class="c1">// 水平方向の精度</span>
</span><span class='line'>  <span class="n">CLLocationAccuracy</span> <span class="n">verticalAccuracy</span> <span class="o">=</span> <span class="n">currentLocation</span><span class="p">.</span><span class="n">verticalAccuracy</span><span class="p">;</span> <span class="c1">// 水ty区方向の精度</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>古い方で位置情報を取得しても少なくともiOS6では問題ありませんでした。が、iOS7ではまだ未検証なので、試してみます。とは言え、新しい方を使うべきだと思いますが&hellip;。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xcode5でDebug gaugesを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2014/03/16/xcode5debug/"/>
    <updated>2014-03-16T21:56:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/03/16/xcode5debug</id>
    <content type="html"><![CDATA[<h3>Xcode5のデバッグ機能を使ってCPUとスレッドを調べよう</h3>

<p>最近、アプリを開発する上で、その操作が<strong>どのくらいCPUを消費するのか</strong>, <strong>マルチスレッドを有効に使えているのか</strong>を厳しく見る必要が出てきました。それまでCPUやスレッドもそこまで気にしたことはなかったのですが、Xcode5からはInstrumentを起動しなくとも、簡易的に確認できるということで試しにやってみました。</p>

<!--more-->


<h4>Xcode5でDebug gaugesを使ってみる</h4>

<p>まずは、本当に簡単な何もしない画面を作成して、様子を見てみました。<br/>
<img src="http://grandbig.github.io/images/xcode_debug1.png" alt="何もしない画面の様子" /></p>

<p>4つスレッドがあります。そして、画面の描画に使われているであろうスレッドがThread1であることがわかると思います。他は全く使ってないですね。<br/>
また、本試験ではiPhone5(iOS7.1)を利用しているため、マルチコアなので、CPUのメータが最大200%であることが示されています。<br/>
しばらく見ていると、4つあったスレッドが2つに減ります。<br/>
<img src="http://grandbig.github.io/images/xcode_debug2.png" alt="スレッドが2つになる" /></p>

<p>続いて、for分で10000回ループしてひたすらログを出力するボタンを作成して、様子を見てみました。<br/>
<img src="http://grandbig.github.io/images/xcode_debug3.png" alt="for分で10000回ループ" /></p>

<p>さて、スレッドを別に作成して実行してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">dispatch_queue_t</span> <span class="n">gQueue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">gQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">NSInteger</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d回目のループ&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>その結果が下図。<br/>
<img src="http://grandbig.github.io/images/xcode_debug4.png" alt="別スレッドで実行" /><br/>
これを見るとメインスレッドとは別のスレッドで実行されていることがわかります。基本的に描画はメインスレッドでしか実行がされないので、その他の処理はメインスレッドとは別スレッドで行うのが良さそうですね。</p>

<p>実際にやってみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">dispatch_queue_t</span> <span class="n">gQueue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">gQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">NSInteger</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%d回目のループ&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
</span><span class='line'>      <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;メインのループ&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://grandbig.github.io/images/xcode_debug5.png" alt="マルチスレッドでの実行" /><br/>
メインスレッドと別スレッドで各10000回ログを出力する処理を実行しているため、同じ時間帯にリソースを使っていることがわかりますね。</p>

<h3>マップを描画してDebug gaugesを見てみる</h3>

<p>アプリを開発するときにマップを利用すると様々な操作でメインスレッドを利用していることがわかります。まずはマップを起動してみましょう。<br/>
<img src="http://grandbig.github.io/images/xcode_debug6.png" alt="マップを起動してみる" /><br/>
起動直後から大量のスレッドが作成されていることがわかります。描画はメインスレッドでやるものの、様々な計算は別スレッドでやっているということなんでしょうか&hellip;。<br/>
起動してからしばらく放置しておくとスレッドがどんどん減っていきます。<br/>
しかし、マップを拡大・縮小するとスレッドが大量に作成されます。また、CPUも激しく消費することがわかります。(余裕で140〜150%まで上がったりしますね&hellip;)</p>

<p>これらはユーザの操作によって引き起こされる現象なので、極端な話、触らなければCPUの消費はされません。<br/>
では、下記のようにしてみたらどうなるでしょうか？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mapViewDidFinishLoadingMap:</span><span class="p">(</span><span class="n">MKMapView</span> <span class="o">*</span><span class="p">)</span><span class="nv">mapView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">map</span> <span class="nl">setUserTrackingMode:</span><span class="n">MKUserTrackingModeFollowWithHeading</span> <span class="nl">animated:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://grandbig.github.io/images/xcode_debug7.png" alt="ユーザの方向にマップが回転する" /><br/>
ユーザの動きを検知して自動で回転するので、CPUを使い続けます。</p>

<h3>まとめ</h3>

<p>アプリを開発する上で、端末のリソースをどのようにうまく使っていくのかは非常に重要です。マップを使うアプリを作成するときは特に注意が必要ですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UIImageを任意の角度で回転させる方法について]]></title>
    <link href="http://grandbig.github.io/blog/2014/03/13/uiimagerotate/"/>
    <updated>2014-03-13T00:01:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/03/13/uiimagerotate</id>
    <content type="html"><![CDATA[<h3>UIImageを自由に回転させよう！</h3>

<p>今日はUIImageの回転について語ります。注意して頂きたいのはUIImageViewの回転ではなく、UIImageの回転です。<br/>
筆者は検索すればさくっと誰かが作ったものが見つかるだろうと思っていました&hellip;が、全然見つからない(汗)<br/>
見つかっても、90°, 180°, 270°の回転といった限定されたものでした。求めているものは自由に回転させる方法なんです！！(5°とか26.8°とか&hellip;)<br/>
しかし、粘って検索したり、いろいろと試した結果、方法がわかりました。ということで、早速説明していきましょう。</p>

<!--more-->


<p>UIImageにはUIImageViewのようにtransformといったプロパティは用意されていません。回転させるためには、ガシガシソースを書く必要があります。<br/>
下記のように&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 元の画像。ここではtest.pngという画像があるとします。</span>
</span><span class='line'><span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="s">@&quot;test.png&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">UIGraphicsBeginImageContext</span><span class="p">(</span><span class="n">CGRectMake</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">));</span>
</span><span class='line'><span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
</span><span class='line'><span class="n">CGContextTranslateCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// 回転の中心点を移動</span>
</span><span class='line'><span class="n">CGContextScaleCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">);</span> <span class="c1">// Y軸方向を補正</span>
</span><span class='line'>
</span><span class='line'><span class="kt">float</span> <span class="n">radian</span> <span class="o">=</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span> <span class="c1">// 45°回転させたい場合</span>
</span><span class='line'><span class="n">CGContextRotateCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">radian</span><span class="p">);</span>
</span><span class='line'><span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">UIGraphicsGetCurrentContext</span><span class="p">(),</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="o">-</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">),</span> <span class="n">image</span><span class="p">.</span><span class="n">CGImage</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">UIImage</span> <span class="o">*</span><span class="n">rotatedImage</span> <span class="o">=</span> <span class="n">UIGraphicsGetImageFromCurrentImageContext</span><span class="p">();</span>
</span><span class='line'><span class="n">UIGraphicsEndImageContext</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// UIImageViewに回転後の画像を設定</span>
</span><span class='line'><span class="n">UIImageView</span> <span class="o">*</span><span class="n">imageView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">rotatedImage</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで回転した画像を確認することができるはずです。<br/>
因みにUIImageViewを回転させて支障がないようであれば、そっちの方が断然簡単です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">UIImageView</span> <span class="o">*</span><span class="n">imageView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="s">@&quot;test.png&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="kt">float</span> <span class="n">radian</span> <span class="o">=</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span> <span class="c1">// 45°回転させたい場合</span>
</span><span class='line'><span class="n">imageView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeRotation</span><span class="p">(</span><span class="n">radian</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>たったこれだけです。<br/>
UIImageViewごと回転で対応できない場合の例としてはマップ上でアノテーションの画像を回転させる場合でしょう。仮にMKAnnotationViewを回転させた場合、アノテーションをタップしたときに表示されるバルーンも回転してしまうので、困ったことになります。こういったときにはUIImageを回転させるしかないんです。</p>

<p>参考URL:<br/>
<a href="http://stackoverflow.com/questions/5102474/rotate-uiimage-custom-degree">Rotate UIImage custom degree Stack Overflow</a><br/>
<a href="http://www.objectivec-iphone.com/animation/UIView-animation/CGAffineTransform.html">UIViewのアフィン変換</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Universalアプリ開発における縦横対応について]]></title>
    <link href="http://grandbig.github.io/blog/2014/03/09/devicerotate/"/>
    <updated>2014-03-09T21:39:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/03/09/devicerotate</id>
    <content type="html"><![CDATA[<h3>iPhoneは縦のみ対応/iPadは縦横対応させたい！！</h3>

<p>さて、久々に基本的なところで躓いてしまったのでメモしておきます。iPhone/iPadの両方に対応したUniversalなアプリを開発するときに、縦横対応を考える必要があります。iPhoneであれば基本的には縦もしくは横どちらかに固定すれば十分です。一方でiPadは縦をメインとして使うユーザと横をメインとして使うユーザの両方がターゲットとなります。では、iPhone/iPadで固定/非固定を分けて開発するためにはどうしたら良いのでしょうか？</p>

<p>今回はその答えを始めに紹介し、続いて筆者が躓いたことによって得た情報を紹介したいと思います。</p>

<!--more-->


<p>では、始めにiPhone/iPadで固定/非固定を分けて開発する方法を紹介しましょう。<br/>
Xcode5上で<strong>TARGETS > Deployment Info</strong>を見て下さい。iPhoneとiPadの文字が並んで表示されている部分があると思います。(恐らく、iPhoneが青字になっていることでしょう。)<br/>
この下に<strong>Device Orientation</strong>と書かれており、<strong>Portrait, Upside Down, Landscape Left, Landscape Right</strong>の4つのチェックボックスがあります。<br/>
iPhoneは縦のみ, iPadは全方向OKにしたい場合は、iPhone選択時に<strong>Portraitのみにチェック</strong>, iPad選択時に<strong>4つ全てにチェック</strong>を入れましょう。<br/>
<img src="http://grandbig.github.io/images/devicerotate1.png" alt="Xcode5で各デバイスの設定をしましょう" /></p>

<p>これで設定完了です。非常に簡単ですね！<br/>
筆者はソースコードでどうにかしようと取り組んでいたため、時間がかかってしまいました笑。<br/>
ただ、逆に言えばソースコードでも設定は可能なんです。そこについて紹介しましょう。</p>

<p>まず、筆者は下記のようにAppDelegate.mファイルにソースを書きました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="p">[[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">bounds</span><span class="p">]];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// UIViewController型のViewControllerを生成</span>
</span><span class='line'>  <span class="n">ViewController</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ViewController</span> <span class="o">*</span><span class="p">)[[</span><span class="n">NavigationController</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithRootViewController:</span><span class="n">vc</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">window</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>objective-c
NavigationControllerをrootViewControllerに指定しています。そのNavigationControllerに自身で作成したViewControllerを加えています。<br/>
さて、続いてViewController.mのソースを書いていきます。Objective-Cでは端末が回転したときに<strong>supportedInterfaceOrientations</strong>と<strong>shouldAutorotate</strong>の2つが呼び出されます。<br/>
supportedInterfaceOrientationsは回転を許可する端末の方向を指定し, shouldAutorotateは端末が回転したときに自動で回転するかどうかを指定します。<br/>
例えば、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">supportedInterfaceOrientations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">UIInterfaceOrientationMaskPortrait</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">shouldAutorotate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">interfaceorientation</span> <span class="o">==</span> <span class="n">UIInterfaceOrientationPortrait</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>と書くと、supportedInterfaceOrientationsではPortrait方向のみ回転を許可し、shouldAutorotateではPortrait方向のみ自動で回転するようになっています。この両関数の指定がずれた場合はエラーが発生します。<br/>
上記のように書いておけば、冒頭で説明したXcode5のDevice Orientationの4つ全てにチェックを入れていたとしても、回転することはありません。<br/>
のはずでしたが、まだこの状態では回転してしまいます&hellip;。なぜなんでしょうか？<br/>
それはrootViewControllerにNavigationControllerを設定しまったためだそうです。これを回避するためには、NavigationControllerに設定してあるtopViewControllerの値を返すようにCustomNavigationControllerを作成する必要があります。<br/>
では、UINavigationControllerを継承したCustomNavigationControllerを作成しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// CustomNavigationController.h</span>
</span><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CustomNavigationController</span> : <span class="nc">UINavigationController</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;CustomNavigationController.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CustomNavigationController</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">CustomNavigationController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithNibName:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">nibNameOrNil</span> <span class="nf">bundle:</span><span class="p">(</span><span class="n">NSBundle</span> <span class="o">*</span><span class="p">)</span><span class="nv">nibBundleOrNil</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nl">initWithNibName:</span><span class="n">nibNameOrNil</span> <span class="nl">bundle:</span><span class="n">nibBundleOrNil</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Custom initialization</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">supper</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 新たに加えるソースは下記4行のみです。</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">supportedInterfaceOrientations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">topViewController</span><span class="p">.</span><span class="n">supportedInterfaceOrientations</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここまで書ければ、後はAppDelegate.mファイルでNavigationControllerとしていたところをCustomNavigationControllerに変更すればOKです。<br/>
今度こそ、端末の回転を抑制することができていますよね？</p>

<p>今回は初歩的な話でしたが(いつもか&hellip;笑)、基本は非常に重要であり、知っていないと思わぬところで時間をくってしまいます。<br/>
様々な書籍でObjective-Cの基本的な書き方, Xcodeの基本的な使い方が紹介されていると思いますが、筆者のおすすめは下記。<br/>
<strong>WEB DB PRESS</strong>で初めてiOS7について基本的なところを説明してくれています。初心者には役に立つこと間違いないでしょう。<strong>Software Design Plus iOSアプリ エンジニア養成読本</strong>はまだ未発売ですが、iOSアプリのエンジニアとして生き残るための方法が書いてあるとのことなので、今から楽しみにしています。といったところで本日はここまで。</p>

<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?t=grandbig7-22&o=9&p=8&l=as1&asins=4774162876&ref=qf_sp_asin_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=000000&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>


<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?t=grandbig7-22&o=9&p=8&l=as1&asins=4774163856&ref=qf_sp_asin_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=000000&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSUserDefaultsで手軽にデータを端末保存しよう！]]></title>
    <link href="http://grandbig.github.io/blog/2014/03/07/nsuserdefaults/"/>
    <updated>2014-03-07T22:59:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/03/07/nsuserdefaults</id>
    <content type="html"><![CDATA[<h3>最も簡単なデータの端末保存方法を学ぼう！</h3>

<p>さて、今日はNSUserDefaultsを使った簡単なデータの保存方法について紹介したいと思います。と言っても、本当に多くのサイトで十分にわかりやすい説明が書かれているので、要点を絞って簡単に説明したいと思います。</p>

<!--more-->


<p>まずは新規にデータを保存する場合です。<br/>
NSString型のデータを保存する場合の例を下記に記します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// NSUserDefaultsの取得</span>
</span><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データの保存処理</span>
</span><span class='line'><span class="p">[</span><span class="n">defaults</span> <span class="nl">setObject:</span><span class="s">@&quot;value&quot;</span> <span class="nl">forKey:</span><span class="s">@&quot;key&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 保存の即時反映</span>
</span><span class='line'><span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>最後のsynchronizeを利用しないとデータ保存までにタイムラグが発生する可能性があります。データ保存後に、すぐさまデータを利用する機会がある場合などはsynchronizeを呼び出した方が良いでしょう。</p>

<p>さて、次にデータを取得する場合です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// NSUserDefaultsの取得</span>
</span><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データの取得</span>
</span><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">stringForKey:</span><span class="s">@&quot;key&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>非常に簡単にできますね。</p>

<p>さて、NSUserDefaultsに保存したデータはどこにいったのでしょうか？<br/>
実はXcodeから確認することができます。確認方法は以下の手順です。<br/>
1. 『Window > Organizer > Applications』から確認したいアプリを選択<br/>
2. フッターに位置するDownloadを選択<br/>
3. Downloadしてきたファイルを右クリックして、『パッケージの内容を表示』を選択<br/>
4. AppData > Library > Preferences > Bundle Identifier名称.plistを見る</p>

<p>該当ファイルを見るとXML書式でデータが書かれていることがわかります。<br/>
<img src="http://grandbig.github.io/images/nsuserdefaults.png" alt="NSUserDefaultsに保存したデータの確認" /></p>

<p>因みにNSUserDefaultsは万能ではありません。<br/>
用途としては<br/>
<strong>ユーザID, プロファイルデータなどの量が増えないデータ</strong><br/>
の保存が考えられます。</p>

<p>もし、<strong>『大量のデータを保存したい』、『ある条件を満たすデータのみを取得したい』</strong>などの使い方をするのであればSQLiteを使うべきでしょう。</p>

<p>ということで本日はここまで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Silent Remote Notificationを試そう！]]></title>
    <link href="http://grandbig.github.io/blog/2014/02/22/silentremotenotification/"/>
    <updated>2014-02-22T00:06:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/02/22/silentremotenotification</id>
    <content type="html"><![CDATA[<h3>iOS7で新たに追加されたSilent Remote Notificationを使ってみよう！！</h3>

<p>本日はiOS7から新たに追加された<strong>Silent Remote Notification</strong>について紹介します。<br/>
iOS6までで利用できたRemote Notificationと何が違うのかと言いますと、<strong>ユーザ端末のロック画面に表示させることなく</strong>通知することができるんです。<br/>
つまり、<br/>
Remote Notification: ユーザに何かを気づかせるためにプッシュする<br/>
Silent Remote Notification: ユーザに気づかせることなくプッシュする<br/>
ということです。</p>

<p>これを見ると、『Silent Remote Notificationって使い道あるの？？』なんて思ってしまいそうですよね。これが意外とありそうなんです。<br/>
例えば、<br/>
・ユーザに気づかれずにアプリ内の情報を最新に更新する<br/>
・ユーザに気づかれずにアプリ内のユーザ情報を取得する<br/>
ことなどが考えられます。<br/>
後者はユーザ視点からすると気になるかもしれませんが、『アプリの有用性をユーザに最大限に感じてもらうための方法』と考えて頂ければとても大切なことであると伝わるでしょうか。</p>

<p>そんな様々な使い道がありそうなSilent Remote Notificationについて早速説明していきます。</p>

<!--more-->


<h4>ネイティブソースとXcode5の設定について</h4>

<p>まずは、ネイティブソースとXcode5の設定から説明します。Xcode5でプロジェクトを作成したら、TARGETS > Capabilities > Background Modes > Remote notificationsにチェックを入れます。<br/>
<img src="http://grandbig.github.io/images/xcode-silent-notifications1.png" alt="Xcode5での設定方法" /><br/>
続いてはネイティブソースでプッシュの受取り口を作りましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// AppDelegate.hファイル</span>
</span><span class='line'><span class="err">@</span><span class="n">interfase</span> <span class="n">AppDelegate</span> <span class="o">:</span> <span class="n">NSObject</span><span class="o">&lt;</span><span class="n">UIApplicationDelegate</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// AppDelegate.mファイル</span>
</span><span class='line'><span class="c1">// ①トークン値の取得</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">application</span><span class="o">:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="n">didRegisterForRemoteNotificationsWithDeviceToken</span><span class="o">:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">devToken</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//デバイストークンから&#39;&lt;&#39;,&#39;&gt;&#39;,&#39; &#39;を削除して変数に保存</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="p">[[[[</span><span class="n">devToken</span> <span class="n">description</span><span class="p">]</span> <span class="n">stringByReplacingOccurrencesOfString</span><span class="o">:</span><span class="err">@</span><span class="s">&quot;&lt;&quot;</span><span class="n">withString</span><span class="o">:</span><span class="err">@</span><span class="s">&quot;&quot;</span><span class="p">]</span>
</span><span class='line'>                          <span class="n">stringByReplacingOccurrencesOfString</span><span class="o">:</span><span class="err">@</span><span class="s">&quot;&gt;&quot;</span> <span class="n">withString</span><span class="o">:</span><span class="err">@</span><span class="s">&quot;&quot;</span><span class="p">]</span>
</span><span class='line'>                          <span class="n">stringByReplacingOccurrencesOfString</span><span class="o">:</span> <span class="err">@</span><span class="s">&quot; &quot;</span> <span class="n">withString</span><span class="o">:</span> <span class="err">@</span><span class="s">&quot;&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">&quot;deviceToken: %@&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">token</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ②通常のRemote Notificationが届いたときに通る処理</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">application</span><span class="o">:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="n">didReceiveRemoteNotification</span><span class="o">:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">userInfo</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ③Silent Remote Notificationが届いたときに通る処理</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">application</span><span class="o">:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span>
</span><span class='line'> <span class="nl">didReceiveRemoteNotification:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">userInfo</span>
</span><span class='line'>  <span class="nl">fetchCompletionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">UIBackgroundFetchResult</span><span class="p">))</span><span class="n">completionHandler</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>プッシュ通知を受け取ったとき、上記に書いたdidReceiveRemoteNotification処理が実行されます。コメントアウトにも書いていますが、③がSilent Remote Notificationが届いたときに通る処理です。<br/>
ただし、Silent Remote NotificationはiOS7以上でないと対応していないのでiOS6の場合は通常のRemote Notification, Silent Remote Notificationに関わらず②のdidReceiveRemoteNotificationを通りますので、ご注意ください。<br/>
あとは③に実行させたい処理を書けば、Silent Remote Notificationの実装は完了です。</p>

<h4>動作確認用に簡単にプッシュ通知を送る処理を書こう</h4>

<p>さて、ネイティブ側の実装はできましたが、本当にこれで送れるのか確認したいですよね？Node.jsのnode-apnモジュールを使えば驚くほど簡単に用意することができます。<br/>
より簡単に作成するためにExpressモジュールを使って説明します。Expressモジュールの用意については<a href="https://gihyo.jp/dev/serial/01/nodejs/0003">第3回 Express.jsを使ったWebアプリケーションを構築</a>を参照ください。</p>

<p>それではpushtestという名前のWebアプリの雛形を作成しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>express -t ejs pushtest
</span></code></pre></td></tr></table></div></figure>


<p>次にpushtest配下で</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm install
</span></code></pre></td></tr></table></div></figure>


<p>を実行して必要なモジュールをインストールしましょう。さらに、node-apnモジュールもインストールしましょう。また後ほど利用するquerystringモジュールもインストールしておきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm install apn
</span><span class='line'>npm install qs
</span></code></pre></td></tr></table></div></figure>


<p>これでモジュールが揃ったので、app.jsを編集しましょう。<br/>
pushtest/routes/apns.jsを作成しておきます。(デフォルトで作成されるindex.jsかuser.jsをコピーしてファイル名を変更すればOKです)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/user&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">apns</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/apns&#39;</span><span class="p">);</span><span class="c1">// apns.jsの読み込みを追加</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/apns&#39;</span><span class="p">,</span> <span class="nx">apns</span><span class="p">.</span><span class="nx">push</span><span class="p">);</span><span class="c1">// GETリクエストを想定</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>そしてお待ちかねのプッシュメイン処理をapns.jsに書いていきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">apns</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;apn&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">qs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;qs&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">// ① GETパラメータからトークンを取得</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ② プッシュ通知の設定</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;cert&quot;</span><span class="o">:</span> <span class="s2">&quot;./keys/cert.pem&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;./keys/key.pem&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;gateway&quot;</span><span class="o">:</span> <span class="s2">&quot;gateway.sandbox.push.apple.com&quot;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">myDevice</span> <span class="o">=</span> <span class="nx">apns</span><span class="p">.</span><span class="nx">Device</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">apnConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apns</span><span class="p">.</span><span class="nx">Connection</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apns</span><span class="p">.</span><span class="nx">Notification</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">note</span><span class="p">.</span><span class="nx">newsstandAvailable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">apnConnection</span><span class="p">.</span><span class="nx">pushNotification</span><span class="p">(</span><span class="nx">note</span><span class="p">,</span> <span class="nx">myDevice</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;respond with a resource&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>先ほどインストールしたqsはGETパラメータをオブジェクト化してくれる便りなモジュールです。詳しくは<a href="http://nodejs.org/api/querystring.html">Node.js Manual&amp;Documents</a>を参照してください。<br/>
まず、①のようにトークン値を取得します。<br/>
次に②のようにプッシュ通知を送るための設定を書きます。<a href="https://github.com/argon/node-apn">GitHubで公開されているReference</a>をほぼそのまま書くだけなので簡単です。<br/>
注意しておきたいのはSilent Remote Notificationの場合は<strong>note.newsstandAvailable=1</strong>を設定する必要があります。逆にbadge, alert, soundは不要です。これらを入れてもプッシュ通知ができないわけではないのですが、冒頭に述べた<strong>ユーザに気づかれずに</strong>という要件を満たせなくなります。</p>

<p>因みに, optionsで設定しているcertとkeyは証明書の保存場所です。上記ソースで設定している場所はapp.jsと同じ階層にkeyフォルダがあることを指します。また、gatewayにはsandboxをつけることを忘れずに。(商用の場合はsandboxは不要です。develop用ではsandboxを設定するんです。)<br/>
証明書(cert.pemとkey.pem)の作成は多くのサイトで説明されているのでここでは割愛します。</p>

<p>ここまで準備ができたら、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>node app.js
</span></code></pre></td></tr></table></div></figure>


<p>でWeb&amp;APサーバをローカルに起動しましょう。<br/>
そして、『localhost:3000?token=トークン値』をブラウザのアドレス部分に打って、Silent Remote Notificationを送りましょう!!<br/>
トークン値はネイティブソース内のdidRegisterForRemoteNotificationsWithDeviceToken関数でLogとして出力しているはずなので、コピーしましょう。</p>

<p>届きましたでしょうか？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MKMapViewの初期中心点をユーザの現在地に設定する方法]]></title>
    <link href="http://grandbig.github.io/blog/2014/02/16/userlocationandmap/"/>
    <updated>2014-02-16T21:16:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/02/16/userlocationandmap</id>
    <content type="html"><![CDATA[<h3>MKMapViewの中心位置について考えた</h3>

<p>本日はMKMapViewの初期表示について説明します。MKMapViewを扱うときにはユーザの位置情報を用いることが多いと思います。そのほとんどの場合、マップを初期表示したときにユーザの現在地を中心にしたいのではないかと思います。しかしながらiPhoneで位置情報を取得するとき、アプリを起動して即座に現在地を特定することはできません。では、『どうするのか？』について失敗談を交えつつ紹介させて頂きます。</p>

<!--more-->


<p>まずは失敗例から紹介します。<br/>
筆者は<strong>ユーザの現在地をマップの中心位置に設定する</strong>ということに意識が向きすぎたせいか当初は下記の手段を取っていました。</p>

<p>下記はViewController.h</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import &lt;UIKit/UIKit.h&gt;
</span><span class='line'>#import &lt;CoreLocation/CoreLocation.h&gt;
</span><span class='line'>#import &lt;MapKit/MapKit.h&gt;
</span><span class='line'>
</span><span class='line'>@interface ViewController : UIViewController &lt;MKMapViewDelegate, CLLocationManagerDelegate&gt;
</span><span class='line'>
</span><span class='line'>@property (strong, nonatomic) IBOutlet CLLocationManager *locationManager;
</span><span class='line'>@property (weak, nonatomic) IBOutlet MKMapView *map;</span></code></pre></td></tr></table></div></figure>


<p>下記はViewController.m</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// ユーザの位置を取得
</span><span class='line'>CLLocation *location = [locationManager location];
</span><span class='line'>CLLocationCoordinate2D uCoordinate = [location coordinate];
</span><span class='line'>// マップの中心位置を設定
</span><span class='line'>MKCoordinateRegion region = MKCoordinateRegionMake(uCoordinate, MKCoordinateSpanMake(0.05, 0.05));</span></code></pre></td></tr></table></div></figure>


<p>しかし、これではアプリ起動直後に真っ青な画面が表示されてしまうことでしょう。その理由はiPhone側で位置情報を取得する前にマップを表示しようとしてしまっているためです。結果、ユーザの現在地はlatitude, longitude共に0として返ってきます。<br/>
ここで筆者はマップに現在地のピンを表示することは割りと早くできていることに気づきました。であれば何かマップからユーザ情報が取得できるのではないかと。<br/>
で考えたのが下記。(ViewController.mのみ修正)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// ユーザの位置を取得
</span><span class='line'>CLLocation *userLocation = self.map.userLocation.location;
</span><span class='line'>CLLocationCoordinate2D uCoordinate = CLLocationCoordinate2DMake(userLocation.coordinate.latitude, userLocation.coordinate.longitude);
</span><span class='line'>// マップの中心位置を設定
</span><span class='line'>MKCoordinateRegion region = MKCoordinateRegionMake(uCoordinate, MKCoordinateSpanMake(0.05, 0.05));</span></code></pre></td></tr></table></div></figure>


<p>しかし、これまたアプリ起動後に真っ青な画面が表示されてしまいました&hellip;。う〜む、なかなかうまくいかない。</p>

<p>で、結局、下記で解決。(ViewController.mのみ修正)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// マップにユーザの現在地を表示
</span><span class='line'>self.map.showsUserLocation = YES;
</span><span class='line'>// マップの中心地がユーザの現在地を追従するように設定
</span><span class='line'>[self.map setUserTrackingMode:MKUserTrackingModeFollow];</span></code></pre></td></tr></table></div></figure>


<p>位置情報が取れ次第(ユーザの現在地が特定でき次第)、マップの中心地が移動するのでアプリ起動後に割りとすぐ理想の結果が得られます。(因みにマップを動かせば、追従モードはOFFとなります。)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xcode5でAuto Layoutを使おう]]></title>
    <link href="http://grandbig.github.io/blog/2014/02/09/xcode5-autolayout/"/>
    <updated>2014-02-09T17:25:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/02/09/xcode5-autolayout</id>
    <content type="html"><![CDATA[<h3>Auto Layoutで『iOS6・iOS7』と『3.5-inch・4-inch』対応</h3>

<p>さて、これまで<strong>iOS6/7 deltas</strong>を利用した方法や<strong>全てコードで書く</strong>方法について説明してきました。これとは別に本日は<strong>Auto Layout</strong>を利用した方法について説明します。<br/>
先にこれらの方法の違いについて紹介します。<br/>
・iOS6/7 deltasを利用する方法<br/>
  XIBやStoryboardを利用した上でiOS5以前から対応する場合<br/>
・全てコードで書く方法<br/>
  XIBやStoryboardなどのGUIを利用せずに、全OS・全ディスプレイに対応する場合<br/>
・Auto Layoutを利用する方法<br/>
  XIBやStoryboardを利用した上でiOS6以降から対応する場合</p>

<p>求められている仕様や開発者の技量、プロジェクトの運用から最適な方法を選択する必要があります。<br/>
とは言え、個人的には<strong>全てコードで書く</strong>方法が最も自由がきくと思っているので、これに慣れていると他の手法は案外シンドイです。</p>

<!--more-->


<h4>Auto LayoutでUINavigationBarを調整しよう</h4>

<p>以前、iOS6/7 deltasを利用する方法で説明したことをAuto Layoutで説明します。皆様、ご存知の通りiOS6以前とiOS7以降とではステータスバーの20px分をナビゲーションバーの高さを考慮しなくてはなりません。<br/>
<img src="http://grandbig.github.io/images/ios6_7_difference.png" alt="iOS6とiOS7でナビゲーションバーの高さが異なる" /></p>

<p>早速、詳しく説明していきます。<br/>
まず、プロジェクトを作成し終わったら、XIBファイルを表示してください。そしてUINavigationBarを設置します。このUINavigationBarの高さをiOSのバージョンごとに変化させたいので、下記手順でAuto LayoutのConstraintを追加します。<br/>
1: 右下のバーの左から2番目をクリックしてConstraintsのウィンドウを表示<br/>
2: 高さを変更したいのでHeightにチェックを入れる<br/>
3: Add ConstraintボタンをクリックしてConstraintを追加する<br/>
<img src="http://grandbig.github.io/images/autolayout1.png" alt="Constraintを追加する" /></p>

<p>これでConstraintsが追加されたのでViewController.hと関連づける。<br/>
1: Constraints > Heightを右クリックしてViewController.hへドラッグ&amp;ドロップ<br/>
2: ウィンドウが表示されるので、名前をつけてConnectをクリックする<br/>
<img src="http://grandbig.github.io/images/autolayout2.png" alt="ViewController.hに関連づける" /><br/>
<img src="http://grandbig.github.io/images/autolayout3.png" alt="名前をつけてConnect" /></p>

<p>次にViewController.mファイルを開きましょう。<br/>
以下のように編集してください。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidLoad
</span><span class='line'>{
</span><span class='line'>  [super viewDidLoad];
</span><span class='line'>  // iOS7の場合は64pxにする
</span><span class='line'>  if (floor(NSFoundationVersionNumber) &gt; NSFoundationVersionNumber_iOS_6_1) {
</span><span class='line'>      self.nvBarHeight.constant = 64;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>以上の手順をすることで下記のようにiOS6とiOS7でUINavigationBarを正しく表示することができます。<br/>
<img src="http://grandbig.github.io/images/autolayout4.png" alt="UINavigationBarの表示" /></p>

<h4>Auto LayoutでUIViewを中央に配置しよう</h4>

<p>次に主にディスプレイサイズで困るであろう中央配置の方法について説明します。<br/>
まずは、何も考えずに普通にUIViewを追加してみましょう。そしてViewを3.5-inch Full Screenと4-inch Full Screenとで表示を変更して見てみましょう。すると、下記のようにUIViewの高さが変わってしまうことがわかると思います。<br/>
<img src="http://grandbig.github.io/images/autolayout5.png" alt="4-inchの場合" /><br/>
<img src="http://grandbig.github.io/images/autolayout6.png" alt="3.5-inchの場合" /><br/>
こんなはずでは&hellip;なんて絶句してしまうかもしれません。が、ご安心ください。これは先ほど説明したHeightのConstraintsを追加することで対応できます。先ほどと同様に下記の手順でHeightのConstraintを追加してみてください。</p>

<p>1: 追加したUIViewを選択した状態で右下のバーの左から2番目をクリックしてConstraintのウィンドウを表示<br/>
2: 高さを保持したいのでHeightにチェックを入れます。高さが希望の値になっていることを確認してください。<br/>
3: Add ConstraintボタンをクリックしてConstraintsを追加する</p>

<p>これで先ほどと同様にViewのinchを変更させてみてください。追加したUIViewの高さが保持されていることがわかると思います。</p>

<p>はい。本題です。<br/>
UIViewをディスプレイのCenterに表示させたい場合は下記手順を実行してください。</p>

<p>1: 追加したUIViewを選択した状態で右下のバーの左から1番目をクリックしてConstraintのウィンドウを表示<br/>
2: Vertical方向に常にディスプレイの中央に表示させたいので、Vertical Center in Containerにチェックを入れます。<br/>
3: Add ConstraintボタンをクリックしてConstraintsを追加する<br/>
<img src="http://grandbig.github.io/images/autolayout7.png" alt="Vertical Center in Containerを追加" /></p>

<p>これでUIViewを高さを保持した状態で3.5-inch/4-inchでもディスプレイの中央に表示することができます。</p>

<h4>Auto Layoutでマージンを調整しよう</h4>

<p>そして、Auto Layoutを用いたマージンの調整方法についても説明しましょう。<br/>
先ほど、ディスプレイの中央に表示したい場合を説明したと思いますが、3.5-inchで見るとUINavigationBarに近すぎると感じることがあるかもしれません。<br/>
であるならば、3.5-inchでも4-inchでもUINavigationBarから一定の距離を保持した方が見栄えが良いと思うこともあると思います。<br/>
さて、その方法について説明します。</p>

<p>1: 追加したUIViewを選択した状態で右下のバーの左から2番目をクリックしてConstraintのウィンドウを表示<br/>
2: 上部との距離を変更します。(初期状態は点線表記になっていますが、赤の実線になるように値を変更してください)<br/>
3: Add ConstraintボタンをクリックしてConstraintsを追加する<br/>
<img src="http://grandbig.github.io/images/autolayout8.png" alt="上部マージンを追加" /></p>

<p>これで3.5-inch/4-inchにディスプレイが変更されたとしてもUINavigationBarとUIViewとの距離は一定に保たれます。</p>

<h4>最後に</h4>

<p>いかがだったでしょうか？<br/>
筆者的には完全に手探りな状態で始めたので、わからないことだらけだったのですが、なんとなく理解できてきました。<br/>
現在はiPhone4S以前を利用しているユーザは(日本では？)少なくなってきたと思うのですが、iPadがiPhoneの3.5-inchと同じ比率ですので、Universalアプリを開発するのであれば対応せざるを得ません。<br/>
また、iOS6ユーザはまだまだいると思いますので、仕様として要求される可能性は十分あります。細かい修正が常に要求されるとは思いますが、忍耐強くiOS8, 9, 10&hellip;とリリースされるのを待ちましょう笑<br/>
次回リリースされるiPhoneやiPadまたはリリースされるかもしれない新デバイスがどんなディスプレイの比率になるかもわからないので、今後こういった対応は常に要求されるんでしょうね(汗)</p>

<p>ということでまた次回！<br/>
筆者も継続して勉強します。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOSアプリを相対表示で作りたい！！]]></title>
    <link href="http://grandbig.github.io/blog/2014/02/04/ios-developapp-relative/"/>
    <updated>2014-02-04T22:52:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/02/04/ios-developapp-relative</id>
    <content type="html"><![CDATA[<h3>iOSアプリでpixel表示を使わない？</h3>

<p>さて、皆さんは<strong>iPhoneとiPadに対応</strong>、<strong>iOS6とiOS7に対応</strong>を仕様として求められたときにどうやって作るのが最も簡単だと思いますか？<br/>
Storyboardを使う方法, 空プロジェクトからnib/xibを使う方法, ただひたすらにコードを書く方法など人によって様々かと思います。筆者は最近、<strong>ただひたすらにコードを書く方法</strong>を取っています。理由は結局, iPhone/iPadの対応やiOS6/iOS7の対応のためにそこだけコードを書いて対応したりすることが生じるためです。それならばいっそのこと、0からコードを書いた方が勉強にもなるし、気持ちが良いのです。<br/>
しかし、周りからのは『コードで書くとデバッグしないとイメージが湧かないんだよなぁ』とか、『pixel指定で作るとか面倒くさくね〜？』なんて言われたりするんですよね(汗)<br/>
この両方に通ずることは<strong>相対表示で画面の構造が作れれば良いのに</strong>なんてことなんじゃないかと勝手に思いました。<br/>
なので、本日は開発者がpixel指定を意図せずiOSアプリの画面を作成できるような関数を定義してみたいと思います。</p>

<!--more-->


<h4>関数の定義</h4>

<p>さて、早速定義します。<br/>
横幅や縦幅を指定したパーセンテージの長さに変換したい場合は</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 横幅の相対変換
</span><span class='line'>- (float) relativeWidth:(CGRect)frame
</span><span class='line'>              percent:(int)percent
</span><span class='line'>{
</span><span class='line'>  // 引数のframeから横幅を取得
</span><span class='line'>  float parentWidth = frame.size.width;
</span><span class='line'>  float childWidth = parentWidth * percent / 100;
</span><span class='line'>
</span><span class='line'>  return childWidth;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>で良いでしょう。<br/>
横幅, 縦幅にとらわれたくなければ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (float) relativeLength:(float)length
</span><span class='line'>               percent:(int)percent
</span><span class='line'>{
</span><span class='line'>  float childLength = length * percent / 100;
</span><span class='line'>
</span><span class='line'>  return childLength;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>とすれば良いでしょう。<br/>
横幅, 縦幅を同時に変換したければ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (CGRect) relativeFrame:(CGRect)frame
</span><span class='line'>          percentWidth:(int)percentWidth
</span><span class='line'>         percentHeight:(int)percentHeight
</span><span class='line'>{
</span><span class='line'>  float parentWidth = frame.size.width;
</span><span class='line'>  float parentHeight = frame.size.height;
</span><span class='line'>
</span><span class='line'>  float childWidth = parentWidth * percentWidth / 100;
</span><span class='line'>  float childHeight = parentHeight * percentHeight / 100;
</span><span class='line'>
</span><span class='line'>  CGRect rect;
</span><span class='line'>  rect.size.width = childWidth;
</span><span class='line'>  rect.size.height = childHeight;
</span><span class='line'>
</span><span class='line'>  return rect;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>とできると思います。</p>

<p>これでHTML, CSSでいうところの<strong>position: relative</strong>で<strong>width: 30%; height: 20%;</strong>のような形を取ることができます。<br/>
動作確認してないけど、たぶん行けるでしょう&hellip;。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UIButtonのaddTargetについて]]></title>
    <link href="http://grandbig.github.io/blog/2014/02/01/uibuttonfunction/"/>
    <updated>2014-02-01T22:04:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/02/01/uibuttonfunction</id>
    <content type="html"><![CDATA[<h3>UIButtonをタップしたときの処理を書くときの注意点</h3>

<p>今日は簡単なメモを書きます。ネイティブアプリを開発するときに、レイアウトをこりたいと思うことがあります。そんなときにひっかかってしまったことを書きます。(まさか今更こんなことにひっかかるとは&hellip;と思いました笑)</p>

<p>UIButtonは下記のように作成します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UIButton *btn = [UIButton buttonWithType: UIButtonTypeRoudedRect];
</span><span class='line'>btn.frame = CGRectMake(0, 0, 100, 30);
</span><span class='line'>[btn setTitle:@"ボタン" forState:UIControlStateNormal];
</span><span class='line'>[btn addTarget:self action:@selector(test:) forControlEvents:UIControlEventTouchDown];</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>で、このボタンをUILabelに配置するために</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 300, 50)];
</span><span class='line'>[label addSubview: btn];</span></code></pre></td></tr></table></div></figure>


<p>と書いたところ、addTargetで設定したタップイベントが実行されませんでした。<br/>
これを</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> UIView *uv = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 300, 50)];
</span><span class='line'>[uv addSubview: btn];</span></code></pre></td></tr></table></div></figure>


<p>と<strong>UIView</strong>に変えたところ、うまくいきました。</p>

<p>ま、UILabelをあえて使う必要もないので、UIViewで良いでしょう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Maps SDK for iOSをiOS6対応させようとしてハマったこと]]></title>
    <link href="http://grandbig.github.io/blog/2014/01/27/googlemapssdk2/"/>
    <updated>2014-01-27T23:50:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/01/27/googlemapssdk2</id>
    <content type="html"><![CDATA[<h3>iOS6からGoogle Maps SDKが使いたい！！</h3>

<p>さて、最近取り組んでいるGoogle Maps SDKについて書きます。前回ご紹介させて頂いたときはiOS7からの対応として書かせて頂きました。<br/>
今日はiOS6から対応するアプリを開発する上でハマったことについて説明します。</p>

<p>Xcode5でiOS6から対応に変更するとき、<strong>Deployment Target</strong>を6.0に変更すると思います。そのままClearn ⇒ Buildをしてみると下図のようなおびただしい数のエラーが&hellip;<br/>
<img src="http://grandbig.github.io/images/googlemapssdk_howtouse1.png" alt="iOS6でビルドするとエラーがたくさん出る" /></p>

<!--more-->


<p>なぜ、Deployment Targetを変えただけでこんなにもエラーが？と思ったので、エラー内容を見てみると&hellip;<br/>
<strong>Undefined symbols for architecture armv7</strong>と書いてあります。<br/>
これだけで調べてもよくわかりませんでした。(原因がわかってからよくよく見てみると様々なサイトでヒントを教えてくれていたとわかるのですが&hellip;)</p>

<p>もう少し、詳しく見てみると<strong>Google Maps</strong>がひっかかっていることがわかりました。で、再度検索し続けると<br/>
<strong>ライブラリが足りない</strong><br/>
という可能性にたどり着きました。<br/>
さ、<a href="https://developers.google.com/maps/documentation/ios/start?hl=ja">Google Maps SDK 公式ページ</a>を見てみましょう。<br/>
自分で作成したXcodeプロジェクトに追加してあるライブラリと公式ページに書いてある追加すべきライブラリを比較すると下記の違いに気づきました。(作成したXcodeプロジェクトにはデフォルトで追加されているライブラリも含まれています。)<br/>
<img src="http://grandbig.github.io/images/googlemapssdk_howtouse2.png" alt="ライブラリが違う" /></p>

<p>結果、ライブラリが異なるという単純な理由だったわけですが、気づくのに時間がかかりました。<br/>
iOS7では動いてしまうという部分も混乱を招く原因だったと思います。</p>

<p>ま、英語を嫌がらずに公式ページを読んだ方が時間はかかりませんってことですね&hellip;。<br/>
今日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOSでMapにGIFアニメーションの画像を表示したい]]></title>
    <link href="http://grandbig.github.io/blog/2014/01/26/googlemapsdk/"/>
    <updated>2014-01-26T23:29:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/01/26/googlemapsdk</id>
    <content type="html"><![CDATA[<h3>MAPにGIFアニメーション画像を表示したい</h3>

<p>最近、ネイティブアプリ開発を再び始めました。そこでマップ上にアニメーションGIF画像を表示しようと思ったのですが、これがなかなかうまくいかないんですね。<br/>
そのときのことについて今日は書きます。</p>

<p>iOSのMapライブラリにはApple標準提供の<strong>MapKit</strong>とGoogleが提供する<strong>Google Maps SDK for iOS</strong>があります。<br/>
当然のことながら標準のMapKitの方が導入は簡単です。(Google Mapsの利用にはそれなりに導入手順があります。ただ、ここで挫折しなければ実はかなり使いやすいのではないかと。)</p>

<p>Google Mapsの導入手順については下記を参考にすると良いと思います。<br/>
<a href="http://qiita.com/shu223/items/bfb5ef3e45682c2bb763">Google Maps SDK for iOSの導入手順 &ndash; Qiita</a><br/>
<a href="http://dev.eyewhale.com/archives/157">Google Maps SDK for iOSの使い方 &ndash; 目くじら日記</a></p>

<!--more-->


<h4>Apple標準提供のMapKitを使ってみる</h4>

<p>さて、まずは当然のことながらMapKitで試してみることにしました。そもそもMapKitライブラリを使用すると簡単にはピンの画像を変えられません。<br/>
詳しくは<a href="http://grandbig.github.io/blog/2013/09/28/put-annotation/">Mapに好きな画像を配置しよう！</a>を見てください。</p>

<p>MapKitにGIFアニメーション画像を配置するべく、LBGIFImageを利用しました。非常に簡単に利用できるので、ぜひ<a href="https://github.com/larcus94/LBGIFImage">LBGIFImage &ndash; GitHub</a>からダウンロードしてみてください。
しかし、MapKitではGIFアニメーション画像を表示することができませんでした。アノテーション(Mapにさすピン)をGIFアニメーションで置き換えることができないのか定かではないのですが、うまくいきませんでした。</p>

<h4>Google Maps SDK for iOSを使ってみる</h4>

<p>次にもしや<strong>Google Maps SDK for iOS</strong>ならできるのでは！？と思いつき試してみました。<br/>
結果から言いますと、超簡単にできました！！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// マーカーの作成
</span><span class='line'>GMSMarker *marker = [[GMSMarker alloc] init];
</span><span class='line'>// 位置の設定
</span><span class='line'>marker.position = CLLocationCoordinate2DMake(35.659352, 139.776228);
</span><span class='line'>// マーカーを地図にプロット
</span><span class='line'>marker.map = mapView;
</span><span class='line'>// GIFアニメーションをUIImageに設定
</span><span class='line'>UIImage* image = [UIImage animatedGIFNamed:@"GIF画像名(.gifは含まない)"];
</span><span class='line'>// マーカーにその画像を設定
</span><span class='line'>marker.icon = image;</span></code></pre></td></tr></table></div></figure>


<p>これだけでできます。(もちろんLBGIFImageライブラリはインポートしてください)</p>

<p>標準提供のMapKitを利用しているアプリでGIFアニメーションをマップ上に表示しているアプリもあるので、やり方はあるのと思います。
ただ、Google Maps SDKはとても使いやすそうなので、こっち使おうかな。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nodebrewで複数のnodeをインストールしよう]]></title>
    <link href="http://grandbig.github.io/blog/2014/01/19/howtonodebrew/"/>
    <updated>2014-01-19T23:14:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/01/19/howtonodebrew</id>
    <content type="html"><![CDATA[<h3>nodebrewでnodeをインストール</h3>

<p>最近はNode.jsがかなりメジャーになってきた気がします。しかし、Node.jsは未だにバージョンが1.0に届いていないので、開発途中に最新バージョンが出てくることも十分あり得ます。そのたびにアンインストールをするわけにもいかないので複数のバージョンのNode.jsをインストールできるようにしておくと便利です。<br/>
nvmを使う方法もあるのですが、筆者は簡単に設定ができるnodebrewを活用しています。</p>

<!--more-->


<h4>設定手順</h4>

<p>早速、設定手順を説明します。<br/>
1. nodebrewをインストール</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -L git.io/nodebrew | perl - setup</span></code></pre></td></tr></table></div></figure>


<p>2. .bash_profileにパスを追加</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PATH=$HOME/.nodebrew/current/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>3. .bash_profileを再読み込み</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source ~/.bash_profile</span></code></pre></td></tr></table></div></figure>


<p>4. nodeのインストール</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodebrew install-binary v0.10.24</span></code></pre></td></tr></table></div></figure>


<p>ただし、v0.8.6以前はバイナリからインストールできないので、下記のようにインストールする必要があります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodebrew install v0.6.12</span></code></pre></td></tr></table></div></figure>


<p>5. インストールされたnodeのバージョンを確認</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodebrew ls</span></code></pre></td></tr></table></div></figure>


<p>6. 利用したいnodeを指定</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodebrew use v0.10.24</span></code></pre></td></tr></table></div></figure>


<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Passbook webServiceURLについて]]></title>
    <link href="http://grandbig.github.io/blog/2014/01/19/passbook-detail/"/>
    <updated>2014-01-19T21:30:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/01/19/passbook-detail</id>
    <content type="html"><![CDATA[<h3>Passbook webServiceURLの設定で躓いたところ</h3>

<p>さて、最近はPassbookばかり触っているので、3回連続でPassbookについてです。筆者が躓いたところをピックアップして記載していきます。<br/>
具体的には<br/>
・webServiceURLに指定するURL<br/>
・Passbookを追加/更新/削除したときに自動で投げてくるパラメータ<br/>
についてです。</p>

<!--more-->


<h4>webServiceURLについて</h4>

<p>PassbookではwebServiceURLを設定するところで躓きました。使いきり&amp;更新や削除などを感知しないパスであれば、何も気にせず適当なURLを設定して構いません。しかし、パスの追加/更新/削除を感知して、ユーザ固有のアクションを起こさせたいという狙いがある場合は、きちんと考えなくてはなりません。</p>

<p>結論から言うと、<strong>http</strong>ではなく<strong>https</strong>から始まるURLを指定しなくてはなりません。また、自己証明書で試した結果、通信ができませんでした&hellip;。これは筆者の設定が悪いのかどうか不明なところなんですが、きちんとした証明書で<strong>https</strong>通信ができるサーバで試した結果、通信できました。ここについてはネット上ではっきりと書かれているサイトがなかったため真実はわからないのですが、少なくとも筆者は自己証明書では失敗したということをお伝えします。</p>

<p>因みに筆者は今回、Windows AzureでWebサイトを作成して活用しました。Webサイトではhttpでもhttpsでもアクセスできるように設定されているとのことで非常に使い勝手が良かったです。</p>

<p>また、Apple iOS Developerであれば、開発者だけができる設定でwebServiceURLにhttpのURLを設定しても通信することができます。次の章で説明する内容を実際に見たい場合は余分なお金のかからないhttpサーバで試してみると良いでしょう。設定は下記のようにできます。<br/>
<img src="http://grandbig.github.io/images/httpAllow.png" alt="設定からhttpを許可する" /></p>

<h4>Passbookを追加/更新/削除したときに自動で投げてくるパラメータ</h4>

<p>続いて、Passbookをユーザが受け取ってからwebServiceURLに指定したサーバに投げてくるパラメータについて説明します。パラメータが送られるパターンは下記です。<br/>
・Passbookを受け取って<strong>追加</strong>ボタンを押したとき<br/>
・Passbookを手動/自動で<strong>更新</strong>したとき<br/>
・Passbookを<strong>削除</strong>したとき</p>

<p>それぞれについて具体的に説明します。</p>

<h5>Passbookを受け取って追加ボタンを押したとき</h5>

<p>追加ボタンを押した瞬間に自動的にPOSTで通信されます。<br/>
その際、投げられるURLは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/webServiceURLで指定したURL/v1/devices/デバイスライブラリID/registrations/パスタイプID/シリアルナンバー</span></code></pre></td></tr></table></div></figure>


<p>となります。
このURLもしくはreq.paramsから<strong>デバイスライブラリID</strong>, <strong>パスタイプID</strong>, <strong>シリアルナンバー</strong>を取得することができます。また、req.headersに<strong>authorization</strong>の値が入っています。</p>

<p>デバイスライブラリIDはデバイスによって異なり、さらに新規パス取得の際には毎回異なる値です。パスタイプIDは開発者が発行するPassbookの証明書の.passを外した部分のことです。シリアルナンバーはパス毎に発行すべきものです。例えば、忘年会のチケットを配布する場合、そのチケットでは同じシリアルナンバーを使います。(ユーザごとにユニークな値をふるべきではありません。)authorizationはユーザ毎にユニークな値を持たせた方が使い勝手が良いと思われます。また、MD5などで暗号化した方がセキュリティ的には良いでしょう。</p>

<h5>Passbookを手動/自動で更新したとき</h5>

<p>Passbookアプリでパスの裏面を上から下にスクロールして手動で更新したときなどではGETで通信されます。<br/>
その際に投げられるURLは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/webServiceURLで指定したURL/v1/passes/パスタイプID/シリアルナンバー</span></code></pre></td></tr></table></div></figure>


<p>となります。
更新の場合は<strong>パスタイプID</strong>, <strong>シリアルナンバー</strong>, <strong>authorization</strong>を取得することができます。<br/>
また、更新処理のときにはログ用にPOSTで</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/webServiceURL/v1/log</span></code></pre></td></tr></table></div></figure>


<p>が投げられます。<br/>
これを用いてログをDBに格納するのも良いでしょう。</p>

<h5>Passbookを削除したとき</h5>

<p>最後はパスを削除した場合です。このときはDELETEで通信されます。<br/>
その際、投げられるURLは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/webServiceURLで指定したURL/v1/devices/デバイスライブラリID/registrations/パスタイプID/シリアルナンバー</span></code></pre></td></tr></table></div></figure>


<p>となります。</p>

<p>因みに筆者の場合は、Node.jsでExpressモジュールを使用しているので、下記のように書いています。<br/>
webServiceURLで末尾に/sendParamというパスをつけた場合です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Passbookを受け取って追加ボタンを押したとき
</span><span class='line'>app.post('/sendParam/v1/devices/:deviceLibraryID/registrations/:passTypeID/:serialNumber', pass.createData);
</span><span class='line'>// Passbookを手動/自動で更新したとき
</span><span class='line'>app.get('/sendParam/v1/passes/:passTypeID/:serialNumber', pass.updateData);
</span><span class='line'>// ログ用
</span><span class='line'>app.post('/sendParam/v1/log', pass.logData);
</span><span class='line'>// Passbookを削除したとき
</span><span class='line'>app.delete('/sendParam/v1/devices/:deviceLibraryID/registrations/:passTypeID/:serialNumber', pass.deleteData);</span></code></pre></td></tr></table></div></figure>


<p>大体Passbookのことはわかってきたのですが、まだまだ躓くところも多く勉強です。本日はここまで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[node-passbookではまったこと]]></title>
    <link href="http://grandbig.github.io/blog/2014/01/06/node-passbook/"/>
    <updated>2014-01-06T22:45:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2014/01/06/node-passbook</id>
    <content type="html"><![CDATA[<h3>PassbookのPassを動的生成するためにnode-passbookを使ってみました</h3>

<p>皆様、あけましておめでとうございます。2014年1回目のブログ更新です。<br/>
今回は<strong>node-passbookではまったこと</strong>について紹介したいと思います。通常、はまらないことかもしれないのですが、筆者は2日半くらい悩みました。</p>

<p>node-passbookは<a href="https://github.com/assaf/node-passbook">Github</a>上で公開されています。</p>

<!--more-->


<h4>node-passbookの設定</h4>

<p>今回は、nodeのWebフレームワークであるExpressを使います。Expressの始め方については<a href="http://gihyo.jp/dev/serial/01/nodejs/0003">gihyo.jsさんのページ</a>を参考にしてください。Expressの準備が整っている前提で説明を始めたいと思います。</p>

<p>まずはnode-passbookモジュールをインストールしましょう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install passbook</span></code></pre></td></tr></table></div></figure>


<p>次に、app.jsを編集しましょう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var express = require('express');
</span><span class='line'>var routes = require('./routes');
</span><span class='line'>var user = require('./routes/user');
</span><span class='line'>// passbook発行処理を書いたpass.jsをrequire
</span><span class='line'>var pass = require('./routes/pass');
</span><span class='line'>
</span><span class='line'>&lt;省略&gt;
</span><span class='line'>
</span><span class='line'>app.get('/', routes.index);
</span><span class='line'>app.get('/users', user.list);
</span><span class='line'>// passbookのpassをダウンロードするときのget
</span><span class='line'>app.get('/download', pass.download);
</span><span class='line'>// passbookのpassを作成するときのget
</span><span class='line'>app.get('/create', pass.create);
</span><span class='line'>
</span><span class='line'>&lt;省略&gt;
</span></code></pre></td></tr></table></div></figure>


<p>では、passbook発行処理を書いたpass.jsをroutes配下に作成します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var fs = require('fs');
</span><span class='line'>var path = require('path');
</span><span class='line'>var createTemplate = require("passbook");
</span><span class='line'>
</span><span class='line'>exports.create = function(req, res) {
</span><span class='line'>  // Passbook作成
</span><span class='line'>  var template = createTemplate('eventTicket', {
</span><span class='line'>      'passTypeIdentifier': 'pass.****.****.****',
</span><span class='line'>      'teamIdentifier': '***********',
</span><span class='line'>      'organizationName': 'Passbookテスト'
</span><span class='line'>  });
</span><span class='line'>  template.keys('./public/keys', 'test12345');
</span><span class='line'>  var passbook = template.createPass({
</span><span class='line'>      serialNumber: 'abcdefc',
</span><span class='line'>      description: 'Passbookテスト用のチケットです。',
</span><span class='line'>      logoText: '参加チケット',
</span><span class='line'>      foregroundColor: 'rgb(255, 255, 255)',
</span><span class='line'>      backgroundColor: 'rgb(60, 65, 76)'
</span><span class='line'>  });
</span><span class='line'>  passbook.fields.webServiceURL = "https://example.com/passes";
</span><span class='line'>  passbook.fields.authenticationToken = "vxwxd7J8AlNNFPS8k0a0FfUFtq0ewzFdc";
</span><span class='line'>  passbook.fields.relevantDate = "2014-01-25T17:00+09:00";
</span><span class='line'>  passbook.fields.barcode = {
</span><span class='line'>      message: "http://google.com",
</span><span class='line'>      format: "PKBarcodeFormatQR",
</span><span class='line'>      messageEncoding: "iso-8859-1",
</span><span class='line'>      altText: "ユーザID"
</span><span class='line'>  };
</span><span class='line'>  passbook.primaryFields.add([
</span><span class='line'>      {
</span><span class='line'>          "key" : "event",
</span><span class='line'>          "label" : "イベント",
</span><span class='line'>          "value" : "Passbookテスト"
</span><span class='line'>      }
</span><span class='line'>  ]);
</span><span class='line'>  passbook.secondaryFields.add([
</span><span class='line'>      {
</span><span class='line'>          "key" : "loc",
</span><span class='line'>          "label" : "場所",
</span><span class='line'>          "value" : "東京近辺"
</span><span class='line'>      }
</span><span class='line'>  ]);
</span><span class='line'>  passbook.backFields.add([
</span><span class='line'>      {
</span><span class='line'>          "key" : "message",
</span><span class='line'>          "label" : "メッセージ",
</span><span class='line'>          "value" : "Passbook盛り上げていきましょう！"
</span><span class='line'>      }
</span><span class='line'>  ]);
</span><span class='line'>  passbook.loadImagesFrom("./public/images");
</span><span class='line'>
</span><span class='line'>  var pkpassFile = fs.createWriteStream("mypass.pkpass");
</span><span class='line'>  passbook.on("error", function(error) {
</span><span class='line'>      console.error(error);
</span><span class='line'>      process.exit(1);
</span><span class='line'>  });
</span><span class='line'>  passbook.pipe(pkpassFile);
</span><span class='line'>          
</span><span class='line'>  res.end();
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>exports.download = function(req, res){
</span><span class='line'>
</span><span class='line'>  var file = './mypass.pkpass',
</span><span class='line'>      filestream = fs.createReadStream(file),
</span><span class='line'>      filename = path.basename(file),
</span><span class='line'>      mimetype = 'application/vnd.apple.pkpass';
</span><span class='line'>  res.setHeader('Content-disposition', 'attachment; filename=' + filename);
</span><span class='line'>  res.setHeader('Content-type', mimetype); 
</span><span class='line'>  filestream.on('data', function(chunk) {
</span><span class='line'>      res.write(chunk);
</span><span class='line'>  });
</span><span class='line'>  filestream.on('end', function() {
</span><span class='line'>      res.end();
</span><span class='line'>  });
</span><span class='line'>};
</span></code></pre></td></tr></table></div></figure>


<p>さて、これでソースの準備は完了です。<br/>
次の章では、筆者がはまった点について具体的に説明します。</p>

<h4>証明書ではまりました</h4>

<p>筆者は上記のソースを書き終わった時点で完了だと思ったのですが、iPhoneから落としてもうまくいきませんでした。<br/>
うまくいかなかったときの現象は下記です。<br/>
iOS6 ⇒ Pass自体は表示されるものの、追加ボタンを押しても追加されない<br/>
iOS7 ⇒ Pass自体表示されない</p>

<p>また、XcodeのOrganizerのコンソールでログを見たところ、<strong>Signature is missing</strong>と表示されてしまいました。<br/>
悩んだ果てにnode-inspectorでデバッグして1つ1つ処理を確認したところ、<strong>node_modules/passbook/lib/pass.js</strong>の342〜350行目を見て気づきました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> function signManifest(template, manifest, callback) {
</span><span class='line'>   var identifier = template.passTypeIdentifier().replace(/^pass./, "");
</span><span class='line'>   
</span><span class='line'>   var args = [
</span><span class='line'>      "smime",
</span><span class='line'>      "-sign", "-binary",
</span><span class='line'>      "-signer",    Path.resolve(template.keysPath, identifier + ".pem"),
</span><span class='line'>      "-certfile",  Path.resolve(template.keysPath, "wwdr.pem"),
</span><span class='line'>      "-passin",    "pass:" + template.password
</span><span class='line'>  ];
</span><span class='line'>
</span><span class='line'>  &lt;省略&gt;</span></code></pre></td></tr></table></div></figure>


<p>そう、pemファイルの名前が間違っていたのです。pemファイルの名前は<strong>passTypeIdentifier</strong>に設定する文字列から<strong>pass.</strong>を削除したものにしなくてはなりませんでした。</p>

<p>やっぱりデバッグは大切ですね。</p>

<p>参考ページ:<br/>
<a href="http://blog.techfirm.co.jp/2012/10/23/node-js%E3%81%A7passbook%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92%E3%81%A4%E3%81%8F%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B1/">node.jsでPassbookサーバをつくってみる</a><br/>
<a href="http://kataok.hatenablog.com/entry/2012/10/20/102125">Node.jsでPassbookを発行してみる</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Passbookを使ってみよう！(超基礎)]]></title>
    <link href="http://grandbig.github.io/blog/2013/12/25/createpassbookbasic/"/>
    <updated>2013-12-25T23:47:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2013/12/25/createpassbookbasic</id>
    <content type="html"><![CDATA[<h3>Passbook 超入門</h3>

<p>今日はPassbookについて書いてみようと思います。この記事を書こうと思ったきっかけはネットでPassbookのPassの作成方法を探してみたところ、『いまいちわかりにくい&hellip;。画像で手順を見たい！！』という思いが生まれたからです。今後、日本でもPassbookの利用を盛り上げていきたいという意向もあります。だって触ってみると案外面白いんですから。<br/>
では、早速説明していきましょう。</p>

<!--more-->


<h4>キーチェーンアクセスに証明書を登録しよう</h4>

<p>Apple Developerプログラムに登録されている前提で説明します。<br/>
まず、<strong>iOS Pass Type IDs</strong>を新規作成します。右上の『＋』ボタンをクリックしましょう。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert1.png" alt="iOS Pass Type IDsを新規作成" /><br/>
次に、<strong>Pass Type ID Description</strong>と<strong>Identifier</strong>を入力してContinueを選択して先に進みましょう。<br/>
※ Identifierは必ず先頭に<strong>pass.</strong>がきます。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert2.png" alt="任意の文字列を入力" /><br/>
そして、Registerをクリックすれば、<strong>iOS Pass Type IDs</strong>を新たに作成されたことを確認できます。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert3.png" alt="Registerをクリック" /><br/>
<img src="http://grandbig.github.io/images/create_passbook_cert4.png" alt="iOS Pass Type IDsを新規作成できました" /><br/>
ここで終了ではありません。ここから<strong>iOS Pass Type IDs</strong>と<strong>certSigningRequestファイル</strong>をひもづける作業が必要となります。<br/>
先ほど作成した<strong>iOS Pass Type IDs</strong>を選択してEditをクリックしましょう。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert5.png" alt="iOS Pass Type IDsを編集" /><br/>
編集画面でCreate Certificate&hellip;を選択して、アップロードするファイルの説明書きを読んでContinueを選択したら、Choose File&hellip;をクリックして<strong>certSigningRequestファイル</strong>をアップロードしましょう！！<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert6.png" alt="Create Certificateを選択" /><br/>
<img src="http://grandbig.github.io/images/create_passbook_cert7.png" alt="Continueでそのまま進む" /><br/>
<img src="http://grandbig.github.io/images/create_passbook_cert8.png" alt="Choose Fileを選択" /><br/>
これで証明書が作成できました。Downloadしてキーチェーンアクセスに登録しましょう！(Chromeであればブラウザの下部にダウンロードファイルが表示されるのでダブルクリックしましょう)<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert9.png" alt="証明書をDownloadしましょう" /><br/>
<img src="http://grandbig.github.io/images/create_passbook_cert10.png" alt="キーチェーンアクセスに登録完了" /></p>

<h4>pass.jsonを編集しよう</h4>

<p>証明書の準備が整ったら実際にPassbookのPassの中身を作成していきます。0から作るのはたいへんですし、いろいろとApple側で決められている制限に従う必要があるので、<a href="https://developer.apple.com/downloads/index.action?name=Passbook">Apple公式ダウンロードページ</a>からサンプル(Passbook Materials)を落としてきましょう。<br/>
dmgファイルを解凍すると中身のファイル構成は下記のようになっています。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert11.png" alt="Passbook Materialsの中身" /></p>

<p>Passesの配下には<strong>.pkpassファイル</strong>と<strong>.rawフォルダ</strong>があります。PassbookのPassとして扱われるファイルが<strong>.pkpassファイル</strong>です。<strong>.rawフォルダ</strong>はPassを構成する素材が入っています。実は<strong>.pkpassファイル</strong>は<strong>.rawフォルダ</strong>を圧縮したものになっています。</p>

<p>また、ファイルやフォルダの種類としてBoardingPass, Coupon, Event, Generic, StoreCardの5種類がありますが、これはPassbookの種類になります。これはレイアウトが異なるので最適なものを利用するようにしましょう。</p>

<p>さて、ここからは実際にサンプルを編集することでオリジナルPassを作成してみたいと思います。<br/>
先ほど解答したフォルダからEvent.rawフォルダを任意の場所にコピーしましょう。<br/>
Event.rawフォルダ内のpass.jsonを編集します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "formatVersion" : 1,
</span><span class='line'>  "passTypeIdentifier" : "pass.com.apple.sample-event",
</span><span class='line'>  "serialNumber" : "nmyuxofgnb",
</span><span class='line'>  "teamIdentifier" : "A1B2C3D4E5",</span></code></pre></td></tr></table></div></figure>


<p>必ず編集する必要があるのは<strong>passTypeIdentifier</strong>と<strong>teamIdentifier</strong>です。<br/>
<strong>passTypeIdentifier</strong>はキーチェーンアクセスから表示されているPass Type IDを使いましょう。(Apple Developerサイトからも確認できます。) また、<strong>teamIdentifier</strong>はキーチェーンアクセスでPassbookの証明書を右クリックして『情報を見る』を選択してください。その中の組織に表示されている英数字を使います。<br/>
<img src="http://grandbig.github.io/images/create_passbook_cert12.png" alt="passTypeIdentifierの確認" /><br/>
<img src="http://grandbig.github.io/images/create_passbook_cert13.png" alt="teamIdentifierの確認" /><br/>
これを先ほどのpass.json内に記載しましょう。</p>

<h4>Passを作成しよう</h4>

<p>さて、Passを作成するための素材は揃いました。最後に<strong>.pkpassファイル</strong>を作成するためのsignpassファイルを書き出します。<br/>
手順としては先ほどダウンロードしたdmgファイル内にあったsignpassフォルダ内のsignpass.xcodeprojファイルをXcodeで起動します。これをBuildしてください。デフォルト設定のままであれば『/Users/＜ユーザー名＞/Library/Developer/Xcode/DerivedData』配下にsignpass&hellip;..(signpassの後はよくわからない文字列)が作成されています。もし、デフォルト設定を変更したせいか、見つからない場合はXcode > Preferences&hellip; > Locations > DerivedDataで設定されているパスを確認して下さい。</p>

<p>該当フォルダを見ると、Build/Products/Debug配下にsignpassファイルが見つかるはずです。
ここまで来たら後は下記コマンドをターミナルで叩くだけ！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./signpass -p ＜パッケージするパスファイルのパス＞</span></code></pre></td></tr></table></div></figure>


<p>パッケージするパスファイルのパスとは例えば、signpassファイルとEvent.rawフォルダが同じ階層にある場合は</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./signpass -p ./Event.raw</span></code></pre></td></tr></table></div></figure>


<p>となります。
これで<strong>Event.pkpassファイル</strong>が作成されているはずです。これにてPass作成完了です。</p>

<h4>PassをWeb配布しよう</h4>

<p>最後にWebでPassを配布する方法について解説します。<br/>
とりあえず、ローカルPCからPassを取得してみたいと思います。これを実現するにあたって、『システム環境設定の共有にWeb共有がない』なんて方がいるかもしれないので、それは<a href="http://d.hatena.ne.jp/sakura_bird1/20120804/1344055999">こちら</a>を参考に設定してください。<br/>
pkpassファイルを取得するためにはhttpd.confにpkpassファイルの行を書き足す必要があります。<br/>
※Apacheを使っている場合の説明です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AddType application/vnd.apple.pkpass    pkpass</span></code></pre></td></tr></table></div></figure>


<p>AddTypeが書かれている<IfModule>タグ内に記載してください。<br/>
apacheを再起動することをお忘れなく。<br/>
これで晴れてPassをWebから取ってくることができます！</p>

<p><img src="http://grandbig.github.io/images/create_passbook_sample.png" alt="Passのサンプル" /></p>

<p>細かいPassの編集については割愛しましたが、試してみていろいろとわかってきたらブログにも載せていきます。</p>

<p>では本日はこの辺で！</p>
]]></content>
  </entry>
  
</feed>
