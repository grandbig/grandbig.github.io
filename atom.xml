<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Takahiro Octopress Blog]]></title>
  <link href="http://grandbig.github.io/atom.xml" rel="self"/>
  <link href="http://grandbig.github.io/"/>
  <updated>2015-10-05T23:15:52+09:00</updated>
  <id>http://grandbig.github.io/</id>
  <author>
    <name><![CDATA[Takahiro]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Android5.0から5.1にアップデートして文鎮化した事件簿]]></title>
    <link href="http://grandbig.github.io/blog/2015/10/05/android-update-crash/"/>
    <updated>2015-10-05T22:38:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/10/05/android-update-crash</id>
    <content type="html"><![CDATA[<h4>Android OSのアップデートは恐ろしい</h4>

<p>さて、本日はAndroid OSのアップデートに関するお話です。<br/>
筆者は最近、Nexus6をAndroid5.0から5.1にアップデートしようとしたのですが、途中で失敗して端末が文鎮化するという悲劇が発生してしまったので、備忘録です。</p>

<h5>文鎮化までの軌跡</h5>

<p>まずは、如何にしてNexus6が文鎮化したかまで説明します。</p>

<ol>
<li>端末の通知センターからバージョンアップのためのデータをダウンロード</li>
<li>端末を再起動して、インストールしますか？と聞かれるのでYESを選択</li>
<li>アップデートに失敗しました。という文言と共に下図が&hellip;</li>
</ol>


<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p><img src="http://grandbig.github.io/images/android-update.png" alt="エラー発生" /></p>

<ol>
<li>嘘だろ&hellip;と思って端末の電源長押しで再起動
永久、再起動ループに&hellip;</li>
<li>電源 + 音量Downボタンを長押しでReboot起動
すると下図のような感じで起動します。<br/>
START, Recovery, Factory&hellip;などのメニューから仕掛けたい動作を選択できます。<br/>
<img src="http://grandbig.github.io/images/android-update2.png" alt="Reboot起動" /></li>
<li>順番に全部やっているけど、どれも無限ループに&hellip;</li>
</ol>


<p>はい！文鎮化しましたね。</p>

<h4>文鎮化Nexus6を復旧するまでの軌跡</h4>

<p>まさか文鎮化したNexus6を放っておくわけにはいきません。<br/>
復旧させましょう！</p>

<ol>
<li>LOCKを外す
<code>fastboot oem unlock</code>を実行して、端末のLOCKを解除しましょう。</li>
<li><a href="https://developers.google.com/android/nexus/images?hl=ja">Google Developerサイト</a>からFactory Imageをダウンロード
筆者は5.0.1 (LRX22C)を落としました。</li>
<li>ダウンロードしたフォルダ内にzipファイルがあるので、解凍する</li>
<li>下記のコマンドを実行</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fastboot flash bootloader bootloader-shamu-moto-apq8084-71.05.img
</span><span class='line'>fastboot reboot-bootloader
</span><span class='line'>sleep 5
</span><span class='line'>fastboot flash radio radio-shamu-d4.0-9625-02.55.04.img
</span><span class='line'>fastboot reboot-bootloader
</span><span class='line'>sleep 5
</span><span class='line'>cd "zipを解凍したフォルダ"
</span><span class='line'>fastboot flash boot boot.img
</span><span class='line'>fastboot flash cache cache.img
</span><span class='line'>fastboot flash recovery recovery.img
</span><span class='line'>fastboot flash system system.img
</span><span class='line'>fastboot flash userdata userdata.img
</span><span class='line'>flashboot reboot</span></code></pre></td></tr></table></div></figure>


<ol>
<li>再起動したAndroidで初期設定</li>
</ol>


<p>これで復旧させることができました。やったね!!</p>

<p>と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AFNetworking 2.6.0でやってみよう自己証明書でのSSL通信]]></title>
    <link href="http://grandbig.github.io/blog/2015/10/02/afnetworking2-dot-6-0/"/>
    <updated>2015-10-02T22:21:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/10/02/afnetworking2-dot-6-0</id>
    <content type="html"><![CDATA[<h4>AFNetworking2.5.xまでの自己証明書でのSSL通信</h4>

<p>これまで<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>2.5.xを使ってきた筆者ですが、開発中は当然のことながら自己証明書を利用することがあります。<br/>
まずはこれまでの書き方を<code>AFHTTPSessionManager</code>を例に確認してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// AFHTTPSessionManagerをインスタンス化</span>
</span><span class='line'><span class="n">AFHTTPSessionManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="n">manager</span><span class="p">];</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">securityPolicy</span><span class="p">.</span><span class="n">allowInvalidCertificates</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">responseSerializer</span><span class="p">.</span><span class="n">acceptableContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithObjects:</span><span class="s">@&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">@&quot;application/json&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>




<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>そうです。<br/>
自己証明書を許可するのに、<code>manager.securityPolicy.allowInvalidCertificates = YES;</code>と書いていました。</p>

<p>しかし、2015/08/18に <strong>2.6.0</strong> が登場した途端、ネット上で大騒ぎに&hellip;笑。<br/>
<a href="https://github.com/AFNetworking/AFNetworking/releases">2.6.0のRelease Note</a>を見てみると、 <strong>Full Certificate Chain Validation has been removed from AFSecurityPolicy.</strong> なんて一言が&hellip;。</p>

<p>いろいろと困ったのですが、筆者の場合は次のやり方でうまくいきました。</p>

<h4>AFNetworking2.6.0での自己証明書 SSL通信</h4>

<p>はい。2.6.0では下記のように書きました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// AFHTTPSessionManagerをインスタンス化</span>
</span><span class='line'><span class="n">AFHTTPSessionManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="n">manager</span><span class="p">];</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">securityPolicy</span><span class="p">.</span><span class="n">allowInvalidCertificates</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">securityPolicy</span><span class="p">.</span><span class="n">validatesDomainName</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">responseSerializer</span><span class="p">.</span><span class="n">acceptableContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithObjects:</span><span class="s">@&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">@&quot;application/json&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>何が変わったかお気づきでしょうか？<br/>
そうです。<br/>
<code>manager.securityPolicy.validatesDomainName = NO;</code>を追加したのです。</p>

<h4>まとめ</h4>

<p>iOS9からATS設定が追加されたこともあり、HTTPSが推奨されています。<br/>
しかも、正式な証明書が開発・商用関係なく使われていくことでしょう。<br/>
なので、こういった更新は納得感ありますが、なかなか開発者には辛いところもありますよね。<br/>
とは言え、AppleやGoogleが決めていくことにはついていった方が良いよな〜といったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xcodeが正常かチェックしましょう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/09/23/check-xcode/"/>
    <updated>2015-09-23T13:35:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/09/23/check-xcode</id>
    <content type="html"><![CDATA[<h4>今、話題のXcodeGhostってなに！？</h4>

<p>中国で出回っている改ざんされたXcodeのことだそうです。<br/>
App Storeから一般公開向けのXcodeをダウンロードしたり、Apple DeveloperサイトからDeveloper向けの最新版をダウンロードするのであれば、特に何の問題もないでしょう。<br/>
『いや、実はどこどこから&hellip;』なんて方がいたら、早速チェックしてみましょう。</p>

<p>ユーザとして気をつけるのは、怪しいアプリはもちろんのこと、話題として上っているアプリはきちんと対応が完了しているのか確認してみるくらいでしょうか。<br/>
Appleも感染アプリの削除に全力で取り組んでいるでしょうし、様子を見るしかなさそうですね。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h4>Xcodeの正常チェックの方法</h4>

<p>さて、本日、Appleから以下の内容のメールが飛んできました。</p>

<p>We recently removed apps from the App Store that were built with a counterfeit version of Xcode which had the potential to cause harm to customers. You should always download Xcode directly from the Mac App Store, or from the Apple Developer website, and leave Gatekeeper enabled on all your systems to protect against tampered software.</p>

<p>When you download Xcode from the Mac App Store, OS X automatically checks the code signature for Xcode and validates that it is code signed by Apple. When you download Xcode from the Apple Developer website, the code signature is also automatically checked and validated by default as long as you have not disabled Gatekeeper.</p>

<p>Whether you downloaded Xcode from Apple or received Xcode from another source, such as a USB or Thunderbolt disk, or over a local network, you can easily verify the integrity of your copy of Xcode. Learn more.</p>

<p>で、最後の <strong>Learn more</strong> をクリックすることで専用サイトで方法を教えてくれます。</p>

<p>コマンドは下記です。<br/>
<code>spctl --assess --verbose /Applications/Xcode.app</code></p>

<p>実行してから完了までに数分かかりますが、問題なければ、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Applications/Xcode.app: accepted
</span><span class='line'>source=Mac App Store</span></code></pre></td></tr></table></div></figure>


<p>もしくは、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Applications/Xcode.app: accepted
</span><span class='line'>source=Apple</span></code></pre></td></tr></table></div></figure>


<p>あるいは、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Applications/Xcode.app: accepted
</span><span class='line'>source=Apple System</span></code></pre></td></tr></table></div></figure>


<p>といった結果が得られるはずです。<br/>
App Storeからダウンロードしたか、AppleのDeveloperサイトからダウンロードしたかで異なります。</p>

<p>因みに、通常、正規のルートでダウンロードしてきた場合は、自動的にGatekeeperがチェックしているそうです。<br/>
意図的にGatekeeperをdisableにしていない限り。</p>

<p>Gatekeeperは『システム環境設定 > セキュリティとプライバシー > 一般 > ダウンロードしたアプリケーションの実行許可』から変更できるそうです。<br/>
それがGatekeeperとか意識したことなかったですけど&hellip;。<br/>
(ここで、すべてのアプリケーションを許可しているとGatekeeperがOFFだとか&hellip;。)</p>

<p>筆者は念のため、調べて問題ないことを確認しましたが、気になる方は試してみてはいかがでしょうか。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SFSafariViewControllerを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/09/22/sfsafariviewcontroller/"/>
    <updated>2015-09-22T22:13:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/09/22/sfsafariviewcontroller</id>
    <content type="html"><![CDATA[<h4>iOS9から導入されたSFSafariViewControllerを使ってみよう！</h4>

<p>さて、iPhone6s, iPhone6s Plusの発売を心待ちにされている開発者の皆さんを横目にブログを更新したいと思います。<br/>
と言っても、筆者は土曜日にはiPhone6sをGETできるはず&hellip;。</p>

<p>本日はSFSafariViewControllerを触ってみたいと思います。<br/>
SFSafariViewControllerはアプリ内でWeb画面を表示したいときに使うことをAppleが奨励しています。これにより、今まで自作アプリからSafariを起動させていたのに対して、アプリ内でSafariを呼び出すことが可能となりました。<br/>
気をつけて欲しいのは、 <strong>カスタマイズはできない</strong> ということです。<br/>
例えば、UIWebViewやWKWebViewでやっていたような『Web側から <strong>document.location = &hellip;.</strong> を実行することでネイティブ側で何か処理をさせる』といったことはできません。<br/>
あくまでも <strong>単なるWebサイトの表示</strong> に利用します。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h5>SFSafariViewControllerの使い方</h5>

<p>まずは、使い方を説明しましょう。<br/>
SFSafariViewControllerを使うためには、 <strong>SafariServices.framework</strong> を追加する必要があります。</p>

<p><img src="http://grandbig.github.io/images/sfsafariviewcontroller_1.png" alt="SafariServices.frameworkを追加" /></p>

<p>後は、ソースコードを書くだけです。<br/>
今回は画面上に置かれた『WEB』ボタンをクリックしたときにSFSafariViewControllerを呼び出すようにしてみます。</p>

<p><img src="http://grandbig.github.io/images/sfsafariviewcontroller_2.png" alt="画面キャプチャ" /></p>

<p>実際のソースコードは下記です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &lt;SafariServices/SafariServices.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span> <span class="o">&lt;</span><span class="n">SFSafariViewControllerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">SFSafariViewController</span> <span class="o">*</span><span class="n">sfv</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// WEBボタンをタップした際に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">goToWebPage:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">sfv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">SFSafariViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://www.yahoo.co.jp/&quot;</span><span class="p">]];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">sfv</span><span class="p">.</span><span class="n">modalTransitionStyle</span> <span class="o">=</span> <span class="n">UIModalTransitionStyleCrossDissolve</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">presentViewController:</span><span class="n">self</span><span class="p">.</span><span class="n">sfv</span> <span class="nl">animated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">sfv</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - SFSafariViewControllerDelegate</span>
</span><span class='line'><span class="c1">// アクションボタンをタップされた際に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span><span class="o">&lt;</span><span class="n">UIActivity</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nf">safariViewController:</span><span class="p">(</span><span class="n">SFSafariViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">controller</span> <span class="nf">activityItemsForURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">URL</span> <span class="nf">title:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">title</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;activityItemdForURL&quot;</span><span class="p">);</span>        
</span><span class='line'>  <span class="k">return</span> <span class="err">@</span><span class="p">[];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// SFSafariViewControllerに表示する最初の画面の読込みが完了した際に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">safariViewController:</span><span class="p">(</span><span class="n">SFSafariViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">controller</span> <span class="nf">didCompleteInitialLoad:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">didLoadSuccessfully</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;didCompleteInitialLoad&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// SFSafariViewControllerのDone(完了)ボタンをタップした際に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">safariViewControllerDidFinish:</span><span class="p">(</span><span class="n">SFSafariViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">controller</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;safariViewControllerDidFinish&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでSFsafariViewControllerが実装されたことがわかると思います。</p>

<p>因みに、SFSafariViewControllerを使う上で気をつけたいのが、如何にユーザにあくまでもアプリ内の遷移であると理解させることかと思います。<br/>
例えば、デフォルトではSFSafariViewControllerは下から上に上がってくる形で表示がされます。<br/>
もし、WebView内でふわっと浮かび上がってくるような画面遷移のアニメーションをしているのだとしたら、これはかなりの違和感になりますよね？<br/>
なので、<code>self.sfv.modalTransitionStyle = UIModalTransitionStyleCrossDissolve;</code>のようにアニメーションを工夫することも重要になってきます。</p>

<p>また、<code>SFSafariViewControllerDelegate</code>のメソッドを3つ書いてみましたが、あまり使いどころが思い浮かばないというのが正直なところです。<br/>
Done(完了)ボタンを押したときに<code>dismissViewController</code>が必要かとも思ったのですが、自動的に閉じますし&hellip;。</p>

<p><code>SFSafariViewController</code>をユーザに見せている間に何らかの処理を裏でしておくといったことは考えられるかもしれませんね。</p>

<h5>Safariを起動する</h5>

<p>SFSafariViewControllerが登場したからといって、Safari起動ができなくなったわけではもちろんありません。<br/>
Safariを起動したって良いんです。<br/>
というのもiOS9からはアプリ間遷移がスムーズになったからです。<br/>
ただし、 <strong>1つ前のアプリに戻る</strong> ときのみの話ですが、頻繁に多種多様なアプリ間を移動するアプリでなければ十分でしょう。</p>

<p>試しに、先ほどの『WEB』ボタンをタップしたときの処理をSafariの起動に変更してみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViwController.mから一部抜粋</span>
</span><span class='line'><span class="c1">// WEBボタンをタップした際に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">goToWebPage:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Safariを起動</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">openURL:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://www.yahoo.co.jp/&quot;</span><span class="p">]];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Safariアプリを起動した後、下記のように、左上に戻るボタンが表示されます。</p>

<p><img src="http://grandbig.github.io/images/sfsafariviewcontroller_3.png" alt="1つ前のアプリに戻る" /></p>

<p>さて、いかがだったでしょうか。<br/>
今後は、iOS9以降対応のアプリを開発すると、すぐには完全に割り切ることはできないと思いますので、iOS8までのことも踏まえつつ、最適な方法を取るのが良いでしょう。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS9でWebViewの性能を測ろう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/09/21/ios9-webview/"/>
    <updated>2015-09-21T23:56:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/09/21/ios9-webview</id>
    <content type="html"><![CDATA[<h4>iOS9で使えるWebViewで各種テスト</h4>

<p>さて、iOS8が出た時にも結果を載せましたが、iOS9でもやってみようと思います。<br/>
iOS9では <strong>SFSafariViewController</strong> というものが増えましたし、UIWebViewおよびWKWebViewがSafariに対して、どの程度の性能を示すのか改めて調べておくことも重要だと思います。</p>

<p>早速結果を記載していきます。</p>

<h5>HTML5の結果</h5>

<p><a href="https://html5test.com/">HTML5test</a>の結果を記載します。<br/>
テストは全てiOS9, iPhone6端末で実施しています。</p>

<ul>
<li>UIWebView: 391</li>
<li>WKWebView: 407</li>
<li>SFSafariViewController: 407</li>
<li>Safari: 409</li>
</ul>


<p>上記のような結果が得られました。<br/>
各種WebView間での差異は全て <strong>Storage</strong> の差です。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h5>CSS3の結果</h5>

<p><a href="http://css3test.com/">CSS3test</a>の結果を記載します。<br/>
テストは全てiOS9, iPhone6端末で実施しています。</p>

<ul>
<li>UIWebView: 55%</li>
<li>WKWebView: 55%</li>
<li>SFSafariViewController: 55%</li>
<li>Safari: 55%</li>
</ul>


<p>上記のようにCSS3においては差異はありませんでした。</p>

<h5>SunSpiderの結果</h5>

<p><a href="https://www.webkit.org/perf/sunspider/sunspider.html">SunSpider</a>の結果を記載します。<br/>
これはJavaScriptを利用したテストです。<br/>
テストは全てiOS9, iPhone6端末で実施しています。</p>

<ul>
<li>UIWebView: 1481.2 ms</li>
<li>WKWebView: 351.7 ms</li>
<li>SFSafariViewController: 364.5 ms</li>
<li>Safari: 343.1 ms</li>
</ul>


<p>上記のような結果が得られました。<br/>
UIWebViewは以前もお伝えしたようにWKWebViewの約4倍程度の処理時間がかかっています。<br/>
他は誤差の範囲で全く同じと見てよいでしょう。</p>

<h5>Octane2.0の結果</h5>

<p><a href="https://developers.google.com/octane/">Octane2.0</a>の結果を記載します。<br/>
これもJavaScriptを利用したテストです。<br/>
テストは全てiOS9, iPhone6端末で実施しています。</p>

<ul>
<li>UIWebView: 987</li>
<li>WKWebView: 8541</li>
<li>SFSafariViewController: 8112</li>
<li>Safari: 8627</li>
</ul>


<p>Octaneは点数制なので、スコアが高いほど優秀と言えます。<br/>
UIWebViewは他と比べて、低い点数となっています。<br/>
一方で、他の3つはほぼ誤差の範囲と見て良いでしょう。(SFSafariViewControllerが多少差がついているものの&hellip;)</p>

<p>以上の結果から用途を守って正しくWebViewを使うと良いでしょう。</p>

<ul>
<li>UIWebView

<ul>
<li>Storyboard上で配置できるので、使い方が簡単。</li>
<li>重い処理をさせることがない(高速処理を求めない)</li>
</ul>
</li>
<li>WKWebView

<ul>
<li>ソースコードベースで書くため、少し手間がかかる。</li>
<li>カスタマイズ性が高い＆高速処理が可能</li>
</ul>
</li>
<li>SFSafariViewController

<ul>
<li>単なるWebサイトを表示するためだけに利用。</li>
<li>カスタマイズ性が全く不要な場合に適切</li>
</ul>
</li>
<li>Safari

<ul>
<li>アプリ外の遷移でも問題なければ、アプリからSafariを起動するのも良いでしょう。iOS9からアプリ間の遷移がスムーズになったわけですし。</li>
</ul>
</li>
</ul>


<p>と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS8でrequestLocationが使える！？]]></title>
    <link href="http://grandbig.github.io/blog/2015/09/20/requestlocation/"/>
    <updated>2015-09-20T01:21:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/09/20/requestlocation</id>
    <content type="html"><![CDATA[<h4>実はiOS8.4.1でrequestLocationが使える</h4>

<p>さて、今回はたまたま気づいたバグ？の紹介です。<br/>
皆様、ご存知の通り, iOS9から <strong>requestLocation</strong> なるものがCoreLocation.frameworkに追加されました。<br/>
これにより、1回だけ現在地を取得する処理を自作せずにframeworkに任せることができるようになりました。</p>

<p>しかし、iOS9からとアナウンスされているものの、実は <strong>iOS8.4.1</strong> でも利用できました。<br/>
コードは下記になります。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &lt;CoreLocation/CoreLocation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span> <span class="o">&lt;</span><span class="n">CLLocationManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">CLLocationManager</span> <span class="o">*</span><span class="n">lm</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">lm</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLLocationManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">lm</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">lm</span> <span class="n">requestWhenInUseAuthorization</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didChangeAuthorizationStatus:</span><span class="p">(</span><span class="n">CLAuthorizationStatus</span><span class="p">)</span><span class="nv">status</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">kCLAuthorizationStatusNotDetermined</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ユーザが位置情報の使用を許可していない</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;kCLAuthorizationStatusNotDetermined&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">kCLAuthorizationStatusAuthorizedAlways</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ユーザが位置情報の使用を常に許可している場合</span>
</span><span class='line'>   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;kCLAuthorizationStatusAuthorizedAlways&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">kCLAuthorizationStatusAuthorizedWhenInUse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// ユーザが位置情報の使用を使用中のみ許可している場合</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;kCLAuthorizationStatusAuthorizedWhenInUse&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didUpdateLocations:</span><span class="p">(</span><span class="n">NSArray</span><span class="o">&lt;</span><span class="n">CLLocation</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 位置情報の取得に成功した場合</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">locations</span><span class="p">.</span><span class="n">firstObject</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didFailWithError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 位置情報の取得に失敗した場合</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">getLocation:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">lm</span> <span class="nl">respondsToSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">requestLocation</span><span class="p">)])</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// iOS9.x以上の場合</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">lm</span> <span class="n">requestLocation</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// iOS8.x以下の場合</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;iOS8.xです&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>騙されたと思って試してみてください。<br/>
なぜかiOS8.4.1でも<code>requestLocation</code>が実行されますので。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Google Sign-In SDK for iOSを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/09/13/google-sign-in/"/>
    <updated>2015-09-13T02:34:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/09/13/google-sign-in</id>
    <content type="html"><![CDATA[<h4>Google Sign-in SDKを使ったOAuth認証をやってみよう！</h4>

<p>さて、本日はGoogle Sign-Inを利用したOAuth認証をやってみようと思います。<br/>
最近、<a href="https://console.developers.google.com">Google Developer Console</a>の画面が完全に一新されていました。<br/>
以前であれば、Google Developer ConsoleにOAuth2.0のiOSのクライアントIDを設定したときに、クライアントIDだけでなく、クライアントシークレットなども表示されていました。<br/>
それが、 <strong>クライアントID</strong> と <strong>iOSのURLスキーム</strong> のみになっていました。<br/>
これは完全にGoogleがGoogle Sign-Inを推奨している証であろうということで、早速使い方を見ていきたいと思います。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h4>Google Developer CosoleでOAuth認証に必要な項目を登録しよう！</h4>

<p>さて、実際にGoogle Sign-Inを始める前に、やらなければならないことがあります。<br/>
それは<a href="https://console.developers.google.com">Google Developer Console</a>での登録作業です。<br/>
冒頭に述べたようにサイトのデザインや表示項目なども変わっているので、1つ1つ見ていきましょう。</p>

<p>まず、OAuth2.0の同意画面を作成しましょう。<br/>
因みに、筆者は既に登録済みのOAuth2.0クライアントIDがあったため、下図のように表示されます。<br/>
<strong>OAuth同意画面</strong> というボタンをクリックして、OAuth同意画面の作成ページに移りましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-5.png" alt="認証情報の確認ページ" /></p>

<p>OAuth同意画面では <strong>メールアドレス</strong> と <strong>サービス名</strong> を入力しましょう。(他は必要に応じて入力してください。)<br/>
<img src="http://grandbig.github.io/images/google-sign-in-6.png" alt="OAuth2.0の同意画面を作成" /></p>

<p>OAuth同意画面が作成できたら、認証情報を追加しましょう。<br/>
下図のように <strong>OAuth2.0クライアントID</strong> を選択してください。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-7.png" alt="OAuth2.0クライアントIDを作成" /></p>

<p>今回はiOS用なので、下図の手順でクライアントIDを作成しましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-8.png" alt="OAuth2.0クライアントIDを作成②" /></p>

<p>これでクライアントIDが作成されたと思います。<br/>
作成したクライアントIDを選択すれば、下図のような情報が得られるはずです。<br/>
 <img src="http://grandbig.github.io/images/google-sign-in-1.png" alt="Google Developer ConsoleのOAuth2.0 for iOS" /></p>

<h5>Google Sign-in SDK for iOSを実装しよう</h5>

<p>当然のことながら、基本的なことは<a href="https://developers.google.com/identity/sign-in/ios/start-integrating">Googleの公式サイト</a>に書かれています。<br/>
とは言え、英語ですし、案外躓くところもあったりするので、順を追って説明していきます。</p>

<p>まずは、<a href="https://developers.google.com/identity/sign-in/ios/start">Google Sign-In for iOSのガイドページ</a>にアクセスしましょう。<br/>
そうすると、順番に説明されていることがわかります。<br/>
①はテストコードを手に入れるだけなので、自分のプロジェクトに組み込むなら②からはじめましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-9.png" alt="GET A CONFIGURATION FILE" /></p>

<p>そうすると、下図のようなページに遷移します。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-10.png" alt="Enable Google services for your app" /></p>

<p>ここで <strong>App name</strong> にGoogle Developer Consoleのプロジェクト名を <strong>『選択』</strong> します。<br/>
注意点として、App nameに記載されているデフォルト名を削除すると、選択可能なプロジェクト名が表示されます。<br/>
App nameが入力されれば、 <strong>iOS Bundle ID</strong> も選択可能になります。</p>

<p>必要事項を入力した後はChoose and configure servicesボタンを選択しましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-11.png" alt="Choose and configure services" /></p>

<p>結果、画面が遷移します。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-12.png" alt="Configuration Fileを作成しよう" /></p>

<p>画面下の方のGenerate configuration filesボタンをクリックしましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-13.png" alt="Configuration Fileを作成しよう" /></p>

<p>plistファイルのダウンロード画面が表示されるので、ダウンロードしましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-14.png" alt="plistファイルをダウンロード" /></p>

<p>必要なファイルが揃ったので、 <strong>Google Sign-In for iOS ライブラリ</strong> を自分のプロジェクトに導入しましょう。<br/>
Podfileを作成して、<code>pod 'Google/SignIn</code>と記載します。あとは<code>pod install</code>でOK</p>

<p>さて<code>xcworkspace</code>ファイルが作成されているはずなので、Xcodeで開きましょう。<br/>
先ほどダウンロードした<code>GoogleService-Info.plist</code>ファイルをプロジェクトに組み込みましょう。<br/>
ファイルを選択して、Xcodeプロジェクトにドラッグ＆ドロップでOKです。</p>

<p>続いて、<code>GoogleService-Info.plist</code>ファイルに記載された <strong>REVERSED_CLIENT_ID</strong> と <strong>BUNDLE_ID</strong> をURL schemesとして設定する必要があります。<br/>
TARGETS > info > URL TypesでURL Typeを2つ追加しましょう。<br/>
<img src="http://grandbig.github.io/images/google-sign-in-15.png" alt="URL Typesを追加" /></p>

<p>これでソースコードを書くまでの準備が整いました。<br/>
次にソースコードを書いていきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// AppDelegate.h</span>
</span><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;Google/SignIn.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">AppDelegate</span> : <span class="nc">UIResponder</span> <span class="o">&lt;</span><span class="n">UIApplicationDelegate</span><span class="p">,</span> <span class="n">GIDSignInDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIWindow</span> <span class="o">*</span><span class="n">window</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// AppDelegate.m</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Override point for customization after application launch.</span>
</span><span class='line'>          
</span><span class='line'>  <span class="n">NSError</span><span class="o">*</span> <span class="n">configureError</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">GGLContext</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">configureWithError:</span> <span class="o">&amp;</span><span class="n">configureError</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSAssert</span><span class="p">(</span><span class="o">!</span><span class="n">configureError</span><span class="p">,</span> <span class="s">@&quot;Error configuring Google services: %@&quot;</span><span class="p">,</span> <span class="n">configureError</span><span class="p">);</span>
</span><span class='line'>                      
</span><span class='line'>  <span class="p">[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>                              
</span><span class='line'>  <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">省略</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="nl">openURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="n">url</span> <span class="nl">sourceApplication:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">sourceApplication</span> <span class="nl">annotation:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">annotation</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">return</span> <span class="p">[[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">handleURL:</span><span class="n">url</span> <span class="nl">sourceApplication:</span><span class="n">sourceApplication</span> <span class="nl">annotation:</span><span class="n">annotation</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Google Sign-inに成功した場合に呼び出される処理</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">signIn:</span><span class="p">(</span><span class="n">GIDSignIn</span> <span class="o">*</span><span class="p">)</span><span class="n">signIn</span> <span class="nl">didSignInForUser:</span><span class="p">(</span><span class="n">GIDGoogleUser</span> <span class="o">*</span><span class="p">)</span><span class="n">user</span> <span class="nl">withError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Perform any operations on signed in user here.</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">userId</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">userID</span><span class="p">;</span>                  <span class="c1">// For client-side use only!</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">idToken</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">authentication</span><span class="p">.</span><span class="n">idToken</span><span class="p">;</span> <span class="c1">// Safe to send to the server</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">email</span><span class="p">;</span>
</span><span class='line'>                      
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;userId: %@, idToken: %@, name: %@, email: %@&quot;</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="n">idToken</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Google Sign-inに失敗した場合に呼び出される処理</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">signIn:</span><span class="p">(</span><span class="n">GIDSignIn</span> <span class="o">*</span><span class="p">)</span><span class="n">signIn</span> <span class="nl">didDisconnectWithUser:</span><span class="p">(</span><span class="n">GIDGoogleUser</span> <span class="o">*</span><span class="p">)</span><span class="n">user</span> <span class="nl">withError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Perform any operations when the user disconnects from app here.</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.h</span>
</span><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;Google/SignIn.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span> <span class="o">&lt;</span><span class="n">GIDSignInUIDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">GIDSignInButton</span> <span class="o">*</span><span class="n">signInButton</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">// Do any additional setup after loading the view, typically from a nib.</span>
</span><span class='line'>          
</span><span class='line'>  <span class="p">[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">uiDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// 任意のスコープを設定</span>
</span><span class='line'>  <span class="p">[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">scopes</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="s">@&quot;https://www.googleapis.com/auth/calendar&quot;</span><span class="p">,</span> <span class="s">@&quot;https://www.googleapis.com/auth/drive&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;scope: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">scopes</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// エラーが発生した場合に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">signInWillDispatch:</span><span class="p">(</span><span class="n">GIDSignIn</span> <span class="o">*</span><span class="p">)</span><span class="nv">signIn</span> <span class="nf">error:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Google OAuth2認証画面を開始するときに実行される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">signIn:</span><span class="p">(</span><span class="n">GIDSignIn</span> <span class="o">*</span><span class="p">)</span><span class="nv">signIn</span> <span class="nf">presentViewController:</span><span class="p">(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">viewController</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// OAuth2認証画面を表示する処理</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">presentViewController:</span><span class="n">viewController</span> <span class="nl">animated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Google OAuth2認証が完了したら実行される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">signIn:</span><span class="p">(</span><span class="n">GIDSignIn</span> <span class="o">*</span><span class="p">)</span><span class="nv">signIn</span> <span class="nf">dismissViewController:</span><span class="p">(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">viewController</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// OAuth2認証の画面を閉じる処理</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">dismissViewControllerAnimated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Google Sign-inボタンをクリックした場合の処理(Storyboardで設定すること)</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">didTapSignIn:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Google Sign-inを実行する処理</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">GIDSignIn</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">signIn</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記を実行することで下記のようにOAuth2認証ができました。</p>

<p><img src="http://grandbig.github.io/images/google-sign-in-2.png" alt="Google OAuth2認証開始画面" /><br/>
<img src="http://grandbig.github.io/images/google-sign-in-3.png" alt="Google OAuth2認証の認証許可確認画面" /></p>

<p><strong>Google+アプリ</strong> がインストールされている場合はSafariではなく <strong>Google+アプリ</strong> が起動します。</p>

<p>さて、いかがだったでしょうか？<br/>
今回はひとまず、ここまでにしますが、今後はOAuth2認証後にGoogle Calendar APIやGoogle Driveの画面表示をしてみたいと思います。<br/>
といったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS9 App Transport Securityについて]]></title>
    <link href="http://grandbig.github.io/blog/2015/08/31/ios9-ats/"/>
    <updated>2015-08-31T22:59:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/08/31/ios9-ats</id>
    <content type="html"><![CDATA[<h4>iOS9のApp Transport Securityについて調べてみた</h4>

<p>さて、今月、最終日になんとかブログ更新です。<br/>
来週、新型iPhoneの発表が期待される中、開発者間で話題となっているApp Transport Security(以下、ATS)について調べてみました。</p>

<p>ATSの詳細は<a href="http://qiita.com/yanayanalte/items/e6d83c12af77fa238a58">iOS9 ATS問題</a>などで既に詳しく書かれていますので、割愛します。<br/>
どちらかと言うと実開発よりで話をしたいと思います。</p>

<p>これまで筆者はiOSアプリを作り続けてきたわけなんですが、実は会社では所謂ハイブリッドアプリと呼ばれる、 <strong>WebViewを用いたアプリ</strong> の開発をすることが多く、古くからあるUIWebViewはもちろんのことWKWebViewも利用してきました。<br/>
正直、これまで特別な場合を覗いて、 <strong>HTTPS</strong> を意識することはありませんでした。<br/>
しかし、昨今のセキュリティ問題から周りの考え方も変わりつつあります。<br/>
それをさらに一押したのが、iOS9のATSではないかと考えています。<br/>
今後は、グローバルに空いているサーバに対しては <strong>HTTPS</strong> しか許されないことになることでしょう。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h5>iOS8でのWKWebViewにおける自己証明書について</h5>

<p>iOS9の具体的な話に入る前に一言だけ。<br/>
周知のことかもしれませんが、iOS8のWKWebViewでは自己証明書を利用したサーバの <strong>https</strong> から始まるURLを指定することはできません。<br/>
指定したとしても、表示することができません。<br/>
これは<a href="http://stackoverflow.com/questions/27100540/allow-unverified-ssl-certificates-in-wkwebview">stackoverflow &ndash; Allow unverified ssl certificates in WKWebView</a>に書かれている通り、WKNavigationDelegate Protocolである <strong>didReceiveAuthenticationChallenge</strong> メソッドが呼ばれないためです。</p>

<p>iOS8が登場した当初はバグでは？と騒がれていましたが、iOS9での <strong>HTTPS</strong> 推奨の流れから見るに、わざとだったのでは？とも勘ぐれますね&hellip;。</p>

<h5>iOS9でのWKWebViewにおける自己証明書について</h5>

<p>iOS9からは <strong>didReceiveAuthenticationChallenge</strong> メソッドを通るらしく、コードを書くことで、自己証明書を利用したHTTPS通信が可能なようです。<br/>
<a href="http://qiita.com/niwatako/items/9ae602cb173625b4530a">iOS9からWKWebViewのSSL/TLS接続はコードで制御する</a>を参照のこと。<br/>
確かに、問題なく、実行できることを確認しました。</p>

<h5>iOS9でのHTTP通信許可方法について</h5>

<p>Info.plistに下記の設定を入れることで、全てのHTTP通信を許可できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">NSAppTransportSecurity</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">NSAllowsArbitraryLoads</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">true</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">dict</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>流石に全てを許可するのははばかられるといった場合にはHTTP通信を許可するドメインを指定することもできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">NSAppTransportSecurity</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">NSExceptionDomains</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">xxx</span><span class="p">.</span><span class="n">com</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="n">NSTemporaryExceptionAllowsInsecureHTTPLoads</span><span class="o">&lt;/</span><span class="n">key</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="n">true</span><span class="o">/&gt;</span>
</span><span class='line'>      <span class="o">&lt;/</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;/</span><span class="n">dict</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">dict</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>しかし、これには注意が必要です。<br/>
もしも、指定したドメインアクセス時に呼び出されるHTMLファイルの中に、外部ドメインから取得しているJavaScriptファイルがあった場合、それらもInfo.plistに指定する必要があります。<br/>
これまで、WebソースはAppleの審査を介さずとも変更が可能な範疇でしたが、HTTP通信として設定を必要とする場合が出てくるため、十分に注意が必要です。<br/>
HTTP, HTTPSのどちらでもソースが取得できる場合は、Info.plistにHTTP通信用のドメインとして登録するのではなく、下記のように <strong>https</strong> からパスを指定した方が良いでしょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;https://〜&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>本日は試してみたことをパパっと書きましたが、時間があるときにもっと探ってみようと思います。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kontakt.ioのSmart Beaconのパラメータを書き換えてみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/07/20/write-kontakt-beacon/"/>
    <updated>2015-07-20T00:01:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/07/20/write-kontakt-beacon</id>
    <content type="html"><![CDATA[<h4>Kontakt.ioのSmart Beaconのパラメータの書き換え方法</h4>

<p>さて、続きを書いていきます。<br/>
前回、Kontakt.ioのSmart Beaconを検知するところまで書きました。<br/>
本記事では、必要に応じて、パラメータを変更する方法について書きたいと思います。</p>

<p>手順は<a href="http://docs.kontakt.io/ios-sdk/quickstart/#beacon-configuration">Kontakt.ioの公式ページのBeacon Configuration</a>に書かれていますが、<code>/device/update</code>に引っかかったり、REST APIを叩こうとしたりすることもあるかもしれないので、紹介します。(筆者は初めきちんと読まずにいろいろと実行してしまいました&hellip;)</p>

<p>では、早速書いていきましょう。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h5>Objective-C編</h5>

<p>さて、まずはObjective-Cです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;KontaktSDK.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span><span class="o">&lt;</span><span class="n">KTKBluetoothManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">KTKBeaconManager</span> <span class="o">*</span><span class="n">bm</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">KTKBeaconDevice</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">flag</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_bm</span> <span class="o">=</span> <span class="p">[</span><span class="n">KTKBeaconManager</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="n">_bm</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="n">_flag</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidAppear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">viewDidAppear:</span><span class="n">animated</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// iBeaconデバイスの検索開始</span>
</span><span class='line'>  <span class="p">[</span><span class="n">_bm</span> <span class="n">startFindingDevices</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidDisappear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">viewDidDisappear:</span><span class="n">animated</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// iBeaconデバイスの検索停止</span>
</span><span class='line'>  <span class="p">[</span><span class="n">_bm</span> <span class="n">stopFindingDevices</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - KTKBluetoothManagerDelegate</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">bluetoothManager:</span><span class="p">(</span><span class="n">KTKBluetoothManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">bluetoothManager</span> <span class="nf">didChangeDevices:</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="nv">devices</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_bd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 利用したいKTKBeaconDeviceが見つかっていない場合</span>
</span><span class='line'>       <span class="n">NSArray</span> <span class="o">*</span><span class="n">deviceArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">devices</span> <span class="n">allObjects</span><span class="p">];</span>
</span><span class='line'>       <span class="k">for</span><span class="p">(</span><span class="kt">id</span> <span class="n">device</span> <span class="k">in</span> <span class="n">deviceArray</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">KTKBeaconDevice</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span><span class="p">([</span><span class="n">beacon</span><span class="p">.</span><span class="n">uniqueID</span> <span class="nl">isEqualToString:</span><span class="s">@&quot;****&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// 利用したいiBeaconを格納</span>
</span><span class='line'>              <span class="n">_bd</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 利用したいKTKBeaconDeviceが見つかった場合</span>
</span><span class='line'>      <span class="n">KTKCharacteristicDescriptor</span> <span class="o">*</span><span class="n">descriptor</span><span class="p">;</span>
</span><span class='line'>      <span class="n">descriptor</span> <span class="o">=</span> <span class="p">[</span><span class="n">_bd</span> <span class="nl">characteristicDescriptorWithType:</span><span class="n">kKTKCharacteristicDescriptorTypeMajor</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// iBeaconデバイスに接続</span>
</span><span class='line'>      <span class="kt">BOOL</span> <span class="n">connected</span> <span class="o">=</span> <span class="p">[</span><span class="n">_bd</span> <span class="nl">connectWithPassword:</span><span class="s">@&quot;****&quot;</span> <span class="nl">andError:</span><span class="o">&amp;</span><span class="n">err</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 接続できた場合</span>
</span><span class='line'>          <span class="c1">// パラメータ値の取得</span>
</span><span class='line'>          <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">_bd</span> <span class="nl">readValueForCharacteristicWithDescriptor:</span><span class="n">descriptor</span><span class="p">];</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">NSString</span> <span class="o">*</span><span class="n">valueString</span> <span class="o">=</span> <span class="p">[</span><span class="n">_bd</span> <span class="nl">stringForCharacteristicWithDescriptor:</span><span class="n">descriptor</span><span class="p">];</span>
</span><span class='line'>              <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;value: %@&quot;</span><span class="p">,</span> <span class="n">valueString</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_flag</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// パラメータの書き換え処理</span>
</span><span class='line'>                  <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="n">_bd</span> <span class="nl">writeString:</span><span class="s">@&quot;20053&quot;</span> <span class="nl">forCharacteristicWithDescriptor:</span><span class="n">descriptor</span><span class="p">];</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="c1">// iBeaconデバイスから切断</span>
</span><span class='line'>              <span class="p">[</span><span class="n">_bd</span> <span class="n">disconnect</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記処理を実行後、Kontakt.ioの専用アプリで確認すれば、パラメータの値が変更されていることを確認できます。</p>

<h5>Swift編</h5>

<p>続いて、Swiftのコードも書いてみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">UIKit</span>
</span><span class='line'>
</span><span class='line'><span class="n">class</span> <span class="nl">ViewController:</span> <span class="n">UIViewController</span><span class="p">,</span> <span class="n">KTKBluetoothManagerDelegate</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">let</span> <span class="nl">bm:</span><span class="n">KTKBeaconManager</span> <span class="o">=</span> <span class="n">KTKBeaconManager</span><span class="p">()</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">bd:</span><span class="n">KTKBeaconDevice</span><span class="o">?</span> <span class="o">=</span> <span class="n">KTKBeaconDevice</span><span class="p">()</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">flag:</span><span class="n">Bool</span> <span class="o">=</span> <span class="n">false</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">bm</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidAppear</span><span class="p">(</span><span class="nl">animated:</span> <span class="n">Bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">// iBeaconデバイスの検索開始</span>
</span><span class='line'>      <span class="n">bm</span><span class="p">.</span><span class="n">startFindingDevices</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidDisappear</span><span class="p">(</span><span class="nl">animated:</span> <span class="n">Bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// iBeaconデバイスの検索停止</span>
</span><span class='line'>      <span class="n">bm</span><span class="p">.</span><span class="n">stopFindingDevices</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">didReceiveMemoryWarning</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">didReceiveMemoryWarning</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">bluetoothManager</span><span class="p">(</span><span class="nl">bluetoothManager:</span> <span class="n">KTKBluetoothManager</span><span class="o">!</span><span class="p">,</span> <span class="n">didChangeDevices</span> <span class="nl">devices:</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">?</span><span class="p">.</span><span class="n">uniqueID</span> <span class="o">==</span> <span class="s">&quot;****&quot;</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 利用したいKTKBeaconDeviceが見つかった場合</span>
</span><span class='line'>          <span class="n">let</span> <span class="nl">descriptor:</span><span class="n">KTKCharacteristicDescriptor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">!</span><span class="p">.</span><span class="n">characteristicDescriptorWithType</span><span class="p">(</span><span class="n">kKTKCharacteristicDescriptorTypeMajor</span><span class="p">)</span>
</span><span class='line'>          <span class="n">var</span> <span class="nl">err:</span><span class="n">NSError</span><span class="o">?</span>
</span><span class='line'>          <span class="c1">// iBeaconデバイスに接続</span>
</span><span class='line'>          <span class="n">let</span> <span class="nl">connected:</span><span class="n">Bool</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">!</span><span class="p">.</span><span class="n">connectWithPassword</span><span class="p">(</span><span class="s">&quot;****&quot;</span><span class="p">,</span> <span class="nl">andError:</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">connected</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// 接続できた場合</span>
</span><span class='line'>              <span class="c1">// パラメータ値の取得</span>
</span><span class='line'>              <span class="n">err</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">!</span><span class="p">.</span><span class="n">readValueForCharacteristicWithDescriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="nb">nil</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">let</span> <span class="n">valueString</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">!</span><span class="p">.</span><span class="n">stringForCharacteristicWithDescriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">println</span><span class="p">(</span><span class="s">&quot;\(valueString)&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">flag</span> <span class="o">==</span> <span class="n">false</span> <span class="p">{</span>
</span><span class='line'>                      <span class="c1">// パラメータの書き換え処理</span>
</span><span class='line'>                      <span class="n">err</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">!</span><span class="p">.</span><span class="n">writeString</span><span class="p">(</span><span class="s">&quot;20053&quot;</span><span class="p">,</span> <span class="nl">forCharacteristicWithDescriptor:</span> <span class="n">descriptor</span><span class="p">)</span>
</span><span class='line'>                      <span class="n">self</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="c1">// iBeaconデバイスから切断</span>
</span><span class='line'>                  <span class="n">self</span><span class="p">.</span><span class="n">bd</span><span class="o">?</span><span class="p">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 利用したいKTKBeaconDeviceが見つかっていない場合</span>
</span><span class='line'>          <span class="n">let</span> <span class="nl">deviceArray:</span><span class="p">[</span><span class="n">AnyObject</span><span class="p">]</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span>
</span><span class='line'>          <span class="k">for</span> <span class="n">device</span> <span class="k">in</span> <span class="n">deviceArray</span>  <span class="p">{</span>
</span><span class='line'>              <span class="n">let</span> <span class="nl">beacon:</span><span class="n">KTKBeaconDevice</span> <span class="o">=</span> <span class="n">device</span> <span class="n">as</span><span class="o">!</span> <span class="n">KTKBeaconDevice</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">beacon</span><span class="p">.</span><span class="n">uniqueID</span> <span class="o">==</span> <span class="s">&quot;****&quot;</span> <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// 利用したいiBeaconを格納</span>
</span><span class='line'>                  <span class="n">self</span><span class="p">.</span><span class="n">bd</span> <span class="o">=</span> <span class="n">beacon</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>こちらも専用アプリでパラメータ値が書き換わっていることを確認できました。<br/>
Kontakt.ioの制御特性を活かしたサービスを企画できる可能性を感じました。<br/>
といったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kontakt.ioのSmart Beaconを使ってみた]]></title>
    <link href="http://grandbig.github.io/blog/2015/07/18/start-kontakt-beacon/"/>
    <updated>2015-07-18T22:40:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/07/18/start-kontakt-beacon</id>
    <content type="html"><![CDATA[<h4>Kontakt.ioのSmart Beaconを使ってみよう</h4>

<p>さて、久しぶりの更新です。<br/>
実は先日、以前から気になっていた<a href="https://store.kontakt.io/our-products/1-bluetooth-beacon.html">Kontakt.io Smart Beacon</a>を購入してみました。<br/>
あまり海外の製品を購入することがないので、届くか心配でしたが、ばっちり自宅に届きました笑</p>

<p>なぜ、Kontakt.ioのSmart Beaconに着目していたかというと、筆者が知る限り、最も発信出力(TxPower)を弱くすることが可能なBeaconだからです。<br/>
<a href="https://support.kontakt.io/hc/en-gb/articles/201621521-Transmission-power-Range-and-RSSI">仕様書</a>を見てみると、出力を-30[dBm]にまで下げることができ、その電波距離は実に2[m]程度らしいです。</p>

<p>また、SDKが充実しており、発信出力を自由に変更できるところもポイント高いですね。<br/>
さて、今回は基本的な実装から見て行きましょう！(何回かに分けて記事にしようと思います。)</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h4>SDKをプロジェクトに追加</h4>

<p>まずは、SDKを使える状態に持っていきます。</p>

<h5>Objective-C編</h5>

<p>CocoaPodsで提供されていますので、簡単です。</p>

<ol>
<li>Projectファイルと同じ階層に<code>Podfile</code>を作成します</li>
<li><code>pod 'KontaktSDK'</code>と記載します</li>
<li><code>pod install</code>を実行します</li>
</ol>


<p>以上でプロジェクトへの追加完了です。</p>

<h5>Swift編</h5>

<p>CocoaPods使いましょう！</p>

<ol>
<li>Projectファイルと同じ階層に<code>Podfile</code>を作成します</li>
<li><code>pod 'KontaktSDK'</code>と記載します</li>
<li><code>pod install</code>を実行します</li>
<li>Bridging-Headerファイルを作成します
<code>ProjectName-Bridging-Header.h</code>ファイルを作成し、Build Settings > Swift Compiler > Objective-C Bridging Headerにパスを設定</li>
<li>Bridging-Headerファイルに必要なライブラリを<code>import</code>します</li>
</ol>


<p>下記は、Buid Settingsの設定です。<br/>
<img src="http://grandbig.github.io/images/kontakt1.png" alt="Bridging-Headerファイルの設定" /></p>

<p>下記はBridging-Headerファイルの中身です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#ifndef KontaktSwiftTest_KontaktSwiftTest_Bridging_Header_h</span>
</span><span class='line'><span class="cp">#define KontaktSwiftTest_KontaktSwiftTest_Bridging_Header_h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreLocation/CoreLocation.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreBluetooth/CoreBluetooth.h&gt;</span>
</span><span class='line'><span class="cp">#import &quot;KontaktSDK.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Kontakt.ioのBeaconを検知してみよう</h4>

<p>これで準備が整ったので、実際にソースを書いて、Beaconを検知してみましょう！</p>

<h5>Objective-C編</h5>

<p>ViewController.mにどんどん書いていきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;KontaktSDK.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span><span class="o">&lt;</span><span class="n">KTKLocationManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">KTKLocationManager</span> <span class="o">*</span><span class="n">lm</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_lm</span> <span class="o">=</span> <span class="p">[</span><span class="n">KTKLocationManager</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="n">_lm</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">KTKLocationManager</span> <span class="n">canMonitorBeacons</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">KTKRegion</span> <span class="o">*</span><span class="n">region</span> <span class="o">=</span> <span class="p">[</span><span class="n">KTKRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>      <span class="n">region</span><span class="p">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="s">@&quot;AF41A130-E105-4F13-9483-316B7101B0A9&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[</span><span class="n">_lm</span> <span class="nl">setRegions:</span><span class="err">@</span><span class="p">[</span><span class="n">region</span><span class="p">]];]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidAppear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">viewDidAppear:</span><span class="n">animated</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">_lm</span> <span class="n">startMonitoringBeacons</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidDisappear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">viewDidDisappear:</span><span class="n">animated</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="p">[</span><span class="n">_lm</span> <span class="n">stopMonitoringBeacons</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - KTKLocationManagerDelegate</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">KTKLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">locationManager</span> <span class="nf">didChangeState:</span><span class="p">(</span><span class="n">KTKLocationManagerState</span><span class="p">)</span><span class="nv">state</span> <span class="nf">withError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">KTKLocationManagerStateFailed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Something went wrong with your Location Services settings. Check OS settings.&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">KTKLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">locationManager</span> <span class="nf">didEnterRegion:</span><span class="p">(</span><span class="n">KTKRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Enter region %@&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">uuid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">KTKLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">locationManager</span> <span class="nf">didExitRegion:</span><span class="p">(</span><span class="n">KTKRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Exit region %@&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">uuid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">KTKLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">locationManager</span> <span class="nf">didRangeBeacons:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">beacons</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Ranged beacons count: %lu&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">beacons</span> <span class="n">count</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Swift編</h5>

<p><code>ViwController.swift</code>にどんどん書いていきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">UIKit</span>
</span><span class='line'>
</span><span class='line'><span class="n">class</span> <span class="nl">ViewController:</span> <span class="n">UIViewController</span><span class="p">,</span> <span class="n">KTKLocationManagerDelegate</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span> <span class="nl">lm:</span><span class="n">KTKLocationManager</span> <span class="o">=</span> <span class="n">KTKLocationManager</span><span class="p">()</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">KTKLocationManager</span><span class="p">.</span><span class="n">canMonitorBeacons</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">let</span> <span class="nl">region:</span><span class="n">KTKRegion</span> <span class="o">=</span> <span class="n">KTKRegion</span><span class="p">()</span>
</span><span class='line'>          <span class="n">region</span><span class="p">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="s">&quot;AF41A130-E105-4F13-9483-316B7101B0A9&quot;</span>
</span><span class='line'>          <span class="n">lm</span><span class="p">.</span><span class="n">setRegions</span><span class="p">([</span><span class="n">region</span><span class="p">])</span>
</span><span class='line'>          <span class="n">self</span><span class="p">.</span><span class="n">lm</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidAppear</span><span class="p">(</span><span class="nl">animated:</span> <span class="n">Bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">lm</span><span class="p">.</span><span class="n">startMonitoringBeacons</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidDisappear</span><span class="p">(</span><span class="nl">animated:</span> <span class="n">Bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">lm</span><span class="p">.</span><span class="n">stopMonitoringBeacons</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">didReceiveMemoryWarning</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">didReceiveMemoryWarning</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">locationManager</span><span class="p">(</span><span class="nl">locationManager:</span> <span class="n">KTKLocationManager</span><span class="o">!</span><span class="p">,</span> <span class="n">didChangeState</span> <span class="nl">state:</span> <span class="n">KTKLocationManagerState</span><span class="p">,</span> <span class="n">withError</span> <span class="nl">error:</span> <span class="n">NSError</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="p">.</span><span class="n">Failed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">println</span><span class="p">(</span><span class="s">&quot;Something went wrong with your Location Services settings. Check OS settings.&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">locationManager</span><span class="p">(</span><span class="nl">locationManager:</span> <span class="n">KTKLocationManager</span><span class="o">!</span><span class="p">,</span> <span class="n">didEnterRegion</span> <span class="nl">region:</span> <span class="n">KTKRegion</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">println</span><span class="p">(</span><span class="s">&quot;Enter region \(region.uuid)&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">locationManager</span><span class="p">(</span><span class="nl">locationManager:</span> <span class="n">KTKLocationManager</span><span class="o">!</span><span class="p">,</span> <span class="n">didExitRegion</span> <span class="nl">region:</span> <span class="n">KTKRegion</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">println</span><span class="p">(</span><span class="s">&quot;Exit region \(region.uuid)&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">locationManager</span><span class="p">(</span><span class="nl">locationManager:</span> <span class="n">KTKLocationManager</span><span class="o">!</span><span class="p">,</span> <span class="n">didRangeBeacons</span> <span class="nl">beacons:</span> <span class="p">[</span><span class="n">AnyObject</span><span class="p">]</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">println</span><span class="p">(</span><span class="s">&quot;Ranged beacons count: \(beacons.count)&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでKontakt.ioのSmart Beaconを検知することができるようになりました。<br/>
次回はAPI連携して、Beaconのパラメータを変えてみたいと思います。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AndroidでRealmで保存した値を確認しよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/22/android-realmbrowser/"/>
    <updated>2015-06-22T00:23:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/22/android-realmbrowser</id>
    <content type="html"><![CDATA[<h4>Android Realm Browserを使おう</h4>

<p>さて、<a href="http://grandbig.github.io/blog/2015/06/20/android-realm/">前回の記事</a>で実装したRealmですが、値を確かめたいことがあると思います。<br/>
その方法について見て行きましょう。</p>

<p><a href="https://github.com/dmytrodanylyk/realm-browser">Android Realm Browser</a>を利用することでアプリ上で直接、値を確認することが可能です。</p>

<p>実装手順</p>

<p>１. GradleScripts > build.gradle(Module: app) のdependenciesを修正
<code>compile 'com.github.dmytrodanylyk.realm-browser:library:0.0.2'</code>を<code>dependencies { ... }</code>に追加します。<br/>
２. <code>RealmFilesActivity</code>を起動する処理を追加</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// MainActivity.java</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>      <span class="k">if</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="c1">// Realmデータ閲覧用のActivityを起動</span>
</span><span class='line'>          <span class="n">RealmBrowser</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addRealmModel</span><span class="o">(</span><span class="n">Engineer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>          <span class="n">RealmFilesActivity</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>さて、これでアプリを実行してみましょう。<br/>
下記のような画面を見ることができるはずです。</p>

<p><img src="http://grandbig.github.io/images/android-realmbrowser.png" alt="Realmデータ確認画面" /></p>

<h4>ADBで確認する方法</h4>

<p>他にも確認する方法があります。<br/>
Android StudioをPC上で使えるように設定するにあたって、意識せずにADBというツールがインストールされています。<br/>
このADBコマンドを利用することでデバイスの中身を直接見ることが可能となります。</p>

<p>ADB設定手順</p>

<p>１. <code>.bashrc</code>ファイルにADBツールのパスを設定
<code>.bashrc</code>ファイルに<code>export PATH=$PATH:/Users/&lt;ユーザ名&gt;/Library/Android/sdk/platform-tools</code>とパスを設定しましょう。<br/>
２. <code>.bashrc</code>ファイルの変更を反映
<code>source ~/.bashrc</code>を実行</p>

<p>これでADBコマンドを利用可能になりました。<br/>
続いて下記手順で、Realmデータの中身を見て行きましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">adb</span> <span class="n">shell</span>
</span><span class='line'><span class="n">$</span> <span class="n">run</span><span class="o">-</span><span class="n">as</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">takahiro</span><span class="o">.</span><span class="na">realmsample</span>
</span><span class='line'><span class="n">$</span> <span class="n">cd</span> <span class="n">files</span><span class="o">/</span>
</span><span class='line'><span class="n">$</span> <span class="n">cat</span> <span class="k">default</span><span class="o">.</span><span class="na">realm</span>
</span></code></pre></td></tr></table></div></figure>


<p>日本語を保存している場合は文字化けして見えますが、保存されていることは確認できます。<br/>
本当は<code>adb pull</code>コマンドを使ってPCに<code>default.realm</code>を持ってきて、Realm Browserアプリで中身を見たいのですが、<br/>
今のところうまくコピーできず見れていません&hellip;。<br/>
(因みに端末はNexus6を利用しています。)</p>

<p>とりあえず、<code>Android Realm Browser</code>で見るしかないかな〜といったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android StudioでRealmを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/20/android-realm/"/>
    <updated>2015-06-20T23:56:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/20/android-realm</id>
    <content type="html"><![CDATA[<h4>Realmを読み込もう！</h4>

<p>AndroidでもRealmを導入してみたいと思います。<br/>
今後、SQLite同様、非常に重宝されるライブラリであることは間違いないですし。</p>

<h5>Realmの導入方法</h5>

<p>ここに関しては、<a href="https://realm.io/jp/docs/java/latest/">公式サイト</a>を見れば、特に困ることはないと思いますが、筆者と同様にAndroidアプリ開発の初心者は躓くかもしれないので、詳しく書いてみようと思います。</p>

<p>まず、 <strong>Realm Android</strong> を検索すると、『 <strong>Realm Java(0.☓☓.☓)</strong> 』のような検索結果が出てくると思います。<br/>
ここで注意して頂きたいのが、そのページが最新版のページになっているか否かということです。<br/>
旧バージョンの場合、URLが <strong><a href="https://realm.io/jp/docs/java/0.%E2%98%93%E2%98%93.%E2%98%93/**">https://realm.io/jp/docs/java/0.%E2%98%93%E2%98%93.%E2%98%93/**</a> のようにバージョンが含まれています。<br/>
最新版の場合は、URLが </strong><a href="https://realm.io/jp/docs/java/latest/**">https://realm.io/jp/docs/java/latest/**</a> のように <strong>latest</strong> というワードが含まれています。</p>

<p>現在(2015/06/20)は <strong>0.80.3</strong> が最新版となっています。</p>

<p>では、導入していきましょう。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>１. GradleScripts > build.gradle(Module: app) のdependenciesを修正
<code>compile 'io.realm:realm-android:0.80.3'</code>を<code>dependencies { ... }</code>に追加します。<br/>
２. メニューのFile > Project Structure&hellip; > Modulesのapp > Build Types > release > Minify Enabledをtrueに変更
<img src="http://grandbig.github.io/images/android-realm1.png" alt="Minify Enabledを設定" /><br/>
これにより、GradleScripts > build.gradle(Module: app)に</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">buildTypes</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">release</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">minifyEnabled</span> <span class="kc">true</span>
</span><span class='line'>          <span class="n">proguardFiles</span> <span class="nf">getDefaultProguardFile</span><span class="o">(</span><span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">android</span><span class="o">.</span><span class="na">txt</span><span class="err">&#39;</span><span class="o">),</span> <span class="err">&#39;</span><span class="n">proguard</span><span class="o">-</span><span class="n">rules</span><span class="o">.</span><span class="na">pro</span><span class="err">&#39;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>という記述が追加されます。<br/>
３. GradleScripts > proguard-rules.proに記述を追加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">-</span><span class="n">keepnames</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">io</span><span class="o">.</span><span class="na">realm</span><span class="o">.</span><span class="na">RealmObject</span>
</span><span class='line'><span class="o">-</span><span class="n">keep</span> <span class="kd">class</span> <span class="nc">io</span><span class="o">.</span><span class="na">realm</span><span class="o">.**</span> <span class="o">{</span> <span class="o">*;</span> <span class="o">}</span>
</span><span class='line'><span class="o">-</span><span class="n">dontwarn</span> <span class="n">javax</span><span class="o">.**</span>
</span><span class='line'><span class="o">-</span><span class="n">dontwarn</span> <span class="n">io</span><span class="o">.</span><span class="na">realm</span><span class="o">.**</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでRealmを利用する準備が整いました。<br/>
実際にコードを書いていきましょう。</p>

<h5>保存オブジェクトの生成</h5>

<p>Realmでは保存する対象を<code>RLMObject</code>として作成します。<br/>
SQLiteでいうところのテーブルを生成しているイメージでしょうか。</p>

<p>今回は練習として<code>Engineer.java</code>内で<code>Engineer</code>クラスを作ってみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// Engineer.java</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Engineer</span> <span class="kd">extends</span> <span class="n">RealmObject</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@PrimaryKey</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">int</span> <span class="n">level</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">businessTitle</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">RealmList</span><span class="o">&lt;</span><span class="n">Skill</span><span class="o">&gt;</span> <span class="n">skills</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Date</span> <span class="n">createDateTime</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Date</span> <span class="n">updateDateTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getLevel</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">level</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLevel</span><span class="o">(</span><span class="kt">int</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">level</span> <span class="o">=</span> <span class="n">level</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getBusinessTitle</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">businessTitle</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBusinessTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">businessTitle</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">businessTitle</span> <span class="o">=</span> <span class="n">businessTitle</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">RealmList</span><span class="o">&lt;</span><span class="n">Skill</span><span class="o">&gt;</span> <span class="nf">getSkills</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">skills</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSkills</span><span class="o">(</span><span class="n">RealmList</span><span class="o">&lt;</span><span class="n">Skill</span><span class="o">&gt;</span> <span class="n">skills</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">skills</span> <span class="o">=</span> <span class="n">skills</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreateDateTime</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">createDateTime</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreateDateTime</span><span class="o">(</span><span class="n">Date</span> <span class="n">createDateTime</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">createDateTime</span> <span class="o">=</span> <span class="n">createDateTime</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getUpdateDateTime</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">updateDateTime</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUpdateDateTime</span><span class="o">(</span><span class="n">Date</span> <span class="n">updateDateTime</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">updateDateTime</span> <span class="o">=</span> <span class="n">updateDateTime</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// Skill.java</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Skill</span> <span class="kd">extends</span> <span class="n">RealmObject</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PrimaryKey</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">skill</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSkill</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">skill</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSkill</span><span class="o">(</span><span class="n">String</span> <span class="n">skill</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">skill</span> <span class="o">=</span> <span class="n">skill</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ポイントとしては、<code>skills</code>のように配列の形で値を保持したい場合は<code>RealmList</code>を利用するということです。</p>

<h5>オブジェクトのセレクト/インサート</h5>

<p>続いて先ほど生成したオブジェクトをセレクト/インサートしてみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// MainActivity.java</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Realm</span> <span class="n">realm</span> <span class="o">=</span> <span class="n">Realm</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">RealmQuery</span><span class="o">&lt;</span><span class="n">Engineer</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">realm</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">Engineer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;ABC123&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">RealmResults</span><span class="o">&lt;</span><span class="n">Engineer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// 検索結果が見つかった場合</span>
</span><span class='line'>          <span class="n">Engineer</span> <span class="n">engineer</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">first</span><span class="o">();</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="na">getLevel</span><span class="o">();</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">businessTitle</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="na">getBusinessTitle</span><span class="o">();</span>
</span><span class='line'>          <span class="n">RealmList</span><span class="o">&lt;</span><span class="n">Skill</span><span class="o">&gt;</span> <span class="n">skills</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="na">getSkills</span><span class="o">();</span>
</span><span class='line'>          <span class="n">Date</span> <span class="n">createDateTime</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="na">getCreateDateTime</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;MainActivity&quot;</span><span class="o">,</span> <span class="s">&quot;name: &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;, businessTitle: &quot;</span> <span class="o">+</span> <span class="n">businessTitle</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// 検索結果が見つからなかった場合</span>
</span><span class='line'>          <span class="n">realm</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'>          <span class="n">Engineer</span> <span class="n">engineer</span> <span class="o">=</span> <span class="n">realm</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">Engineer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>          <span class="n">engineer</span><span class="o">.</span><span class="na">setLevel</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>          <span class="n">engineer</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;ABC123&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">engineer</span><span class="o">.</span><span class="na">setBusinessTitle</span><span class="o">(</span><span class="s">&quot;新米エンジニア&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">Skill</span> <span class="n">skill</span> <span class="o">=</span> <span class="n">realm</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">Skill</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>          <span class="n">skill</span><span class="o">.</span><span class="na">setSkill</span><span class="o">(</span><span class="s">&quot;Java&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">engineer</span><span class="o">.</span><span class="na">getSkills</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">skill</span><span class="o">);</span>
</span><span class='line'>          <span class="n">engineer</span><span class="o">.</span><span class="na">setCreateDateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">realm</span><span class="o">.</span><span class="na">commitTransaction</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="o">....</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここでは<code>name = "ABC123"</code>のデータを検索して、見つからない場合は新規データをインサートし、見つかった場合はデータをログに出力しています。<br/>
書込みには<code>beginTransaction()</code>と<code>commitTransaction()</code>を利用しています。</p>

<h5>データの確認</h5>

<p>Realm Browserを使いたいところですが、現在調査中です&hellip;。<br/>
デバイス内のどこにファイルがあるのかについてはわかったのですが、うまくファイルをPCに取り込めません&hellip;。<br/>
継続調査をし、ブログにアップしますね。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[複数のiBeaconを検知しよう！(別UUIDの場合)]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/14/multi-ibeacon-region/"/>
    <updated>2015-06-14T23:43:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/14/multi-ibeacon-region</id>
    <content type="html"><![CDATA[<h4>複数のiBeacon(別UUIDのiBeacon)を検知する方法</h4>

<p>さて、本日は別々のUUIDを持ったiBeacon信号を補足したいと思います。<br/>
iBeaconは案外、電波が遠くまで飛ぶため、幾つかのUUIDを補足できるようにしておくことで、うまく<code>didEnterRegion</code>, <code>didExitRegion</code>を使い、レンジングでのみ取得可能な値を効果的に使うことができるかもしれません。<br/>
今回はiOS8以上を対象に下記サンプルソースを書きました。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">CLLocationManager</span> <span class="o">*</span><span class="n">locationManager</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSUUID</span> <span class="o">*</span><span class="n">proximityUUID1</span><span class="p">,</span> <span class="o">*</span><span class="n">proximityUUID2</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="n">beaconRegion1</span><span class="p">,</span> <span class="o">*</span><span class="n">beaconRegion2</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">CLBeacon</span> <span class="o">*</span><span class="n">nearestBeacon</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLLocationManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">locationManager</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUUIDString:</span><span class="s">@&quot;8D4DB809-032F-4771-96F3-99BD5C25F924&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">beaconRegion1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLBeaconRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithProximityUUID:</span> <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID1</span> <span class="nl">identifier:</span><span class="s">@&quot;com.takahiro.ibeaconSample&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUUIDString:</span><span class="s">@&quot;1AE93327-B172-4C5D-BBF7-F52B959FD4EB&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">self</span><span class="p">.</span><span class="n">beaconRegion2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLBeaconRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithProximityUUID:</span> <span class="n">self</span><span class="p">.</span><span class="n">proximityUUID1</span> <span class="nl">identifier:</span><span class="s">@&quot;com.takahiro.ibeaconSample2&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">requestAlwaysAuthorization</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ユーザの位置情報の許可状態を確認するメソッド</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didChangeAuthorizationStatus:</span><span class="p">(</span><span class="n">CLAuthorizationStatus</span><span class="p">)</span><span class="nv">status</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">kCLAuthorizationStatusAuthorizedAlways</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Beaconのモニタリングを開始</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startMonitoringForRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">beaconRegion1</span><span class="p">];</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startMonitoringForRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">beaconRegion2</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 指定した領域に入った場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didEnterRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Enter Region&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 指定した領域から出た場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didExitRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="s">@&quot;Exit Region&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// iBeacon領域内に既にいるか/いないかの判定</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didDetermineState:</span><span class="p">(</span><span class="n">CLRegionState</span><span class="p">)</span><span class="nv">state</span> <span class="nf">forRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nl">CLRegionStateInside:</span>
</span><span class='line'>          <span class="k">if</span><span class="p">([</span><span class="n">region</span> <span class="nl">isMemberOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">isRangingAvailable</span><span class="p">]){</span>
</span><span class='line'>              <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startRangingBeaconsInRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">beaconRegion1</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="nl">startRangingBeaconsInRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">beaconRegion2</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nl">CLRegionStateOutside:</span>
</span><span class='line'>          <span class="k">if</span><span class="p">([</span><span class="n">region</span> <span class="nl">isMemberOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">isRangingAvailable</span><span class="p">]){</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nl">CLRegionStateUnknown:</span>
</span><span class='line'>          <span class="k">if</span><span class="p">([</span><span class="n">region</span> <span class="nl">isMemberOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">CLLocationManager</span> <span class="n">isRangingAvailable</span><span class="p">]){</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Beacon信号を検出した場合</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didRangeBeacons:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">beacons</span> <span class="nf">inRegion:</span><span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="nv">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">beacons</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span> <span class="o">=</span> <span class="n">beacons</span><span class="p">.</span><span class="n">firstObject</span><span class="p">;</span>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">rangeMessage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">switch</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span><span class="p">.</span><span class="n">proximity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityImmediate:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Immediate&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityNear:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Near&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">CLProximityFar:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Far&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>
</span><span class='line'>              <span class="n">rangeMessage</span> <span class="o">=</span> <span class="s">@&quot;Range Unknown&quot;</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat:</span><span class="s">@&quot;%f [m]&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">nearestBeacon</span><span class="p">.</span><span class="n">accuracy</span><span class="p">];</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span> <span class="nl">sendLocalNotificationForMessage:</span><span class="n">self</span><span class="p">.</span><span class="n">str</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ローカルプッシュ</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendLocalNotificationForMessage:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">localNotification</span> <span class="o">=</span> <span class="p">[</span><span class="n">UILocalNotification</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">alertBody</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">fireDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">];</span>
</span><span class='line'>  <span class="n">localNotification</span><span class="p">.</span><span class="n">soundName</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">scheduleLocalNotification:</span><span class="n">localNotification</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ローカルプッシュを可能にするために<code>AppDelegate.m</code>に下記書式を追加しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// AppDelegate.m</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">UIApplication</span> <span class="nl">instancesRespondToSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">registerUserNotificationSettings:</span><span class="p">)])</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">registerUserNotificationSettings:</span><span class="p">[</span><span class="n">UIUserNotificationSettings</span> <span class="nl">settingsForTypes:</span><span class="n">UIUserNotificationTypeAlert</span><span class="o">|</span><span class="n">UIUserNotificationTypeSound</span> <span class="nl">categories:</span><span class="nb">nil</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ポイントは<code>CLBeaconRegion</code>を作成するときに指定する<code>UUID</code>と<code>identifier</code>が共にユニークであることです。<br/>
<code>UUID</code>のみを別々にしても<code>identifier</code>が同じだと別のiBeacon領域と見なされないので注意が必要です。</p>

<p>別々のiBeacon領域が作成できれば、<code>didEnterRegion</code>, <code>didExitRegion</code>などのデリゲートメソッドはそれぞれのiBeacon領域に対して発生します。<br/>
もし、比較的狭い空間で複数のiBeaconを設置して、アプリをFG起動しない前提で人流解析をしたい場合は複数のiBeacon領域(別々のUUIDを持ったiBeacon領域)を用意することも１つの手だと思います。</p>

<p>と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swiftで継承とカテゴリってどうやってやるの！？]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/07/swift-inheritance-extension/"/>
    <updated>2015-06-07T23:30:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/07/swift-inheritance-extension</id>
    <content type="html"><![CDATA[<h4>Swiftで継承</h4>

<p>まずはObjective-CとSwiftの継承の書き方の違いを見て行きましょう。</p>

<p>早速、Objective-Cの継承ですが、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ヘッダーファイル</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">SampleA</span>:<span class="nc">NSObject</span>
</span><span class='line'><span class="c1">// プロパティの定義</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">sampleString</span><span class="p">;</span>
</span><span class='line'><span class="c1">// メソッドの定義</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sampleMethod</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// モデルファイル</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">SampleA</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span>
</span><span class='line'>
</span><span class='line'><span class="err">- (</span><span class="nc">void</span><span class="p">)</span><span class="n">sampleMethod</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">....</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>といった形で書けます。</p>

<p>これがSwiftだと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// swiftファイル</span>
</span><span class='line'><span class="n">class</span> <span class="nl">SampleA:</span><span class="n">NSObject</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// プロパティの定義</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">sampleString:</span><span class="n">String</span> <span class="o">=</span> <span class="s">&quot;サンプル&quot;</span>
</span><span class='line'>  <span class="c1">// メソッドの定義</span>
</span><span class='line'>  <span class="n">func</span> <span class="n">sampleMethod</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">....</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>とかなりシンプルに書けますね！</p>

<h4>Swiftでカテゴリ</h4>

<p>次にSwiftでObjective-Cで言うカテゴリを実装してみます。</p>

<p>Objective-Cでは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ヘッダーファイル</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">NSError</span><span class="nl">(ContextBase)</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nf">createError:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span> <span class="nf">code:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">code</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// モデルファイル</span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">NSError</span><span class="nl">(ContextBase)</span>
</span><span class='line'>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nl">createError:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">message</span> <span class="nl">code:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">code</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">errorUserInfo</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span> <span class="nl">NSLocalizedDescriptionKey:</span><span class="n">message</span> <span class="p">};</span>
</span><span class='line'>  <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSError</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDomain:</span><span class="n">domain</span> <span class="nl">code:</span><span class="n">code</span> <span class="nl">userInfo:</span><span class="n">errorUserInfo</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>と書いてきました。<br/>
これがSwiftでは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// Swiftファイル</span>
</span><span class='line'><span class="n">extension</span> <span class="n">NSError</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">func</span> <span class="n">createError</span><span class="p">(</span><span class="nl">message:</span><span class="n">String</span><span class="o">!</span><span class="p">,</span> <span class="nl">code:</span><span class="n">Int</span><span class="o">!</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NSError</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">errorUserInfo</span> <span class="o">=</span> <span class="p">[</span><span class="nl">NSLocalizedDescriptionKey:</span> <span class="n">message</span><span class="p">]</span>
</span><span class='line'>      <span class="n">let</span> <span class="nl">error:</span><span class="n">NSError</span> <span class="o">=</span> <span class="n">NSError</span><span class="p">(</span><span class="nl">domain:</span> <span class="s">&quot;jp.co.swiftSample&quot;</span><span class="p">,</span> <span class="nl">code:</span> <span class="n">code</span><span class="p">,</span> <span class="nl">userInfo:</span> <span class="n">errorUserInfo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">error</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>と書けます。<br/>
う〜んこれもシンプル！！<br/>
Objective-Cで利用してきた継承はもちろんのこと、カテゴリも残っていて助かりますね！</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SwiftでRealmを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/07/swift-realm/"/>
    <updated>2015-06-07T16:35:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/07/swift-realm</id>
    <content type="html"><![CDATA[<h4>Realmをプロジェクトに追加しよう</h4>

<p>本日は最近、流行っているRealmについて遊んでみたいと思います。<br/>
まずは導入の仕方から見て行きましょう！</p>

<h5>Realmの導入方法</h5>

<p>下記のPodfileを作成しましょう。<br/>
本記事のSwiftプロジェクトとして、<code>SwiftRealm.xcodeproj</code>を作成します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// Podfile</span>
</span><span class='line'><span class="n">platform</span> <span class="o">:</span><span class="n">ios</span><span class="p">,</span> <span class="err">&#39;</span><span class="mf">8.0</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">source</span> <span class="err">&#39;</span><span class="nl">https:</span><span class="c1">//github.com/CocoaPods/Specs.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">target</span> <span class="err">&#39;</span><span class="n">SwiftRealm</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">exclusive:</span> <span class="n">true</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pod</span> <span class="err">&#39;</span><span class="n">Realm</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">target</span> <span class="err">&#39;</span><span class="n">SwiftRealmTests</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">exclusive:</span> <span class="n">true</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">pod</span> <span class="err">&#39;</span><span class="n">Realm</span><span class="o">/</span><span class="n">Headers</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>




<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>あとは<code>pod install</code>しましょう。<br/>
すると、<code>SwiftRealm.xcworkspace</code>が作成されるので、Xcodeで起動しましょう。</p>

<p><img src="http://grandbig.github.io/images/swift-realm.png" alt="Realmを追加した結果" /></p>

<p>なんと、Objective-C++で書かれていますね！
Swiftで利用するためにはBridging-Headerファイルの設定を行う必要があります。</p>

<p>SwiftRealm-Bridging-Header.hを作成します。<br/>
<img src="http://grandbig.github.io/images/swift-realm2.png" alt="ヘッダーファイルの作成" /></p>

<p>TARGETS > SwiftRealm > Build Settings > Swift Compiler &ndash; Code Generation > Objective-C Bridging Header にパスを設定します。<br/>
<img src="http://grandbig.github.io/images/swift-realm3.png" alt="パスの設定" /></p>

<p>SwiftRealm-Bridging-Header.hの中身を書きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#ifndef SwiftRealm_SwiftRealm_Bridging_Header_h</span>
</span><span class='line'><span class="cp">#define SwiftRealm_SwiftRealm_Bridging_Header_h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;Realm/Realm.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでRealmを利用する準備が整いました。<br/>
実際にコードを書いていきましょう。</p>

<h5>保存オブジェクトの生成</h5>

<p>Realmでは保存する対象を<code>RLMObject</code>として作成します。<br/>
SQLiteでいうところのテーブルを生成しているイメージでしょうか。</p>

<p>今回は練習として<code>Engineer.swift</code>内で<code>Engineer</code>クラスを作ってみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// Engineer.swift</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Engineerクラス</span>
</span><span class='line'><span class="n">class</span> <span class="nl">Engineer:</span><span class="n">RLMObject</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// プロパティと初期値の設定</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="kt">id</span><span class="o">:</span><span class="n">Int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="nl">level:</span><span class="n">Int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="nl">businessTitle:</span><span class="n">String</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="n">skills</span> <span class="o">=</span> <span class="n">RLMArray</span><span class="p">(</span><span class="nl">objectClassName:</span> <span class="s">&quot;Skills&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="nl">created:</span><span class="n">Double</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">dynamic</span> <span class="n">var</span> <span class="nl">updated:</span><span class="n">Double</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// プライマリーキーの設定</span>
</span><span class='line'>  <span class="n">override</span> <span class="n">class</span> <span class="n">func</span> <span class="n">primaryKey</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;id&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// インデックスの設定</span>
</span><span class='line'>  <span class="n">override</span> <span class="n">class</span> <span class="n">func</span> <span class="n">indexedProperties</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">AnyObject</span><span class="p">]</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="s">&quot;level&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Skillsクラス</span>
</span><span class='line'><span class="n">class</span> <span class="nl">Skills:</span> <span class="n">RLMObject</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">dynamic</span> <span class="n">var</span> <span class="nl">skill:</span><span class="n">String</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ポイントとしては、<code>skills</code>のように配列の形で1つの要素に複数の値を割り当てたい場合は、それ単体で別に<code>RLMObject</code>の拡張クラスを作成する必要があります。<br/>
<code>RLMArray</code>を初期化することは許可されていないためです。</p>

<h5>オブジェクトのインサート/アップデート</h5>

<p>続いて、先ほど生成したオブジェクトをインサート/アップデートしてみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">UIKit</span>
</span><span class='line'>
</span><span class='line'><span class="n">class</span> <span class="nl">ViewController:</span> <span class="n">UIViewController</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// id=0のオブジェクトを検索</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">let</span> <span class="n">engineer</span> <span class="o">=</span> <span class="n">Engineer</span><span class="p">(</span><span class="nl">forPrimaryKey:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 検索結果がある場合</span>
</span><span class='line'>          <span class="n">println</span><span class="p">(</span><span class="s">&quot;既にエンジニアが１人います。\(engineer)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// アップデート</span>
</span><span class='line'>          <span class="n">let</span> <span class="n">realm</span> <span class="o">=</span> <span class="n">RLMRealm</span><span class="p">.</span><span class="n">defaultRealm</span><span class="p">()</span>
</span><span class='line'>          <span class="c1">// 書込みの開始</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">beginWriteTransaction</span><span class="p">()</span>
</span><span class='line'>          <span class="c1">// Skillsクラスをインスタンス化</span>
</span><span class='line'>          <span class="n">let</span> <span class="n">skills</span> <span class="o">=</span> <span class="n">Skills</span><span class="p">()</span>
</span><span class='line'>          <span class="c1">// 要素を設定</span>
</span><span class='line'>          <span class="n">skills</span><span class="p">.</span><span class="n">skill</span> <span class="o">=</span> <span class="s">&quot;Objective-C&quot;</span>
</span><span class='line'>          <span class="c1">// 既存のデータに要素を追加</span>
</span><span class='line'>          <span class="n">engineer</span><span class="p">.</span><span class="n">skills</span><span class="p">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">skills</span><span class="p">)</span>
</span><span class='line'>          <span class="n">engineer</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">NSDate</span><span class="p">().</span><span class="n">timeIntervalSince1970</span>
</span><span class='line'>          <span class="c1">// データのアップデート処理</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">addOrUpdateObject</span><span class="p">(</span><span class="n">engineer</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">// 書込みの終了</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">commitWriteTransaction</span><span class="p">()</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 検索結果がない場合</span>
</span><span class='line'>          <span class="c1">// Engineerクラスをインスタンス化</span>
</span><span class='line'>          <span class="n">let</span> <span class="n">newEngineer</span> <span class="o">=</span> <span class="n">Engineer</span><span class="p">()</span>
</span><span class='line'>          <span class="n">newEngineer</span><span class="p">.</span><span class="kt">id</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>          <span class="n">newEngineer</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>          <span class="n">newEngineer</span><span class="p">.</span><span class="n">businessTitle</span> <span class="o">=</span> <span class="s">&quot;新米エンジニア&quot;</span>
</span><span class='line'>          <span class="c1">// Skillsクラスをインスタンス化</span>
</span><span class='line'>          <span class="n">let</span> <span class="n">skills</span> <span class="o">=</span> <span class="n">Skills</span><span class="p">()</span>
</span><span class='line'>          <span class="n">skills</span><span class="p">.</span><span class="n">skill</span> <span class="o">=</span> <span class="s">&quot;Swift&quot;</span>
</span><span class='line'>          <span class="n">newEngineer</span><span class="p">.</span><span class="n">skills</span><span class="p">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">skills</span><span class="p">)</span>
</span><span class='line'>          <span class="n">newEngineer</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">NSDate</span><span class="p">().</span><span class="n">timeIntervalSince1970</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// データの新規作成</span>
</span><span class='line'>          <span class="n">let</span> <span class="n">realm</span> <span class="o">=</span> <span class="n">RLMRealm</span><span class="p">.</span><span class="n">defaultRealm</span><span class="p">()</span>
</span><span class='line'>          <span class="c1">// 書込みの開始</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">beginWriteTransaction</span><span class="p">()</span>
</span><span class='line'>          <span class="c1">// データのインサート処理</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">newEngineer</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">// 書込みの終了</span>
</span><span class='line'>          <span class="n">realm</span><span class="p">.</span><span class="n">commitWriteTransaction</span><span class="p">()</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">override</span> <span class="n">func</span> <span class="n">didReceiveMemoryWarning</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">super</span><span class="p">.</span><span class="n">didReceiveMemoryWarning</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここでは、<code>id=0</code>のデータを検索して、見つからない場合は新規データをインサートし、見つかった場合はデータのアップデートをしています。<br/>
書込みにはトランザクションブロックを使った方法もあるようですが、今回は<code>beginWriteTransaction</code>と<code>commitWriteTransaction</code>を利用しました。</p>

<h5>データの確認</h5>

<p>では、データを作成した後に、そのデータを確認したい場合はどうすれば良いのでしょうか？<br/>
実はMac専用のアプリが提供されています。</p>

<p><a href="https://realm.io/jp/docs/java/latest/">こちらのサイト</a>の <strong>Realm Browser</strong> の項目からインストールしましょう。</p>

<p>Realm Browserを使えば、下記のようにデータを見ることができます。</p>

<p><img src="http://grandbig.github.io/images/swift-realm4.png" alt="Realm Browserで確認１" /><br/>
<img src="http://grandbig.github.io/images/swift-realm5.png" alt="Realm Browserで確認２" /></p>

<p>これからSQLiteよりもRealmの方がスタンダートな保存方法となることでしょう。<br/>
どんどん使い方を勉強していかなくては！！<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OAuth2.0認証をUIWebView&WKWebViewで実施しよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/06/custom-oauth-webview/"/>
    <updated>2015-06-06T23:38:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/06/custom-oauth-webview</id>
    <content type="html"><![CDATA[<h4>最適なWebViewを使って、OAuth2.0認証をしよう！</h4>

<p>本日は、iOSのバージョン毎に最適なWebViewを使ってOAuth2.0認証を実施してみたいと思います。<br/>
やはり、iOS8であればWKWebViewを使いたいですし、iOS7ではUIWebViewしか利用できないという現実があります。</p>

<p>WKWebViewとUIWebViewの使い分け処理に関しては、<a href="http://techblog.yahoo.co.jp/ios/let-uiwebview-as-wkwebview/">let UIWebView as WKWebView</a>を参考にさせて頂きました。<br/>
(あえてObjective-Cで書いています。)</p>

<p>まずは、UIWebViewとWKWebViewの使い分け部分を説明していきます。</p>

<p>共通インターフェースとして<code>WKWebViewProtocol.h</code>を作成します。<br/>
共通化したい処理を書き出しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// WKWebViewProtocol.h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;WebKit/WebKit.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@protocol</span> <span class="nc">WKWebViewProtocol</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">title</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSURL</span> <span class="o">*</span><span class="n">URL</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="n">isLoading</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">loading</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">canGoBack</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">canGoForward</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">loadRequest:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stopLoading</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">evaluateJavaScript:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">javaScriptString</span> <span class="nf">completionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionHandler</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">goBack</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">goForward</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>次にUIWebViewを拡張した<code>UIWebView+ProtocolConfirmed</code>クラスを作成します。<br/>
基本的にWKWebViewに合わせる形で実装していきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// UIWebView+ProtocolConfirmed.h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &quot;WKWebViewProtocol.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">UIWebView</span><span class="nl">(UIWebView_ProtocolConfirmed)</span> <span class="o">&lt;</span><span class="n">WKWebViewProtocol</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// UIWebView+ProtocolConfirmed.m</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;UIWebView+ProtocolConfirmed.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">UIWebView</span><span class="nl">(UIWebView_ProtocolConfirmed)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// NSURLの取得</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nf">URL</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">URLString</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">stringByEvaluatingJavaScriptFromString:</span><span class="s">@&quot;document.URL&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">URLString</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページのタイトルの取得</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">title</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nl">stringByEvaluatingJavaScriptFromString:</span><span class="s">@&quot;document.title&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// JavaScriptの実行処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">evaluateJavaScript:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">javaScriptString</span> <span class="nf">completionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionHandler</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">stringByEvaluatingJavaScriptFromString:</span><span class="n">javaScriptString</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">completionHandler</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">completionHandler</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最後にWKWebView側を実装します。<br/>
と言っても、UIWebViewをWKWebViewに合わせるので、何も書くことはありません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// WKWebView+ProtocolConfirmed.h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;WebKit/WebKit.h&gt;</span>
</span><span class='line'><span class="cp">#import &quot;WKWebViewProtocol.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">WKWebView</span><span class="nl">(WKWebView_ProtocolConfirmed)</span> <span class="o">&lt;</span><span class="n">WKWebViewProtocol</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// WKWebView+ProtocolConfirmed.m</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;WKWebView+ProtocolConfirmed.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">WKWebView</span><span class="nl">(WKWebView_ProtocolConfirmed)</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>では、実際に実装していきましょう。<br/>
OAuth認証の処理に関しては、<a href="http://grandbig.github.io/blog/2015/06/01/custom-oauth/">OAuth2.0認証の処理を自作しよう！</a>を参考にしてください。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;WKWebViewProtocol.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;WKWebView+ProtocolConfirmed.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;UIWebView+ProtocolConfirmed.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;OAuth2Client.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">@&quot;クライアントID&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientSecret</span> <span class="o">=</span> <span class="s">@&quot;クライアントシークレット&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">authorizationURL</span> <span class="o">=</span> <span class="s">@&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">tokenURL</span> <span class="o">=</span> <span class="s">@&quot;https://accounts.google.com/o/oauth2/token&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">scope</span> <span class="o">=</span> <span class="s">@&quot;https://www.googleapis.com/auth/plus.login+https://www.googleapis.com/auth/userinfo.email+https://www.googleapis.com/auth/calendar&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// UIWebViewおよびWKWebView関連のDelegateを読み込む</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span><span class="o">&lt;</span><span class="n">UIWebViewDelegate</span><span class="p">,</span> <span class="n">WKUIDelegate</span><span class="p">,</span> <span class="n">WKNavigationDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// UIWebViewとWKWebViewを一纏めにしたWebViewとして下記を定義</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="n">WKWebViewProtocol</span><span class="o">&gt;</span> <span class="n">webView</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSMutableData</span> <span class="o">*</span><span class="n">receivedData</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">isLogin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// WebViewを画面に追加する処理</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="n">createWebView</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span><span class="p">([</span><span class="n">defaults</span> <span class="nl">boolForKey:</span><span class="s">@&quot;isLogin&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 既にOAuth2.0認証実行済みの場合</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">getRefreshAccessToken:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 成功した場合</span>
</span><span class='line'>          <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">accessToken</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 失敗した場合</span>
</span><span class='line'>          <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 初めてOAuth2.0認証を実行する場合</span>
</span><span class='line'>      <span class="c1">// OAuth2.0認証に必要な各種パラメータの設定</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">setUpOAuth2AccountClientId:</span><span class="n">clientId</span> <span class="nl">clientSecret:</span><span class="n">clientSecret</span> <span class="nl">scope:</span><span class="n">scope</span> <span class="nl">authorizationURL:</span><span class="n">authorizationURL</span> <span class="nl">tokenURL:</span><span class="n">tokenURL</span><span class="p">];</span>
</span><span class='line'>      <span class="c1">// OAuth2.0認証リクエスト</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">requestAccessToAccount:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="n">preparedURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// リクエスト</span>
</span><span class='line'>          <span class="p">[</span><span class="n">_webView</span> <span class="nl">loadRequest:</span><span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span> <span class="n">preparedURL</span><span class="p">]];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// WKWebViewまたはUIWebViewをViewに追加する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">createWebView</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;WKWebView&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// iOS8の場合</span>
</span><span class='line'>      <span class="n">WKWebView</span> <span class="o">*</span><span class="n">wkWebView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WKWebView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">];</span>
</span><span class='line'>      <span class="n">wkWebView</span><span class="p">.</span><span class="n">navigationDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>      <span class="n">wkWebView</span><span class="p">.</span><span class="n">UIDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">wkWebView</span><span class="p">];</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">webView</span> <span class="o">=</span> <span class="n">wkWebView</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// iOS7以下の場合</span>
</span><span class='line'>      <span class="n">UIWebView</span> <span class="o">*</span><span class="n">uiWebView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIWebView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">];</span>
</span><span class='line'>      <span class="n">uiWebView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">uiWebView</span><span class="p">];</span>
</span><span class='line'>      <span class="n">self</span><span class="p">.</span><span class="n">webView</span> <span class="o">=</span> <span class="n">uiWebView</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - UIWebViewDelegate</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページの読込みが開始されたときに呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webViewDidStartLoad:</span><span class="p">(</span><span class="n">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;webViewDidStartLoad&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページを読み終わった後に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webViewDidFinishLoad:</span><span class="p">(</span><span class="n">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;webViewDidFinishLoad&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// エラーが発生したときに呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">didFailLoadWithError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;didFailLoadWithError&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページ遷移する前に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">shouldStartLoadWithRequest:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">navigationType:</span><span class="p">(</span><span class="n">UIWebViewNavigationType</span><span class="p">)</span><span class="nv">navigationType</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;shouldStartLoadWithRequest&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">BOOL</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">checkRedirectURI:</span><span class="n">request</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">getAccessToken:</span><span class="n">request</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">){</span>
</span><span class='line'>          <span class="c1">// 処理が終了したら呼び出される</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">accessToken</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="nl">setBool:</span><span class="n">YES</span> <span class="nl">forKey:</span><span class="s">@&quot;isLogin&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="p">[</span><span class="n">webView</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// ページ遷移しない</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ページ遷移する</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - WKNavigationDelegate</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページの読込みが開始されたときに呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">didStartProvisionalNavigation:</span><span class="p">(</span><span class="n">WKNavigation</span> <span class="o">*</span><span class="p">)</span><span class="nv">navigation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;didStartProvisionalNavigation&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページを読み終わった後に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">didFinishNavigation:</span><span class="p">(</span><span class="n">WKNavigation</span> <span class="o">*</span><span class="p">)</span><span class="nv">navigation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;didFinishNavigation&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// エラーが発生したときに呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">didFailProvisionalNavigation:</span><span class="p">(</span><span class="n">WKNavigation</span> <span class="o">*</span><span class="p">)</span><span class="nv">navigation</span> <span class="nf">withError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;didFailProvisionalNavigation&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ページ遷移する前に呼び出される処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">decidePolicyForNavigationAction:</span><span class="p">(</span><span class="n">WKNavigationAction</span> <span class="o">*</span><span class="p">)</span><span class="nv">navigationAction</span> <span class="nf">decisionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">WKNavigationActionPolicy</span><span class="p">))</span><span class="nv">decisionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;decidePolicyForNavigationAction&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">navigationAction</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">BOOL</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">checkRedirectURI:</span><span class="n">request</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">getAccessToken:</span><span class="n">request</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">){</span>
</span><span class='line'>          <span class="c1">// 処理が終了したら呼び出される</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">accessToken</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="nl">setBool:</span><span class="n">YES</span> <span class="nl">forKey:</span><span class="s">@&quot;isLogin&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="p">[</span><span class="n">webView</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// ページ遷移しない</span>
</span><span class='line'>      <span class="n">decisionHandler</span><span class="p">(</span><span class="n">WKNavigationActionPolicyCancel</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// ページ遷移する</span>
</span><span class='line'>  <span class="n">decisionHandler</span><span class="p">(</span><span class="n">WKNavigationActionPolicyAllow</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>さあ、これでiOS8端末でもiOS7端末でも正しくOAuth認証画面が表示されるかと思います。<br/>
もう今年にはiOS9が発表され、WKWebViewが当然のようになってくるとしたら、UIWebViewは不要になると思いますが、今のところはまだまだ必要でしょう。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AndroidでBackgroundでiBeaconを検知しよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/06/altbeacon-service/"/>
    <updated>2015-06-06T22:00:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/06/altbeacon-service</id>
    <content type="html"><![CDATA[<h4>AltBeaconでiBeacon検知(アプリBG起動編)</h4>

<p>さて、以前、<a href="http://grandbig.github.io/blog/2015/05/16/altbeacon/">AltBeaconを使ってAndroidでiBeaconを検知しよう</a>で基本的な使い方を説明させて頂きました。<br/>
今回はアプリをBackgroundで起動しているときにもiBeaconを検知できるようにしてみようと思います。<br/>
Background起動だけであれば、Applicationクラスを使うことで実現できますが、<br/>
Serviceクラスを使えば、アプリをBackgroundから削除したとしても動作させることができます。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>では早速、ソースコードを見て行きましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// BeaconServiceクラス</span>
</span><span class='line'><span class="c1">// Serviceを拡張し、BootstrapNotifierをインターフェースとしたBeaconServiceクラス</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeaconService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="kd">implements</span> <span class="n">BootstrapNotifier</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">altbeacon</span><span class="o">.</span><span class="na">beacon</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">BeaconService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// iBeaconのデータを認識するためのParserフォーマット</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">IBEACON_FORMAT</span> <span class="o">=</span> <span class="s">&quot;m:2-3=0215,i:4-19,i:20-21,i:22-23,p:24-24&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">// BGで監視するiBeacon領域</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">RegionBootstrap</span> <span class="n">regionBootstrap</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">// iBeacon検知用のマネージャー</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">BeaconManager</span> <span class="n">beaconManager</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">// UUID設定用</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Identifier</span> <span class="n">identifier</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">// iBeacon領域</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Region</span> <span class="n">region</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">// 監視するiBeacon領域の名前</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">beaconName</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// iBeaconのデータを受信できるようにParserを設定</span>
</span><span class='line'>      <span class="n">beaconManager</span> <span class="o">=</span> <span class="n">BeaconManager</span><span class="o">.</span><span class="na">getInstanceForApplication</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">beaconManager</span><span class="o">.</span><span class="na">getBeaconParsers</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">BeaconParser</span><span class="o">().</span><span class="na">setBeaconLayout</span><span class="o">(</span><span class="n">IBEACON_FORMAT</span><span class="o">));</span>
</span><span class='line'>      <span class="c1">// BGでiBeacon領域を監視(モニタリング)するスキャン間隔を設定</span>
</span><span class='line'>      <span class="n">beaconManager</span><span class="o">.</span><span class="na">setBackgroundBetweenScanPeriod</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// UUIDの作成</span>
</span><span class='line'>      <span class="n">identifier</span> <span class="o">=</span> <span class="n">Identifier</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;A56BA1E1-C06E-4C08-8467-DB6F5BD04486&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">// Beacon名の作成</span>
</span><span class='line'>      <span class="n">beaconName</span> <span class="o">=</span> <span class="s">&quot;MyBeacon-000206C6&quot;</span><span class="o">;</span>
</span><span class='line'>      <span class="c1">// major, minorの指定はしない</span>
</span><span class='line'>      <span class="n">region</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Region</span><span class="o">(</span><span class="n">beaconName</span><span class="o">,</span> <span class="n">identifier</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>      <span class="n">regionBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegionBootstrap</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">region</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">beaconManager</span><span class="o">.</span><span class="na">setRangeNotifier</span><span class="o">(</span><span class="k">new</span> <span class="n">RangeNotifier</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">didRangeBeaconsInRegion</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Beacon</span><span class="o">&gt;</span> <span class="n">beacons</span><span class="o">,</span> <span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// 検出したビーコンの情報を全部Logに書き出す</span>
</span><span class='line'>              <span class="k">for</span><span class="o">(</span><span class="n">Beacon</span> <span class="n">beacon</span> <span class="o">:</span> <span class="n">beacons</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;UUID:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId1</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, major:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId2</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, minor:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getId3</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, Distance:&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getDistance</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;,RSSI&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getRssi</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, TxPower&quot;</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">.</span><span class="na">getTxPower</span><span class="o">());</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">});</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">onStartCommand</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onStartCommand</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">startId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">didEnterRegion</span><span class="o">(</span><span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// 領域侵入</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Enter Region&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="c1">// アプリをFG起動させる</span>
</span><span class='line'>      <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="n">intent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
</span><span class='line'>      <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// レンジング開始</span>
</span><span class='line'>          <span class="n">beaconManager</span><span class="o">.</span><span class="na">startRangingBeaconsInRegion</span><span class="o">(</span><span class="n">region</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// 例外が発生した場合</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">didExitRegion</span><span class="o">(</span><span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// 領域退出</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Exit Region&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// レンジング停止</span>
</span><span class='line'>          <span class="n">beaconManager</span><span class="o">.</span><span class="na">stopRangingBeaconsInRegion</span><span class="o">(</span><span class="n">region</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// 例外が発生した場合</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">didDetermineStateForRegion</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">Region</span> <span class="n">region</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// 領域に対する状態が変化</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Determine State: &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>領域進入時にアプリをFG起動</strong> させているので、アプリがFG起動したらiBeacon領域に侵入したと言えます。<br/>
さあ、これでiOSとほぼ同じ挙動を実現できました。</p>

<p>蛇足かもしれませんが、<code>MainActivity.java</code>でサービスを起動する部分も書いておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// MainActivity.java</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">ActionBarActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// サービス起動</span>
</span><span class='line'>      <span class="n">startService</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">BeaconService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">省略</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ソースコードは<a href="https://github.com/grandbig/altBeaconSample/tree/service">こちら</a>から。<br/>
serviceブランチを参照ください。</p>

<p>といったところで本日はここまで。</p>

<p>参考:<br/>
<a href="http://dev.classmethod.jp/smartphone/android-beacon-library-introduction-5/">[Android][iBeacon] Android Beacon Library パラっと解説 その5 [バックグラウンド領域監視]</a></p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OAuth2.0認証の処理を自作しよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/06/01/custom-oauth/"/>
    <updated>2015-06-01T00:56:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/06/01/custom-oauth</id>
    <content type="html"><![CDATA[<h4>OAuth2.0認証処理を自分で作ろう！ Objective-C編</h4>

<p>本日は、<a href="https://code.google.com/p/gtm-oauth2/">gtm-oauth</a>や<a href="https://github.com/nxtbgthng/OAuth2Client">OAuth2Client</a>を使わずにOAuth2.0認証処理を自作してみます。</p>

<p>OAuth2.0認証を通すためのGoogle設定は<a href="http://grandbig.github.io/blog/2014/07/13/ios-google-oauth2/">iOSでGoogle OAuth認証がしたい</a>を参照ください。<br/>
筆者が開発したライブラリは単純な下記処理のみ含んでいます。</p>

<ul>
<li>OAuth2.0認証に必要な各種パラメータをKeychain Servicesに保存</li>
<li>アクセストークンを取得する処理</li>
<li>リフレッシュトークンから新規アクセストークンを取得する処理</li>
</ul>


<p>ここで、Keychain Servicesを使うにあたって、<a href="https://github.com/TheLevelUp/LUKeychainAccess">LUKeychainAccess</a>を利用しています。<br/>
これにより、複雑なKeychain ServicesをNSUserDefaultsの感覚で利用することができます。<br/>
また、Googleへの問い合わせなどのHTTP/HTTPSリクエストに<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>を利用しています。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h4>OAuth2.0認証ライブラリの作成</h4>

<p>下記にソースをそのまま載せておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// OAuth2Client.m</span>
</span><span class='line'><span class="cp">#import &quot;OAuth2Client.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;LUKeychainAccess.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;AFNetworking.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">callback</span> <span class="o">=</span>  <span class="s">@&quot;http://localhost&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">visibleactions</span> <span class="o">=</span> <span class="s">@&quot;http://schemas.google.com/AddActivity&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">OAuth2Client</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// シングルトンのインスタンス取得</span>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">OAuth2Client</span> <span class="o">*</span><span class="p">)</span><span class="nf">sharedInstance</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="n">OAuth2Client</span><span class="o">*</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class='line'>  <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>      <span class="n">sharedInstance</span> <span class="o">=</span> <span class="p">[</span><span class="n">OAuth2Client</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];]</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">sharedInstance</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OAuth2.0認証に必要なパラメータを設定する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setUpOAuth2AccountClientId:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span> <span class="nf">clientSecret:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientSecret</span> <span class="nf">scope:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">scope</span> <span class="nf">authorizationURL:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">authorizationURL</span> <span class="nf">tokenURL:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tokenURL</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">clientId</span> <span class="nl">forKey:</span><span class="s">@&quot;clientId&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">clientSecret</span> <span class="nl">forKey:</span><span class="s">@&quot;clientSecret&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">scope</span> <span class="nl">forKey:</span><span class="s">@&quot;scope&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">authorizationURL</span> <span class="nl">forKey:</span><span class="s">@&quot;authorizationURL&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">tokenURL</span> <span class="nl">forKey:</span><span class="s">@&quot;tokenURL&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OAuth2.0認証に必要なリクエストを生成する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">requestAccessToAccount:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSURL</span> <span class="o">*</span><span class="n">preparedURL</span><span class="p">))</span><span class="nv">withPreparedAuthorizationURLHandler</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">clientId</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;clientId&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">scope</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;scope&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">authorizationURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;authorizationURL&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%@?response_type=code&amp;client_id=%@&amp;redirect_uri=%@&amp;scope=%@&amp;data-requestvisibleactions=%@&quot;</span><span class="p">,</span> <span class="n">authorizationURL</span><span class="p">,</span> <span class="n">clientId</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">visibleactions</span><span class="p">];</span>
</span><span class='line'>  <span class="n">withPreparedAuthorizationURLHandler</span><span class="p">([</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">url</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OAuth2.0認証のリダイレクトURIの一致の有無を確認する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">checkRedirectURI:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// HOSTの取得</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">[[</span><span class="n">request</span> <span class="n">URL</span><span class="p">]</span> <span class="n">host</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">host</span> <span class="nl">isEqualToString:</span><span class="s">@&quot;localhost&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// アクセストークンを取得する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getAccessToken:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">completionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">))</span><span class="nv">completionHandler</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">[[</span><span class="n">request</span> <span class="n">URL</span><span class="p">]</span> <span class="n">host</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">host</span> <span class="nl">isEqualToString:</span><span class="s">@&quot;localhost&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSString</span><span class="o">*</span> <span class="n">verifier</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>      <span class="n">NSArray</span><span class="o">*</span> <span class="n">urlParams</span> <span class="o">=</span> <span class="p">[[</span><span class="n">request</span> <span class="n">URL</span><span class="p">]</span> <span class="n">query</span><span class="p">]</span> <span class="nl">componentsSeparatedByString:</span><span class="s">@&quot;&amp;&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">NSString</span><span class="o">*</span> <span class="n">param</span> <span class="k">in</span> <span class="n">urlParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">NSArray</span><span class="o">*</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="nl">componentsSeparatedByString:</span><span class="s">@&quot;=&quot;</span><span class="p">];</span>
</span><span class='line'>          <span class="n">NSString</span><span class="o">*</span> <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyValue</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">([</span><span class="n">key</span> <span class="nl">isEqualToString:</span><span class="s">@&quot;code&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">verifier</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyValue</span> <span class="nl">objectAtIndex:</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">verifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">NSString</span> <span class="o">*</span><span class="n">clientId</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;clientId&quot;</span><span class="p">];</span>
</span><span class='line'>          <span class="n">NSString</span> <span class="o">*</span><span class="n">clientSecret</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;clientSecret&quot;</span><span class="p">];</span>
</span><span class='line'>          <span class="n">NSString</span> <span class="o">*</span><span class="n">tokenURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;tokenURL&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// AFHTTPSessionManagerをインスタンス化</span>
</span><span class='line'>          <span class="n">AFHTTPSessionManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="n">manager</span><span class="p">];</span>
</span><span class='line'>          <span class="c1">// サーバエラー時のContent-Typeにtext/plainを許可(成功時にapplication/jsonが必要なので共に追加)</span>
</span><span class='line'>          <span class="n">manager</span><span class="p">.</span><span class="n">responseSerializer</span><span class="p">.</span><span class="n">acceptableContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithObjects:</span><span class="s">@&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">@&quot;application/json&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>          <span class="c1">// パラメータの設定</span>
</span><span class='line'>          <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;code&quot;</span><span class="o">:</span> <span class="n">verifier</span><span class="p">,</span> <span class="s">@&quot;client_id&quot;</span><span class="o">:</span> <span class="n">clientId</span><span class="p">,</span> <span class="s">@&quot;client_secret&quot;</span><span class="o">:</span> <span class="n">clientSecret</span><span class="p">,</span> <span class="s">@&quot;redirect_uri&quot;</span><span class="o">:</span> <span class="n">callback</span><span class="p">,</span> <span class="s">@&quot;grant_type&quot;</span><span class="o">:</span> <span class="s">@&quot;authorization_code&quot;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>          <span class="p">[</span><span class="n">manager</span> <span class="nl">POST:</span><span class="n">tokenURL</span> <span class="nl">parameters:</span><span class="n">data</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// 成功した場合</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="n">responseObject</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span> <span class="o">=</span> <span class="n">responseObject</span><span class="p">[</span><span class="s">@&quot;access_token&quot;</span><span class="p">];</span>
</span><span class='line'>                  <span class="n">NSString</span> <span class="o">*</span><span class="n">refreshToken</span> <span class="o">=</span> <span class="n">responseObject</span><span class="p">[</span><span class="s">@&quot;refresh_token&quot;</span><span class="p">];</span>
</span><span class='line'>                  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">accessToken</span> <span class="nl">forKey:</span><span class="s">@&quot;accessToken&quot;</span><span class="p">];</span>
</span><span class='line'>                  <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">refreshToken</span> <span class="nl">forKey:</span><span class="s">@&quot;refreshToken&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>                  <span class="c1">// 処理が終了したときに実行(アクセストークンを返す)</span>
</span><span class='line'>                  <span class="n">completionHandler</span><span class="p">(</span><span class="n">accessToken</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// 失敗した場合</span>
</span><span class='line'>              <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
</span><span class='line'>              <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span> <span class="n">userInfo</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;com.alamofire.serialization.response.error.data&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// エラーの中身がある場合</span>
</span><span class='line'>                  <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">data</span> <span class="nl">options:</span><span class="n">NSJSONReadingAllowFragments</span> <span class="nl">error:</span><span class="o">&amp;</span><span class="n">err</span><span class="p">];</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="c1">// 失敗を返す</span>
</span><span class='line'>              <span class="n">failure</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// HOST名が一致しない場合</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// リフレッシュトークンから新しいアクセストークンを取得する処理</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getRefreshAccessToken:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">))</span><span class="nv">success</span> <span class="nf">failure:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">))</span><span class="nv">failure</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">clientId</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;clientId&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">tokenURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;tokenURL&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">refreshToken</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;refreshToken&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">clientId</span> <span class="o">&amp;&amp;</span> <span class="n">tokenURL</span> <span class="o">&amp;&amp;</span> <span class="n">refreshToken</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 必須パラメータがある場合</span>
</span><span class='line'>      <span class="c1">// AFHTTPSessionManagerをインスタンス化</span>
</span><span class='line'>      <span class="n">AFHTTPSessionManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="n">manager</span><span class="p">];</span>
</span><span class='line'>      <span class="c1">// サーバエラー時のContent-Typeにtext/plainを許可(成功時にapplication/jsonが必要なので共に追加)</span>
</span><span class='line'>      <span class="n">manager</span><span class="p">.</span><span class="n">responseSerializer</span><span class="p">.</span><span class="n">acceptableContentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithObjects:</span><span class="s">@&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">@&quot;application/json&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// パラメータの設定</span>
</span><span class='line'>      <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;client_id&quot;</span><span class="o">:</span> <span class="n">clientId</span><span class="p">,</span> <span class="s">@&quot;refresh_token&quot;</span><span class="o">:</span> <span class="n">refreshToken</span><span class="p">,</span> <span class="s">@&quot;grant_type&quot;</span><span class="o">:</span> <span class="s">@&quot;refresh_token&quot;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">[</span><span class="n">manager</span> <span class="nl">POST:</span><span class="n">tokenURL</span> <span class="nl">parameters:</span><span class="n">data</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 成功した場合</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">responseObject</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span> <span class="o">=</span> <span class="n">responseObject</span><span class="p">[</span><span class="s">@&quot;access_token&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="n">NSString</span> <span class="o">*</span><span class="n">refreshToken</span> <span class="o">=</span> <span class="n">responseObject</span><span class="p">[</span><span class="s">@&quot;refresh_token&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">accessToken</span> <span class="nl">forKey:</span><span class="s">@&quot;accessToken&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[[</span><span class="n">LUKeychainAccess</span> <span class="n">standardKeychainAccess</span><span class="p">]</span> <span class="nl">setObject:</span><span class="n">refreshToken</span> <span class="nl">forKey:</span><span class="s">@&quot;refreshToken&quot;</span><span class="p">];</span>
</span><span class='line'>              
</span><span class='line'>              <span class="c1">// 処理が終了したときに実行(アクセストークンを返す)</span>
</span><span class='line'>              <span class="n">success</span><span class="p">(</span><span class="n">accessToken</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span> <span class="n">failure</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 失敗した場合</span>
</span><span class='line'>          <span class="n">NSError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
</span><span class='line'>          <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span> <span class="n">userInfo</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;com.alamofire.serialization.response.error.data&quot;</span><span class="p">];</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// エラーの中身がある場合</span>
</span><span class='line'>              <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">data</span> <span class="nl">options:</span><span class="n">NSJSONReadingAllowFragments</span> <span class="nl">error:</span><span class="o">&amp;</span><span class="n">err</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="c1">// 失敗を返す</span>
</span><span class='line'>          <span class="n">failure</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 必須パラメータがない場合</span>
</span><span class='line'>      <span class="c1">// TODO: エラーオブジェクトを生成して返す</span>
</span><span class='line'>      <span class="n">failure</span><span class="p">(</span><span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// OAuth2Client.h</span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">OAuth2Client</span> : <span class="nc">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// シングルトンのインスタンス取得</span>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">OAuth2Client</span> <span class="o">*</span><span class="p">)</span><span class="nf">sharedInstance</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> OAuth2.0認証に必要なパラメータを設定する処理</span>
</span><span class='line'><span class="cm"> @param clientId クライアントID</span>
</span><span class='line'><span class="cm"> @param clientSecret クライアントシークレット</span>
</span><span class='line'><span class="cm"> @param scope アクセス範囲</span>
</span><span class='line'><span class="cm"> @param authorizationURL OAuth2.0 認証先URL</span>
</span><span class='line'><span class="cm"> @param tokenURL OAuth2.0 トークン取得先URL</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setUpOAuth2AccountClientId:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientId</span> <span class="nf">clientSecret:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">clientSecret</span> <span class="nf">scope:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">scope</span> <span class="nf">authorizationURL:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">authorizationURL</span> <span class="nf">tokenURL:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">tokenURL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> OAuth2.0認証に必要なリクエストを生成する処理</span>
</span><span class='line'><span class="cm"> @param withPreparedAuthorizationURLHandler OAuth2.0認証に必要なリクエストを返すBlock構文</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">requestAccessToAccount:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSURL</span> <span class="o">*</span><span class="n">preparedURL</span><span class="p">))</span><span class="nv">withPreparedAuthorizationURLHandler</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> OAuth2.0認証のリダイレクトURIの一致の有無を確認する処理</span>
</span><span class='line'><span class="cm"> @param request リクエスト</span>
</span><span class='line'><span class="cm"> @return リダイレクトURIの一致の有無</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">checkRedirectURI:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> アクセストークンを取得する処理</span>
</span><span class='line'><span class="cm"> @param request アクセストークンの取得に必要なリクエスト</span>
</span><span class='line'><span class="cm"> @param completionHandler アクセストークンの取得処理が完了したら実行される処理</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getAccessToken:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">completionHandler:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">))</span><span class="nv">completionHandler</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> リフレッシュトークンから新しいアクセストークンを取得する処理</span>
</span><span class='line'><span class="cm"> @param success 処理が成功した場合に実行(返却データはアクセストークン)</span>
</span><span class='line'><span class="cm"> @param failure 処理が失敗した場合に実行(返却データはエラーオブジェクト)</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getRefreshAccessToken:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">))</span><span class="nv">success</span> <span class="nf">failure:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">))</span><span class="nv">failure</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>呼び出し側のソース</h4>

<p>呼び出し側のソースを記載します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// ViewController.m</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;OAuth2Client.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">@&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">clientSecret</span> <span class="o">=</span> <span class="s">@&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">authorizationURL</span> <span class="o">=</span> <span class="s">@&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">tokenURL</span> <span class="o">=</span> <span class="s">@&quot;https://accounts.google.com/o/oauth2/token&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">scope</span> <span class="o">=</span> <span class="s">@&quot;https://www.googleapis.com/auth/plus.login+https://www.googleapis.com/auth/userinfo.email+https://www.googleapis.com/auth/calendar&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span><span class="o">&lt;</span><span class="n">UIWebViewDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">UIWebView</span> <span class="o">*</span><span class="n">webView</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSMutableData</span> <span class="o">*</span><span class="n">receivedData</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">isLogin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_webView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span><span class="p">([</span><span class="n">defaults</span> <span class="nl">boolForKey:</span><span class="s">@&quot;isLogin&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 既にOAuth2.0認証実行済みの場合</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">getRefreshAccessToken:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 成功した場合</span>
</span><span class='line'>          <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">accessToken</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// 失敗した場合</span>
</span><span class='line'>          <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 初めてOAuth2.0認証を実行する場合</span>
</span><span class='line'>      <span class="c1">// OAuth2.0認証に必要な各種パラメータの設定</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">setUpOAuth2AccountClientId:</span><span class="n">clientId</span> <span class="nl">clientSecret:</span><span class="n">clientSecret</span> <span class="nl">scope:</span><span class="n">scope</span> <span class="nl">authorizationURL:</span><span class="n">authorizationURL</span> <span class="nl">tokenURL:</span><span class="n">tokenURL</span><span class="p">];</span>
</span><span class='line'>      <span class="c1">// OAuth2.0認証リクエスト</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">requestAccessToAccount:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="n">preparedURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// リクエスト</span>
</span><span class='line'>          <span class="p">[</span><span class="n">_webView</span> <span class="nl">loadRequest:</span><span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span> <span class="n">preparedURL</span><span class="p">]];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">webView:</span><span class="p">(</span><span class="n">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="nv">webView</span> <span class="nf">shouldStartLoadWithRequest:</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">navigationType:</span><span class="p">(</span><span class="n">UIWebViewNavigationType</span><span class="p">)</span><span class="nv">navigationType</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">([</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">checkRedirectURI:</span><span class="n">request</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[[</span><span class="n">OAuth2Client</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="nl">getAccessToken:</span><span class="n">request</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">accessToken</span><span class="p">){</span>
</span><span class='line'>          <span class="c1">// 処理が終了したら呼び出される</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">accessToken</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="nl">setBool:</span><span class="n">YES</span> <span class="nl">forKey:</span><span class="s">@&quot;isLogin&quot;</span><span class="p">];</span>
</span><span class='line'>              <span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="p">[</span><span class="n">webView</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで簡単ですが、OAuth2.0認証の自作ライブラリの開発が完了です。<br/>
必要最低限の機能ですが、十分だと思います。<br/>
(もう少し時間をかけてより良いものを作りたいと思います笑。)</p>

<p>参考:</p>

<ul>
<li><a href="http://technogerms.com/login-with-google-using-oauth-2-0-for-ios-xcode-objective-c/">Login with Google using OAuth 2.0 for iOS Xcode Objective-C</a></li>
<li><a href="http://www.ari-hiro.com/blog/2012/12/30/oauth2-summary">OAuth2.0の備忘録的まとめ</a></li>
<li><a href="http://qiita.com/asakahara/items/06abbc0209262d0051ef">iOSでアプリを削除してもデータを保持する方法</a></li>
</ul>


<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android Studioでvolley frameworkを利用するまで]]></title>
    <link href="http://grandbig.github.io/blog/2015/05/24/android-volley/"/>
    <updated>2015-05-24T20:50:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/05/24/android-volley</id>
    <content type="html"><![CDATA[<h4>volley frameworkを使ったプロジェクトをGitHubにアップする</h4>

<p>本日はAndroidについて書きます。<br/>
Androidアプリを開発する上で、通信系のframeworkを使うなら、<a href="https://android.googlesource.com/platform/frameworks/volley">volley framework</a>を選択すると思います。<br/>
非常に便利なframworkである反面、導入が面倒だったりします。<br/>
筆者はiOSエンジニアなので、<a href="https://cocoapods.org/">CocoaPods</a>をよく使うのですが、如何に便利なツールなのかがよくわかりました笑</p>

<h5>プロジェクトの作成</h5>

<p>まずは、Android Studioでプロジェクトを作成して、GitHubにアップしましょう。</p>

<ol>
<li>Android Studioでプロジェクトを作成(VolleySampleを作成)</li>
<li>GitHubで新規repogitoryを作成</li>
<li>Android Studioのプロジェクトのルート(VolleySample/)配下に移動して、下記コマンドを実行しましょう。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">echo</span> <span class="s">&quot;# VolleySample&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">README</span><span class="o">.</span><span class="na">md</span>
</span><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">init</span>
</span><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
</span><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s">&quot;first commit&quot;</span>
</span><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">origin</span> <span class="nl">https:</span><span class="c1">//github.com/grandbig/VolleySample.git</span>
</span><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">push</span> <span class="o">-</span><span class="n">u</span> <span class="n">origin</span> <span class="n">master</span>
</span></code></pre></td></tr></table></div></figure>


<p>下記のようになればOKです。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p><img src="http://grandbig.github.io/images/android-volley-1.png" alt="プロジェクトをGitHubにアップ" /></p>

<h5>volleyの導入</h5>

<p>次にvolley frameworkを自身のプロジェクトに導入します。<br/>
導入にはgit submoduleを使います。</p>

<p>先ほど作成したAndroid Studioプロジェクトのルート(VolleySample/)配下で下記コマンドを実行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">add</span> <span class="nl">https:</span><span class="c1">//android.googlesource.com/platform/frameworks/volley modules/volley</span>
</span></code></pre></td></tr></table></div></figure>


<p>これにより、VolleySample/.gitmodulesが作成されます。<br/>
中身はというと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">[</span><span class="n">submodule</span> <span class="s">&quot;modules/volley&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">modules</span><span class="o">/</span><span class="n">volley</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="nl">https:</span><span class="c1">//android.googlesource.com/platform/frameworks/volley</span>
</span></code></pre></td></tr></table></div></figure>


<p>になっているはずです。
続いて、<code>settings.gradle(Project Settings)</code>に下記1行を追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">include</span> <span class="err">&#39;</span><span class="o">:</span><span class="nl">modules:</span><span class="n">volley</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://grandbig.github.io/images/android-volley-2.png" alt="settings.gradleの設定" /></p>

<p>そして、<code>build.gradle(Module: app)</code>の<code>dependencies</code>に1行追加しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="err">&#39;</span><span class="n">libs</span><span class="err">&#39;</span><span class="o">,</span> <span class="nl">include:</span> <span class="o">[</span><span class="err">&#39;</span><span class="o">*.</span><span class="na">jar</span><span class="err">&#39;</span><span class="o">])</span>
</span><span class='line'>  <span class="n">compile</span> <span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">support</span><span class="o">:</span><span class="n">appcompat</span><span class="o">-</span><span class="nl">v7:</span><span class="mf">21.0</span><span class="o">.</span><span class="mi">3</span><span class="err">&#39;</span>
</span><span class='line'>  <span class="n">compile</span> <span class="nf">project</span><span class="o">(</span><span class="err">&#39;</span><span class="o">:</span><span class="nl">modules:</span><span class="n">volley</span><span class="err">&#39;</span><span class="o">)</span> <span class="o">....</span> <span class="err">ここを追加しましょう</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://grandbig.github.io/images/android-volley-3.png" alt="build.gradleの設定" /></p>

<p>ここまできたら、一旦、GradleをSyncさせましょう。<br/>
足りないものがあればインストールを求められるはずなので、その場合はインストールしておきましょう。</p>

<p>では、GitHubにこれまでの作業分を更新させましょう。</p>

<p><img src="http://grandbig.github.io/images/android-volley-4.png" alt="volleyを追加した状態でGitHubにアップ" /></p>

<h5>volleyの利用</h5>

<p>実際にvolleyを使ってみましょう。<br/>
<a href="http://grandbig.github.io/blog/2015/05/24/swift-alamofire1/">Swift Alamofireライブラリを使ってみよう！</a>と<a href="http://grandbig.github.io/blog/2015/05/24/swift-afnetworking/">Swift AFNetworkingライブラリを使ってみよう！</a>で例として使ったOpen Weather Map APIをここでも利用します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// MainActivity.java</span>
</span><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">takahiro</span><span class="o">.</span><span class="na">volleysample</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.support.v7.app.ActionBarActivity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.Menu</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.MenuItem</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.Request</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.RequestQueue</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.VolleyError</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.Response</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.toolbox.JsonObjectRequest</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.android.volley.toolbox.Volley</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">ActionBarActivity</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="n">RequestQueue</span> <span class="n">mRequestQueue</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">mRequestQueue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mRequestQueue</span> <span class="o">=</span> <span class="n">Volley</span><span class="o">.</span><span class="na">newRequestQueue</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// URLの指定</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://api.openweathermap.org/data/2.5/weather?q=Tokyo,jp&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">mRequestQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonObjectRequest</span><span class="o">(</span><span class="n">Request</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Response</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">JSONObject</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="o">(</span><span class="n">JSONObject</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// 通信に成功した場合</span>
</span><span class='line'>              <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;VolleySample&quot;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">},</span> <span class="k">new</span> <span class="n">Response</span><span class="o">.</span><span class="na">ErrorListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="nd">@Override</span>
</span><span class='line'>          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="o">(</span><span class="n">VolleyError</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// エラーが発生した場合</span>
</span><span class='line'>              <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;VolleySample&quot;</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">});</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">省略</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因みに、<code>AndroidManifest.xml</code>にインターネットの通信許可を与えることを忘れずに。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// AndroidManifest.xml</span>
</span><span class='line'><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">manifest</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="n">package</span><span class="o">=</span><span class="s">&quot;com.example.takahiro.volleysample&quot;</span> <span class="o">&gt;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">application</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">省略</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;/</span><span class="n">application</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">manifest</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>無事、通信が成功しましたね！<br/>
ってところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swift AFNetworkingライブラリを使ってみよう！]]></title>
    <link href="http://grandbig.github.io/blog/2015/05/24/swift-afnetworking/"/>
    <updated>2015-05-24T10:53:00+09:00</updated>
    <id>http://grandbig.github.io/blog/2015/05/24/swift-afnetworking</id>
    <content type="html"><![CDATA[<h4>通信系ライブラリAFNetworkingの使い方を覚えよう！</h4>

<p>さて、本日はObjective-Cの超有名通信系ライブラリの<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>をSwiftで使ってみようと思います。</p>

<h5>導入の仕方</h5>

<p>まずは導入の仕方を見て行きましょう。<br/>
CocoaPodsを使います。<br/>
Podfileを作成し、下記の内容を記載しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">platform</span> <span class="o">:</span><span class="n">ios</span><span class="p">,</span> <span class="err">&#39;</span><span class="mf">7.0</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">pod</span> <span class="s">&quot;AFNetworking&quot;</span><span class="p">,</span> <span class="s">&quot;~&gt; 2.0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで<code>pod install</code>すればプロジェクトに <strong>AFNetworking</strong> が追加されるはずです。<br/>
ここで注意したいのが、あくまでもObjective-Cで書かれたライブラリなので、Swiftで使うためにはBridgeファイルを用意する必要があります。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<ol>
<li>プロジェクトにヘッダーファイルを追加します。
ProjectName-Bridging-Header.hという形式が推奨されている模様<br/>
今回はSwiftSample-Bridging-Header.hという名前で追加しました。</li>
<li>TARGETS > SwiftSample > Build Settings > Swift Compiler &ndash; Code Generation > Objective-C Bridging Headerにパスを指定
SwiftSample/SwiftSample-Bridging-Header.hを指定しました。</li>
<li>Bridgeファイルにライブラリを<code>import</code>する</li>
<li>ライブラリを利用するファイルにも<code>import</code>を書きましょう(Swiftの書き方で。)</li>
</ol>


<p>下記の画像を参照ください。
<img src="http://grandbig.github.io/images/swift-afnetworking.png" alt="Bridgeファイルの用意" /></p>

<p>また、Bridgeファイルへの具体的な内容を書いておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#ifndef SwiftSample_SwiftSample_Bridging_Header_h</span>
</span><span class='line'><span class="cp">#define SwiftSample_SwiftSample_Bridging_Header_h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;AFNetworking/AFNetworking.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>GETリクエスト</h5>

<p>では、早速、GETリクエストを書いてみましょう。<br/>
以前の<a href="http://grandbig.github.io/blog/2015/02/12/afnetworking/">AFNetworking2.xでWeb-APIを叩いてみた！</a>でも利用した <strong>OpenWeatherMap API</strong> を例として使います。</p>

<p><code>http://api.openweathermap.org/data/2.5/weather?q=Tokyo,jp</code>でリクエストして、<br/>
下記のデータを返してもらうことを想定しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nl">base:</span>  <span class="s">&quot;stations&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">clouds:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nl">all:</span> <span class="mi">32</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nl">cod:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">coord:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nl">lat:</span> <span class="mf">35.69</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">lon:</span> <span class="mf">139.65</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nl">dt:</span> <span class="mi">1432394992</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">id</span><span class="o">:</span> <span class="mi">1850147</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">main:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nl">grnd_level:</span> <span class="mf">1019.97</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">humidity:</span> <span class="mi">88</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">pressure:</span> <span class="mf">1019.97</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">sea_level:</span> <span class="mf">1024.92</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">temp:</span> <span class="mf">290.99</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">temp_max:</span> <span class="mf">290.99</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">temp_min:</span> <span class="mf">290.99</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nl">name:</span> <span class="n">Tokyo</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">sys:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nl">country:</span> <span class="s">&quot;JP&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">message:</span> <span class="mf">0.0386</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">sunrise:</span> <span class="mi">1432323041</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">sunset:</span> <span class="mi">1432374314</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nl">weather:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="nl">description:</span> <span class="s">&quot;scattered clouds&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nl">icon:</span> <span class="s">&quot;03n&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="kt">id</span><span class="o">:</span> <span class="mi">802</span><span class="p">,</span>
</span><span class='line'>          <span class="nl">main:</span> <span class="s">&quot;Clouds&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nl">wind:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nl">deg:</span> <span class="mf">198.001</span><span class="p">,</span>
</span><span class='line'>      <span class="nl">speed:</span> <span class="mf">5.11</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>では、GETリクエストを投げてみましょう。<br/>
返却されたデータの取得方法についても記載します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// GETリクエスト</span>
</span><span class='line'><span class="n">let</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">AFHTTPSessionManager</span><span class="p">()</span>
</span><span class='line'><span class="n">manager</span><span class="p">.</span><span class="n">GET</span><span class="p">(</span><span class="s">&quot;http://api.openweathermap.org/data/2.5/weather?q=Tokyo,jp&quot;</span><span class="p">,</span> <span class="nl">parameters:</span> <span class="nb">nil</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">success:</span> <span class="p">{</span> <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span> <span class="k">in</span>
</span><span class='line'>      <span class="c1">// 処理が成功した場合</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">json</span> <span class="n">as</span><span class="o">!</span> <span class="p">[</span><span class="nl">String:</span> <span class="n">AnyObject</span><span class="p">]</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">weatherArray</span> <span class="o">=</span> <span class="n">dict</span><span class="p">[</span><span class="s">&quot;weather&quot;</span><span class="p">]</span> <span class="n">as</span><span class="o">!</span> <span class="p">[</span><span class="n">AnyObject</span><span class="p">]</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">weather</span> <span class="o">=</span> <span class="n">weatherArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">as</span><span class="o">!</span> <span class="p">[</span><span class="nl">String:</span> <span class="n">AnyObject</span><span class="p">]</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">description</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="s">&quot;description&quot;</span><span class="p">]</span> <span class="n">as</span><span class="o">!</span> <span class="n">String</span>
</span><span class='line'>      <span class="n">println</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'>  <span class="p">},</span> <span class="nl">failure:</span> <span class="p">{</span> <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span> <span class="k">in</span>
</span><span class='line'>      <span class="c1">// エラーが発生した場合</span>
</span><span class='line'>  <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Objective-Cでは下記のように書いていたので、対応づけて見るとわかりやすいかもしれません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">AFHTTPSessionManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFHTTPSessionManager</span> <span class="n">manager</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">manager</span><span class="p">.</span><span class="nl">GET:</span><span class="s">@&quot;http://api.openweathermap.org/data/2.5/weather?q=Tokyo,jp&quot;</span><span class="p">,</span> <span class="nl">parameters:</span> <span class="nb">nil</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSArray</span> <span class="o">*</span><span class="n">weatherArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="nl">objectForKey:</span><span class="s">@&quot;weather&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">weather</span> <span class="o">=</span> <span class="p">[</span><span class="n">weatherArray</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSString</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="n">weather</span> <span class="nl">objectForKey:</span><span class="s">@&quot;description&quot;</span><span class="p">];</span>
</span><span class='line'>      <span class="n">NSLog</span><span class="p">(</span><span class="n">description</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// エラーが発生した場合</span>
</span><span class='line'>  <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>success</code>と<code>failure</code>は戻り値が<code>void</code>なので、Swiftでも<code>-&gt; Void</code>と指定しています。<br/>
<code>[String: AnyObject]</code>は <strong>keyがString型</strong> で <strong>valueがAnyObject(何でもあり)型</strong> のDictionary型への変換で、<br/>
<code>[AnyObject]</code>は <strong>要素がAnyObject(何でもあり)型</strong> のArray型への変換です。</p>

<p>Alamofireとはやはり違った書き方となるので、iOSのターゲットなど要件に従って使い分けていくのが良いでしょう。<br/>
と言ったところで本日はここまで。</p>

<script async src="http://grandbig.github.io//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

]]></content>
  </entry>
  
</feed>
