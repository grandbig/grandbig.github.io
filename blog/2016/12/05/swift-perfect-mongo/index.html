
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Server Side SwiftでMongoDBと遊んでみる - Takahiro Octopress Blog</title>
  <meta name="author" content="Takahiro">

  
  <meta name="description" content="はじめに こちらはSwift その2 Advent Calendar 2016 5日目の記事です。
今年は筆者が興味を持っている Server Side Swift について書きたいと思います。
Swiftサーバを立てるために、以前の記事でも利用したPerfectを使います。 &hellip;">
  
  <meta name="google-site-verification" content="h2JWV1Gq5wVvtkoCC7o7IEPIVqaLWigK5aaxuRom6os" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://grandbig.github.io/blog/2016/12/05/swift-perfect-mongo/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Takahiro Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44313398-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Takahiro Octopress Blog</a></h1>
  
    <h2>-1から始める情弱プログラミング</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:grandbig.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Server Side SwiftでMongoDBと遊んでみる</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-05T00:00:00+09:00" pubdate data-updated="true">Dec 5<span>th</span>, 2016</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>はじめに</h3>

<p>こちらは<a href="http://qiita.com/advent-calendar/2016/swift2">Swift その2 Advent Calendar 2016</a> 5日目の記事です。<br/>
今年は筆者が興味を持っている <strong>Server Side Swift</strong> について書きたいと思います。
Swiftサーバを立てるために、<a href="http://grandbig.github.io/blog/2016/10/30/swift-perfect/">以前の記事</a>でも利用した<a href="https://github.com/PerfectlySoft/Perfect">Perfect</a>を使います。</p>

<p>ただ単にSwiftサーバを立てても面白くないので、提供されているMongoDB接続モジュールを利用して遊んでみようと思います。</p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<h3>SwiftによるAP・DBサーバの構築</h3>

<p>早速、Perfectを用いてSwiftによるAP・DBサーバを構築しようと思います。<br/>
基本的には<a href="https://github.com/PerfectlySoft/Perfect-MongoDB">ReadMe</a>に従えば良いのですが、丁寧に１つずつ見ていきます。</p>

<h4>必要モジュールのインストール</h4>

<p>流石に <strong>Homebrew</strong> はインストールされている方が多いと思いますが、入れていない方は下記コマンドで入れましょう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span></code></pre></td></tr></table></div></figure>


<p>また今回は <strong>MongoDB</strong> を利用するため、 <strong>mongodb</strong> および <strong>mongo-c</strong> をインストールする必要があります。<br/>
mongodbに関しては、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install mongodb</span></code></pre></td></tr></table></div></figure>


<p>でOKです。(自動起動などに関しては<a href="http://grandbig.github.io/blog/2016/11/20/brew-install-db/">こちら</a>を参照ください。)<br/>
続いて、mongo-cは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install mongo-c</span></code></pre></td></tr></table></div></figure>


<p>でインストール完了できるはずです。</p>

<h4>xcodeprojを作成</h4>

<h5>テンプレートのダウンロード</h5>

<p>0からPerfectを用いてサーバを構築しても良いのですが、Perfectではテンプレートを用意してくれています。<br/>
せっかくなので <code>git clone</code> してテンプレートをダウンロードして使いましょう。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/PerfectlySoft/PerfectTemplate.git
</span><span class='line'>cd PerfectTemplate</span></code></pre></td></tr></table></div></figure>


<h5>MongoDBモジュールを利用するように編集</h5>

<p><strong>Perfect-MongoDB</strong> を利用するので、<code>Package.swift</code>を編集しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">import</span> <span class="n">PackageDescription</span>
</span><span class='line'>
</span><span class='line'><span class="n">let</span> <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="p">(</span>
</span><span class='line'>  <span class="nl">name:</span> <span class="s">&quot;PerfectTemplate&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">targets:</span> <span class="p">[],</span>
</span><span class='line'>  <span class="nl">dependencies:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Package</span><span class="p">(</span><span class="nl">url:</span> <span class="s">&quot;https://github.com/PerfectlySoft/Perfect-HTTPServer.git&quot;</span><span class="p">,</span> <span class="nl">majorVersion:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">minor:</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Package</span><span class="p">(</span><span class="nl">url:</span><span class="s">&quot;https://github.com/PerfectlySoft/PerfectLib.git&quot;</span><span class="p">,</span> <span class="nl">majorVersion:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">minor:</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Package</span><span class="p">(</span><span class="nl">url:</span><span class="s">&quot;https://github.com/PerfectlySoft/Perfect-MongoDB.git&quot;</span><span class="p">,</span> <span class="nl">majorVersion:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">minor:</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ReadMeでは <strong>Perfect-HTTPServer</strong> は書かれていないのですが、これを使った方が便利なので、テンプレートに残したまま進めます。</p>

<h5>Packageからxcodeprojを作成</h5>

<p><code>Package.swift</code>の編集が終わったら、下記コマンドを実行して<code>xcodeproj</code>ファイルを作成しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">swift</span> <span class="n">package</span> <span class="n">generate</span><span class="o">-</span><span class="n">xcodeproj</span>
</span></code></pre></td></tr></table></div></figure>


<p>そうすれば下図のような結果が得られるはずです。</p>

<p><img src="/images/perfect-mongo_1.png" alt="フォルダ構成" /></p>

<h4>MongoDBにデータを作成</h4>

<p>サンプルを作成するためにもデータがなきゃ話になりませんよね？<br/>
ということでデータを入れましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// MongoDBにアクセス</span>
</span><span class='line'><span class="n">$</span> <span class="n">mongo</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DBとCollectionの作成</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">use</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">createCollection</span><span class="p">(</span><span class="err">&#39;</span><span class="n">testCollection</span><span class="err">&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DBの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">show</span> <span class="n">dbs</span><span class="p">;</span>
</span><span class='line'><span class="n">local</span>  <span class="mf">0.000</span><span class="n">GB</span>
</span><span class='line'><span class="n">test</span>   <span class="mf">0.000</span><span class="n">GB</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Collectionの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">show</span> <span class="n">collections</span>
</span><span class='line'><span class="n">testCollection</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データのインサート</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="nl">name:</span> <span class="err">&#39;</span><span class="n">takahiro</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">age:</span> <span class="mi">30</span><span class="p">,</span> <span class="nl">hobby:</span> <span class="err">&#39;</span><span class="n">blog</span><span class="err">&#39;</span><span class="p">});</span>
</span><span class='line'><span class="n">WriteResult</span><span class="p">({</span> <span class="s">&quot;nInserted&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="nl">name:</span> <span class="err">&#39;</span><span class="n">ichiro</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">age:</span> <span class="mi">43</span><span class="p">,</span> <span class="nl">hobby:</span> <span class="err">&#39;</span><span class="n">baseball</span><span class="err">&#39;</span><span class="p">});</span>
</span><span class='line'><span class="n">WriteResult</span><span class="p">({</span> <span class="s">&quot;nInserted&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58391469a8589d99c931303c&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;takahiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;blog&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58392222a8589d99c931303d&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;ichiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;baseball&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>MongoDBにアクセスして全データを取得</h4>

<p>データの作成も完了したので、実際にGETリクエストでMongoDBからデータを取得する処理を書いてみましょう。<br/>
(ReadMeではPerfect-HTTPServerを利用しない方法で書かれていたため本記事とは若干異なります。)</p>

<h5>テンプレートファイルの確認</h5>

<p>まずは、初めから作成されている処理内容を確認します。<br/>
説明は下記ソースコードにコメントを書いたので参照ください。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTP</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTPServer</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// HTTPサーバの生成</span>
</span><span class='line'><span class="n">let</span> <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// リクエストに対するルーティングを設定</span>
</span><span class='line'><span class="n">var</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">Routes</span><span class="p">()</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>    <span class="c1">// レスポンスヘッダーの設定</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">setHeader</span><span class="p">(.</span><span class="n">contentType</span><span class="p">,</span> <span class="nl">value:</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// レスポンスボディの設定</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="s">&quot;&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// レスポンス完了処理</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// サーバにルーティング設定を適用</span>
</span><span class='line'><span class="n">server</span><span class="p">.</span><span class="n">addRoutes</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ポートを設定</span>
</span><span class='line'><span class="n">server</span><span class="p">.</span><span class="n">serverPort</span> <span class="o">=</span> <span class="mi">8181</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ドキュメントルートのパスを設定</span>
</span><span class='line'><span class="n">server</span><span class="p">.</span><span class="n">documentRoot</span> <span class="o">=</span> <span class="s">&quot;./webroot&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// arguments.swiftで定義されているメソッド</span>
</span><span class='line'><span class="c1">// 更なるサーバ定義が必要な場合はここを見ましょう(SSLなど)</span>
</span><span class='line'><span class="n">configureServer</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">do</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// HTTPサーバの起動</span>
</span><span class='line'>    <span class="n">try</span> <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span> <span class="n">catch</span> <span class="n">PerfectError</span><span class="p">.</span><span class="n">networkError</span><span class="p">(</span><span class="n">let</span> <span class="n">err</span><span class="p">,</span> <span class="n">let</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">print</span><span class="p">(</span><span class="s">&quot;Network error thrown: \(err) \(msg)&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記をXcodeをからRunさせた状態で <code>http://localhost:8181</code> にアクセスしてみましょう。<br/>
Hello Worldの結果が得られるはずです。</p>

<p><img src="/images/perfect-mongo_2.png" alt="Hello World" /></p>

<h5>MongoDB関連処理ファイルの作成</h5>

<p>続いて、MongoDBへの接続・切断やデータ取得などの処理を作成していきます。<br/>
これは別クラスの中に書いていきましょう。</p>

<p>今回はMongoDB関連の処理をハンドリングするということで<code>mongoHandler.swift</code>というファイルを作成します。<br/>
因みにただ作成しただけでは、XcodeがCompile対象として正しく認識してくれないので、自身で設定を変えましょう。<br/>
下図のようにTARGETSから実行ファイルを選択して、Compile Sourcesとして<code>mongoHandler.swift</code>を追加してください。</p>

<p><img src="/images/perfect-mongo_3.png" alt="Compile Sourcesに追加" /></p>

<p>では実際のソースを見ていきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// mongoHandler.swift</span>
</span><span class='line'>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTP</span>
</span><span class='line'><span class="n">import</span> <span class="n">MongoDB</span>
</span><span class='line'>
</span><span class='line'><span class="n">class</span> <span class="n">MongoHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">var</span> <span class="nl">client:</span> <span class="n">MongoClient</span><span class="o">?</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">database:</span> <span class="n">MongoDatabase</span><span class="o">?</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">collection:</span> <span class="n">MongoCollection</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// MongoDBへの接続処理</span>
</span><span class='line'>  <span class="n">fileprivate</span> <span class="n">func</span> <span class="n">connect</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// コネクション確立</span>
</span><span class='line'>    <span class="n">client</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MongoClient</span><span class="p">(</span><span class="nl">uri:</span> <span class="s">&quot;mongodb://localhost&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// testデータベースへの接続</span>
</span><span class='line'>    <span class="n">database</span> <span class="o">=</span> <span class="n">client</span><span class="o">?</span><span class="p">.</span><span class="n">getDatabase</span><span class="p">(</span><span class="nl">name:</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// testCollectionコレクションへの接続</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">database</span><span class="o">?</span><span class="p">.</span><span class="n">getCollection</span><span class="p">(</span><span class="nl">name:</span> <span class="s">&quot;testCollection&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// MongoDBからの切断処理</span>
</span><span class='line'>  <span class="n">fileprivate</span> <span class="n">func</span> <span class="n">close</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">collection</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="n">database</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="n">client</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">func</span> <span class="n">searchAll</span><span class="p">(</span><span class="nl">request:</span> <span class="n">HTTPRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nl">response:</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// MongoDBへの接続</span>
</span><span class='line'>    <span class="n">connect</span><span class="p">()</span>
</span><span class='line'>    <span class="c1">// 指定コレクションが見つからない場合は処理終了</span>
</span><span class='line'>    <span class="n">guard</span> <span class="n">let</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// データ全件取得のためBSONオブジェクトを初期化してクエリとして設定</span>
</span><span class='line'>    <span class="n">let</span> <span class="n">fnd</span> <span class="o">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="nl">query:</span> <span class="n">BSON</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// データ格納用に配列を定義</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">String</span><span class="p">]()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 取得したデータを配列に格納する</span>
</span><span class='line'>    <span class="c1">// fndはMongoCursor型であり、for文での繰り返し処理が可能</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="n">fnd</span><span class="o">!</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">arr</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">asString</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// JSONStringに変換</span>
</span><span class='line'>    <span class="n">let</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">data</span><span class="se">\&quot;</span><span class="s">:[\(arr.joined(separator: &quot;</span><span class="p">,</span><span class="s">&quot;))]}&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// レスポンスデータとして設定</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="n">returning</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// レスポンス処理完了</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// MongoDBから切断</span>
</span><span class='line'>    <span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>MongoDBへの接続・切断処理は共通処理となることは容易に想像できるため、切り出しました。</p>

<h5>main.swiftからmongoHandler.swiftを呼び出す</h5>

<p>さて、<code>main.swift</code>から<code>mongoHandler.swift</code>を呼び出してみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="c1">// MongoHandlerの初期化</span>
</span><span class='line'><span class="n">let</span> <span class="n">mongoHandler</span> <span class="o">=</span> <span class="n">MongoHandler</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// GETリクエストでMongoDBのデータ全取得</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>    <span class="n">mongoHandler</span><span class="p">.</span><span class="n">searchAll</span><span class="p">(</span><span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで<code>http://localhost:8181</code>にアクセスすれば下図のような結果が得られるはずです。</p>

<p><img src="/images/perfect-mongo_4.png" alt="データ全件取得結果" /></p>

<h4>MongoDBにアクセスして指定のクエリでデータを取得</h4>

<p>全件取得の方法はわかったので、続いてクエリありの検索を実行してみましょう。<br/>
先程述べた通り、下記のようなデータが格納されています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// データの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58391469a8589d99c931303c&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;takahiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;blog&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58392222a8589d99c931303d&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;ichiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;baseball&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>name</code>、<code>age</code>、<code>hobby</code>を指定して検索するのはそんなに難しくないと思います。</p>

<h5>nameを指定してデータを取得</h5>

<p>わかりやすいところからと言うことで<code>name</code>を指定してデータを取得してみます。<br/>
まずは<code>mongoHandler.swift</code>にクエリ指定のメソッドを追加しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// mongoHandler.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTP</span>
</span><span class='line'><span class="n">import</span> <span class="n">MongoDB</span>
</span><span class='line'>
</span><span class='line'><span class="n">class</span> <span class="n">MongoHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="nl">client:</span> <span class="n">MongoClient</span><span class="o">?</span>
</span><span class='line'>    <span class="n">var</span> <span class="nl">database:</span> <span class="n">MongoDatabase</span><span class="o">?</span>
</span><span class='line'>    <span class="n">var</span> <span class="nl">collection:</span> <span class="n">MongoCollection</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">fileprivate</span> <span class="n">func</span> <span class="n">connect</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// open a connection</span>
</span><span class='line'>        <span class="n">client</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span> <span class="n">MongoClient</span><span class="p">(</span><span class="nl">uri:</span> <span class="s">&quot;mongodb://localhost&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// set database, assuming &quot;test&quot; exists</span>
</span><span class='line'>        <span class="n">database</span> <span class="o">=</span> <span class="n">client</span><span class="o">?</span><span class="p">.</span><span class="n">getDatabase</span><span class="p">(</span><span class="nl">name:</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// define collection</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">database</span><span class="o">?</span><span class="p">.</span><span class="n">getCollection</span><span class="p">(</span><span class="nl">name:</span> <span class="s">&quot;testCollection&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fileprivate</span> <span class="n">func</span> <span class="n">close</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">collection</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="n">database</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="n">client</span><span class="o">?</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// searchAllメソッドは省略</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// =====ここから追加========================================================</span>
</span><span class='line'>      <span class="n">func</span> <span class="n">search</span><span class="p">(</span><span class="nl">query:</span> <span class="n">BSON</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">HTTPRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nl">response:</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// MongoDBへの接続</span>
</span><span class='line'>          <span class="n">connect</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// 指定コレクションが見つからない場合は処理終了</span>
</span><span class='line'>      <span class="n">guard</span> <span class="n">let</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// クエリを指定して検索</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">fnd</span> <span class="o">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="nl">query:</span> <span class="n">query</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// データ格納用に配列を定義</span>
</span><span class='line'>      <span class="n">var</span> <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">String</span><span class="p">]()</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// 取得したデータを配列に格納する</span>
</span><span class='line'>      <span class="c1">// fndはMongoCursor型であり、for文での繰り返し処理が可能</span>
</span><span class='line'>      <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="n">fnd</span><span class="o">!</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">arr</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">asString</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// JSONStringに変換</span>
</span><span class='line'>      <span class="n">let</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">data</span><span class="se">\&quot;</span><span class="s">:[\(arr.joined(separator: &quot;</span><span class="p">,</span><span class="s">&quot;))]}&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// レスポンスデータとして設定</span>
</span><span class='line'>      <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="n">returning</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">// レスポンス処理完了</span>
</span><span class='line'>      <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// MongoDBから切断</span>
</span><span class='line'>      <span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>searchAll</code>との違いは引数に<code>BSON</code>型の<code>query</code>を追加しているところです。</p>

<p>続いて、<code>main.swift</code>にGETリクエストで<code>name</code>パラメータをキャッチできるように処理を追加していきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTP</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTPServer</span>
</span><span class='line'><span class="n">import</span> <span class="n">MongoDB</span>                  <span class="c1">// ここを追加</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 省略</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// nameパラメータを指定したGETリクエストのハンドリング</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo/name/{name}&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(クエリとして渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">bson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="n">defer</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 処理完了時にBSONオブジェクトを削除</span>
</span><span class='line'>    <span class="n">bson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// クエリとして渡すパラメータをセット</span>
</span><span class='line'>  <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nl">string:</span> <span class="n">request</span><span class="p">.</span><span class="n">urlVariables</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// クエリを指定して検索</span>
</span><span class='line'>  <span class="n">mongoHandler</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="nl">query:</span> <span class="n">bson</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>これだけで準備万端です。<br/>
<code>http://localhost:8181/name/takahiro</code>にアクセスすると下記結果が得られます。</p>

<p><img src="/images/perfect-mongo_5.png" alt="nameパラメータを指定したGETリクエスト結果" />_</p>

<h5>ObjectIdを指定してデータを取得</h5>

<p>続いて、少しクエリの書き方に迷うかもしれない<code>ObjectId</code>を指定したデータ検索をしてみましょう。<br/>
<code>mongoHandler.swift</code>には特に変更がありません。<br/>
<code>main.swift</code>のみ変更していきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTP</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTPServer</span>
</span><span class='line'><span class="n">import</span> <span class="n">MongoDB</span>
</span><span class='line'><span class="n">import</span> <span class="n">libmongoc</span>                <span class="c1">// ここを追加</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 省略</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ObjectIdパラメータを指定したGETリクエストのハンドリング</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo/oid/{oid}&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(クエリとして渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">bson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="n">defer</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 処理完了時にBSONオブジェクトを削除</span>
</span><span class='line'>    <span class="n">bson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// bson_oid_t型のオブジェクトの初期化</span>
</span><span class='line'>  <span class="n">var</span> <span class="nl">oid:</span> <span class="n">bson_oid_t</span> <span class="o">=</span> <span class="n">bson_oid_t</span><span class="p">()</span>
</span><span class='line'>  <span class="c1">// String型からbson_oid_t型に変換</span>
</span><span class='line'>  <span class="n">bson_oid_init_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">urlVariables</span><span class="p">[</span><span class="s">&quot;oid&quot;</span><span class="p">])</span>
</span><span class='line'>  <span class="c1">// クエリとして渡すパラメータをセット</span>
</span><span class='line'>  <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="nl">oid:</span> <span class="n">oid</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// クエリを指定して検索</span>
</span><span class='line'>  <span class="n">mongoHandler</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="nl">query:</span> <span class="n">bson</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>肝なのが、<code>import libmongoc</code>をしているということです。<br/>
このライブラリの各種メソッドを利用することでServer Side Swiftから<code>ObjectId</code>を指定したデータ検索が可能になります。</p>

<p>少し詳しく説明すると、<br/>
クエリとして<code>ObjectId</code>を渡すためには<code>public func append(key k: String, oid: bson_oid_t) -&gt; Bool</code>を利用する必要があります。<br/>
しかし、このメソッドの第二引数をよく見ると、<code>bson_oid_t</code>型となっています。</p>

<p>GETリクエストの時点で<code>bson_oid_t</code>型でパラメータを渡すわけにもいかないので、  サーバサイド側で変換する必要があります。<br/>
そのために利用するメソッドが<code>void bson_oid_init_from_string (bson_oid_t *oid, const char *str);</code>です。<br/>
筆者もSwiftで初めて利用したのですが、このメソッドは戻り値が<code>void</code>型のため何も返ってきません。<br/>
が、第一引数に参照渡しとして<code>bson_oid_t</code>型オブジェクトを設定することで、メソッドの処理結果が<code>oid</code>に格納されます。<br/>
これでめでたくクエリとして<code>ObjectId</code>が設定できるわけです。</p>

<p>では、<code>http://localhost:8181/oid/58392222a8589d99c931303d</code>にアクセスしてみましょう。</p>

<p><img src="/images/perfect-mongo_6.png" alt="ObjectIdパラメータを指定したGETリクエスト結果" /></p>

<h4>MongoDBにデータを保存</h4>

<p>検索に関してはざっと見てきたので、MongoDBへの保存処理も見ていきましょう。</p>

<h5>insertメソッドでデータを保存</h5>

<p>保存には<code>MongoClient</code>の<code>insert</code>メソッドを利用します。<br/>
(他にも<code>save</code>メソッドもあります。)</p>

<p>まずは <code>mongoHandler.swift</code> へのメソッド追加からです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// mongoHandler.swift</span>
</span><span class='line'><span class="n">func</span> <span class="nf">save</span><span class="p">(</span><span class="nl">query:</span> <span class="n">BSON</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">HTTPRequest</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// MongoDBへの接続</span>
</span><span class='line'>  <span class="n">connect</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 指定コレクションが見つからない場合は処理終了</span>
</span><span class='line'>  <span class="n">guard</span> <span class="n">let</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// データの保存処理</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">insert</span> <span class="o">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="nl">document:</span> <span class="n">query</span><span class="p">)</span> <span class="n">as</span> <span class="n">MongoResult</span>
</span><span class='line'>  <span class="c1">// データ保存結果によって返却値を変更</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="k">switch</span> <span class="n">insert</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">success:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Succeeded&quot;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// レスポンスデータとして設定</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="n">returning</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// レスポンス処理完了</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// MongoDBから切断</span>
</span><span class='line'>  <span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>次にPOSTで届いたリクエストパラメータがJSONStringなのでDictionary型に変換します。<br/>
その処理を <code>decode.swift</code> ファイルを新規作成して追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// decode.swift</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectHTTPServer</span>
</span><span class='line'><span class="n">import</span> <span class="n">PerfectLib</span>
</span><span class='line'>
</span><span class='line'><span class="n">func</span> <span class="n">decode</span><span class="p">(</span><span class="nl">postBody:</span> <span class="n">String</span><span class="o">?</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nl">String:</span> <span class="n">Any</span><span class="p">]</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">guard</span> <span class="n">let</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">try</span> <span class="n">postBody</span><span class="o">?</span><span class="p">.</span><span class="n">jsonDecode</span><span class="p">()</span> <span class="n">as</span><span class="o">?</span> <span class="p">[</span><span class="nl">String:</span><span class="n">Any</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="o">:</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">decoded</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="o">:</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして <code>main.swift</code> にPOSTリクエストのハンドリング処理を書きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">post</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo/&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(クエリとして渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">bson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="n">defer</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 処理完了時にBSONオブジェクトを削除</span>
</span><span class='line'>    <span class="n">bson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// JSONString型をDictionary型に変換</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">decodedParam</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="nl">postBody:</span> <span class="n">request</span><span class="p">.</span><span class="n">postBodyString</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// 各パラメータ単位でBSONオブジェクトに格納</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">in</span> <span class="n">decodedParam</span><span class="o">!</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="n">key</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;name&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nl">string:</span> <span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;age&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="nl">int32:</span> <span class="n">Int32</span><span class="p">(</span><span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">Int</span><span class="p">))</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;hobby&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;hobby&quot;</span><span class="p">,</span> <span class="nl">string:</span> <span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// データ保存</span>
</span><span class='line'>  <span class="n">mongoHandler</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="nl">query:</span> <span class="n">bson</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで処理は完成です。<br/>
ではPOSTリクエストを投げてみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">$</span> <span class="n">curl</span> <span class="nl">http:</span><span class="c1">//localhost:8181/mongo -X POST -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;name&quot;:&quot;Hanako&quot;, &quot;age&quot;: 24, &quot;hobby&quot;: &quot;game&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>再度、MongoDBを検索してみると下記のような結果が得られるはずです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// データの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">find</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58391469a8589d99c931303c&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;takahiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;blog&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;58392222a8589d99c931303d&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;ichiro&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;baseball&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;583afcaedcab265c1821fb51&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;Hanako&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;game&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因みに、<code>main.swift</code>でリクエストパラメータとして取得した<code>age</code>を <strong>Int32</strong> 型に変換しているのには理由があります。<br/>
これを仮に <code>bson.append(key: "age", int: value as! Int)</code> とした場合、MongoDBには <code>NumberLong</code>として保存されてしまいます。 <br/>
これは32bitか64bitかの違いですね。</p>

<h5>insertメソッドのMongoInsertFlagについて</h5>

<p>先程、<code>insert</code>メソッドを利用しましたが、実は第一引数のみ持っている <code>insert</code> メソッドを利用していました。<br/>
実は他にも <code>public func insert(document: BSON, flag: MongoInsertFlag = .none) -&gt; Result</code> といった第二引数を持つ <code>insert</code> メソッドが存在します。</p>

<p>少し気になったのでこの <code>MongoInsertFlag</code>について調べてみました。<br/>
<code>MongoInsertFlag</code>は<code>MongoCollection.swift</code>内に <strong>enum</strong> として定義されています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">public</span> <span class="k">enum</span> <span class="nl">MongoInsertFlag:</span> <span class="n">Int</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">none</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">continueOnError</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">noValidate</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">var</span> <span class="nl">mongoFlag:</span> <span class="n">mongoc_insert_flags_t</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="n">self</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">none:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_INSERT_NONE</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">continueOnError:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_INSERT_CONTINUE_ON_ERROR</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">noValidate:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">mongoc_insert_flags_t</span><span class="p">(</span><span class="nl">rawValue:</span> <span class="n">MONGOC_INSERT_NO_VALIDATE</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここで<code>MONGOC_INSERT_NONE</code>, <code>MONGOC_INSERT_CONTINUE_ON_ERROR</code>, <code>MONGOC_INSERT_NO_VALIDATE</code>の3つがフラグとして用意されていることがわかります。<br/>
これらはそれぞれ次のような意味とのことです。</p>

<ul>
<li><code>MONGOC_INSERT_NONE</code>

<ul>
<li>特別何もしません。</li>
</ul>
</li>
<li><code>MONGOC_INSERT_CONTINUE_ON_ERROR</code>

<ul>
<li>途中でエラーが発生したとしても後続の<code>insert</code>処理がある場合は続ける</li>
</ul>
</li>
<li><code>MONGOC_INSERT_NO_VALIDATE</code>

<ul>
<li>インサート前に値のバリデーションチェックをしない

<ul>
<li>MongoDBへの保存処理前にAPサーバ時点などでバリデーションチェックはした方が良い</li>
</ul>
</li>
<li>これをすることで処理時間を短縮することができる</li>
</ul>
</li>
</ul>


<h4>MongoDBのデータを更新</h4>

<p>MongoDBへの更新処理も見ていきましょう。</p>

<h5>updateメソッドでデータを保存</h5>

<p>保存には<code>MongoClient</code>の<code>update</code>メソッドを利用します。</p>

<p><code>mongoHandler.swift</code>にメソッドを追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// mongoHandler.swift</span>
</span><span class='line'><span class="n">func</span> <span class="nf">update</span><span class="p">(</span><span class="nl">update:</span> <span class="n">BSON</span><span class="p">,</span> <span class="nl">selector:</span> <span class="n">BSON</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">HTTPRequest</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// MongoDBへの接続</span>
</span><span class='line'>  <span class="n">connect</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 指定コレクションが見つからない場合は処理終了</span>
</span><span class='line'>  <span class="n">guard</span> <span class="n">let</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// データの更新</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">updated</span> <span class="o">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="nl">update:</span> <span class="n">update</span><span class="p">,</span> <span class="nl">selector:</span> <span class="n">query</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// データ更新結果によって返却値を変更</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="k">switch</span> <span class="n">updated</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">success:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Succeeded&quot;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// レスポンスデータとして設定</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="n">returning</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// レスポンス処理完了</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// MongoDBから切断</span>
</span><span class='line'>  <span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして <code>main.swift</code> にPUTリクエストのハンドリング処理を書きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">post</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo/&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(更新内容として渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">updateBson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(クエリとして渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">selectorBson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="n">defer</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 処理完了時にBSONオブジェクトを削除</span>
</span><span class='line'>    <span class="n">updateBson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>      <span class="n">selectorBson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// JSONString型をDictionary型に変換</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">decodedParam</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="nl">postBody:</span> <span class="n">request</span><span class="p">.</span><span class="n">postBodyString</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// 各パラメータ単位でBSONオブジェクトに格納</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">in</span> <span class="n">decodedParam</span><span class="o">!</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="n">key</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;name&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">updateBson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nl">string:</span> <span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;age&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">updateBson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="nl">int32:</span> <span class="n">Int32</span><span class="p">(</span><span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">Int</span><span class="p">))</span>
</span><span class='line'>      <span class="k">case</span> <span class="s">&quot;hobby&quot;</span><span class="o">:</span>
</span><span class='line'>          <span class="n">updateBson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;hobby&quot;</span><span class="p">,</span> <span class="nl">string:</span> <span class="n">value</span> <span class="n">as</span><span class="o">!</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>      <span class="k">default</span><span class="o">:</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// データ更新</span>
</span><span class='line'>  <span class="n">mongoHandler</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="nl">update:</span> <span class="n">updateBson</span><span class="p">,</span> <span class="nl">query:</span> <span class="n">selectorBson</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>基本的にはPOSTと同じ感じで処理を書くことができます。<br/>
しかしながら気をつけなくてはいけないのが、<strong>$setが利用できない</strong> ということです。<br/>
通常、MongoDBでは、 <strong>$setを使わないと</strong> &hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// データの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">find</span><span class="p">();</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;583afcaedcab265c1821fb51&quot;</span><span class="p">),</span> <span class="s">&quot;name&quot;</span> <span class="o">:</span> <span class="s">&quot;Hanako&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span> <span class="o">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;game&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データの更新</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="nl">_id:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;583afcaedcab265c1821fb51&quot;</span><span class="p">)},</span> <span class="p">{</span><span class="s">&quot;hobby&quot;</span><span class="o">:</span> <span class="s">&quot;go shopping&quot;</span><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// データの確認</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">db</span><span class="p">.</span><span class="n">testCollection</span><span class="p">.</span><span class="n">find</span><span class="p">();</span>
</span><span class='line'><span class="p">{</span> <span class="s">&quot;_id&quot;</span> <span class="o">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;583afcaedcab265c1821fb51&quot;</span><span class="p">),</span> <span class="s">&quot;hobby&quot;</span> <span class="o">:</span> <span class="s">&quot;go shopping&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>となってしまいます。<br/>
現状、<code>Perfect-MongoDB</code>に実装されているメソッドを見ると<code>$set</code>はないようです。<br/>
そのため、今回はあえてPOST同様に全てのパラメータをクライアント側から下記のように投げることにしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">$</span> <span class="n">curl</span> <span class="nl">http:</span><span class="c1">//localhost:8181/mongo/583afcaedcab265c1821fb51 -X PUT -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;name&quot; : &quot;Hanako&quot;, &quot;age&quot; : 24, &quot;hobby&quot;: &quot;game&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>updateメソッドのMongoUpdateFlagについて</h5>

<p><code>update</code>メソッドにも実は<code>MongoUpdateFlag</code>というオプションを設定できるメソッドが存在します。<br/>
<code>MongoUpdateFlag</code>は<code>MongoInsertFlag</code>と同じく <strong>enum</strong> として定義されています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">public</span> <span class="k">enum</span> <span class="nl">MongoUpdateFlag:</span> <span class="n">Int</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">none</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">upsert</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">multiUpdate</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">noValidate</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">var</span> <span class="nl">mongoFlag:</span> <span class="n">mongoc_update_flags_t</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="n">self</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">none:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_UPDATE_NONE</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">upsert:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_UPDATE_UPSERT</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">multiUpdate:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_UPDATE_MULTI_UPDATE</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">noValidate:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">mongoc_update_flags_t</span><span class="p">(</span><span class="nl">rawValue:</span> <span class="n">MONGOC_UPDATE_NO_VALIDATE</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>それぞれのフラグの意味は下記の通りです。</p>

<ul>
<li><code>MONGO_UPDATE_NONE</code>

<ul>
<li>特別何もしません</li>
</ul>
</li>
<li><code>MONGOC_UPDATE_UPSERT</code>

<ul>
<li>検索に引っかからない場合は<code>insert</code>します</li>
</ul>
</li>
<li><code>MONGOC_UPDATE_MULTI_UPDATE</code>

<ul>
<li>検索にヒットする件数が複数の場合は全て更新します</li>
</ul>
</li>
<li><code>MONGOC_UPDATE_NO_VALIDATE</code>

<ul>
<li>アップデート前に値のバリデーションチェックをしません</li>
</ul>
</li>
</ul>


<h4>MongoDBのデータを削除</h4>

<p>MongoDBからのデータ削除処理も見ていきましょう。</p>

<h5>removeメソッドでデータを保存</h5>

<p>保存には<code>MongoClient</code>の<code>remove</code>メソッドを利用します。</p>

<p><code>mongoHandler.swift</code>にメソッドを追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// mongoHandler.swift</span>
</span><span class='line'><span class="n">func</span> <span class="nf">delete</span><span class="p">(</span><span class="nl">query:</span> <span class="n">BSON</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">HTTPRequest</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// MongoDBへの接続</span>
</span><span class='line'>  <span class="n">connect</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 指定コレクションが見つからない場合は処理終了</span>
</span><span class='line'>  <span class="n">guard</span> <span class="n">let</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collection</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// データ削除処理</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="nl">selector:</span> <span class="n">query</span><span class="p">,</span> <span class="nl">flag:</span> <span class="p">.</span><span class="n">none</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// データ削除結果によって返却値を変更</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="k">switch</span> <span class="n">removed</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">success:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Succeeded&quot;</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="n">returning</span> <span class="o">=</span> <span class="s">&quot;Failed&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// レスポンスデータとして設定</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">appendBody</span><span class="p">(</span><span class="nl">string:</span> <span class="n">returning</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// レスポンス処理完了</span>
</span><span class='line'>  <span class="n">response</span><span class="p">.</span><span class="n">completed</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// MongoDBから切断</span>
</span><span class='line'>  <span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして <code>main.swift</code> にDELETEリクエストのハンドリング処理を書きます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// main.swift</span>
</span><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="nl">method:</span> <span class="p">.</span><span class="n">delete</span><span class="p">,</span> <span class="nl">uri:</span> <span class="s">&quot;/mongo/{oid}&quot;</span><span class="p">,</span> <span class="nl">handler:</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">// BSON型オブジェクトの初期化(クエリとして渡す)</span>
</span><span class='line'>  <span class="n">let</span> <span class="n">bson</span> <span class="o">=</span> <span class="n">BSON</span><span class="p">()</span>
</span><span class='line'>  <span class="n">defer</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 処理完了時にBSONオブジェクトを削除</span>
</span><span class='line'>    <span class="n">bson</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">var</span> <span class="nl">oid:</span> <span class="n">bson_oid_t</span> <span class="o">=</span> <span class="n">bson_oid_t</span><span class="p">()</span>
</span><span class='line'>  <span class="n">bson_oid_init_from_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">urlVariables</span><span class="p">[</span><span class="s">&quot;oid&quot;</span><span class="p">])</span>
</span><span class='line'>  <span class="n">bson</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">key:</span> <span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="nl">oid:</span> <span class="n">oid</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// データ削除</span>
</span><span class='line'>  <span class="n">mongoHandler</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="nl">query:</span> <span class="n">bson</span><span class="p">,</span> <span class="nl">request:</span> <span class="n">request</span><span class="p">,</span> <span class="nl">response:</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>下記のようなDELETEリクエストを投げてみればデータが削除されていることが確認できるはずです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">$</span> <span class="n">curl</span> <span class="nl">http:</span><span class="c1">//localhost:8181/mongo/583afcaedcab265c1821fb51 -X DELETE -H &quot;Content-Type: application/json&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>removeメソッドのMongoRemoveFlagについて</h5>

<p><code>remove</code>メソッドにも実は<code>MongoRemoveFlag</code>というオプションを設定できるメソッドが存在します。<br/>
<code>MongoRemoveFlag</code>は<code>MongoUpdateFlag</code>と同じく <strong>enum</strong> として定義されています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">public</span> <span class="k">enum</span> <span class="nl">MongoRemoveFlag:</span> <span class="n">Int</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">none</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">singleRemove</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">var</span> <span class="nl">mongoFlag:</span> <span class="n">mongoc_remove_flags_t</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">switch</span> <span class="n">self</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">none:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_REMOVE_NONE</span>
</span><span class='line'>      <span class="k">case</span> <span class="p">.</span><span class="nl">singleRemove:</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">MONGOC_REMOVE_SINGLE_REMOVE</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>フラグの意味は下記の通りです。</p>

<ul>
<li><code>MONGOC_REMOVE_NONE</code>

<ul>
<li>特に何のオプションもつけません。</li>
<li>検索にヒットしたデータは全て削除します。</li>
</ul>
</li>
<li><code>MONGOC_REMOVE_SINGLE_REMOVE</code>

<ul>
<li>初めに該当したデータ1件のみを削除します。</li>
</ul>
</li>
</ul>


<h3>まとめ</h3>

<p>以上で基本的なCRUDに対応したAPサーバとDBサーバをSwiftとMongoDBで構築することができました。<br/>
これから何かサービスでも&hellip;と思っていたら時間切れ&hellip;<br/>
今回は一旦ここまでとしたいと思いますが、今後の展望としてはSwift製iOSアプリと連携させてiOSアプリを作成するか、もしくはReact / Reduxを使ったWebサービスと連携させたいと企んでいます。<br/>
処理速度とかリソースの消費具合とかは全然比較もしていないのでわからないですが、Swiftによるサーバサイド構築によるメリットも今後Appleさんが？明らかにしてくれるかもしれません。</p>

<p>何と言っても新しい技術や取り組みは楽しいですね！！<br/>
と言ったところで本日はここまで。</p>

<h3>参考URL</h3>

<ul>
<li><a href="http://perfect.org/docs/MongoDB.html">Perfect MongoDB Documentation</a></li>
<li><a href="http://mongoc.org/libbson/1.3.5/bson_oid_init_from_string.html">Libbson API Reference: Bson Oid Init</a></li>
<li><a href="http://mongoc.org/libmongoc/1.4.0/updating-document.html">Libbson API Reference: Update Document</a></li>
<li><a href="http://mongoc.org/libmongoc/1.0.0/mongoc_insert_flags_t.html">MongoDB C Driver API Reference: Insert Flag</a></li>
<li><a href="http://mongoc.org/libmongoc/1.2.3/mongoc_update_flags_t.html">MongoDB C Driver API Reference: Update Flag</a></li>
<li><a href="http://mongoc.org/libmongoc/1.3.2/mongoc_remove_flags_t.html">MongoDB C Driver API Reference: Remove Flag</a></li>
</ul>


<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Takahiro</span></span>

      








  


<time datetime="2016-12-05T00:00:00+09:00" pubdate data-updated="true">Dec 5<span>th</span>, 2016</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/be/'>BE</a>, <a class='category' href='/blog/categories/mongodb/'>mongodb</a>, <a class='category' href='/blog/categories/swift/'>swift</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://grandbig.github.io/blog/2016/12/05/swift-perfect-mongo/" data-via="" data-counturl="http://grandbig.github.io/blog/2016/12/05/swift-perfect-mongo/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/11/25/git-ssl-error/" title="Previous Post: GitのFetchでSSLエラーが出たときの対応">&laquo; GitのFetchでSSLエラーが出たときの対応</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/12/06/reswift-2/" title="Next Post: ReSwiftを勉強してみよう！(2)">ReSwiftを勉強してみよう！(2) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/07/16/google-maps-sdk-2/">Google Maps SDK for iOSを使ってみよう！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/29/footstepmeter-ver1-dot-0-3/">足跡計 ver1.0.3の紹介</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/18/google-maps-sdk/">Google Maps SDK for iOSを導入してみよう！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/17/ios-header/">iOSでヘッダーを設定する3つの方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/11/uiimagerotate-swift3/">Swift3でUIImageを任意の角度で回転させる方法について</a>
      </li>
    
  </ul>
</section>




<section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 広告１ -->
<ins class="adsbygoogle"style="display:inline-block;width:300px;height:250px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="4255355169"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
	google_ad_client: "ca-pub-2881241309408290",
	enable_page_level_ads: true
});
</script>
</section>
<section>
	<h1>Top Categories</h1>
		<ul id="top-category-list"><li><a href='/blog/categories/ios'>ios (147)</a></li><li><a href='/blog/categories/swift'>swift (52)</a></li><li><a href='/blog/categories/android'>android (20)</a></li><li><a href='/blog/categories/java'>java (20)</a></li><li><a href='/blog/categories/ibeacon'>iBeacon (19)</a></li><li><a href='/blog/categories/webview'>webview (10)</a></li><li><a href='/blog/categories/ios8'>ios8 (9)</a></li><li><a href='/blog/categories/javascript'>javascript (7)</a></li><li><a href='/blog/categories/map'>map (7)</a></li><li><a href='/blog/categories/web'>web (7)</a></li><li><a href='/blog/categories/springboot'>springboot (7)</a></li><li><a href='/blog/categories/docker'>docker (7)</a></li><li><a href='/blog/categories/location'>location (6)</a></li><li><a href='/blog/categories/be'>BE (6)</a></li><li><a href='/blog/categories/xcode'>xcode (6)</a></li></ul>
</section>
<aside>
	<h3>
		About Takahiro
	</h3>
	<div>
		<div>メカ出身のプログラマー</div>
		<div>故にLevelは-1</div>
		<div>主にiOSアプリケーションの開発を担当しています(たまにWeb, Android, サーバサイドもやります)</div>
		<a class="button" href="mailto:takahiro.kato.blog15@gmail.com">MAILはこちらから</a>
	</div>
</aside>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Takahiro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'takahirooctopressblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://grandbig.github.io/blog/2016/12/05/swift-perfect-mongo/';
        var disqus_url = 'http://grandbig.github.io/blog/2016/12/05/swift-perfect-mongo/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
