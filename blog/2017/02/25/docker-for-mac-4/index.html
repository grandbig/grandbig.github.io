
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dockerコンテナ内のUbuntuでRedisを使ってみよう！ - Takahiro Octopress Blog</title>
  <meta name="author" content="Takahiro">

  
  <meta name="description" content="はじめに 今回はDockerコンテナ内のUbuntuにRedisをインストールしてみたいと思います。
基本的な操作だけでなく、デフォルトの設定とそれらの意味についても見ていきます。 UbuntuへのRedisのインストール まずはインストールをしないと始まりません。
その方法について見ていきます &hellip;">
  
  <meta name="google-site-verification" content="h2JWV1Gq5wVvtkoCC7o7IEPIVqaLWigK5aaxuRom6os" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://grandbig.github.io/blog/2017/02/25/docker-for-mac-4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Takahiro Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44313398-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Takahiro Octopress Blog</a></h1>
  
    <h2>-1から始める情弱プログラミング</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:grandbig.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dockerコンテナ内のUbuntuでRedisを使ってみよう！</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-25T22:36:00+09:00" pubdate data-updated="true">Feb 25<span>th</span>, 2017</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>はじめに</h3>

<p>今回はDockerコンテナ内のUbuntuに<a href="https://redis.io/">Redis</a>をインストールしてみたいと思います。<br/>
基本的な操作だけでなく、デフォルトの設定とそれらの意味についても見ていきます。</p>

<h3>UbuntuへのRedisのインストール</h3>

<p>まずはインストールをしないと始まりません。<br/>
その方法について見ていきます。<br/>
今回扱う環境は以下の通りです。</p>

<ul>
<li>Ubuntu: 14.04.5 LTS</li>
<li>Redis: 2.8.4</li>
</ul>


<p>バージョン的に最新ではない部分もあるのですが、Dockerコンテナ内のサーバを構築する上で利用したバージョンで進めます。</p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>




<!-- more -->


<p>インストールは実に簡単です。<br/>
<code>apt-get</code>を利用するのみです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span>
</span><span class='line'><span class="nx">Reading</span> <span class="kr">package</span> <span class="nx">lists</span><span class="p">...</span> <span class="nx">Done</span>
</span><span class='line'><span class="nx">Building</span> <span class="nx">dependency</span> <span class="nx">tree</span>
</span><span class='line'><span class="nx">Reading</span> <span class="nx">state</span> <span class="nx">information</span><span class="p">...</span> <span class="nx">Done</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nx">Setting</span> <span class="nx">up</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span> <span class="p">(</span><span class="mi">2</span><span class="o">:</span><span class="mf">2.8</span><span class="p">.</span><span class="mi">4</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="nx">Starting</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span><span class="o">:</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span>
</span><span class='line'><span class="nx">Processing</span> <span class="nx">triggers</span> <span class="k">for</span> <span class="nx">libc</span><span class="o">-</span><span class="nx">bin</span> <span class="p">(</span><span class="mf">2.19</span><span class="o">-</span><span class="mi">0</span><span class="nx">ubuntu6</span><span class="p">.</span><span class="mi">9</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="nx">Processing</span> <span class="nx">triggers</span> <span class="k">for</span> <span class="nx">ureadahead</span> <span class="p">(</span><span class="mf">0.100</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記のログで<code>Starting redis-server: redis-server.</code>として出力されている通り、インストールが完了すると、Redisを起動してくれます。<br/>
念のため確認してみますが、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="nx">ps</span> <span class="nx">aux</span> <span class="o">|</span> <span class="nx">grep</span> <span class="nx">redis</span>
</span><span class='line'><span class="nx">redis</span>     <span class="mi">8833</span>  <span class="mf">0.0</span>  <span class="mf">0.1</span>  <span class="mi">37000</span>  <span class="mi">3348</span> <span class="o">?</span>        <span class="nx">Ssl</span>  <span class="mi">13</span><span class="o">:</span><span class="mi">25</span>   <span class="mi">0</span><span class="o">:</span><span class="mi">00</span> <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">redis</span><span class="o">-</span><span class="nx">server</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span>
</span><span class='line'><span class="nx">root</span>      <span class="mi">8843</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">8868</span>   <span class="mi">784</span> <span class="o">?</span>        <span class="nx">S</span><span class="o">+</span>   <span class="mi">13</span><span class="o">:</span><span class="mi">26</span>   <span class="mi">0</span><span class="o">:</span><span class="mi">00</span> <span class="nx">grep</span> <span class="o">--</span><span class="nx">color</span><span class="o">=</span><span class="nx">auto</span> <span class="nx">redis</span>
</span></code></pre></td></tr></table></div></figure>


<p>ご覧の通り起動しています。</p>

<h3>Redisの起動</h3>

<p>インストール後、自動で起動してくれているものの、手動での起動と停止状態は知っておく必要があります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Redisの起動(続けて操作するためにBG起動)</span>
</span><span class='line'><span class="nx">$</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span> <span class="o">&amp;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Redisの停止</span>
</span><span class='line'><span class="nx">$</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span> <span class="nx">shutdown</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Redisの基本コマンド</h3>

<p>Redisの基本コマンドは以下の通りです。</p>

<ul>
<li><code>keys *</code>: 現時点で保存されているkey全てを表示</li>
<li><code>set key value</code>: keyとvalueの格納</li>
<li><code>get key</code>: 指定したkeyのvalueを取得</li>
<li><code>del key</code>: 指定したkeyのvalueを削除</li>
<li><code>flushdb</code>: 現時点で保存されているkey全てを削除</li>
</ul>


<p>実際に使ってみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">cli</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">keys</span> <span class="o">*</span>
</span><span class='line'><span class="p">(</span><span class="nx">empty</span> <span class="nx">list</span> <span class="nx">or</span> <span class="nx">set</span><span class="p">)</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">set</span> <span class="nx">user</span> <span class="nx">takahiro</span>
</span><span class='line'><span class="nx">OK</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">set</span> <span class="nx">device</span> <span class="nx">iphone</span>
</span><span class='line'><span class="nx">OK</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">keys</span> <span class="o">*</span>
</span><span class='line'><span class="mi">1</span><span class="p">)</span> <span class="s2">&quot;user&quot;</span>
</span><span class='line'><span class="mi">2</span><span class="p">)</span> <span class="s2">&quot;device&quot;</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">get</span> <span class="nx">user</span>
</span><span class='line'><span class="s2">&quot;takahiro&quot;</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">get</span> <span class="nx">device</span>
</span><span class='line'><span class="s2">&quot;iphone&quot;</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">del</span> <span class="nx">device</span>
</span><span class='line'><span class="p">(</span><span class="nx">integer</span><span class="p">)</span> <span class="mi">1</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">keys</span> <span class="o">*</span>
</span><span class='line'><span class="mi">1</span><span class="p">)</span> <span class="s2">&quot;user&quot;</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">flushdb</span>
</span><span class='line'><span class="nx">OK</span>
</span><span class='line'><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="nx">keys</span> <span class="o">*</span>
</span><span class='line'><span class="p">(</span><span class="nx">empty</span> <span class="nx">list</span> <span class="nx">or</span> <span class="nx">set</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Redisのデフォルト設定</h3>

<p>続いて、Redisの設定を見ていきます。<br/>
インストール後、<code>redis.conf</code>ファイルが<code>/etc/redis/</code>配下に作成されます。<br/>
デフォルトでこのファイルの中身には多くのことが書かれています。<br/>
1つずつ見ていきましょう。</p>

<h4>単位指定について</h4>

<p>まずはメモリ単位関連の説明です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">configuration</span> <span class="nx">file</span> <span class="nx">example</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span> <span class="nx">on</span> <span class="nx">units</span><span class="o">:</span> <span class="nx">when</span> <span class="nx">memory</span> <span class="nx">size</span> <span class="nx">is</span> <span class="nx">needed</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">specify</span>
</span><span class='line'><span class="err">#</span> <span class="nx">it</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">usual</span> <span class="nx">form</span> <span class="nx">of</span> <span class="mi">1</span><span class="nx">k</span> <span class="mi">5</span><span class="nx">GB</span> <span class="mi">4</span><span class="nx">M</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">k</span> <span class="o">=&gt;</span> <span class="mi">1000</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">kb</span> <span class="o">=&gt;</span> <span class="mi">1024</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="mi">1000000</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">mb</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">g</span> <span class="o">=&gt;</span> <span class="mi">1000000000</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="nx">gb</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="nx">bytes</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">units</span> <span class="nx">are</span> <span class="k">case</span> <span class="nx">insensitive</span> <span class="nx">so</span> <span class="mi">1</span><span class="nx">GB</span> <span class="mi">1</span><span class="nx">Gb</span> <span class="mi">1</span><span class="nx">gB</span> <span class="nx">are</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">same</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>もう上記のままですね。<br/>
<code>1k</code>か<code>1kb</code>なのか微妙に書き方を気をつけないと想定外の容量指定になるので気をつけましょう。<br/>
ただし、<code>1GB</code> / <code>1Gb</code> / <code>1gB</code>は微妙に書き方が異なりますが指定容量は同じです。</p>

<h4>includeによる設定ファイルの分割について</h4>

<p>Apacheなどでもよくある通り<code>include</code>を利用することもできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">##################################</span> <span class="nx">INCLUDES</span> <span class="err">###################################</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">Include</span> <span class="nx">one</span> <span class="nx">or</span> <span class="nx">more</span> <span class="nx">other</span> <span class="nx">config</span> <span class="nx">files</span> <span class="nx">here</span><span class="p">.</span>  <span class="nx">This</span> <span class="nx">is</span> <span class="nx">useful</span> <span class="k">if</span> <span class="nx">you</span>
</span><span class='line'><span class="err">#</span> <span class="nx">have</span> <span class="nx">a</span> <span class="nx">standard</span> <span class="nx">template</span> <span class="nx">that</span> <span class="nx">goes</span> <span class="nx">to</span> <span class="nx">all</span> <span class="nx">Redis</span> <span class="nx">server</span> <span class="nx">but</span> <span class="nx">also</span> <span class="nx">need</span>
</span><span class='line'><span class="err">#</span> <span class="nx">to</span> <span class="nx">customize</span> <span class="nx">a</span> <span class="nx">few</span> <span class="nx">per</span><span class="o">-</span><span class="nx">server</span> <span class="nx">settings</span><span class="p">.</span>  <span class="nx">Include</span> <span class="nx">files</span> <span class="nx">can</span> <span class="nx">include</span>
</span><span class='line'><span class="err">#</span> <span class="nx">other</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">use</span> <span class="k">this</span> <span class="nx">wisely</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Notice</span> <span class="nx">option</span> <span class="s2">&quot;include&quot;</span> <span class="nx">won</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">be</span> <span class="nx">rewritten</span> <span class="nx">by</span> <span class="nx">command</span> <span class="s2">&quot;CONFIG REWRITE&quot;</span>
</span><span class='line'><span class="err">#</span> <span class="nx">from</span> <span class="nx">admin</span> <span class="nx">or</span> <span class="nx">Redis</span> <span class="nx">Sentinel</span><span class="p">.</span> <span class="nx">Since</span> <span class="nx">Redis</span> <span class="nx">always</span> <span class="nx">uses</span> <span class="nx">the</span> <span class="nx">last</span> <span class="nx">processed</span>
</span><span class='line'><span class="err">#</span> <span class="nx">line</span> <span class="nx">as</span> <span class="nx">value</span> <span class="nx">of</span> <span class="nx">a</span> <span class="nx">configuration</span> <span class="nx">directive</span><span class="p">,</span> <span class="nx">you</span><span class="err">‘</span><span class="nx">d</span> <span class="nx">better</span> <span class="nx">put</span> <span class="nx">includes</span>
</span><span class='line'><span class="err">#</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">beginning</span> <span class="nx">of</span> <span class="k">this</span> <span class="nx">file</span> <span class="nx">to</span> <span class="nx">avoid</span> <span class="nx">overwriting</span> <span class="nx">config</span> <span class="nx">change</span> <span class="nx">at</span> <span class="nx">runtime</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">instead</span> <span class="nx">you</span> <span class="nx">are</span> <span class="nx">interested</span> <span class="k">in</span> <span class="nx">using</span> <span class="nx">includes</span> <span class="nx">to</span> <span class="nx">override</span> <span class="nx">configuration</span>
</span><span class='line'><span class="err">#</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">better</span> <span class="nx">to</span> <span class="nx">use</span> <span class="nx">include</span> <span class="nx">as</span> <span class="nx">the</span> <span class="nx">last</span> <span class="nx">line</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">include</span> <span class="o">/</span><span class="nx">path</span><span class="o">/</span><span class="nx">to</span><span class="o">/</span><span class="nx">local</span><span class="p">.</span><span class="nx">conf</span>
</span><span class='line'><span class="err">#</span> <span class="nx">include</span> <span class="o">/</span><span class="nx">path</span><span class="o">/</span><span class="nx">to</span><span class="o">/</span><span class="nx">other</span><span class="p">.</span><span class="nx">conf</span>
</span></code></pre></td></tr></table></div></figure>


<p>サーバごとに設定を分けたいとか、第三者が見やすいように設定単位でファイルを分けたいとか様々な用途で便利に利用できるはずです。<br/>
<code>include</code>したファイルに定義した内容で<code>redis.conf</code>の定義内容を書き換えるのであれば、<code>redis.conf</code>の一番最後に<code>include</code>を書いた方が良いでしょう。<br/>
(逆に、書き換えたくないのであれば、<code>redis.conf</code>の初めに書きましょう。)</p>

<h4>一般設定について</h4>

<p>さて、最も基本となる設定です。<br/>
少々、長いので細かめに分割してみていきましょう。</p>

<h5>デーモン化の有無</h5>

<p>デーモン化の有無は下記で設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">Redis</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">run</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">daemon</span><span class="p">.</span> <span class="nx">Use</span> <span class="s1">&#39;yes&#39;</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">need</span> <span class="nx">it</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">write</span> <span class="nx">a</span> <span class="nx">pid</span> <span class="nx">file</span> <span class="k">in</span> <span class="err">/var/run/redis.pid when daemonized.</span>
</span><span class='line'><span class="nx">daemonize</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<p>デフォルト設定ではデーモン起動はしないようになっています。<br/>
* yes: デーモン起動する<br/>
* no: デーモン起動しない</p>

<p>PIDファイルはデフォルトで<code>/var/run/redis.pid</code>に出力します。</p>

<h5>PIDファイルの指定</h5>

<p>デフォルトとは異なる場所にPIDファイルを出力したい場合に指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">running</span> <span class="nx">daemonized</span><span class="p">,</span> <span class="nx">Redis</span> <span class="nx">writes</span> <span class="nx">a</span> <span class="nx">pid</span> <span class="nx">file</span> <span class="k">in</span> <span class="err">/var/run/redis.pid by</span>
</span><span class='line'><span class="err">#</span> <span class="k">default</span><span class="p">.</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">specify</span> <span class="nx">a</span> <span class="nx">custom</span> <span class="nx">pid</span> <span class="nx">file</span> <span class="nx">location</span> <span class="nx">here</span><span class="p">.</span>
</span><span class='line'><span class="nx">pidfile</span> <span class="o">/</span><span class="kd">var</span><span class="err">/run/redis/redis-server.pid</span>
</span></code></pre></td></tr></table></div></figure>


<h5>ボート番号の指定</h5>

<p>Redisを起動する際のポート番号を指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Accept</span> <span class="nx">connections</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">port</span><span class="p">,</span> <span class="k">default</span> <span class="nx">is</span> <span class="mi">6379</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">port</span> <span class="mi">0</span> <span class="nx">is</span> <span class="nx">specified</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">not</span> <span class="nx">listen</span> <span class="nx">on</span> <span class="nx">a</span> <span class="nx">TCP</span> <span class="nx">socket</span><span class="p">.</span>
</span><span class='line'><span class="nx">port</span> <span class="mi">6379</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>デフォルトポート番号: 6379</li>
<li>0指定: TCPソケット通信を受け付けない</li>
</ul>


<h5>IPアドレスの指定</h5>

<p>Redisを起動する際の接続するIPアドレスを指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">Redis</span> <span class="nx">listens</span> <span class="k">for</span> <span class="nx">connections</span> <span class="nx">from</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">network</span> <span class="nx">interfaces</span>
</span><span class='line'><span class="err">#</span> <span class="nx">available</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">server</span><span class="p">.</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">listen</span> <span class="nx">to</span> <span class="nx">just</span> <span class="nx">one</span> <span class="nx">or</span> <span class="nx">multiple</span>
</span><span class='line'><span class="err">#</span> <span class="nx">interfaces</span> <span class="nx">using</span> <span class="nx">the</span> <span class="s2">&quot;bind&quot;</span> <span class="nx">configuration</span> <span class="nx">directive</span><span class="p">,</span> <span class="nx">followed</span> <span class="nx">by</span> <span class="nx">one</span> <span class="nx">or</span>
</span><span class='line'><span class="err">#</span> <span class="nx">more</span> <span class="nx">IP</span> <span class="nx">addresses</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Examples</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">bind</span> <span class="mf">192.168</span><span class="p">.</span><span class="mf">1.100</span> <span class="mf">10.0</span><span class="p">.</span><span class="mf">0.1</span>
</span><span class='line'><span class="nx">bind</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span>
</span></code></pre></td></tr></table></div></figure>


<p>複数のIPアドレスを指定する場合は半角スペースを挟んで連続して書きましょう。</p>

<h5>Unixドメインソケット通信の設定</h5>

<p>TCP通信だけでなく、Unixドメインソケット通信を受け付ける場合に設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">path</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">unix</span> <span class="nx">socket</span> <span class="nx">that</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">listen</span> <span class="k">for</span>
</span><span class='line'><span class="err">#</span> <span class="nx">incoming</span> <span class="nx">connections</span><span class="p">.</span> <span class="nx">There</span> <span class="nx">is</span> <span class="nx">no</span> <span class="k">default</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">not</span> <span class="nx">listen</span>
</span><span class='line'><span class="err">#</span> <span class="nx">on</span> <span class="nx">a</span> <span class="nx">unix</span> <span class="nx">socket</span> <span class="nx">when</span> <span class="nx">not</span> <span class="nx">specified</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">unixsocket</span> <span class="o">/</span><span class="kd">var</span><span class="err">/run/redis/redis.sock</span>
</span><span class='line'><span class="err">#</span> <span class="nx">unixsocketperm</span> <span class="mi">755</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>デフォルトではコメントアウトされている

<ul>
<li>同一サーバ内での受付はTCPより良いという話も&hellip;!?</li>
</ul>
</li>
<li><code>unixsocket</code>: <code>socket</code>ファイルのパス指定</li>
<li><code>unixsocketperm</code>: <code>socket</code>ファイルへのアクセス権</li>
</ul>


<h5>タイムアウトの設定</h5>

<p>クライアントからの接続タイムアウト設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Close</span> <span class="nx">the</span> <span class="nx">connection</span> <span class="nx">after</span> <span class="nx">a</span> <span class="nx">client</span> <span class="nx">is</span> <span class="nx">idle</span> <span class="k">for</span> <span class="nx">N</span> <span class="nx">seconds</span> <span class="p">(</span><span class="mi">0</span> <span class="nx">to</span> <span class="nx">disable</span><span class="p">)</span>
</span><span class='line'><span class="nx">timeout</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>0を設定すると、タイムアウトは無効になります。</p>

<h5>TCP KeepAlive設定</h5>

<p>TCP通信の生存確認に関する設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">TCP</span> <span class="nx">keepalive</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">non</span><span class="o">-</span><span class="nx">zero</span><span class="p">,</span> <span class="nx">use</span> <span class="nx">SO_KEEPALIVE</span> <span class="nx">to</span> <span class="nx">send</span> <span class="nx">TCP</span> <span class="nx">ACKs</span> <span class="nx">to</span> <span class="nx">clients</span> <span class="k">in</span> <span class="nx">absence</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">communication</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">is</span> <span class="nx">useful</span> <span class="k">for</span> <span class="nx">two</span> <span class="nx">reasons</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">Detect</span> <span class="nx">dead</span> <span class="nx">peers</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">Take</span> <span class="nx">the</span> <span class="nx">connection</span> <span class="nx">alive</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">network</span>
</span><span class='line'><span class="err">#</span>    <span class="nx">equipment</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">middle</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">On</span> <span class="nx">Linux</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">value</span> <span class="p">(</span><span class="k">in</span> <span class="nx">seconds</span><span class="p">)</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">period</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">send</span> <span class="nx">ACKs</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">to</span> <span class="nx">close</span> <span class="nx">the</span> <span class="nx">connection</span> <span class="nx">the</span> <span class="kr">double</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">time</span> <span class="nx">is</span> <span class="nx">needed</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">On</span> <span class="nx">other</span> <span class="nx">kernels</span> <span class="nx">the</span> <span class="nx">period</span> <span class="nx">depends</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">kernel</span> <span class="nx">configuration</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">A</span> <span class="nx">reasonable</span> <span class="nx">value</span> <span class="k">for</span> <span class="k">this</span> <span class="nx">option</span> <span class="nx">is</span> <span class="mi">60</span> <span class="nx">seconds</span><span class="p">.</span>
</span><span class='line'><span class="nx">tcp</span><span class="o">-</span><span class="nx">keepalive</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>有効にすることで、通信断(Dead Peer)状態を防いだり、コネクションの接続生存を確認することができます</li>
<li>適切な値として <code>60秒</code> が推奨されています</li>
</ul>


<h5>ログレベルの設定</h5>

<p>ログの出力量を調整するために設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">server</span> <span class="nx">verbosity</span> <span class="nx">level</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">one</span> <span class="nx">of</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span> <span class="nx">debug</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">lot</span> <span class="nx">of</span> <span class="nx">information</span><span class="p">,</span> <span class="nx">useful</span> <span class="k">for</span> <span class="nx">development</span><span class="o">/</span><span class="nx">testing</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span> <span class="nx">verbose</span> <span class="p">(</span><span class="nx">many</span> <span class="nx">rarely</span> <span class="nx">useful</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">not</span> <span class="nx">a</span> <span class="nx">mess</span> <span class="nx">like</span> <span class="nx">the</span> <span class="nx">debug</span> <span class="nx">level</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span> <span class="nx">notice</span> <span class="p">(</span><span class="nx">moderately</span> <span class="nx">verbose</span><span class="p">,</span> <span class="nx">what</span> <span class="nx">you</span> <span class="nx">want</span> <span class="k">in</span> <span class="nx">production</span> <span class="nx">probably</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span> <span class="nx">warning</span> <span class="p">(</span><span class="nx">only</span> <span class="nx">very</span> <span class="nx">important</span> <span class="o">/</span> <span class="nx">critical</span> <span class="nx">messages</span> <span class="nx">are</span> <span class="nx">logged</span><span class="p">)</span>
</span><span class='line'><span class="nx">loglevel</span> <span class="nx">notice</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>debug</code>: 開発やテスト用に利用。大量のログを出力します</li>
<li><code>verbose</code>: <code>debug</code>よりは少ないものの多くのログを出力します</li>
<li><code>notice</code>: 商用に適した設定です</li>
<li><code>warning</code>: 重要またはクリティカルなメッセージのみログに出します</li>
</ul>


<h5>ログファイルの出力先の指定</h5>

<p>ログファイルの出力先のパスを指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">log</span> <span class="nx">file</span> <span class="nx">name</span><span class="p">.</span> <span class="nx">Also</span> <span class="nx">the</span> <span class="nx">empty</span> <span class="nx">string</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">force</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">to</span> <span class="nx">log</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">standard</span> <span class="nx">output</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">use</span> <span class="nx">standard</span>
</span><span class='line'><span class="err">#</span> <span class="nx">output</span> <span class="k">for</span> <span class="nx">logging</span> <span class="nx">but</span> <span class="nx">daemonize</span><span class="p">,</span> <span class="nx">logs</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">sent</span> <span class="nx">to</span> <span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="kc">null</span>
</span><span class='line'><span class="nx">logfile</span> <span class="o">/</span><span class="kd">var</span><span class="err">/log/redis/redis-server.log</span>
</span></code></pre></td></tr></table></div></figure>


<h5>システムログの設定</h5>

<p>システムログに関する設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">To</span> <span class="nx">enable</span> <span class="nx">logging</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">system</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">just</span> <span class="nx">set</span> <span class="s1">&#39;syslog-enabled&#39;</span> <span class="nx">to</span> <span class="nx">yes</span><span class="p">,</span>
</span><span class='line'><span class="err">#</span> <span class="nx">and</span> <span class="nx">optionally</span> <span class="nx">update</span> <span class="nx">the</span> <span class="nx">other</span> <span class="nx">syslog</span> <span class="nx">parameters</span> <span class="nx">to</span> <span class="nx">suit</span> <span class="nx">your</span> <span class="nx">needs</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">syslog</span><span class="o">-</span><span class="nx">enabled</span> <span class="nx">no</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">syslog</span> <span class="nx">identity</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">syslog</span><span class="o">-</span><span class="nx">ident</span> <span class="nx">redis</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">syslog</span> <span class="nx">facility</span><span class="p">.</span> <span class="nx">Must</span> <span class="nx">be</span> <span class="nx">USER</span> <span class="nx">or</span> <span class="nx">between</span> <span class="nx">LOCAL0</span><span class="o">-</span><span class="nx">LOCAL7</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">syslog</span><span class="o">-</span><span class="nx">facility</span> <span class="nx">local0</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>syslog-enabled</code>: システムログのロギングの有無を設定します</li>
<li><code>syslog-ident</code>: システムログの識別子の設定をします</li>
<li><code>syslog-facility</code>: システムログの分類を設定します

<ul>
<li><code>user</code>: ユーザプロセスのメッセージを記録するために設定します</li>
<li><code>local0 〜 7</code>: セキュリティやネットワークなど細かく設定できます</li>
</ul>
</li>
</ul>


<p><code>local0 〜 7</code>については<a href="https://www.furukawa.co.jp/fitelnet/f/man/100/command-config/global_config/syslog_facility.htm#facility">syslog facility</a>が参考になりそうです。</p>

<h5>データベースの設定</h5>

<p>使用するデータベース番号を指定します。<br/>
デフォルトで<code>16</code>が指定されていることで利用可能なデータベース番号は<code>0 〜 15</code>となっています。<br/>
特に何もしなければ<code>DB 0</code>を利用します。<br/>
<code>SELECT</code>文を利用することでデータベースを指定して使うこともできます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Set</span> <span class="nx">the</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">databases</span><span class="p">.</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">database</span> <span class="nx">is</span> <span class="nx">DB</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">select</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">different</span> <span class="nx">one</span> <span class="nx">on</span> <span class="nx">a</span> <span class="nx">per</span><span class="o">-</span><span class="nx">connection</span> <span class="nx">basis</span> <span class="nx">using</span> <span class="nx">SELECT</span> <span class="o">&lt;</span><span class="nx">dbid</span><span class="o">&gt;</span> <span class="nx">where</span>
</span><span class='line'><span class="err">#</span> <span class="nx">dbid</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">number</span> <span class="nx">between</span> <span class="mi">0</span> <span class="nx">and</span> <span class="s1">&#39;databases&#39;</span><span class="o">-</span><span class="mi">1</span>
</span><span class='line'><span class="nx">databases</span> <span class="mi">16</span>
</span></code></pre></td></tr></table></div></figure>


<h4>スナップショット(バックアップ)設定</h4>

<p>こちらもかなり重要な設定となります。<br/>
利用用途にもよりますが、サービス上、消えてしまってはまずいデータを扱うのであれば堅牢な仕組みになるように設定を考える必要があります。</p>

<h5>ディスク保存の頻度設定</h5>

<p><code>key</code>の変更数と保存までに時間を設定します。<br/>
これにより、ある程度自由に堅牢性を設定することが可能です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Save</span> <span class="nx">the</span> <span class="nx">DB</span> <span class="nx">on</span> <span class="nx">disk</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">save</span> <span class="o">&lt;</span><span class="nx">seconds</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">changes</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">Will</span> <span class="nx">save</span> <span class="nx">the</span> <span class="nx">DB</span> <span class="k">if</span> <span class="nx">both</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">seconds</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">given</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">number</span> <span class="nx">of</span> <span class="nx">write</span> <span class="nx">operations</span> <span class="nx">against</span> <span class="nx">the</span> <span class="nx">DB</span> <span class="nx">occurred</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">In</span> <span class="nx">the</span> <span class="nx">example</span> <span class="nx">below</span> <span class="nx">the</span> <span class="nx">behaviour</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">to</span> <span class="nx">save</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">after</span> <span class="mi">900</span> <span class="nx">sec</span> <span class="p">(</span><span class="mi">15</span> <span class="nx">min</span><span class="p">)</span> <span class="k">if</span> <span class="nx">at</span> <span class="nx">least</span> <span class="mi">1</span> <span class="nx">key</span> <span class="nx">changed</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">after</span> <span class="mi">300</span> <span class="nx">sec</span> <span class="p">(</span><span class="mi">5</span> <span class="nx">min</span><span class="p">)</span> <span class="k">if</span> <span class="nx">at</span> <span class="nx">least</span> <span class="mi">10</span> <span class="nx">keys</span> <span class="nx">changed</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">after</span> <span class="mi">60</span> <span class="nx">sec</span> <span class="k">if</span> <span class="nx">at</span> <span class="nx">least</span> <span class="mi">10000</span> <span class="nx">keys</span> <span class="nx">changed</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">Note</span><span class="o">:</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">disable</span> <span class="nx">saving</span> <span class="nx">at</span> <span class="nx">all</span> <span class="nx">commenting</span> <span class="nx">all</span> <span class="nx">the</span> <span class="s2">&quot;save&quot;</span> <span class="nx">lines</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">It</span> <span class="nx">is</span> <span class="nx">also</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">remove</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">previously</span> <span class="nx">configured</span> <span class="nx">save</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">points</span> <span class="nx">by</span> <span class="nx">adding</span> <span class="nx">a</span> <span class="nx">save</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">single</span> <span class="nx">empty</span> <span class="nx">string</span> <span class="nx">argument</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">like</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">example</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>   <span class="nx">save</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">save</span> <span class="mi">900</span> <span class="mi">1</span>
</span><span class='line'><span class="nx">save</span> <span class="mi">300</span> <span class="mi">10</span>
</span><span class='line'><span class="nx">save</span> <span class="mi">60</span> <span class="mi">10000</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記デフォルト設定の意味は下記です。<br/>
* <code>save 900 1</code>: 1個の<code>key</code>が変更されたら、15分後にディスクにその状態を保存<br/>
* <code>sabe 300 10</code>: 10個の<code>key</code>が変更されたら、5分後にディスクにその状態を保存<br/>
* <code>save 60 10000</code>: 10000個の<code>key</code>が変更されたら、1分後にディスクにその状態を保存</p>

<p>もしディスク保存したくなければ(インメモリでの利用のみであれば)<code>save ""</code>を指定しましょう。</p>

<h5>エラー発生時の保存挙動の設定</h5>

<p>これはエラーが発生したときにディスク保存をどうするかを決める設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">stop</span> <span class="nx">accepting</span> <span class="nx">writes</span> <span class="k">if</span> <span class="nx">RDB</span> <span class="nx">snapshots</span> <span class="nx">are</span> <span class="nx">enabled</span>
</span><span class='line'><span class="err">#</span> <span class="p">(</span><span class="nx">at</span> <span class="nx">least</span> <span class="nx">one</span> <span class="nx">save</span> <span class="nx">point</span><span class="p">)</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">latest</span> <span class="nx">background</span> <span class="nx">save</span> <span class="nx">failed</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">will</span> <span class="nx">make</span> <span class="nx">the</span> <span class="nx">user</span> <span class="nx">aware</span> <span class="p">(</span><span class="k">in</span> <span class="nx">a</span> <span class="nx">hard</span> <span class="nx">way</span><span class="p">)</span> <span class="nx">that</span> <span class="nx">data</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">persisting</span>
</span><span class='line'><span class="err">#</span> <span class="nx">on</span> <span class="nx">disk</span> <span class="nx">properly</span><span class="p">,</span> <span class="nx">otherwise</span> <span class="nx">chances</span> <span class="nx">are</span> <span class="nx">that</span> <span class="nx">no</span> <span class="nx">one</span> <span class="nx">will</span> <span class="nx">notice</span> <span class="nx">and</span> <span class="nx">some</span>
</span><span class='line'><span class="err">#</span> <span class="nx">disaster</span> <span class="nx">will</span> <span class="nx">happen</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">background</span> <span class="nx">saving</span> <span class="nx">process</span> <span class="nx">will</span> <span class="nx">start</span> <span class="nx">working</span> <span class="nx">again</span> <span class="nx">Redis</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">automatically</span> <span class="nx">allow</span> <span class="nx">writes</span> <span class="nx">again</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">However</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">setup</span> <span class="nx">your</span> <span class="nx">proper</span> <span class="nx">monitoring</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">Redis</span> <span class="nx">server</span>
</span><span class='line'><span class="err">#</span> <span class="nx">and</span> <span class="nx">persistence</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">may</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">disable</span> <span class="k">this</span> <span class="nx">feature</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">Redis</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="k">continue</span> <span class="nx">to</span> <span class="nx">work</span> <span class="nx">as</span> <span class="nx">usual</span> <span class="nx">even</span> <span class="k">if</span> <span class="nx">there</span> <span class="nx">are</span> <span class="nx">problems</span> <span class="kd">with</span> <span class="nx">disk</span><span class="p">,</span>
</span><span class='line'><span class="err">#</span> <span class="nx">permissions</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span><span class="p">.</span>
</span><span class='line'><span class="nx">stop</span><span class="o">-</span><span class="nx">writes</span><span class="o">-</span><span class="nx">on</span><span class="o">-</span><span class="nx">bgsave</span><span class="o">-</span><span class="nx">error</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>yes: 保存を止めます</li>
<li>no: 書き込みを続けます</li>
</ul>


<h5>Dump時の圧縮設定</h5>

<p>データをDumpする際に<code>LZF</code>圧縮をかけるか否かを設定できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Compress</span> <span class="nx">string</span> <span class="nx">objects</span> <span class="nx">using</span> <span class="nx">LZF</span> <span class="nx">when</span> <span class="nx">dump</span> <span class="p">.</span><span class="nx">rdb</span> <span class="nx">databases</span><span class="o">?</span>
</span><span class='line'><span class="err">#</span> <span class="nx">For</span> <span class="k">default</span> <span class="nx">that</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">set</span> <span class="nx">to</span> <span class="s1">&#39;yes&#39;</span> <span class="nx">as</span> <span class="nx">it</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">almost</span> <span class="nx">always</span> <span class="nx">a</span> <span class="nx">win</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">save</span> <span class="nx">some</span> <span class="nx">CPU</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">saving</span> <span class="nx">child</span> <span class="nx">set</span> <span class="nx">it</span> <span class="nx">to</span> <span class="s1">&#39;no&#39;</span> <span class="nx">but</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">dataset</span> <span class="nx">will</span> <span class="nx">likely</span> <span class="nx">be</span> <span class="nx">bigger</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">compressible</span> <span class="nx">values</span> <span class="nx">or</span> <span class="nx">keys</span><span class="p">.</span>
</span><span class='line'><span class="nx">rdbcompression</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>yes: 圧縮します(CPU負荷が上がる一方で小容量)</li>
<li>no: 圧縮しません(CPU負荷が下がる一方で大容量)</li>
</ul>


<h5>Checksum設定</h5>

<p>これはデータの整合性を検証するための設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Since</span> <span class="nx">version</span> <span class="mi">5</span> <span class="nx">of</span> <span class="nx">RDB</span> <span class="nx">a</span> <span class="nx">CRC64</span> <span class="nx">checksum</span> <span class="nx">is</span> <span class="nx">placed</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">end</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">file</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">makes</span> <span class="nx">the</span> <span class="nx">format</span> <span class="nx">more</span> <span class="nx">resistant</span> <span class="nx">to</span> <span class="nx">corruption</span> <span class="nx">but</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">performance</span>
</span><span class='line'><span class="err">#</span> <span class="nx">hit</span> <span class="nx">to</span> <span class="nx">pay</span> <span class="p">(</span><span class="nx">around</span> <span class="mi">10</span><span class="o">%</span><span class="p">)</span> <span class="nx">when</span> <span class="nx">saving</span> <span class="nx">and</span> <span class="nx">loading</span> <span class="nx">RDB</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">disable</span> <span class="nx">it</span>
</span><span class='line'><span class="err">#</span> <span class="k">for</span> <span class="nx">maximum</span> <span class="nx">performances</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">RDB</span> <span class="nx">files</span> <span class="nx">created</span> <span class="kd">with</span> <span class="nx">checksum</span> <span class="nx">disabled</span> <span class="nx">have</span> <span class="nx">a</span> <span class="nx">checksum</span> <span class="nx">of</span> <span class="nx">zero</span> <span class="nx">that</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">tell</span> <span class="nx">the</span> <span class="nx">loading</span> <span class="nx">code</span> <span class="nx">to</span> <span class="nx">skip</span> <span class="nx">the</span> <span class="nx">check</span><span class="p">.</span>
</span><span class='line'><span class="nx">rdbchecksum</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<p>データ保存時にRDBファイルの読み込みを行うため、10%の性能劣化が発生するが、堅牢なデータを担保したいのであれば設定して損はないでしょう。</p>

<h5>Dumpファイル名の設定</h5>

<p>Dumpしたファイルの名称を指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">filename</span> <span class="nx">where</span> <span class="nx">to</span> <span class="nx">dump</span> <span class="nx">the</span> <span class="nx">DB</span>
</span><span class='line'><span class="nx">dbfilename</span> <span class="nx">dump</span><span class="p">.</span><span class="nx">rdb</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Dumpファイルの保存場所の設定</h5>

<p>どこにDumpファイルを配置するかの設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">working</span> <span class="nx">directory</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">DB</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">written</span> <span class="nx">inside</span> <span class="k">this</span> <span class="nx">directory</span><span class="p">,</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">filename</span> <span class="nx">specified</span>
</span><span class='line'><span class="err">#</span> <span class="nx">above</span> <span class="nx">using</span> <span class="nx">the</span> <span class="s1">&#39;dbfilename&#39;</span> <span class="nx">configuration</span> <span class="nx">directive</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">Append</span> <span class="nx">Only</span> <span class="nx">File</span> <span class="nx">will</span> <span class="nx">also</span> <span class="nx">be</span> <span class="nx">created</span> <span class="nx">inside</span> <span class="k">this</span> <span class="nx">directory</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">you</span> <span class="nx">must</span> <span class="nx">specify</span> <span class="nx">a</span> <span class="nx">directory</span> <span class="nx">here</span><span class="p">,</span> <span class="nx">not</span> <span class="nx">a</span> <span class="nx">file</span> <span class="nx">name</span><span class="p">.</span>
</span><span class='line'><span class="nx">dir</span> <span class="o">/</span><span class="kd">var</span><span class="err">/lib/redis</span>
</span></code></pre></td></tr></table></div></figure>


<h4>レプリケーション設定</h4>

<p>障害発生時に利用するレプリケーションの設定についてもデフォルトで説明書きがなされています。</p>

<h5>スレーブ設定</h5>

<p>スレーブのコピー元となるマスターを指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Master</span><span class="o">-</span><span class="nx">Slave</span> <span class="nx">replication</span><span class="p">.</span> <span class="nx">Use</span> <span class="nx">slaveof</span> <span class="nx">to</span> <span class="nx">make</span> <span class="nx">a</span> <span class="nx">Redis</span> <span class="nx">instance</span> <span class="nx">a</span> <span class="nx">copy</span> <span class="nx">of</span>
</span><span class='line'><span class="err">#</span> <span class="nx">another</span> <span class="nx">Redis</span> <span class="nx">server</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">configuration</span> <span class="nx">is</span> <span class="nx">local</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">slave</span>
</span><span class='line'><span class="err">#</span> <span class="nx">so</span> <span class="k">for</span> <span class="nx">example</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">configure</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">to</span> <span class="nx">save</span> <span class="nx">the</span> <span class="nx">DB</span> <span class="kd">with</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">different</span> <span class="nx">interval</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">to</span> <span class="nx">listen</span> <span class="nx">to</span> <span class="nx">another</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">on</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">slaveof</span> <span class="o">&lt;</span><span class="nx">masterip</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">masterport</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>スレーブ側のRedisに設定を記載します。<br/>
マスター側とDB保存間隔の設定や接続時のポート番号が異なっていたとしても何ら問題はありません。</p>

<h5>マスターのパスワード設定</h5>

<p>マスター側がパスワード認証を必要している場合、スレーブ側でマスターのパスワードを設定していないとリクエスト要求が通りません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">is</span> <span class="nx">password</span> <span class="kr">protected</span> <span class="p">(</span><span class="nx">using</span> <span class="nx">the</span> <span class="s2">&quot;requirepass&quot;</span> <span class="nx">configuration</span>
</span><span class='line'><span class="err">#</span> <span class="nx">directive</span> <span class="nx">below</span><span class="p">)</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">tell</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">to</span> <span class="nx">authenticate</span> <span class="nx">before</span>
</span><span class='line'><span class="err">#</span> <span class="nx">starting</span> <span class="nx">the</span> <span class="nx">replication</span> <span class="nx">synchronization</span> <span class="nx">process</span><span class="p">,</span> <span class="nx">otherwise</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">refuse</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">request</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">masterauth</span> <span class="o">&lt;</span><span class="nx">master</span><span class="o">-</span><span class="nx">password</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>マスターとの同期が最新でない場合のスレーブ挙動の設定</h5>

<p>スレーブがマスターと同期が取れなくなることは長く運用を続けていく上で必ず発生しうるものです。<br/>
その際にスレーブがどのような振る舞いをすべきか設定しておきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">loses</span> <span class="nx">its</span> <span class="nx">connection</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">master</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">when</span> <span class="nx">the</span> <span class="nx">replication</span>
</span><span class='line'><span class="err">#</span> <span class="nx">is</span> <span class="nx">still</span> <span class="k">in</span> <span class="nx">progress</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">can</span> <span class="nx">act</span> <span class="k">in</span> <span class="nx">two</span> <span class="nx">different</span> <span class="nx">ways</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">slave</span><span class="o">-</span><span class="nx">serve</span><span class="o">-</span><span class="nx">stale</span><span class="o">-</span><span class="nx">data</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="s1">&#39;yes&#39;</span> <span class="p">(</span><span class="nx">the</span> <span class="k">default</span><span class="p">)</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span>    <span class="nx">still</span> <span class="nx">reply</span> <span class="nx">to</span> <span class="nx">client</span> <span class="nx">requests</span><span class="p">,</span> <span class="nx">possibly</span> <span class="kd">with</span> <span class="nx">out</span> <span class="nx">of</span> <span class="nx">date</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span>    <span class="nx">data</span> <span class="nx">set</span> <span class="nx">may</span> <span class="nx">just</span> <span class="nx">be</span> <span class="nx">empty</span> <span class="k">if</span> <span class="k">this</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">first</span> <span class="nx">synchronization</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nx">slave</span><span class="o">-</span><span class="nx">serve</span><span class="o">-</span><span class="nx">stale</span><span class="o">-</span><span class="nx">data</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="s1">&#39;no&#39;</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">will</span> <span class="nx">reply</span> <span class="kd">with</span>
</span><span class='line'><span class="err">#</span>    <span class="nx">an</span> <span class="nx">error</span> <span class="s2">&quot;SYNC with master in progress&quot;</span> <span class="nx">to</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">kind</span> <span class="nx">of</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>    <span class="nx">but</span> <span class="nx">to</span> <span class="nx">INFO</span> <span class="nx">and</span> <span class="nx">SLAVEOF</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="nx">slave</span><span class="o">-</span><span class="nx">serve</span><span class="o">-</span><span class="nx">stale</span><span class="o">-</span><span class="nx">data</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>yes</code>: 最後に同期が取れた際の最新データを返却</li>
<li><code>no</code>: 最新の同期が取れていないためエラーを返却</li>
</ul>


<h5>スレーブの書き込み権限の設定</h5>

<p>特別な理由がない限り、<code>yes</code>で良さそうな設定です。<br/>
スレーブは基本的にマスターに障害が発生した場合に利用する想定なので、直接書き込み権限をつける必要はないでしょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">configure</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">instance</span> <span class="nx">to</span> <span class="nx">accept</span> <span class="nx">writes</span> <span class="nx">or</span> <span class="nx">not</span><span class="p">.</span> <span class="nx">Writing</span> <span class="nx">against</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">instance</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">useful</span> <span class="nx">to</span> <span class="nx">store</span> <span class="nx">some</span> <span class="nx">ephemeral</span> <span class="nx">data</span> <span class="p">(</span><span class="nx">because</span> <span class="nx">data</span>
</span><span class='line'><span class="err">#</span> <span class="nx">written</span> <span class="nx">on</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">easily</span> <span class="nx">deleted</span> <span class="nx">after</span> <span class="nx">resync</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">master</span><span class="p">)</span> <span class="nx">but</span>
</span><span class='line'><span class="err">#</span> <span class="nx">may</span> <span class="nx">also</span> <span class="nx">cause</span> <span class="nx">problems</span> <span class="k">if</span> <span class="nx">clients</span> <span class="nx">are</span> <span class="nx">writing</span> <span class="nx">to</span> <span class="nx">it</span> <span class="nx">because</span> <span class="nx">of</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">misconfiguration</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Since</span> <span class="nx">Redis</span> <span class="mf">2.6</span> <span class="nx">by</span> <span class="k">default</span> <span class="nx">slaves</span> <span class="nx">are</span> <span class="nx">read</span><span class="o">-</span><span class="nx">only</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span><span class="o">:</span> <span class="nx">read</span> <span class="nx">only</span> <span class="nx">slaves</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">designed</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">exposed</span> <span class="nx">to</span> <span class="nx">untrusted</span> <span class="nx">clients</span>
</span><span class='line'><span class="err">#</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">internet</span><span class="p">.</span> <span class="nx">It</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">just</span> <span class="nx">a</span> <span class="nx">protection</span> <span class="nx">layer</span> <span class="nx">against</span> <span class="nx">misuse</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">instance</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Still</span> <span class="nx">a</span> <span class="nx">read</span> <span class="nx">only</span> <span class="nx">slave</span> <span class="nx">exports</span> <span class="nx">by</span> <span class="k">default</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">administrative</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span> <span class="nx">such</span> <span class="nx">as</span> <span class="nx">CONFIG</span><span class="p">,</span> <span class="nx">DEBUG</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span><span class="p">.</span> <span class="nx">To</span> <span class="nx">a</span> <span class="nx">limited</span> <span class="nx">extent</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">improve</span>
</span><span class='line'><span class="err">#</span> <span class="nx">security</span> <span class="nx">of</span> <span class="nx">read</span> <span class="nx">only</span> <span class="nx">slaves</span> <span class="nx">using</span> <span class="s1">&#39;rename-command&#39;</span> <span class="nx">to</span> <span class="nx">shadow</span> <span class="nx">all</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">administrative</span> <span class="o">/</span> <span class="nx">dangerous</span> <span class="nx">commands</span><span class="p">.</span>
</span><span class='line'><span class="nx">slave</span><span class="o">-</span><span class="nx">read</span><span class="o">-</span><span class="nx">only</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意すべきこととしては、<code>slave-read-only</code>を<code>yes</code>に設定したとしても、<code>CONFIG</code>コマンドなどで設定値を変更することができてしまいます。<br/>
もし、それを防止したいのであれば、<code>rename-command</code>を利用することで予めコマンド名を第三者からはわからないもに変えておきましょう。</p>

<h5>マスターへのヘルスチェック設定</h5>

<p>スレーブがマスターの生存を確認するために流し込む<code>ping</code>の時間の間隔設定です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Slaves</span> <span class="nx">send</span> <span class="nx">PINGs</span> <span class="nx">to</span> <span class="nx">server</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">predefined</span> <span class="nx">interval</span><span class="p">.</span> <span class="nx">It</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">change</span>
</span><span class='line'><span class="err">#</span> <span class="k">this</span> <span class="nx">interval</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">repl_ping_slave_period</span> <span class="nx">option</span><span class="p">.</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">value</span> <span class="nx">is</span> <span class="mi">10</span>
</span><span class='line'><span class="err">#</span> <span class="nx">seconds</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">repl</span><span class="o">-</span><span class="nx">ping</span><span class="o">-</span><span class="nx">slave</span><span class="o">-</span><span class="nx">period</span> <span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<h5>レプリケーションのタイムアウト設定</h5>

<p>マスタースレーブ間で同期を取る際などにリクエスト/レスポンスが発生します。<br/>
その際のタイムアウト設定となります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">following</span> <span class="nx">option</span> <span class="nx">sets</span> <span class="nx">the</span> <span class="nx">replication</span> <span class="nx">timeout</span> <span class="k">for</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">Bulk</span> <span class="nx">transfer</span> <span class="nx">I</span><span class="o">/</span><span class="nx">O</span> <span class="nx">during</span> <span class="nx">SYNC</span><span class="p">,</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">slave</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">Master</span> <span class="nx">timeout</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">slaves</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">pings</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">Slave</span> <span class="nx">timeout</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">masters</span> <span class="p">(</span><span class="nx">REPLCONF</span> <span class="nx">ACK</span> <span class="nx">pings</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">important</span> <span class="nx">to</span> <span class="nx">make</span> <span class="nx">sure</span> <span class="nx">that</span> <span class="k">this</span> <span class="nx">value</span> <span class="nx">is</span> <span class="nx">greater</span> <span class="nx">than</span> <span class="nx">the</span> <span class="nx">value</span>
</span><span class='line'><span class="err">#</span> <span class="nx">specified</span> <span class="k">for</span> <span class="nx">repl</span><span class="o">-</span><span class="nx">ping</span><span class="o">-</span><span class="nx">slave</span><span class="o">-</span><span class="nx">period</span> <span class="nx">otherwise</span> <span class="nx">a</span> <span class="nx">timeout</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">detected</span>
</span><span class='line'><span class="err">#</span> <span class="nx">every</span> <span class="nx">time</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">low</span> <span class="nx">traffic</span> <span class="nx">between</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">slave</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">repl</span><span class="o">-</span><span class="nx">timeout</span> <span class="mi">60</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意点としては、<code>repl-ping-slave-period</code>よりも大きな設定をしないと毎回<code>ping</code>でタイムアウトすることになります。</p>

<h5>TCPの遅延に関する設定</h5>

<p>TCP通信時の帯域幅の占有可否と遅延の許容可否の優先度を決めます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Disable</span> <span class="nx">TCP_NODELAY</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">socket</span> <span class="nx">after</span> <span class="nx">SYNC</span><span class="o">?</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">select</span> <span class="s2">&quot;yes&quot;</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">use</span> <span class="nx">a</span> <span class="nx">smaller</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">TCP</span> <span class="nx">packets</span> <span class="nx">and</span>
</span><span class='line'><span class="err">#</span> <span class="nx">less</span> <span class="nx">bandwidth</span> <span class="nx">to</span> <span class="nx">send</span> <span class="nx">data</span> <span class="nx">to</span> <span class="nx">slaves</span><span class="p">.</span> <span class="nx">But</span> <span class="k">this</span> <span class="nx">can</span> <span class="nx">add</span> <span class="nx">a</span> <span class="nx">delay</span> <span class="k">for</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">data</span> <span class="nx">to</span> <span class="nx">appear</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">side</span><span class="p">,</span> <span class="nx">up</span> <span class="nx">to</span> <span class="mi">40</span> <span class="nx">milliseconds</span> <span class="kd">with</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Linux</span> <span class="nx">kernels</span> <span class="nx">using</span> <span class="nx">a</span> <span class="k">default</span> <span class="nx">configuration</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">select</span> <span class="s2">&quot;no&quot;</span> <span class="nx">the</span> <span class="nx">delay</span> <span class="k">for</span> <span class="nx">data</span> <span class="nx">to</span> <span class="nx">appear</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">side</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">be</span> <span class="nx">reduced</span> <span class="nx">but</span> <span class="nx">more</span> <span class="nx">bandwidth</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">used</span> <span class="k">for</span> <span class="nx">replication</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">we</span> <span class="nx">optimize</span> <span class="k">for</span> <span class="nx">low</span> <span class="nx">latency</span><span class="p">,</span> <span class="nx">but</span> <span class="k">in</span> <span class="nx">very</span> <span class="nx">high</span> <span class="nx">traffic</span> <span class="nx">conditions</span>
</span><span class='line'><span class="err">#</span> <span class="nx">or</span> <span class="nx">when</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">and</span> <span class="nx">slaves</span> <span class="nx">are</span> <span class="nx">many</span> <span class="nx">hops</span> <span class="nx">away</span><span class="p">,</span> <span class="nx">turning</span> <span class="k">this</span> <span class="nx">to</span> <span class="s2">&quot;yes&quot;</span> <span class="nx">may</span>
</span><span class='line'><span class="err">#</span> <span class="nx">be</span> <span class="nx">a</span> <span class="nx">good</span> <span class="nx">idea</span><span class="p">.</span>
</span><span class='line'><span class="nx">repl</span><span class="o">-</span><span class="nx">disable</span><span class="o">-</span><span class="nx">tcp</span><span class="o">-</span><span class="nx">nodelay</span> <span class="nx">no</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>yes</code>: TCP通信時のパケット数を小さく抑えることで、帯域幅の占有率を下げることができます。一方で遅延は増加します。</li>
<li><code>no</code>: TCP通信時に帯域幅を広く使うことで遅延を減少させます。</li>
</ul>


<h5>スレーブのバックアップログサイズの設定</h5>

<p>マスターからスレーブへの接続が切断されてしまっている間に保存しておく差分の最大サイズです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Set</span> <span class="nx">the</span> <span class="nx">replication</span> <span class="nx">backlog</span> <span class="nx">size</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">backlog</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">buffer</span> <span class="nx">that</span> <span class="nx">accumulates</span>
</span><span class='line'><span class="err">#</span> <span class="nx">slave</span> <span class="nx">data</span> <span class="nx">when</span> <span class="nx">slaves</span> <span class="nx">are</span> <span class="nx">disconnected</span> <span class="k">for</span> <span class="nx">some</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">when</span> <span class="nx">a</span> <span class="nx">slave</span>
</span><span class='line'><span class="err">#</span> <span class="nx">wants</span> <span class="nx">to</span> <span class="nx">reconnect</span> <span class="nx">again</span><span class="p">,</span> <span class="nx">often</span> <span class="nx">a</span> <span class="nx">full</span> <span class="nx">resync</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">needed</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">a</span> <span class="nx">partial</span>
</span><span class='line'><span class="err">#</span> <span class="nx">resync</span> <span class="nx">is</span> <span class="nx">enough</span><span class="p">,</span> <span class="nx">just</span> <span class="nx">passing</span> <span class="nx">the</span> <span class="nx">portion</span> <span class="nx">of</span> <span class="nx">data</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">missed</span> <span class="k">while</span>
</span><span class='line'><span class="err">#</span> <span class="nx">disconnected</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">biggest</span> <span class="nx">the</span> <span class="nx">replication</span> <span class="nx">backlog</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">longer</span> <span class="nx">the</span> <span class="nx">time</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">can</span> <span class="nx">be</span>
</span><span class='line'><span class="err">#</span> <span class="nx">disconnected</span> <span class="nx">and</span> <span class="nx">later</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">perform</span> <span class="nx">a</span> <span class="nx">partial</span> <span class="nx">resynchronization</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">backlog</span> <span class="nx">is</span> <span class="nx">only</span> <span class="nx">allocated</span> <span class="nx">once</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">at</span> <span class="nx">least</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">connected</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">repl</span><span class="o">-</span><span class="nx">backlog</span><span class="o">-</span><span class="nx">size</span> <span class="mi">1</span><span class="nx">mb</span>
</span></code></pre></td></tr></table></div></figure>


<h5>バックログファイルの維持許容時間の設定</h5>

<p>スレーブが切断されている間にバックアップのためのログ保存を行う一方で、そのバックログファイルを解放する設定も可能です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">After</span> <span class="nx">a</span> <span class="nx">master</span> <span class="nx">has</span> <span class="nx">no</span> <span class="nx">longer</span> <span class="nx">connected</span> <span class="nx">slaves</span> <span class="k">for</span> <span class="nx">some</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">backlog</span>
</span><span class='line'><span class="err">#</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">freed</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">following</span> <span class="nx">option</span> <span class="nx">configures</span> <span class="nx">the</span> <span class="nx">amount</span> <span class="nx">of</span> <span class="nx">seconds</span> <span class="nx">that</span>
</span><span class='line'><span class="err">#</span> <span class="nx">need</span> <span class="nx">to</span> <span class="nx">elapse</span><span class="p">,</span> <span class="nx">starting</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">time</span> <span class="nx">the</span> <span class="nx">last</span> <span class="nx">slave</span> <span class="nx">disconnected</span><span class="p">,</span> <span class="k">for</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">backlog</span> <span class="nx">buffer</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">freed</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">A</span> <span class="nx">value</span> <span class="nx">of</span> <span class="mi">0</span> <span class="nx">means</span> <span class="nx">to</span> <span class="nx">never</span> <span class="nx">release</span> <span class="nx">the</span> <span class="nx">backlog</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">repl</span><span class="o">-</span><span class="nx">backlog</span><span class="o">-</span><span class="nx">ttl</span> <span class="mi">3600</span>
</span></code></pre></td></tr></table></div></figure>


<p>上記設定でコメントアウトを外せば、1時間はバックアップログファイルを維持します。<br/>
<code>0</code>を設定した場合、ファイルの解放は実施しません。</p>

<h5>スレーブの優先度設定</h5>

<p>マスターが何らかの障害により動作できなくなった場合にスレーブがマスターに昇格することになります。<br/>
もし、スレーブが複数台存在していたら、どれをマスターに昇格させるべきか選ぶ必要があります。<br/>
その際に参考とする値となっています。(実際には <code>Redis Sentinel</code> が参考にする値)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">slave</span> <span class="nx">priority</span> <span class="nx">is</span> <span class="nx">an</span> <span class="nx">integer</span> <span class="nx">number</span> <span class="nx">published</span> <span class="nx">by</span> <span class="nx">Redis</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">INFO</span> <span class="nx">output</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">used</span> <span class="nx">by</span> <span class="nx">Redis</span> <span class="nx">Sentinel</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">select</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="nx">to</span> <span class="nx">promote</span> <span class="nx">into</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">master</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">master</span> <span class="nx">is</span> <span class="nx">no</span> <span class="nx">longer</span> <span class="nx">working</span> <span class="nx">correctly</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">A</span> <span class="nx">slave</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">low</span> <span class="nx">priority</span> <span class="nx">number</span> <span class="nx">is</span> <span class="nx">considered</span> <span class="nx">better</span> <span class="k">for</span> <span class="nx">promotion</span><span class="p">,</span> <span class="nx">so</span>
</span><span class='line'><span class="err">#</span> <span class="k">for</span> <span class="nx">instance</span> <span class="k">if</span> <span class="nx">there</span> <span class="nx">are</span> <span class="nx">three</span> <span class="nx">slaves</span> <span class="kd">with</span> <span class="nx">priority</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">25</span> <span class="nx">Sentinel</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">pick</span> <span class="nx">the</span> <span class="nx">one</span> <span class="kd">with</span> <span class="nx">priority</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">lowest</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">However</span> <span class="nx">a</span> <span class="nx">special</span> <span class="nx">priority</span> <span class="nx">of</span> <span class="mi">0</span> <span class="nx">marks</span> <span class="nx">the</span> <span class="nx">slave</span> <span class="nx">as</span> <span class="nx">not</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">perform</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">role</span> <span class="nx">of</span> <span class="nx">master</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">a</span> <span class="nx">slave</span> <span class="kd">with</span> <span class="nx">priority</span> <span class="nx">of</span> <span class="mi">0</span> <span class="nx">will</span> <span class="nx">never</span> <span class="nx">be</span> <span class="nx">selected</span> <span class="nx">by</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">Sentinel</span> <span class="k">for</span> <span class="nx">promotion</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">the</span> <span class="nx">priority</span> <span class="nx">is</span> <span class="mi">100</span><span class="p">.</span>
</span><span class='line'><span class="nx">slave</span><span class="o">-</span><span class="nx">priority</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<h5>マスターへの書き込み権限の設定</h5>

<p>Redis2.8系から導入された設定です。<br/>
『マスターに最低 N スレーブが接続している場合にかぎり、書き込み要求を受け付ける設定』です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="k">for</span> <span class="nx">a</span> <span class="nx">master</span> <span class="nx">to</span> <span class="nx">stop</span> <span class="nx">accepting</span> <span class="nx">writes</span> <span class="k">if</span> <span class="nx">there</span> <span class="nx">are</span> <span class="nx">less</span> <span class="nx">than</span>
</span><span class='line'><span class="err">#</span> <span class="nx">N</span> <span class="nx">slaves</span> <span class="nx">connected</span><span class="p">,</span> <span class="nx">having</span> <span class="nx">a</span> <span class="nx">lag</span> <span class="nx">less</span> <span class="nx">or</span> <span class="nx">equal</span> <span class="nx">than</span> <span class="nx">M</span> <span class="nx">seconds</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">N</span> <span class="nx">slaves</span> <span class="nx">need</span> <span class="nx">to</span> <span class="nx">be</span> <span class="k">in</span> <span class="s2">&quot;online&quot;</span> <span class="nx">state</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">lag</span> <span class="k">in</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">that</span> <span class="nx">must</span> <span class="nx">be</span> <span class="o">&lt;=</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">is</span> <span class="nx">calculated</span> <span class="nx">from</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">last</span> <span class="nx">ping</span> <span class="nx">received</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">slave</span><span class="p">,</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">usually</span> <span class="nx">sent</span> <span class="nx">every</span> <span class="nx">second</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">option</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">GUARANTEES</span> <span class="nx">that</span> <span class="nx">N</span> <span class="nx">replicas</span> <span class="nx">will</span> <span class="nx">accept</span> <span class="nx">the</span> <span class="nx">write</span><span class="p">,</span> <span class="nx">but</span>
</span><span class='line'><span class="err">#</span> <span class="nx">will</span> <span class="nx">limit</span> <span class="nx">the</span> <span class="nb">window</span> <span class="nx">of</span> <span class="nx">exposure</span> <span class="k">for</span> <span class="nx">lost</span> <span class="nx">writes</span> <span class="k">in</span> <span class="k">case</span> <span class="nx">not</span> <span class="nx">enough</span> <span class="nx">slaves</span>
</span><span class='line'><span class="err">#</span> <span class="nx">are</span> <span class="nx">available</span><span class="p">,</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">seconds</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">For</span> <span class="nx">example</span> <span class="nx">to</span> <span class="nx">require</span> <span class="nx">at</span> <span class="nx">least</span> <span class="mi">3</span> <span class="nx">slaves</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">lag</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="nx">seconds</span> <span class="nx">use</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">min</span><span class="o">-</span><span class="nx">slaves</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">write</span> <span class="mi">3</span>
</span><span class='line'><span class="err">#</span> <span class="nx">min</span><span class="o">-</span><span class="nx">slaves</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">lag</span> <span class="mi">10</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Setting</span> <span class="nx">one</span> <span class="nx">or</span> <span class="nx">the</span> <span class="nx">other</span> <span class="nx">to</span> <span class="mi">0</span> <span class="nx">disables</span> <span class="nx">the</span> <span class="nx">feature</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">min</span><span class="o">-</span><span class="nx">slaves</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">write</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="mi">0</span> <span class="p">(</span><span class="nx">feature</span> <span class="nx">disabled</span><span class="p">)</span> <span class="nx">and</span>
</span><span class='line'><span class="err">#</span> <span class="nx">min</span><span class="o">-</span><span class="nx">slaves</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">lag</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="mi">10</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>min-slaves-to-write</code>: 書き込むために必要な最少接続スレーブ数の設定</li>
<li><code>min-slaves-max-lag</code>: 書き込むために必要な最大タイムラグの設定</li>
</ul>


<h4>セキュリティ関連の設定</h4>

<p>セキュリティ面で設定が必要な場合に活用します。</p>

<h5>認証パスワードの設定</h5>

<p>クライアントからコマンドを叩かれる前にパスワードを要求することでセキュリティを高めます。<br/>
クライアントからRedisに対して直接コマンドを叩くケースがある場合は設定しておきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Require</span> <span class="nx">clients</span> <span class="nx">to</span> <span class="nx">issue</span> <span class="nx">AUTH</span> <span class="o">&lt;</span><span class="nx">PASSWORD</span><span class="o">&gt;</span> <span class="nx">before</span> <span class="nx">processing</span> <span class="nx">any</span> <span class="nx">other</span>
</span><span class='line'><span class="err">#</span> <span class="nx">commands</span><span class="p">.</span>  <span class="nx">This</span> <span class="nx">might</span> <span class="nx">be</span> <span class="nx">useful</span> <span class="k">in</span> <span class="nx">environments</span> <span class="k">in</span> <span class="nx">which</span> <span class="nx">you</span> <span class="k">do</span> <span class="nx">not</span> <span class="nx">trust</span>
</span><span class='line'><span class="err">#</span> <span class="nx">others</span> <span class="kd">with</span> <span class="nx">access</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">host</span> <span class="nx">running</span> <span class="nx">redis</span><span class="o">-</span><span class="nx">server</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">should</span> <span class="nx">stay</span> <span class="nx">commented</span> <span class="nx">out</span> <span class="k">for</span> <span class="nx">backward</span> <span class="nx">compatibility</span> <span class="nx">and</span> <span class="nx">because</span> <span class="nx">most</span>
</span><span class='line'><span class="err">#</span> <span class="nx">people</span> <span class="k">do</span> <span class="nx">not</span> <span class="nx">need</span> <span class="nx">auth</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span> <span class="nx">they</span> <span class="nx">run</span> <span class="nx">their</span> <span class="nx">own</span> <span class="nx">servers</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Warning</span><span class="o">:</span> <span class="nx">since</span> <span class="nx">Redis</span> <span class="nx">is</span> <span class="nx">pretty</span> <span class="nx">fast</span> <span class="nx">an</span> <span class="nx">outside</span> <span class="nx">user</span> <span class="nx">can</span> <span class="k">try</span> <span class="nx">up</span> <span class="nx">to</span>
</span><span class='line'><span class="err">#</span> <span class="mi">150</span><span class="nx">k</span> <span class="nx">passwords</span> <span class="nx">per</span> <span class="nx">second</span> <span class="nx">against</span> <span class="nx">a</span> <span class="nx">good</span> <span class="nx">box</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">means</span> <span class="nx">that</span> <span class="nx">you</span> <span class="nx">should</span>
</span><span class='line'><span class="err">#</span> <span class="nx">use</span> <span class="nx">a</span> <span class="nx">very</span> <span class="nx">strong</span> <span class="nx">password</span> <span class="nx">otherwise</span> <span class="nx">it</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">very</span> <span class="nx">easy</span> <span class="nx">to</span> <span class="k">break</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">requirepass</span> <span class="nx">foobared</span>
</span></code></pre></td></tr></table></div></figure>


<h5>コマンド名の変更</h5>

<p><code>slave-read-only</code>で少し触れましたが、<code>CONFIG</code>コマンドを直接クライアントから叩かれたりすると困るかもしれません。<br/>
そういったケースが想定される場合は設定しておきましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Command</span> <span class="nx">renaming</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">change</span> <span class="nx">the</span> <span class="nx">name</span> <span class="nx">of</span> <span class="nx">dangerous</span> <span class="nx">commands</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">shared</span>
</span><span class='line'><span class="err">#</span> <span class="nx">environment</span><span class="p">.</span> <span class="nx">For</span> <span class="nx">instance</span> <span class="nx">the</span> <span class="nx">CONFIG</span> <span class="nx">command</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">renamed</span> <span class="nx">into</span> <span class="nx">something</span>
</span><span class='line'><span class="err">#</span> <span class="nx">hard</span> <span class="nx">to</span> <span class="nx">guess</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">it</span> <span class="nx">will</span> <span class="nx">still</span> <span class="nx">be</span> <span class="nx">available</span> <span class="k">for</span> <span class="nx">internal</span><span class="o">-</span><span class="nx">use</span> <span class="nx">tools</span>
</span><span class='line'><span class="err">#</span> <span class="nx">but</span> <span class="nx">not</span> <span class="nx">available</span> <span class="k">for</span> <span class="nx">general</span> <span class="nx">clients</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Example</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">rename</span><span class="o">-</span><span class="nx">command</span> <span class="nx">CONFIG</span> <span class="nx">b840fc02d524045429941cc15f59e41cb7be6c52</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">also</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">completely</span> <span class="nx">kill</span> <span class="nx">a</span> <span class="nx">command</span> <span class="nx">by</span> <span class="nx">renaming</span> <span class="nx">it</span> <span class="nx">into</span>
</span><span class='line'><span class="err">#</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">string</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">rename</span><span class="o">-</span><span class="nx">command</span> <span class="nx">CONFIG</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Please</span> <span class="nx">note</span> <span class="nx">that</span> <span class="nx">changing</span> <span class="nx">the</span> <span class="nx">name</span> <span class="nx">of</span> <span class="nx">commands</span> <span class="nx">that</span> <span class="nx">are</span> <span class="nx">logged</span> <span class="nx">into</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">AOF</span> <span class="nx">file</span> <span class="nx">or</span> <span class="nx">transmitted</span> <span class="nx">to</span> <span class="nx">slaves</span> <span class="nx">may</span> <span class="nx">cause</span> <span class="nx">problems</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<h4>リソース制限に関する設定</h4>

<p>サーバはリソースが限られているため、利用ケースに合わせてリソース制限を適切に設定することが必要です。</p>

<h5>最大同時接続クライアント数の設定</h5>

<p>デフォルト<code>10000</code>ですが、実際にはRedis Serverの予約数である<code>32</code>がそこから引かれます。<br/>
もし、設定した同時接続数を超えた場合はエラーを返却します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Set</span> <span class="nx">the</span> <span class="nx">max</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">connected</span> <span class="nx">clients</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">time</span><span class="p">.</span> <span class="nx">By</span> <span class="k">default</span>
</span><span class='line'><span class="err">#</span> <span class="k">this</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="mi">10000</span> <span class="nx">clients</span><span class="p">,</span> <span class="nx">however</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">Redis</span> <span class="nx">server</span> <span class="nx">is</span> <span class="nx">not</span>
</span><span class='line'><span class="err">#</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">configure</span> <span class="nx">the</span> <span class="nx">process</span> <span class="nx">file</span> <span class="nx">limit</span> <span class="nx">to</span> <span class="nx">allow</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">limit</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">max</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">allowed</span> <span class="nx">clients</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">file</span> <span class="nx">limit</span>
</span><span class='line'><span class="err">#</span> <span class="nx">minus</span> <span class="mi">32</span> <span class="p">(</span><span class="nx">as</span> <span class="nx">Redis</span> <span class="nx">reserves</span> <span class="nx">a</span> <span class="nx">few</span> <span class="nx">file</span> <span class="nx">descriptors</span> <span class="k">for</span> <span class="nx">internal</span> <span class="nx">uses</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Once</span> <span class="nx">the</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="nx">reached</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">close</span> <span class="nx">all</span> <span class="nx">the</span> <span class="k">new</span> <span class="nx">connections</span> <span class="nx">sending</span>
</span><span class='line'><span class="err">#</span> <span class="nx">an</span> <span class="nx">error</span> <span class="s1">&#39;max number of clients reached&#39;</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">maxclients</span> <span class="mi">10000</span>
</span></code></pre></td></tr></table></div></figure>


<h5>利用するメモリ上限の設定</h5>

<p>指定した分までメモリを利用します。<br/>
デフォルトはコメントアウトされているため、システム上限までメモリを利用できます。<br/>
上限までメモリを利用した場合の挙動については<code>maxmemory-policy</code>で指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">use</span> <span class="nx">more</span> <span class="nx">memory</span> <span class="nx">than</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">amount</span> <span class="nx">of</span> <span class="nx">bytes</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">the</span> <span class="nx">memory</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="nx">reached</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="k">try</span> <span class="nx">to</span> <span class="nx">remove</span> <span class="nx">keys</span>
</span><span class='line'><span class="err">#</span> <span class="nx">according</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">eviction</span> <span class="nx">policy</span> <span class="nx">selected</span> <span class="p">(</span><span class="nx">see</span> <span class="nx">maxmemory</span><span class="o">-</span><span class="nx">policy</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">Redis</span> <span class="nx">can</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">remove</span> <span class="nx">keys</span> <span class="nx">according</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">policy</span><span class="p">,</span> <span class="nx">or</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">policy</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">set</span> <span class="nx">to</span> <span class="s1">&#39;noeviction&#39;</span><span class="p">,</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">start</span> <span class="nx">to</span> <span class="nx">reply</span> <span class="kd">with</span> <span class="nx">errors</span> <span class="nx">to</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span> <span class="nx">that</span> <span class="nx">would</span> <span class="nx">use</span> <span class="nx">more</span> <span class="nx">memory</span><span class="p">,</span> <span class="nx">like</span> <span class="nx">SET</span><span class="p">,</span> <span class="nx">LPUSH</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">on</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">will</span> <span class="k">continue</span>
</span><span class='line'><span class="err">#</span> <span class="nx">to</span> <span class="nx">reply</span> <span class="nx">to</span> <span class="nx">read</span><span class="o">-</span><span class="nx">only</span> <span class="nx">commands</span> <span class="nx">like</span> <span class="nx">GET</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">option</span> <span class="nx">is</span> <span class="nx">usually</span> <span class="nx">useful</span> <span class="nx">when</span> <span class="nx">using</span> <span class="nx">Redis</span> <span class="nx">as</span> <span class="nx">an</span> <span class="nx">LRU</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">to</span> <span class="nx">set</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">hard</span> <span class="nx">memory</span> <span class="nx">limit</span> <span class="k">for</span> <span class="nx">an</span> <span class="nx">instance</span> <span class="p">(</span><span class="nx">using</span> <span class="nx">the</span> <span class="s1">&#39;noeviction&#39;</span> <span class="nx">policy</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">WARNING</span><span class="o">:</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">slaves</span> <span class="nx">attached</span> <span class="nx">to</span> <span class="nx">an</span> <span class="nx">instance</span> <span class="kd">with</span> <span class="nx">maxmemory</span> <span class="nx">on</span><span class="p">,</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">size</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">output</span> <span class="nx">buffers</span> <span class="nx">needed</span> <span class="nx">to</span> <span class="nx">feed</span> <span class="nx">the</span> <span class="nx">slaves</span> <span class="nx">are</span> <span class="nx">subtracted</span>
</span><span class='line'><span class="err">#</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">used</span> <span class="nx">memory</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">network</span> <span class="nx">problems</span> <span class="o">/</span> <span class="nx">resyncs</span> <span class="nx">will</span>
</span><span class='line'><span class="err">#</span> <span class="nx">not</span> <span class="nx">trigger</span> <span class="nx">a</span> <span class="nx">loop</span> <span class="nx">where</span> <span class="nx">keys</span> <span class="nx">are</span> <span class="nx">evicted</span><span class="p">,</span> <span class="nx">and</span> <span class="k">in</span> <span class="nx">turn</span> <span class="nx">the</span> <span class="nx">output</span>
</span><span class='line'><span class="err">#</span> <span class="nx">buffer</span> <span class="nx">of</span> <span class="nx">slaves</span> <span class="nx">is</span> <span class="nx">full</span> <span class="kd">with</span> <span class="nx">DELs</span> <span class="nx">of</span> <span class="nx">keys</span> <span class="nx">evicted</span> <span class="nx">triggering</span> <span class="nx">the</span> <span class="nx">deletion</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">more</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span> <span class="nx">until</span> <span class="nx">the</span> <span class="nx">database</span> <span class="nx">is</span> <span class="nx">completely</span> <span class="nx">emptied</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">In</span> <span class="kr">short</span><span class="p">...</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">slaves</span> <span class="nx">attached</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">suggested</span> <span class="nx">that</span> <span class="nx">you</span> <span class="nx">set</span> <span class="nx">a</span> <span class="nx">lower</span>
</span><span class='line'><span class="err">#</span> <span class="nx">limit</span> <span class="k">for</span> <span class="nx">maxmemory</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">some</span> <span class="nx">free</span> <span class="nx">RAM</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">system</span> <span class="k">for</span> <span class="nx">slave</span>
</span><span class='line'><span class="err">#</span> <span class="nx">output</span> <span class="nx">buffers</span> <span class="p">(</span><span class="nx">but</span> <span class="k">this</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">needed</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">policy</span> <span class="nx">is</span> <span class="s1">&#39;noeviction&#39;</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">maxmemory</span> <span class="o">&lt;</span><span class="nx">bytes</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>許容メモリ利用上限に達した場合の挙動の設定</h5>

<p>幾つか用意されたポリシーの中から挙動を選択します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">MAXMEMORY</span> <span class="nx">POLICY</span><span class="o">:</span> <span class="nx">how</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">select</span> <span class="nx">what</span> <span class="nx">to</span> <span class="nx">remove</span> <span class="nx">when</span> <span class="nx">maxmemory</span>
</span><span class='line'><span class="err">#</span> <span class="nx">is</span> <span class="nx">reached</span><span class="p">.</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">select</span> <span class="nx">among</span> <span class="nx">five</span> <span class="nx">behaviors</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="kr">volatile</span><span class="o">-</span><span class="nx">lru</span> <span class="o">-&gt;</span> <span class="nx">remove</span> <span class="nx">the</span> <span class="nx">key</span> <span class="kd">with</span> <span class="nx">an</span> <span class="nx">expire</span> <span class="nx">set</span> <span class="nx">using</span> <span class="nx">an</span> <span class="nx">LRU</span> <span class="nx">algorithm</span>
</span><span class='line'><span class="err">#</span> <span class="nx">allkeys</span><span class="o">-</span><span class="nx">lru</span> <span class="o">-&gt;</span> <span class="nx">remove</span> <span class="nx">any</span> <span class="nx">key</span> <span class="nx">accordingly</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">LRU</span> <span class="nx">algorithm</span>
</span><span class='line'><span class="err">#</span> <span class="kr">volatile</span><span class="o">-</span><span class="nx">random</span> <span class="o">-&gt;</span> <span class="nx">remove</span> <span class="nx">a</span> <span class="nx">random</span> <span class="nx">key</span> <span class="kd">with</span> <span class="nx">an</span> <span class="nx">expire</span> <span class="nx">set</span>
</span><span class='line'><span class="err">#</span> <span class="nx">allkeys</span><span class="o">-</span><span class="nx">random</span> <span class="o">-&gt;</span> <span class="nx">remove</span> <span class="nx">a</span> <span class="nx">random</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">any</span> <span class="nx">key</span>
</span><span class='line'><span class="err">#</span> <span class="kr">volatile</span><span class="o">-</span><span class="nx">ttl</span> <span class="o">-&gt;</span> <span class="nx">remove</span> <span class="nx">the</span> <span class="nx">key</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">nearest</span> <span class="nx">expire</span> <span class="nx">time</span> <span class="p">(</span><span class="nx">minor</span> <span class="nx">TTL</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span> <span class="nx">noeviction</span> <span class="o">-&gt;</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">expire</span> <span class="nx">at</span> <span class="nx">all</span><span class="p">,</span> <span class="nx">just</span> <span class="k">return</span> <span class="nx">an</span> <span class="nx">error</span> <span class="nx">on</span> <span class="nx">write</span> <span class="nx">operations</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Note</span><span class="o">:</span> <span class="kd">with</span> <span class="nx">any</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">above</span> <span class="nx">policies</span><span class="p">,</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="k">return</span> <span class="nx">an</span> <span class="nx">error</span> <span class="nx">on</span> <span class="nx">write</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">operations</span><span class="p">,</span> <span class="nx">when</span> <span class="nx">there</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">suitable</span> <span class="nx">keys</span> <span class="k">for</span> <span class="nx">eviction</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">At</span> <span class="nx">the</span> <span class="nx">date</span> <span class="nx">of</span> <span class="nx">writing</span> <span class="k">this</span> <span class="nx">commands</span> <span class="nx">are</span><span class="o">:</span> <span class="nx">set</span> <span class="nx">setnx</span> <span class="nx">setex</span> <span class="nx">append</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">incr</span> <span class="nx">decr</span> <span class="nx">rpush</span> <span class="nx">lpush</span> <span class="nx">rpushx</span> <span class="nx">lpushx</span> <span class="nx">linsert</span> <span class="nx">lset</span> <span class="nx">rpoplpush</span> <span class="nx">sadd</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">sinter</span> <span class="nx">sinterstore</span> <span class="nx">sunion</span> <span class="nx">sunionstore</span> <span class="nx">sdiff</span> <span class="nx">sdiffstore</span> <span class="nx">zadd</span> <span class="nx">zincrby</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">zunionstore</span> <span class="nx">zinterstore</span> <span class="nx">hset</span> <span class="nx">hsetnx</span> <span class="nx">hmset</span> <span class="nx">hincrby</span> <span class="nx">incrby</span> <span class="nx">decrby</span>
</span><span class='line'><span class="err">#</span>       <span class="nx">getset</span> <span class="nx">mset</span> <span class="nx">msetnx</span> <span class="nx">exec</span> <span class="nx">sort</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">is</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">maxmemory</span><span class="o">-</span><span class="nx">policy</span> <span class="kr">volatile</span><span class="o">-</span><span class="nx">lru</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>volatile-lru</code>: LRUアルゴリズムに基づき、期限切れ<code>key</code>を削除</li>
<li><code>allkeys-lru</code>: LRUアルゴリズムに基づき、期限に関係なく<code>key</code>を削除</li>
<li><code>volatile-random</code>: 期限切れ<code>key</code>をランダム削除</li>
<li><code>allkeys-random</code>: 全ての<code>key</code>を対象にランダム削除</li>
<li><code>volatile-ttl</code>: 期限切れの中でも最も古い<code>key</code>から順に削除</li>
<li><code>noeviction</code>: <code>key</code>に期限切れが存在しないため、上限以上の書き込みに対してはエラーを返却する</li>
</ul>


<p>LRUアルゴリズムについては<a href="https://ja.wikipedia.org/wiki/Least_Recently_Used">Least Recently Used &ndash; Wikipedia</a>を読みましょう。</p>

<h5>近似LRUアルゴリズムの精緻設定</h5>

<p>先程LRUアルゴリズムを利用する設定があることに触れましたが、Redisではメモリ消費を抑えるために正確なLRUアルゴリズムを採用してはいません。<br/>
代替手段で近似的LRUアルゴリズムを実現しているのですが、その精緻をサンプラーの数を設定することで自由度高く決めることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">LRU</span> <span class="nx">and</span> <span class="nx">minimal</span> <span class="nx">TTL</span> <span class="nx">algorithms</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">precise</span> <span class="nx">algorithms</span> <span class="nx">but</span> <span class="nx">approximated</span>
</span><span class='line'><span class="err">#</span> <span class="nx">algorithms</span> <span class="p">(</span><span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">save</span> <span class="nx">memory</span><span class="p">),</span> <span class="nx">so</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">select</span> <span class="nx">as</span> <span class="nx">well</span> <span class="nx">the</span> <span class="nx">sample</span>
</span><span class='line'><span class="err">#</span> <span class="nx">size</span> <span class="nx">to</span> <span class="nx">check</span><span class="p">.</span> <span class="nx">For</span> <span class="nx">instance</span> <span class="k">for</span> <span class="k">default</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">check</span> <span class="nx">three</span> <span class="nx">keys</span> <span class="nx">and</span>
</span><span class='line'><span class="err">#</span> <span class="nx">pick</span> <span class="nx">the</span> <span class="nx">one</span> <span class="nx">that</span> <span class="nx">was</span> <span class="nx">used</span> <span class="nx">less</span> <span class="nx">recently</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">change</span> <span class="nx">the</span> <span class="nx">sample</span> <span class="nx">size</span>
</span><span class='line'><span class="err">#</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">configuration</span> <span class="nx">directive</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">maxmemory</span><span class="o">-</span><span class="nx">samples</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<h4>AOFに関する設定</h4>

<p>AOFとは<code>Append Only File</code>の略語で追記専用ファイルを利用することによるデータ永続化を目指す設定です。</p>

<h5>AOFの利用設定</h5>

<p>AOFの利用可否を設定します。もちろん<code>yes</code>にすればAOFが利用できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">Redis</span> <span class="nx">asynchronously</span> <span class="nx">dumps</span> <span class="nx">the</span> <span class="nx">dataset</span> <span class="nx">on</span> <span class="nx">disk</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">mode</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">good</span> <span class="nx">enough</span> <span class="k">in</span> <span class="nx">many</span> <span class="nx">applications</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">an</span> <span class="nx">issue</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">Redis</span> <span class="nx">process</span> <span class="nx">or</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">power</span> <span class="nx">outage</span> <span class="nx">may</span> <span class="nx">result</span> <span class="nx">into</span> <span class="nx">a</span> <span class="nx">few</span> <span class="nx">minutes</span> <span class="nx">of</span> <span class="nx">writes</span> <span class="nx">lost</span> <span class="p">(</span><span class="nx">depending</span> <span class="nx">on</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">configured</span> <span class="nx">save</span> <span class="nx">points</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">Append</span> <span class="nx">Only</span> <span class="nx">File</span> <span class="nx">is</span> <span class="nx">an</span> <span class="nx">alternative</span> <span class="nx">persistence</span> <span class="nx">mode</span> <span class="nx">that</span> <span class="nx">provides</span>
</span><span class='line'><span class="err">#</span> <span class="nx">much</span> <span class="nx">better</span> <span class="nx">durability</span><span class="p">.</span> <span class="nx">For</span> <span class="nx">instance</span> <span class="nx">using</span> <span class="nx">the</span> <span class="k">default</span> <span class="nx">data</span> <span class="nx">fsync</span> <span class="nx">policy</span>
</span><span class='line'><span class="err">#</span> <span class="p">(</span><span class="nx">see</span> <span class="nx">later</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">config</span> <span class="nx">file</span><span class="p">)</span> <span class="nx">Redis</span> <span class="nx">can</span> <span class="nx">lose</span> <span class="nx">just</span> <span class="nx">one</span> <span class="nx">second</span> <span class="nx">of</span> <span class="nx">writes</span> <span class="k">in</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">dramatic</span> <span class="nx">event</span> <span class="nx">like</span> <span class="nx">a</span> <span class="nx">server</span> <span class="nx">power</span> <span class="nx">outage</span><span class="p">,</span> <span class="nx">or</span> <span class="nx">a</span> <span class="nx">single</span> <span class="nx">write</span> <span class="k">if</span> <span class="nx">something</span>
</span><span class='line'><span class="err">#</span> <span class="nx">wrong</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">Redis</span> <span class="nx">process</span> <span class="nx">itself</span> <span class="nx">happens</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">the</span> <span class="nx">operating</span> <span class="nx">system</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">still</span> <span class="nx">running</span> <span class="nx">correctly</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">AOF</span> <span class="nx">and</span> <span class="nx">RDB</span> <span class="nx">persistence</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">enabled</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">time</span> <span class="nx">without</span> <span class="nx">problems</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">is</span> <span class="nx">enabled</span> <span class="nx">on</span> <span class="nx">startup</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">load</span> <span class="nx">the</span> <span class="nx">AOF</span><span class="p">,</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">file</span>
</span><span class='line'><span class="err">#</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">better</span> <span class="nx">durability</span> <span class="nx">guarantees</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Please</span> <span class="nx">check</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//redis.io/topics/persistence for more information.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">appendonly</span> <span class="nx">no</span>
</span></code></pre></td></tr></table></div></figure>


<h5>AOFファイル名の設定</h5>

<p>ファイル名を設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">name</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">append</span> <span class="nx">only</span> <span class="nx">file</span> <span class="p">(</span><span class="k">default</span><span class="o">:</span> <span class="s2">&quot;appendonly.aof&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">appendfilename</span> <span class="s2">&quot;appendonly.aof&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h5>AOFへの同期タイミングの設定</h5>

<p>Redisには3つのモードが存在します。</p>

<ul>
<li><code>no</code>: <code>fsync</code>を利用せずOSに全てを任せます。高速です。</li>
<li><code>always</code>: 追記専用ログへの書き込み発生する際に必ず<code>fsync</code>を実行します。遅いですが安全です。</li>
<li><code>everysec</code>: 毎秒ごとに<code>fsync</code>を実行します。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">fsync</span><span class="p">()</span> <span class="nx">call</span> <span class="nx">tells</span> <span class="nx">the</span> <span class="nx">Operating</span> <span class="nx">System</span> <span class="nx">to</span> <span class="nx">actually</span> <span class="nx">write</span> <span class="nx">data</span> <span class="nx">on</span> <span class="nx">disk</span>
</span><span class='line'><span class="err">#</span> <span class="nx">instead</span> <span class="nx">to</span> <span class="nx">wait</span> <span class="k">for</span> <span class="nx">more</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">output</span> <span class="nx">buffer</span><span class="p">.</span> <span class="nx">Some</span> <span class="nx">OS</span> <span class="nx">will</span> <span class="nx">really</span> <span class="nx">flush</span>
</span><span class='line'><span class="err">#</span> <span class="nx">data</span> <span class="nx">on</span> <span class="nx">disk</span><span class="p">,</span> <span class="nx">some</span> <span class="nx">other</span> <span class="nx">OS</span> <span class="nx">will</span> <span class="nx">just</span> <span class="k">try</span> <span class="nx">to</span> <span class="k">do</span> <span class="nx">it</span> <span class="nx">ASAP</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">supports</span> <span class="nx">three</span> <span class="nx">different</span> <span class="nx">modes</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">no</span><span class="o">:</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">fsync</span><span class="p">,</span> <span class="nx">just</span> <span class="kd">let</span> <span class="nx">the</span> <span class="nx">OS</span> <span class="nx">flush</span> <span class="nx">the</span> <span class="nx">data</span> <span class="nx">when</span> <span class="nx">it</span> <span class="nx">wants</span><span class="p">.</span> <span class="nx">Faster</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">always</span><span class="o">:</span> <span class="nx">fsync</span> <span class="nx">after</span> <span class="nx">every</span> <span class="nx">write</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">append</span> <span class="nx">only</span> <span class="nx">log</span> <span class="p">.</span> <span class="nx">Slow</span><span class="p">,</span> <span class="nx">Safest</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">everysec</span><span class="o">:</span> <span class="nx">fsync</span> <span class="nx">only</span> <span class="nx">one</span> <span class="nx">time</span> <span class="nx">every</span> <span class="nx">second</span><span class="p">.</span> <span class="nx">Compromise</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">is</span> <span class="s2">&quot;everysec&quot;</span><span class="p">,</span> <span class="nx">as</span> <span class="nx">that</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">usually</span> <span class="nx">the</span> <span class="nx">right</span> <span class="nx">compromise</span> <span class="nx">between</span>
</span><span class='line'><span class="err">#</span> <span class="nx">speed</span> <span class="nx">and</span> <span class="nx">data</span> <span class="nx">safety</span><span class="p">.</span> <span class="nx">It</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">up</span> <span class="nx">to</span> <span class="nx">you</span> <span class="nx">to</span> <span class="nx">understand</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">relax</span> <span class="k">this</span> <span class="nx">to</span>
</span><span class='line'><span class="err">#</span> <span class="s2">&quot;no&quot;</span> <span class="nx">that</span> <span class="nx">will</span> <span class="kd">let</span> <span class="nx">the</span> <span class="nx">operating</span> <span class="nx">system</span> <span class="nx">flush</span> <span class="nx">the</span> <span class="nx">output</span> <span class="nx">buffer</span> <span class="nx">when</span>
</span><span class='line'><span class="err">#</span> <span class="nx">it</span> <span class="nx">wants</span><span class="p">,</span> <span class="k">for</span> <span class="nx">better</span> <span class="nx">performances</span> <span class="p">(</span><span class="nx">but</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">can</span> <span class="nx">live</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">idea</span> <span class="nx">of</span>
</span><span class='line'><span class="err">#</span> <span class="nx">some</span> <span class="nx">data</span> <span class="nx">loss</span> <span class="nx">consider</span> <span class="nx">the</span> <span class="k">default</span> <span class="nx">persistence</span> <span class="nx">mode</span> <span class="nx">that</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">snapshotting</span><span class="p">),</span>
</span><span class='line'><span class="err">#</span> <span class="nx">or</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">contrary</span><span class="p">,</span> <span class="nx">use</span> <span class="s2">&quot;always&quot;</span> <span class="nx">that</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">very</span> <span class="nx">slow</span> <span class="nx">but</span> <span class="nx">a</span> <span class="nx">bit</span> <span class="nx">safer</span> <span class="nx">than</span>
</span><span class='line'><span class="err">#</span> <span class="nx">everysec</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">More</span> <span class="nx">details</span> <span class="nx">please</span> <span class="nx">check</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">article</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//antirez.com/post/redis-persistence-demystified.html</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">unsure</span><span class="p">,</span> <span class="nx">use</span> <span class="s2">&quot;everysec&quot;</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">appendfsync</span> <span class="nx">always</span>
</span><span class='line'><span class="nx">appendfsync</span> <span class="nx">everysec</span>
</span><span class='line'><span class="err">#</span> <span class="nx">appendfsync</span> <span class="nx">no</span>
</span></code></pre></td></tr></table></div></figure>


<p>デフォルトは<code>everysec</code>が設定されています。</p>

<h5>ディスクI/O遅延に対する設定</h5>

<p><code>save</code>プロセスがディスクに対して大量のI/Oを発生させていた場合、<code>fsync</code>呼び出し時にRedisが長時間ブロックする可能性があります。<br/>
バックグラウンドプロセスで<code>save</code>が動いている場合は<code>fsync</code>を止めるように設定することで、この問題を回避することができます。<br/>
(<code>no-appendfsync-on-rewrite</code>は文字通りそういった意味ですね。)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">fsync</span> <span class="nx">policy</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="nx">always</span> <span class="nx">or</span> <span class="nx">everysec</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">a</span> <span class="nx">background</span>
</span><span class='line'><span class="err">#</span> <span class="nx">saving</span> <span class="nx">process</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">background</span> <span class="nx">save</span> <span class="nx">or</span> <span class="nx">AOF</span> <span class="nx">log</span> <span class="nx">background</span> <span class="nx">rewriting</span><span class="p">)</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">performing</span> <span class="nx">a</span> <span class="nx">lot</span> <span class="nx">of</span> <span class="nx">I</span><span class="o">/</span><span class="nx">O</span> <span class="nx">against</span> <span class="nx">the</span> <span class="nx">disk</span><span class="p">,</span> <span class="k">in</span> <span class="nx">some</span> <span class="nx">Linux</span> <span class="nx">configurations</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">may</span> <span class="nx">block</span> <span class="nx">too</span> <span class="kr">long</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">fsync</span><span class="p">()</span> <span class="nx">call</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">no</span> <span class="nx">fix</span> <span class="k">for</span>
</span><span class='line'><span class="err">#</span> <span class="k">this</span> <span class="nx">currently</span><span class="p">,</span> <span class="nx">as</span> <span class="nx">even</span> <span class="nx">performing</span> <span class="nx">fsync</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">different</span> <span class="nx">thread</span> <span class="nx">will</span> <span class="nx">block</span>
</span><span class='line'><span class="err">#</span> <span class="nx">our</span> <span class="nx">synchronous</span> <span class="nx">write</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="nx">call</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">In</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">mitigate</span> <span class="k">this</span> <span class="nx">problem</span> <span class="nx">it</span><span class="err">‘</span><span class="nx">s</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">use</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">option</span>
</span><span class='line'><span class="err">#</span> <span class="nx">that</span> <span class="nx">will</span> <span class="nx">prevent</span> <span class="nx">fsync</span><span class="p">()</span> <span class="nx">from</span> <span class="nx">being</span> <span class="nx">called</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">main</span> <span class="nx">process</span> <span class="k">while</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">BGSAVE</span> <span class="nx">or</span> <span class="nx">BGREWRITEAOF</span> <span class="nx">is</span> <span class="k">in</span> <span class="nx">progress</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">means</span> <span class="nx">that</span> <span class="k">while</span> <span class="nx">another</span> <span class="nx">child</span> <span class="nx">is</span> <span class="nx">saving</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">durability</span> <span class="nx">of</span> <span class="nx">Redis</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">as</span> <span class="s2">&quot;appendfsync none&quot;</span><span class="p">.</span> <span class="nx">In</span> <span class="nx">practical</span> <span class="nx">terms</span><span class="p">,</span> <span class="k">this</span> <span class="nx">means</span> <span class="nx">that</span> <span class="nx">it</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">lose</span> <span class="nx">up</span> <span class="nx">to</span> <span class="mi">30</span> <span class="nx">seconds</span> <span class="nx">of</span> <span class="nx">log</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">worst</span> <span class="nx">scenario</span> <span class="p">(</span><span class="kd">with</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="k">default</span> <span class="nx">Linux</span> <span class="nx">settings</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">latency</span> <span class="nx">problems</span> <span class="nx">turn</span> <span class="k">this</span> <span class="nx">to</span> <span class="s2">&quot;yes&quot;</span><span class="p">.</span> <span class="nx">Otherwise</span> <span class="nx">leave</span> <span class="nx">it</span> <span class="nx">as</span>
</span><span class='line'><span class="err">#</span> <span class="s2">&quot;no&quot;</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">safest</span> <span class="nx">pick</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">durability</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">no</span><span class="o">-</span><span class="nx">appendfsync</span><span class="o">-</span><span class="nx">on</span><span class="o">-</span><span class="nx">rewrite</span> <span class="nx">no</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>yes</code>: バックグランドプロセスで<code>save</code>が動いていたら<code>fsync</code>しない</li>
<li><code>no</code>: 上記縛りを設定しない</li>
</ul>


<h5>AOFのログファイル自動書き換え設定</h5>

<p>AOFファイルサイズが肥大したときに対処するための基準を設定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Automatic</span> <span class="nx">rewrite</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">append</span> <span class="nx">only</span> <span class="nx">file</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">is</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">automatically</span> <span class="nx">rewrite</span> <span class="nx">the</span> <span class="nx">log</span> <span class="nx">file</span> <span class="nx">implicitly</span> <span class="nx">calling</span>
</span><span class='line'><span class="err">#</span> <span class="nx">BGREWRITEAOF</span> <span class="nx">when</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">log</span> <span class="nx">size</span> <span class="nx">grows</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">percentage</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">is</span> <span class="nx">how</span> <span class="nx">it</span> <span class="nx">works</span><span class="o">:</span> <span class="nx">Redis</span> <span class="nx">remembers</span> <span class="nx">the</span> <span class="nx">size</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">file</span> <span class="nx">after</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">latest</span> <span class="nx">rewrite</span> <span class="p">(</span><span class="k">if</span> <span class="nx">no</span> <span class="nx">rewrite</span> <span class="nx">has</span> <span class="nx">happened</span> <span class="nx">since</span> <span class="nx">the</span> <span class="nx">restart</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">size</span> <span class="nx">of</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">at</span> <span class="nx">startup</span> <span class="nx">is</span> <span class="nx">used</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">base</span> <span class="nx">size</span> <span class="nx">is</span> <span class="nx">compared</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">size</span><span class="p">.</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">size</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">bigger</span> <span class="nx">than</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">percentage</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">rewrite</span> <span class="nx">is</span> <span class="nx">triggered</span><span class="p">.</span> <span class="nx">Also</span>
</span><span class='line'><span class="err">#</span> <span class="nx">you</span> <span class="nx">need</span> <span class="nx">to</span> <span class="nx">specify</span> <span class="nx">a</span> <span class="nx">minimal</span> <span class="nx">size</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">file</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">rewritten</span><span class="p">,</span> <span class="k">this</span>
</span><span class='line'><span class="err">#</span> <span class="nx">is</span> <span class="nx">useful</span> <span class="nx">to</span> <span class="nx">avoid</span> <span class="nx">rewriting</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">file</span> <span class="nx">even</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">percentage</span> <span class="nx">increase</span>
</span><span class='line'><span class="err">#</span> <span class="nx">is</span> <span class="nx">reached</span> <span class="nx">but</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">still</span> <span class="nx">pretty</span> <span class="nx">small</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Specify</span> <span class="nx">a</span> <span class="nx">percentage</span> <span class="nx">of</span> <span class="nx">zero</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">disable</span> <span class="nx">the</span> <span class="nx">automatic</span> <span class="nx">AOF</span>
</span><span class='line'><span class="err">#</span> <span class="nx">rewrite</span> <span class="nx">feature</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">auto</span><span class="o">-</span><span class="nx">aof</span><span class="o">-</span><span class="nx">rewrite</span><span class="o">-</span><span class="nx">percentage</span> <span class="mi">100</span>
</span><span class='line'><span class="nx">auto</span><span class="o">-</span><span class="nx">aof</span><span class="o">-</span><span class="nx">rewrite</span><span class="o">-</span><span class="nx">min</span><span class="o">-</span><span class="nx">size</span> <span class="mi">64</span><span class="nx">mb</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>auto-aof-rewrite-percentage</code>: 書き換えを発生させるファイルサイズの基準</li>
<li><code>auto-aof-rewrite-min-size</code>: ここで指定したファイルサイズ以内であれば書き換えを実行しません</li>
</ul>


<h4>LUAスクリプトに関する設定</h4>

<p>LUAスクリプトを実行する場合に必要な設定です。<br/>
と言っても最大実行時間しかありません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Max</span> <span class="nx">execution</span> <span class="nx">time</span> <span class="nx">of</span> <span class="nx">a</span> <span class="nx">Lua</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">milliseconds</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">the</span> <span class="nx">maximum</span> <span class="nx">execution</span> <span class="nx">time</span> <span class="nx">is</span> <span class="nx">reached</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">log</span> <span class="nx">that</span> <span class="nx">a</span> <span class="nx">script</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">still</span> <span class="k">in</span> <span class="nx">execution</span> <span class="nx">after</span> <span class="nx">the</span> <span class="nx">maximum</span> <span class="nx">allowed</span> <span class="nx">time</span> <span class="nx">and</span> <span class="nx">will</span> <span class="nx">start</span> <span class="nx">to</span>
</span><span class='line'><span class="err">#</span> <span class="nx">reply</span> <span class="nx">to</span> <span class="nx">queries</span> <span class="kd">with</span> <span class="nx">an</span> <span class="nx">error</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">a</span> <span class="kr">long</span> <span class="nx">running</span> <span class="nx">script</span> <span class="nx">exceed</span> <span class="nx">the</span> <span class="nx">maximum</span> <span class="nx">execution</span> <span class="nx">time</span> <span class="nx">only</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">SCRIPT</span> <span class="nx">KILL</span> <span class="nx">and</span> <span class="nx">SHUTDOWN</span> <span class="nx">NOSAVE</span> <span class="nx">commands</span> <span class="nx">are</span> <span class="nx">available</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">first</span> <span class="nx">can</span> <span class="nx">be</span>
</span><span class='line'><span class="err">#</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">stop</span> <span class="nx">a</span> <span class="nx">script</span> <span class="nx">that</span> <span class="nx">did</span> <span class="nx">not</span> <span class="nx">yet</span> <span class="nx">called</span> <span class="nx">write</span> <span class="nx">commands</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">second</span>
</span><span class='line'><span class="err">#</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">only</span> <span class="nx">way</span> <span class="nx">to</span> <span class="nx">shut</span> <span class="nx">down</span> <span class="nx">the</span> <span class="nx">server</span> <span class="k">in</span> <span class="nx">the</span> <span class="k">case</span> <span class="nx">a</span> <span class="nx">write</span> <span class="nx">commands</span> <span class="nx">was</span>
</span><span class='line'><span class="err">#</span> <span class="nx">already</span> <span class="nx">issue</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">script</span> <span class="nx">but</span> <span class="nx">the</span> <span class="nx">user</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">wait</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">natural</span>
</span><span class='line'><span class="err">#</span> <span class="nx">termination</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">script</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Set</span> <span class="nx">it</span> <span class="nx">to</span> <span class="mi">0</span> <span class="nx">or</span> <span class="nx">a</span> <span class="nx">negative</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">unlimited</span> <span class="nx">execution</span> <span class="nx">without</span> <span class="nx">warnings</span><span class="p">.</span>
</span><span class='line'><span class="nx">lua</span><span class="o">-</span><span class="nx">time</span><span class="o">-</span><span class="nx">limit</span> <span class="mi">5000</span>
</span></code></pre></td></tr></table></div></figure>


<h4>スローログの設定</h4>

<p>サービスレベルに耐えられないスロークエリを事前に検出するための設定です。<br/>
サービスレベル上、許容できないスロークエリの閾値を指定することで、その閾値を超えたクエリをログファイルに記録します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">Redis</span> <span class="nx">Slow</span> <span class="nx">Log</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">system</span> <span class="nx">to</span> <span class="nx">log</span> <span class="nx">queries</span> <span class="nx">that</span> <span class="nx">exceeded</span> <span class="nx">a</span> <span class="nx">specified</span>
</span><span class='line'><span class="err">#</span> <span class="nx">execution</span> <span class="nx">time</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">execution</span> <span class="nx">time</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">include</span> <span class="nx">the</span> <span class="nx">I</span><span class="o">/</span><span class="nx">O</span> <span class="nx">operations</span>
</span><span class='line'><span class="err">#</span> <span class="nx">like</span> <span class="nx">talking</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">sending</span> <span class="nx">the</span> <span class="nx">reply</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span><span class="p">,</span>
</span><span class='line'><span class="err">#</span> <span class="nx">but</span> <span class="nx">just</span> <span class="nx">the</span> <span class="nx">time</span> <span class="nx">needed</span> <span class="nx">to</span> <span class="nx">actually</span> <span class="nx">execute</span> <span class="nx">the</span> <span class="nx">command</span> <span class="p">(</span><span class="k">this</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">only</span>
</span><span class='line'><span class="err">#</span> <span class="nx">stage</span> <span class="nx">of</span> <span class="nx">command</span> <span class="nx">execution</span> <span class="nx">where</span> <span class="nx">the</span> <span class="nx">thread</span> <span class="nx">is</span> <span class="nx">blocked</span> <span class="nx">and</span> <span class="nx">can</span> <span class="nx">not</span> <span class="nx">serve</span>
</span><span class='line'><span class="err">#</span> <span class="nx">other</span> <span class="nx">requests</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">meantime</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">configure</span> <span class="nx">the</span> <span class="nx">slow</span> <span class="nx">log</span> <span class="kd">with</span> <span class="nx">two</span> <span class="nx">parameters</span><span class="o">:</span> <span class="nx">one</span> <span class="nx">tells</span> <span class="nx">Redis</span>
</span><span class='line'><span class="err">#</span> <span class="nx">what</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">execution</span> <span class="nx">time</span><span class="p">,</span> <span class="k">in</span> <span class="nx">microseconds</span><span class="p">,</span> <span class="nx">to</span> <span class="nx">exceed</span> <span class="k">in</span> <span class="nx">order</span> <span class="k">for</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">command</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">logged</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">other</span> <span class="nx">parameter</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">length</span> <span class="nx">of</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">slow</span> <span class="nx">log</span><span class="p">.</span> <span class="nx">When</span> <span class="nx">a</span> <span class="k">new</span> <span class="nx">command</span> <span class="nx">is</span> <span class="nx">logged</span> <span class="nx">the</span> <span class="nx">oldest</span> <span class="nx">one</span> <span class="nx">is</span> <span class="nx">removed</span> <span class="nx">from</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">queue</span> <span class="nx">of</span> <span class="nx">logged</span> <span class="nx">commands</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">following</span> <span class="nx">time</span> <span class="nx">is</span> <span class="nx">expressed</span> <span class="k">in</span> <span class="nx">microseconds</span><span class="p">,</span> <span class="nx">so</span> <span class="mi">1000000</span> <span class="nx">is</span> <span class="nx">equivalent</span>
</span><span class='line'><span class="err">#</span> <span class="nx">to</span> <span class="nx">one</span> <span class="nx">second</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="nx">a</span> <span class="nx">negative</span> <span class="nx">number</span> <span class="nx">disables</span> <span class="nx">the</span> <span class="nx">slow</span> <span class="nx">log</span><span class="p">,</span> <span class="k">while</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">value</span> <span class="nx">of</span> <span class="nx">zero</span> <span class="nx">forces</span> <span class="nx">the</span> <span class="nx">logging</span> <span class="nx">of</span> <span class="nx">every</span> <span class="nx">command</span><span class="p">.</span>
</span><span class='line'><span class="nx">slowlog</span><span class="o">-</span><span class="nx">log</span><span class="o">-</span><span class="nx">slower</span><span class="o">-</span><span class="nx">than</span> <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'><span class="err">#</span> <span class="nx">There</span> <span class="nx">is</span> <span class="nx">no</span> <span class="nx">limit</span> <span class="nx">to</span> <span class="k">this</span> <span class="nx">length</span><span class="p">.</span> <span class="nx">Just</span> <span class="nx">be</span> <span class="nx">aware</span> <span class="nx">that</span> <span class="nx">it</span> <span class="nx">will</span> <span class="nx">consume</span> <span class="nx">memory</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">reclaim</span> <span class="nx">memory</span> <span class="nx">used</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">slow</span> <span class="nx">log</span> <span class="kd">with</span> <span class="nx">SLOWLOG</span> <span class="nx">RESET</span><span class="p">.</span>
</span><span class='line'><span class="nx">slowlog</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">len</span> <span class="mi">128</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>slowlog-log-slower-than</code>: スロークエリとみなす実行時間の閾値。マイクロ秒です。</li>
<li><code>slowlog-max-len</code>: スロークエリログとして記録する容量の閾値。超えると古い順に削除します。</li>
</ul>


<h4>イベント通知設定</h4>

<p>Pub/Sub利用時に設定するようです。<br/>
Redisが通知するイベントは幾つかあるのですが、全て1文字で表現されており、<code>notify-keyspace-events</code>に指定することで通知イベントを決定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">can</span> <span class="nx">notify</span> <span class="nx">Pub</span><span class="o">/</span><span class="nx">Sub</span> <span class="nx">clients</span> <span class="nx">about</span> <span class="nx">events</span> <span class="nx">happening</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">key</span> <span class="nx">space</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">This</span> <span class="nx">feature</span> <span class="nx">is</span> <span class="nx">documented</span> <span class="nx">at</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//redis.io/topics/keyspace-events</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">For</span> <span class="nx">instance</span> <span class="k">if</span> <span class="nx">keyspace</span> <span class="nx">events</span> <span class="nx">notification</span> <span class="nx">is</span> <span class="nx">enabled</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">a</span> <span class="nx">client</span>
</span><span class='line'><span class="err">#</span> <span class="nx">performs</span> <span class="nx">a</span> <span class="nx">DEL</span> <span class="nx">operation</span> <span class="nx">on</span> <span class="nx">key</span> <span class="s2">&quot;foo&quot;</span> <span class="nx">stored</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">Database</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">two</span>
</span><span class='line'><span class="err">#</span> <span class="nx">messages</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">published</span> <span class="nx">via</span> <span class="nx">Pub</span><span class="o">/</span><span class="nx">Sub</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">PUBLISH</span> <span class="nx">__keyspace</span><span class="err">@</span><span class="mi">0</span><span class="nx">__</span><span class="o">:</span><span class="nx">foo</span> <span class="nx">del</span>
</span><span class='line'><span class="err">#</span> <span class="nx">PUBLISH</span> <span class="nx">__keyevent</span><span class="err">@</span><span class="mi">0</span><span class="nx">__</span><span class="o">:</span><span class="nx">del</span> <span class="nx">foo</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">possible</span> <span class="nx">to</span> <span class="nx">select</span> <span class="nx">the</span> <span class="nx">events</span> <span class="nx">that</span> <span class="nx">Redis</span> <span class="nx">will</span> <span class="nx">notify</span> <span class="nx">among</span> <span class="nx">a</span> <span class="nx">set</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">classes</span><span class="p">.</span> <span class="nx">Every</span> <span class="kr">class</span> <span class="nx">is</span> <span class="nx">identified</span> <span class="nx">by</span> <span class="nx">a</span> <span class="nx">single</span> <span class="nx">character</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">K</span>     <span class="nx">Keyspace</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">published</span> <span class="kd">with</span> <span class="nx">__keyspace</span><span class="err">@</span><span class="o">&lt;</span><span class="nx">db</span><span class="o">&gt;</span><span class="nx">__</span> <span class="nx">prefix</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">E</span>     <span class="nx">Keyevent</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">published</span> <span class="kd">with</span> <span class="nx">__keyevent</span><span class="err">@</span><span class="o">&lt;</span><span class="nx">db</span><span class="o">&gt;</span><span class="nx">__</span> <span class="nx">prefix</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">g</span>     <span class="nx">Generic</span> <span class="nx">commands</span> <span class="p">(</span><span class="nx">non</span><span class="o">-</span><span class="nx">type</span> <span class="nx">specific</span><span class="p">)</span> <span class="nx">like</span> <span class="nx">DEL</span><span class="p">,</span> <span class="nx">EXPIRE</span><span class="p">,</span> <span class="nx">RENAME</span><span class="p">,</span> <span class="p">...</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">$</span>     <span class="nb">String</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">l</span>     <span class="nx">List</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">s</span>     <span class="nx">Set</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">h</span>     <span class="nx">Hash</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">z</span>     <span class="nx">Sorted</span> <span class="nx">set</span> <span class="nx">commands</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">x</span>     <span class="nx">Expired</span> <span class="nx">events</span> <span class="p">(</span><span class="nx">events</span> <span class="nx">generated</span> <span class="nx">every</span> <span class="nx">time</span> <span class="nx">a</span> <span class="nx">key</span> <span class="nx">expires</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">e</span>     <span class="nx">Evicted</span> <span class="nx">events</span> <span class="p">(</span><span class="nx">events</span> <span class="nx">generated</span> <span class="nx">when</span> <span class="nx">a</span> <span class="nx">key</span> <span class="nx">is</span> <span class="nx">evicted</span> <span class="k">for</span> <span class="nx">maxmemory</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">A</span>     <span class="nx">Alias</span> <span class="k">for</span> <span class="nx">g$lshzxe</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">that</span> <span class="nx">the</span> <span class="s2">&quot;AKE&quot;</span> <span class="nx">string</span> <span class="nx">means</span> <span class="nx">all</span> <span class="nx">the</span> <span class="nx">events</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">The</span> <span class="s2">&quot;notify-keyspace-events&quot;</span> <span class="nx">takes</span> <span class="nx">as</span> <span class="nx">argument</span> <span class="nx">a</span> <span class="nx">string</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">composed</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">by</span> <span class="nx">zero</span> <span class="nx">or</span> <span class="nx">multiple</span> <span class="nx">characters</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">empty</span> <span class="nx">string</span> <span class="nx">means</span> <span class="nx">that</span> <span class="nx">notifications</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">are</span> <span class="nx">disabled</span> <span class="nx">at</span> <span class="nx">all</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">Example</span><span class="o">:</span> <span class="nx">to</span> <span class="nx">enable</span> <span class="nx">list</span> <span class="nx">and</span> <span class="nx">generic</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">point</span> <span class="nx">of</span> <span class="nx">view</span> <span class="nx">of</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span>           <span class="nx">event</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">use</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">notify</span><span class="o">-</span><span class="nx">keyspace</span><span class="o">-</span><span class="nx">events</span> <span class="nx">Elg</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">Example</span> <span class="mi">2</span><span class="o">:</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">the</span> <span class="nx">stream</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">expired</span> <span class="nx">keys</span> <span class="nx">subscribing</span> <span class="nx">to</span> <span class="nx">channel</span>
</span><span class='line'><span class="err">#</span>             <span class="nx">name</span> <span class="nx">__keyevent</span><span class="err">@</span><span class="mi">0</span><span class="nx">__</span><span class="o">:</span><span class="nx">expired</span> <span class="nx">use</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">notify</span><span class="o">-</span><span class="nx">keyspace</span><span class="o">-</span><span class="nx">events</span> <span class="nx">Ex</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">By</span> <span class="k">default</span> <span class="nx">all</span> <span class="nx">notifications</span> <span class="nx">are</span> <span class="nx">disabled</span> <span class="nx">because</span> <span class="nx">most</span> <span class="nx">users</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">need</span>
</span><span class='line'><span class="err">#</span>  <span class="k">this</span> <span class="nx">feature</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">feature</span> <span class="nx">has</span> <span class="nx">some</span> <span class="nx">overhead</span><span class="p">.</span> <span class="nx">Note</span> <span class="nx">that</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span>
</span><span class='line'><span class="err">#</span>  <span class="nx">specify</span> <span class="nx">at</span> <span class="nx">least</span> <span class="nx">one</span> <span class="nx">of</span> <span class="nx">K</span> <span class="nx">or</span> <span class="nx">E</span><span class="p">,</span> <span class="nx">no</span> <span class="nx">events</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">delivered</span><span class="p">.</span>
</span><span class='line'><span class="nx">notify</span><span class="o">-</span><span class="nx">keyspace</span><span class="o">-</span><span class="nx">events</span> <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>AKE</code>: これを設定することで全ての通知タイプに対応します。</li>
<li><code>空文字</code>: これを設定することで全ての通知を無効にします。</li>
</ul>


<h4>高度な設定</h4>

<p>この辺りが意識して触れるようになったらRedis上級者と見なせるのではないでしょうか。</p>

<h5>Hash型データのメモリ効率設定</h5>

<p>CPUとメモリのトレードオフにはなるのですが、「要素数の上限」と「1要素あたりの上限サイズ」の2つの閾値以内に収まる場合に、非常にメモリ効率の良い方法でエンコードされます。<br/>
これによりメモリが最大10分の1、平均でも5分の1に抑えられます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Hashes</span> <span class="nx">are</span> <span class="nx">encoded</span> <span class="nx">using</span> <span class="nx">a</span> <span class="nx">memory</span> <span class="nx">efficient</span> <span class="nx">data</span> <span class="nx">structure</span> <span class="nx">when</span> <span class="nx">they</span> <span class="nx">have</span> <span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">small</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">entries</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">biggest</span> <span class="nx">entry</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exceed</span> <span class="nx">a</span> <span class="nx">given</span>
</span><span class='line'><span class="err">#</span> <span class="nx">threshold</span><span class="p">.</span> <span class="nx">These</span> <span class="nx">thresholds</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">configured</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">directives</span><span class="p">.</span>
</span><span class='line'><span class="nx">hash</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">entries</span> <span class="mi">512</span>
</span><span class='line'><span class="nx">hash</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">value</span> <span class="mi">64</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>hash-max-ziplist-entries</code>: 要素数の上限</li>
<li><code>hash-max-ziplist-value</code>: 1要素あたりの上限サイズ</li>
</ul>


<h5>List型データのメモリ効率設定</h5>

<p>List型データに対する設定です。(各々の意味はHash型と同じです。)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Similarly</span> <span class="nx">to</span> <span class="nx">hashes</span><span class="p">,</span> <span class="nx">small</span> <span class="nx">lists</span> <span class="nx">are</span> <span class="nx">also</span> <span class="nx">encoded</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">special</span> <span class="nx">way</span> <span class="k">in</span> <span class="nx">order</span>
</span><span class='line'><span class="err">#</span> <span class="nx">to</span> <span class="nx">save</span> <span class="nx">a</span> <span class="nx">lot</span> <span class="nx">of</span> <span class="nx">space</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">special</span> <span class="nx">representation</span> <span class="nx">is</span> <span class="nx">only</span> <span class="nx">used</span> <span class="nx">when</span>
</span><span class='line'><span class="err">#</span> <span class="nx">you</span> <span class="nx">are</span> <span class="nx">under</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">limits</span><span class="o">:</span>
</span><span class='line'><span class="nx">list</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">entries</span> <span class="mi">512</span>
</span><span class='line'><span class="nx">list</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">value</span> <span class="mi">64</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Set型データのメモリ効率設定</h5>

<p>Set型データに対する設定です。<br/>
Set型のみ圧縮方式が<code>ziplist</code>ではなく<code>intset</code>であるためか設定項目数が異なります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Sets</span> <span class="nx">have</span> <span class="nx">a</span> <span class="nx">special</span> <span class="nx">encoding</span> <span class="k">in</span> <span class="nx">just</span> <span class="nx">one</span> <span class="k">case</span><span class="o">:</span> <span class="nx">when</span> <span class="nx">a</span> <span class="nx">set</span> <span class="nx">is</span> <span class="nx">composed</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">just</span> <span class="nx">strings</span> <span class="nx">that</span> <span class="nx">happens</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">integers</span> <span class="k">in</span> <span class="nx">radix</span> <span class="mi">10</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">range</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="mi">64</span> <span class="nx">bit</span> <span class="nx">signed</span> <span class="nx">integers</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">following</span> <span class="nx">configuration</span> <span class="nx">setting</span> <span class="nx">sets</span> <span class="nx">the</span> <span class="nx">limit</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">size</span> <span class="nx">of</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">set</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">use</span> <span class="k">this</span> <span class="nx">special</span> <span class="nx">memory</span> <span class="nx">saving</span> <span class="nx">encoding</span><span class="p">.</span>
</span><span class='line'><span class="nx">set</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">intset</span><span class="o">-</span><span class="nx">entries</span> <span class="mi">512</span>
</span></code></pre></td></tr></table></div></figure>


<h5>ZSet型データのメモリ効率設定</h5>

<p>ZSet型データに対する設定です。(各々の意味はHash型と同じです。)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Similarly</span> <span class="nx">to</span> <span class="nx">hashes</span> <span class="nx">and</span> <span class="nx">lists</span><span class="p">,</span> <span class="nx">sorted</span> <span class="nx">sets</span> <span class="nx">are</span> <span class="nx">also</span> <span class="nx">specially</span> <span class="nx">encoded</span> <span class="k">in</span>
</span><span class='line'><span class="err">#</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">save</span> <span class="nx">a</span> <span class="nx">lot</span> <span class="nx">of</span> <span class="nx">space</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">encoding</span> <span class="nx">is</span> <span class="nx">only</span> <span class="nx">used</span> <span class="nx">when</span> <span class="nx">the</span> <span class="nx">length</span> <span class="nx">and</span>
</span><span class='line'><span class="err">#</span> <span class="nx">elements</span> <span class="nx">of</span> <span class="nx">a</span> <span class="nx">sorted</span> <span class="nx">set</span> <span class="nx">are</span> <span class="nx">below</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">limits</span><span class="o">:</span>
</span><span class='line'><span class="nx">zset</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">entries</span> <span class="mi">128</span>
</span><span class='line'><span class="nx">zset</span><span class="o">-</span><span class="nx">max</span><span class="o">-</span><span class="nx">ziplist</span><span class="o">-</span><span class="nx">value</span> <span class="mi">64</span>
</span></code></pre></td></tr></table></div></figure>


<h5>再ハッシュ設定</h5>

<p>これは、『100ミリ秒ごとに1ミリ秒のCPU時間を使用して、Redisのメインのハッシュテーブル(トップレベルのキーと値を保持している)の再ハッシュ化を行う』設定です。<br/>
<code>yes</code>にすることでメモリが効率的に利用されるようになる一方で最大2ミリ秒間の遅延が発生する可能性があります。<br/>
この2ミリ秒間の遅延を許容できない場合は<code>no</code>に設定を変更しましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Active</span> <span class="nx">rehashing</span> <span class="nx">uses</span> <span class="mi">1</span> <span class="nx">millisecond</span> <span class="nx">every</span> <span class="mi">100</span> <span class="nx">milliseconds</span> <span class="nx">of</span> <span class="nx">CPU</span> <span class="nx">time</span> <span class="k">in</span>
</span><span class='line'><span class="err">#</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">help</span> <span class="nx">rehashing</span> <span class="nx">the</span> <span class="nx">main</span> <span class="nx">Redis</span> <span class="nx">hash</span> <span class="nx">table</span> <span class="p">(</span><span class="nx">the</span> <span class="nx">one</span> <span class="nx">mapping</span> <span class="nx">top</span><span class="o">-</span><span class="nx">level</span>
</span><span class='line'><span class="err">#</span> <span class="nx">keys</span> <span class="nx">to</span> <span class="nx">values</span><span class="p">).</span> <span class="nx">The</span> <span class="nx">hash</span> <span class="nx">table</span> <span class="nx">implementation</span> <span class="nx">Redis</span> <span class="nx">uses</span> <span class="p">(</span><span class="nx">see</span> <span class="nx">dict</span><span class="p">.</span><span class="nx">c</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span> <span class="nx">performs</span> <span class="nx">a</span> <span class="nx">lazy</span> <span class="nx">rehashing</span><span class="o">:</span> <span class="nx">the</span> <span class="nx">more</span> <span class="nx">operation</span> <span class="nx">you</span> <span class="nx">run</span> <span class="nx">into</span> <span class="nx">a</span> <span class="nx">hash</span> <span class="nx">table</span>
</span><span class='line'><span class="err">#</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">rehashing</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">more</span> <span class="nx">rehashing</span> <span class="s2">&quot;steps&quot;</span> <span class="nx">are</span> <span class="nx">performed</span><span class="p">,</span> <span class="nx">so</span> <span class="k">if</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">server</span> <span class="nx">is</span> <span class="nx">idle</span> <span class="nx">the</span> <span class="nx">rehashing</span> <span class="nx">is</span> <span class="nx">never</span> <span class="nx">complete</span> <span class="nx">and</span> <span class="nx">some</span> <span class="nx">more</span> <span class="nx">memory</span> <span class="nx">is</span> <span class="nx">used</span>
</span><span class='line'><span class="err">#</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">hash</span> <span class="nx">table</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">is</span> <span class="nx">to</span> <span class="nx">use</span> <span class="k">this</span> <span class="nx">millisecond</span> <span class="mi">10</span> <span class="nx">times</span> <span class="nx">every</span> <span class="nx">second</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span>
</span><span class='line'><span class="err">#</span> <span class="nx">active</span> <span class="nx">rehashing</span> <span class="nx">the</span> <span class="nx">main</span> <span class="nx">dictionaries</span><span class="p">,</span> <span class="nx">freeing</span> <span class="nx">memory</span> <span class="nx">when</span> <span class="nx">possible</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">If</span> <span class="nx">unsure</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span> <span class="nx">use</span> <span class="s2">&quot;activerehashing no&quot;</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">hard</span> <span class="nx">latency</span> <span class="nx">requirements</span> <span class="nx">and</span> <span class="nx">it</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="nx">not</span> <span class="nx">a</span> <span class="nx">good</span> <span class="nx">thing</span> <span class="k">in</span> <span class="nx">your</span> <span class="nx">environment</span> <span class="nx">that</span> <span class="nx">Redis</span> <span class="nx">can</span> <span class="nx">reply</span> <span class="nx">form</span> <span class="nx">time</span> <span class="nx">to</span> <span class="nx">time</span>
</span><span class='line'><span class="err">#</span> <span class="nx">to</span> <span class="nx">queries</span> <span class="kd">with</span> <span class="mi">2</span> <span class="nx">milliseconds</span> <span class="nx">delay</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">use</span> <span class="s2">&quot;activerehashing yes&quot;</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">have</span> <span class="nx">such</span> <span class="nx">hard</span> <span class="nx">requirements</span> <span class="nx">but</span>
</span><span class='line'><span class="err">#</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">free</span> <span class="nx">memory</span> <span class="nx">asap</span> <span class="nx">when</span> <span class="nx">possible</span><span class="p">.</span>
</span><span class='line'><span class="nx">activerehashing</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<p>2ミリ秒の遅延も許せないサービスってあるんだろうか&hellip;と思いつつも。</p>

<h5>クライアントの出力バッファ制限の設定</h5>

<p>指定した値以上に出力バッファが到達するとクライアントとの接続を強制的に切断します。<br/>
出力バッファが制限値に到達し続けるということは、想定した出力バッファサイズと処理速度を見誤っている可能性があるということです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">client</span> <span class="nx">output</span> <span class="nx">buffer</span> <span class="nx">limits</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">force</span> <span class="nx">disconnection</span> <span class="nx">of</span> <span class="nx">clients</span>
</span><span class='line'><span class="err">#</span> <span class="nx">that</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">reading</span> <span class="nx">data</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">server</span> <span class="nx">fast</span> <span class="nx">enough</span> <span class="k">for</span> <span class="nx">some</span> <span class="nx">reason</span> <span class="p">(</span><span class="nx">a</span>
</span><span class='line'><span class="err">#</span> <span class="nx">common</span> <span class="nx">reason</span> <span class="nx">is</span> <span class="nx">that</span> <span class="nx">a</span> <span class="nx">Pub</span><span class="o">/</span><span class="nx">Sub</span> <span class="nx">client</span> <span class="nx">can</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">consume</span> <span class="nx">messages</span> <span class="nx">as</span> <span class="nx">fast</span> <span class="nx">as</span> <span class="nx">the</span>
</span><span class='line'><span class="err">#</span> <span class="nx">publisher</span> <span class="nx">can</span> <span class="nx">produce</span> <span class="nx">them</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">limit</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">set</span> <span class="nx">differently</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">three</span> <span class="nx">different</span> <span class="nx">classes</span> <span class="nx">of</span> <span class="nx">clients</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">normal</span> <span class="o">-&gt;</span> <span class="nx">normal</span> <span class="nx">clients</span>
</span><span class='line'><span class="err">#</span> <span class="nx">slave</span>  <span class="o">-&gt;</span> <span class="nx">slave</span> <span class="nx">clients</span> <span class="nx">and</span> <span class="nx">MONITOR</span> <span class="nx">clients</span>
</span><span class='line'><span class="err">#</span> <span class="nx">pubsub</span> <span class="o">-&gt;</span> <span class="nx">clients</span> <span class="nx">subscribed</span> <span class="nx">to</span> <span class="nx">at</span> <span class="nx">least</span> <span class="nx">one</span> <span class="nx">pubsub</span> <span class="nx">channel</span> <span class="nx">or</span> <span class="nx">pattern</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">syntax</span> <span class="nx">of</span> <span class="nx">every</span> <span class="nx">client</span><span class="o">-</span><span class="nx">output</span><span class="o">-</span><span class="nx">buffer</span><span class="o">-</span><span class="nx">limit</span> <span class="nx">directive</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">following</span><span class="o">:</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">client</span><span class="o">-</span><span class="nx">output</span><span class="o">-</span><span class="nx">buffer</span><span class="o">-</span><span class="nx">limit</span> <span class="o">&lt;</span><span class="kr">class</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">hard</span> <span class="nx">limit</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">soft</span> <span class="nx">limit</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">soft</span> <span class="nx">seconds</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">A</span> <span class="nx">client</span> <span class="nx">is</span> <span class="nx">immediately</span> <span class="nx">disconnected</span> <span class="nx">once</span> <span class="nx">the</span> <span class="nx">hard</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="nx">reached</span><span class="p">,</span> <span class="nx">or</span> <span class="k">if</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">soft</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="nx">reached</span> <span class="nx">and</span> <span class="nx">remains</span> <span class="nx">reached</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="nx">number</span> <span class="nx">of</span>
</span><span class='line'><span class="err">#</span> <span class="nx">seconds</span> <span class="p">(</span><span class="nx">continuously</span><span class="p">).</span>
</span><span class='line'><span class="err">#</span> <span class="nx">So</span> <span class="k">for</span> <span class="nx">instance</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">hard</span> <span class="nx">limit</span> <span class="nx">is</span> <span class="mi">32</span> <span class="nx">megabytes</span> <span class="nx">and</span> <span class="nx">the</span> <span class="nx">soft</span> <span class="nx">limit</span> <span class="nx">is</span>
</span><span class='line'><span class="err">#</span> <span class="mi">16</span> <span class="nx">megabytes</span> <span class="o">/</span> <span class="mi">10</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">client</span> <span class="nx">will</span> <span class="nx">get</span> <span class="nx">disconnected</span> <span class="nx">immediately</span>
</span><span class='line'><span class="err">#</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">size</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">output</span> <span class="nx">buffers</span> <span class="nx">reach</span> <span class="mi">32</span> <span class="nx">megabytes</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">will</span> <span class="nx">also</span> <span class="nx">get</span>
</span><span class='line'><span class="err">#</span> <span class="nx">disconnected</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">client</span> <span class="nx">reaches</span> <span class="mi">16</span> <span class="nx">megabytes</span> <span class="nx">and</span> <span class="nx">continuously</span> <span class="nx">overcomes</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">limit</span> <span class="k">for</span> <span class="mi">10</span> <span class="nx">seconds</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="nx">normal</span> <span class="nx">clients</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">limited</span> <span class="nx">because</span> <span class="nx">they</span> <span class="nx">don</span><span class="err">‘</span><span class="nx">t</span> <span class="nx">receive</span> <span class="nx">data</span>
</span><span class='line'><span class="err">#</span> <span class="nx">without</span> <span class="nx">asking</span> <span class="p">(</span><span class="k">in</span> <span class="nx">a</span> <span class="nx">push</span> <span class="nx">way</span><span class="p">),</span> <span class="nx">but</span> <span class="nx">just</span> <span class="nx">after</span> <span class="nx">a</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">only</span>
</span><span class='line'><span class="err">#</span> <span class="nx">asynchronous</span> <span class="nx">clients</span> <span class="nx">may</span> <span class="nx">create</span> <span class="nx">a</span> <span class="nx">scenario</span> <span class="nx">where</span> <span class="nx">data</span> <span class="nx">is</span> <span class="nx">requested</span> <span class="nx">faster</span>
</span><span class='line'><span class="err">#</span> <span class="nx">than</span> <span class="nx">it</span> <span class="nx">can</span> <span class="nx">read</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Instead</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">a</span> <span class="k">default</span> <span class="nx">limit</span> <span class="k">for</span> <span class="nx">pubsub</span> <span class="nx">and</span> <span class="nx">slave</span> <span class="nx">clients</span><span class="p">,</span> <span class="nx">since</span>
</span><span class='line'><span class="err">#</span> <span class="nx">subscribers</span> <span class="nx">and</span> <span class="nx">slaves</span> <span class="nx">receive</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">push</span> <span class="nx">fashion</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Both</span> <span class="nx">the</span> <span class="nx">hard</span> <span class="nx">or</span> <span class="nx">the</span> <span class="nx">soft</span> <span class="nx">limit</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">disabled</span> <span class="nx">by</span> <span class="nx">setting</span> <span class="nx">them</span> <span class="nx">to</span> <span class="nx">zero</span><span class="p">.</span>
</span><span class='line'><span class="nx">client</span><span class="o">-</span><span class="nx">output</span><span class="o">-</span><span class="nx">buffer</span><span class="o">-</span><span class="nx">limit</span> <span class="nx">normal</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
</span><span class='line'><span class="nx">client</span><span class="o">-</span><span class="nx">output</span><span class="o">-</span><span class="nx">buffer</span><span class="o">-</span><span class="nx">limit</span> <span class="nx">slave</span> <span class="mi">256</span><span class="nx">mb</span> <span class="mi">64</span><span class="nx">mb</span> <span class="mi">60</span>
</span><span class='line'><span class="nx">client</span><span class="o">-</span><span class="nx">output</span><span class="o">-</span><span class="nx">buffer</span><span class="o">-</span><span class="nx">limit</span> <span class="nx">pubsub</span> <span class="mi">32</span><span class="nx">mb</span> <span class="mi">8</span><span class="nx">mb</span> <span class="mi">60</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>client-output-buffer-limit normal 0 0 0</code>

<ul>
<li>通常クライアントに対する設定</li>
<li>hard limit / soft limit を0設定して無効化している</li>
</ul>
</li>
<li><code>client-output-buffer-limit slave 256mb 64mb 60</code>

<ul>
<li>スレーブクライアントに対する設定</li>
<li>hard limitが256mbなので、256MBに到達した時点で即時切断します</li>
<li>soft limitが64mb, soft secondsが60なので、出力バッファが60秒間64MBに到達し続けた場合に切断します</li>
<li>ここはレプリケーション設定にも関わってくるため設定値は考えてつける必要があります</li>
</ul>
</li>
<li><code>client-output-buffer-limit pubsub 32mb 8mb 60</code>

<ul>
<li>Pub/Sub(購読)クライアントに対する設定</li>
<li>hard limitが32mbなので、32MBに到達した時点で即時切断します</li>
<li>soft limitが8mb, soft secondsが60なので、出力バッファが60秒間8MBに到達し続けた場合に切断します</li>
</ul>
</li>
</ul>


<h5>バックグラウンド処理の頻度に関する設定</h5>

<p>Redisはバックグランドタスクとして、タイムアウトしたクライアントとのコネクションの切断 / 期限切れキーの削除などを実施しています。<br/>
その頻度を<code>hz</code>の値によって決めています。<br/>
基本的に推奨値は<code>10</code>なので変更することは少ないと思われます。<br/>
低レイテンシを厳しく求められる環境でのみ<code>100</code>を設定しても良いでしょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">calls</span> <span class="nx">an</span> <span class="nx">internal</span> <span class="kd">function</span> <span class="nx">to</span> <span class="nx">perform</span> <span class="nx">many</span> <span class="nx">background</span> <span class="nx">tasks</span><span class="p">,</span> <span class="nx">like</span>
</span><span class='line'><span class="err">#</span> <span class="nx">closing</span> <span class="nx">connections</span> <span class="nx">of</span> <span class="nx">clients</span> <span class="k">in</span> <span class="nx">timeout</span><span class="p">,</span> <span class="nx">purging</span> <span class="nx">expired</span> <span class="nx">keys</span> <span class="nx">that</span> <span class="nx">are</span>
</span><span class='line'><span class="err">#</span> <span class="nx">never</span> <span class="nx">requested</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">so</span> <span class="nx">forth</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Not</span> <span class="nx">all</span> <span class="nx">tasks</span> <span class="nx">are</span> <span class="nx">performed</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">frequency</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">Redis</span> <span class="nx">checks</span> <span class="k">for</span>
</span><span class='line'><span class="err">#</span> <span class="nx">tasks</span> <span class="nx">to</span> <span class="nx">perform</span> <span class="nx">accordingly</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">specified</span> <span class="s2">&quot;hz&quot;</span> <span class="nx">value</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">By</span> <span class="k">default</span> <span class="s2">&quot;hz&quot;</span> <span class="nx">is</span> <span class="nx">set</span> <span class="nx">to</span> <span class="mi">10</span><span class="p">.</span> <span class="nx">Raising</span> <span class="nx">the</span> <span class="nx">value</span> <span class="nx">will</span> <span class="nx">use</span> <span class="nx">more</span> <span class="nx">CPU</span> <span class="nx">when</span>
</span><span class='line'><span class="err">#</span> <span class="nx">Redis</span> <span class="nx">is</span> <span class="nx">idle</span><span class="p">,</span> <span class="nx">but</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">time</span> <span class="nx">will</span> <span class="nx">make</span> <span class="nx">Redis</span> <span class="nx">more</span> <span class="nx">responsive</span> <span class="nx">when</span>
</span><span class='line'><span class="err">#</span> <span class="nx">there</span> <span class="nx">are</span> <span class="nx">many</span> <span class="nx">keys</span> <span class="nx">expiring</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">same</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">timeouts</span> <span class="nx">may</span> <span class="nx">be</span>
</span><span class='line'><span class="err">#</span> <span class="nx">handled</span> <span class="kd">with</span> <span class="nx">more</span> <span class="nx">precision</span><span class="p">.</span>
</span><span class='line'><span class="err">#</span>
</span><span class='line'><span class="err">#</span> <span class="nx">The</span> <span class="nx">range</span> <span class="nx">is</span> <span class="nx">between</span> <span class="mi">1</span> <span class="nx">and</span> <span class="mi">500</span><span class="p">,</span> <span class="nx">however</span> <span class="nx">a</span> <span class="nx">value</span> <span class="nx">over</span> <span class="mi">100</span> <span class="nx">is</span> <span class="nx">usually</span> <span class="nx">not</span>
</span><span class='line'><span class="err">#</span> <span class="nx">a</span> <span class="nx">good</span> <span class="nx">idea</span><span class="p">.</span> <span class="nx">Most</span> <span class="nx">users</span> <span class="nx">should</span> <span class="nx">use</span> <span class="nx">the</span> <span class="k">default</span> <span class="nx">of</span> <span class="mi">10</span> <span class="nx">and</span> <span class="nx">raise</span> <span class="k">this</span> <span class="nx">up</span> <span class="nx">to</span>
</span><span class='line'><span class="err">#</span> <span class="mi">100</span> <span class="nx">only</span> <span class="k">in</span> <span class="nx">environments</span> <span class="nx">where</span> <span class="nx">very</span> <span class="nx">low</span> <span class="nx">latency</span> <span class="nx">is</span> <span class="nx">required</span><span class="p">.</span>
</span><span class='line'><span class="nx">hz</span> <span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<h5>AOF書き換え時のfsyncの設定</h5>

<p><code>yes</code>を設定することで、32MBごとにfsyncを実行するようになります。<br/>
これによりファイルをディスクに書き込む際に、大きな遅延スパイクが発生するのを避けることができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">When</span> <span class="nx">a</span> <span class="nx">child</span> <span class="nx">rewrites</span> <span class="nx">the</span> <span class="nx">AOF</span> <span class="nx">file</span><span class="p">,</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">option</span> <span class="nx">is</span> <span class="nx">enabled</span>
</span><span class='line'><span class="err">#</span> <span class="nx">the</span> <span class="nx">file</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">fsync</span><span class="o">-</span><span class="nx">ed</span> <span class="nx">every</span> <span class="mi">32</span> <span class="nx">MB</span> <span class="nx">of</span> <span class="nx">data</span> <span class="nx">generated</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">is</span> <span class="nx">useful</span>
</span><span class='line'><span class="err">#</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">commit</span> <span class="nx">the</span> <span class="nx">file</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">disk</span> <span class="nx">more</span> <span class="nx">incrementally</span> <span class="nx">and</span> <span class="nx">avoid</span>
</span><span class='line'><span class="err">#</span> <span class="nx">big</span> <span class="nx">latency</span> <span class="nx">spikes</span><span class="p">.</span>
</span><span class='line'><span class="nx">aof</span><span class="o">-</span><span class="nx">rewrite</span><span class="o">-</span><span class="nx">incremental</span><span class="o">-</span><span class="nx">fsync</span> <span class="nx">yes</span>
</span></code></pre></td></tr></table></div></figure>


<h3>まとめ</h3>

<p>細かな設定の棚卸しをしてみたものの、かなりしんどかったです&hellip;<br/>
運用してみないと想像がつかない設定も多く、この辺りは本当に実務でしか経験を養えないのだと痛感しました。<br/>
しかし、各々の意味を理解しておくことは決して無駄ではないと思うので、勉強になったかなと思います。<br/>
と言ったところで本日はここまで。</p>

<h3>参考</h3>

<ul>
<li><a href="http://redis-documentasion-japanese.readthedocs.io/ja/latest/topics/replication.html">Redis Documentation レプリケーション</a></li>
<li><a href="http://redis-documentasion-japanese.readthedocs.io/ja/latest/topics/lru-cache.html">Redis Documentation LRUキャッシュ</a></li>
<li><a href="http://redis-documentasion-japanese.readthedocs.io/ja/latest/topics/notifications.html">Redis Documentation キー・スペース通知</a></li>
<li><a href="http://redis-documentasion-japanese.readthedocs.io/ja/latest/topics/memory-optimization.html">Redis Documentation メモリ最適化</a></li>
<li><a href="http://t-cyrill.hatenablog.jp/entry/2016/12/11/224604">真剣にRedisを使ってみようという気持ちになったのでRedisについて知っていることを書く</a></li>
<li><a href="http://qiita.com/eccyan/items/e8cc56948a00d6aad0aa">Redis のメモリが足りなくなった時にどうやってチューニングしたか</a></li>
<li><a href="http://mocobeta-backup.tumblr.com/post/84793291682/redis-set">Redisのメモリ使用量削減</a></li>
<li><a href="http://tech.guitarrapc.com/entry/2013/08/02/210858">EC2など 高負荷クラウド環境における Redis のチューニングについて</a></li>
<li><a href="http://redis.shibu.jp/admin/config.html">redis 2.0.3 documentation</a></li>
</ul>


<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"style="display:inline-block;width:320px;height:100px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="6603059167"></ins></p>

<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Takahiro</span></span>

      








  


<time datetime="2017-02-25T22:36:00+09:00" pubdate data-updated="true">Feb 25<span>th</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/docker/'>docker</a>, <a class='category' href='/blog/categories/redis/'>redis</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://grandbig.github.io/blog/2017/02/25/docker-for-mac-4/" data-via="" data-counturl="http://grandbig.github.io/blog/2017/02/25/docker-for-mac-4/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/02/19/docker-for-mac-3/" title="Previous Post: Dockerコンテナ内のUbuntuでApache設定を試してみよう！">&laquo; Dockerコンテナ内のUbuntuでApache設定を試してみよう！</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/02/26/docker-for-mac-5/" title="Next Post: Dockerコンテナ内のUbuntuでMariaDBを使ってみよう！">Dockerコンテナ内のUbuntuでMariaDBを使ってみよう！ &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/04/11/docker-for-mac-7/">Dockerコンテナ内のUbuntuにSwiftサーバを立てよう！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/09/swift-di/">SwinjectでDIを意識してみよう！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/25/docker-for-mac-6/">Kitematicでエラーが発生してDockerコンテナが作成できない！！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/26/docker-for-mac-5/">Dockerコンテナ内のUbuntuでMariaDBを使ってみよう！</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/25/docker-for-mac-4/">Dockerコンテナ内のUbuntuでRedisを使ってみよう！</a>
      </li>
    
  </ul>
</section>




<section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 広告１ -->
<ins class="adsbygoogle"style="display:inline-block;width:300px;height:250px"data-ad-client="ca-pub-2881241309408290"data-ad-slot="4255355169"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
	google_ad_client: "ca-pub-2881241309408290",
	enable_page_level_ads: true
});
</script>
</section>
<section>
	<h1>Top Categories</h1>
		<ul id="top-category-list"><li><a href='/blog/categories/ios'>ios (137)</a></li><li><a href='/blog/categories/swift'>swift (42)</a></li><li><a href='/blog/categories/android'>android (20)</a></li><li><a href='/blog/categories/java'>java (19)</a></li><li><a href='/blog/categories/ibeacon'>iBeacon (19)</a></li><li><a href='/blog/categories/webview'>webview (10)</a></li><li><a href='/blog/categories/ios8'>ios8 (9)</a></li><li><a href='/blog/categories/web'>web (7)</a></li><li><a href='/blog/categories/docker'>docker (7)</a></li><li><a href='/blog/categories/javascript'>javascript (7)</a></li><li><a href='/blog/categories/xcode'>xcode (6)</a></li><li><a href='/blog/categories/location'>location (6)</a></li><li><a href='/blog/categories/node'>node (6)</a></li><li><a href='/blog/categories/springboot'>springboot (6)</a></li><li><a href='/blog/categories/redux'>redux (6)</a></li></ul>
</section>
<aside>
	<h3>
		About Takahiro
	</h3>
	<div>
		<div>メカ出身のプログラマー</div>
		<div>故にLevelは-1</div>
		<div>主にiOSアプリケーションの開発を担当しています(たまにWeb, Android, サーバサイドもやります)</div>
		<a class="button" href="mailto:takahiro.kato.blog15@gmail.com">MAILはこちらから</a>
	</div>
</aside>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Takahiro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'takahirooctopressblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://grandbig.github.io/blog/2017/02/25/docker-for-mac-4/';
        var disqus_url = 'http://grandbig.github.io/blog/2017/02/25/docker-for-mac-4/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
